<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shispring.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shispring">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>èµ„æº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/28/%E9%99%90%E6%B5%81%E5%AE%9E%E6%93%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/28/%E9%99%90%E6%B5%81%E5%AE%9E%E6%93%8D/" class="post-title-link" itemprop="url">é™æµå®æ“</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-28 17:43:21 / ä¿®æ”¹æ—¶é—´ï¼š17:56:05" itemprop="dateCreated datePublished" datetime="2026-01-28T17:43:21+08:00">2026-01-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="é™æµç®—æ³•"><a href="#é™æµç®—æ³•" class="headerlink" title="é™æµç®—æ³•"></a>é™æµç®—æ³•</h2><table>
<thead>
<tr>
<th>ç®—æ³•åç§°</th>
<th>åŸç†ä¸€å¥è¯</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>å…¸å‹æ¡ˆä¾‹ &#x2F; åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è®¡æ•°å™¨ï¼ˆCounterï¼‰</strong></td>
<td>ç´¯åŠ è¯·æ±‚æ•°ï¼Œè¶…è¿‡é˜ˆå€¼æ‹’ç»</td>
<td>å®ç°æç®€å•</td>
<td>æ— æ—¶é—´ç»´åº¦ï¼›æ´ªå³°ç¬é—´å¤±æ•ˆ</td>
<td>Demo &#x2F; æ•™å­¦</td>
</tr>
<tr>
<td><strong>å›ºå®šçª—å£ï¼ˆFixed Windowï¼‰</strong></td>
<td>æ¯ä¸ªæ—¶é—´çª—å£å†…æœ€å¤š N æ¬¡</td>
<td>ç®€å•ã€æ˜“ç†è§£</td>
<td>çª—å£è¾¹ç•Œçªåˆº</td>
<td>ç®€å•æ¥å£é™æµ</td>
</tr>
<tr>
<td><strong>æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰</strong></td>
<td>ç»Ÿè®¡æœ€è¿‘ T æ—¶é—´å†…è¯·æ±‚æ•°</td>
<td>å¹³æ»‘ã€ç²¾ç¡®</td>
<td>å®ç°å¤æ‚ã€å­˜å‚¨æˆæœ¬é«˜</td>
<td>SDK &#x2F; API ç½‘å…³</td>
</tr>
<tr>
<td><strong>æ¼æ¡¶ï¼ˆLeaky Bucketï¼‰</strong></td>
<td>è¯·æ±‚è¿›æ¡¶ï¼Œå›ºå®šé€Ÿç‡æ¼å‡º</td>
<td>è¾“å‡ºç¨³å®šã€å¯æ•´å½¢</td>
<td>ä¸æ”¯æŒçªå‘æµé‡</td>
<td>ç½‘ç»œæ•´å½¢ã€QoS</td>
</tr>
<tr>
<td>â­ <strong>ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰</strong></td>
<td>å®šé€Ÿç”Ÿæˆä»¤ç‰Œï¼Œè¯·æ±‚æ¶ˆè€—</td>
<td>æ”¯æŒçªå‘ã€å¼¹æ€§å¥½</td>
<td>å®ç°ç•¥å¤æ‚</td>
<td><strong>ç”Ÿäº§ä¸»æµæ–¹æ¡ˆ</strong></td>
</tr>
</tbody></table>
<blockquote>
<p>é™æµ â‰  å¹³æ»‘<br>é™æµ &#x3D; å…è®¸çˆ†å‘ï¼Œä½†è¦å…œåº•</p>
</blockquote>
<h2 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h2><h3 id="æ ¸å¿ƒå‚æ•°"><a href="#æ ¸å¿ƒå‚æ•°" class="headerlink" title="æ ¸å¿ƒå‚æ•°"></a>æ ¸å¿ƒå‚æ•°</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>rate</td>
<td>æ¯ç§’ç”Ÿæˆå¤šå°‘ä»¤ç‰Œ</td>
</tr>
<tr>
<td>capacity</td>
<td>æ¡¶æœ€å¤§å®¹é‡</td>
</tr>
<tr>
<td>tokens</td>
<td>å½“å‰å¯ç”¨ä»¤ç‰Œ</td>
</tr>
<tr>
<td>timestamp</td>
<td>ä¸Šæ¬¡æ›´æ–°æ—¶é—´</td>
</tr>
</tbody></table>
<h3 id="è¡Œä¸ºç‰¹æ€§"><a href="#è¡Œä¸ºç‰¹æ€§" class="headerlink" title="è¡Œä¸ºç‰¹æ€§"></a>è¡Œä¸ºç‰¹æ€§</h3><ul>
<li>å¹³æ—¶æ²¡æµé‡ â†’ ä»¤ç‰Œç´¯ç§¯</li>
<li>çªå‘æµé‡ â†’ å¿«é€Ÿæ¶ˆè€—</li>
<li>è¶…å‡ºèƒ½åŠ› â†’ ç›´æ¥æ‹’ç»ï¼ˆ429ï¼‰</li>
</ul>
<blockquote>
<p><strong>Lua åœ¨ Redis ä¸­æ˜¯ï¼šå•çº¿ç¨‹ã€åŸå­æ‰§è¡Œ</strong></p>
</blockquote>
<h2 id="ç»“åˆ-docker-composeï¼šå®Œæ•´åŠ è½½æµç¨‹"><a href="#ç»“åˆ-docker-composeï¼šå®Œæ•´åŠ è½½æµç¨‹" class="headerlink" title="ç»“åˆ docker-composeï¼šå®Œæ•´åŠ è½½æµç¨‹"></a>ç»“åˆ docker-composeï¼šå®Œæ•´åŠ è½½æµç¨‹</h2><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rate-limit-demo/</span><br><span class="line">â”œâ”€â”€ app.py</span><br><span class="line">â”œâ”€â”€ token_bucket.lua</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â””â”€â”€ docker-compose.yml</span><br></pre></td></tr></table></figure>
<h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"># cat token_bucket.lua</span><br><span class="line">-- token_bucket.lua</span><br><span class="line">local key = KEYS[1]</span><br><span class="line">local rate = tonumber(ARGV[1])</span><br><span class="line">local capacity = tonumber(ARGV[2])</span><br><span class="line">local now = tonumber(ARGV[3])</span><br><span class="line">local requested = tonumber(ARGV[4])</span><br><span class="line"></span><br><span class="line">local data = redis.call(&quot;HMGET&quot;, key, &quot;tokens&quot;, &quot;timestamp&quot;)</span><br><span class="line">local tokens = tonumber(data[1]) or capacity</span><br><span class="line">local last = tonumber(data[2]) or now</span><br><span class="line"></span><br><span class="line">-- ç”Ÿæˆæ–°ä»¤ç‰Œ</span><br><span class="line">local delta = math.max(0, now - last)</span><br><span class="line">tokens = math.min(capacity, tokens + delta * rate)</span><br><span class="line"></span><br><span class="line">if tokens &lt; requested then</span><br><span class="line">    redis.call(&quot;HMSET&quot;, key, &quot;tokens&quot;, tokens, &quot;timestamp&quot;, now)</span><br><span class="line">    return 0</span><br><span class="line">else</span><br><span class="line">    tokens = tokens - requested</span><br><span class="line">    redis.call(&quot;HMSET&quot;, key, &quot;tokens&quot;, tokens, &quot;timestamp&quot;, now)</span><br><span class="line">    return 1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># cat app.py</span><br><span class="line">from fastapi import FastAPI, Request, HTTPException</span><br><span class="line">import redis</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=&quot;redis&quot;, port=6379, decode_responses=True)</span><br><span class="line"></span><br><span class="line">with open(&quot;token_bucket.lua&quot;) as f:</span><br><span class="line">    LUA_SCRIPT = r.register_script(f.read())</span><br><span class="line"></span><br><span class="line">RATE = 5</span><br><span class="line">CAPACITY = 10</span><br><span class="line"></span><br><span class="line">@app.get(&quot;/api&quot;)</span><br><span class="line">def api(request: Request):</span><br><span class="line">    now = int(time.time())</span><br><span class="line">    allowed = LUA_SCRIPT(</span><br><span class="line">        keys=[&quot;token_bucket:api&quot;],</span><br><span class="line">        args=[RATE, CAPACITY, now, 1]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    if allowed == 0:</span><br><span class="line">        raise HTTPException(status_code=429, detail=&quot;Too Many Requests&quot;)</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;msg&quot;: &quot;ok&quot;&#125;</span><br><span class="line"></span><br><span class="line"># cat Dockerfile</span><br><span class="line">FROM docker.io/python:3.12.9</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY app.py token_bucket.lua ./</span><br><span class="line">RUN pip install fastapi uvicorn redis</span><br><span class="line"></span><br><span class="line">CMD [&quot;uvicorn&quot;, &quot;app:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]</span><br><span class="line"></span><br><span class="line"># cat docker-compose.yml</span><br><span class="line">services:</span><br><span class="line">  api:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: docker.io/redis:7.4.7</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="å¯åŠ¨é¡ºåº"><a href="#å¯åŠ¨é¡ºåº" class="headerlink" title="å¯åŠ¨é¡ºåº"></a>å¯åŠ¨é¡ºåº</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br><span class="line">   â†“</span><br><span class="line">redis å®¹å™¨å¯åŠ¨</span><br><span class="line">   â†“</span><br><span class="line">api å®¹å™¨å¯åŠ¨</span><br><span class="line">   â†“</span><br><span class="line">Python import app.py</span><br><span class="line">   â†“</span><br><span class="line">è¯»å– token_bucket.lua</span><br><span class="line">   â†“</span><br><span class="line">SCRIPT LOAD åˆ° Redis</span><br><span class="line">   â†“</span><br><span class="line">è¿”å› SHA1</span><br><span class="line">   â†“</span><br><span class="line">åç»­è¯·æ±‚ â†’ EVALSHA</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å¯åŠ¨åŠéªŒè¯å‘½ä»¤"><a href="#å¯åŠ¨åŠéªŒè¯å‘½ä»¤" class="headerlink" title="å¯åŠ¨åŠéªŒè¯å‘½ä»¤"></a>å¯åŠ¨åŠéªŒè¯å‘½ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#start</span><br><span class="line">docker compose up --build</span><br><span class="line"></span><br><span class="line">#è§‚å¯Ÿtokenå˜åŒ–</span><br><span class="line">while true; do   curl http://localhost:8000/api;  sleep 0.1; done</span><br><span class="line"></span><br><span class="line">#åœ¨å®¿ä¸»æœºä¸Šè§‚æµ‹</span><br><span class="line">#è£…å®¢æˆ·ç«¯ï¼šyum install -y redis</span><br><span class="line">watch -n 0.1 &quot;redis-cli HGETALL token_bucket:api&quot;</span><br><span class="line"></span><br><span class="line">#æ›¿ä»£abçš„å‹æµ‹æ–¹æ¡ˆ</span><br><span class="line">hey -n 100 -c 5 -q 5 http://localhost:8000/api</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/linux%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/linux%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88/" class="post-title-link" itemprop="url">linuxå†…æ ¸åè®®æ ˆ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-27 17:34:36 / ä¿®æ”¹æ—¶é—´ï¼š17:48:59" itemprop="dateCreated datePublished" datetime="2026-01-27T17:34:36+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="åè®®æ ˆ"><a href="#åè®®æ ˆ" class="headerlink" title="åè®®æ ˆ"></a>åè®®æ ˆ</h2><p><img src="https://raw.githubusercontent.com/shispring/picgo/master/Network-API-and-data-flow-within-Linux-kernel-1.png" alt="linux-kernel-network" title="linux kernel network"></p>
<hr>
<h2 id="ğŸ§ -ä¸»çº¿å£è¯€"><a href="#ğŸ§ -ä¸»çº¿å£è¯€" class="headerlink" title="ğŸ§  ä¸»çº¿å£è¯€"></a>ğŸ§  ä¸»çº¿å£è¯€</h2><h3 id="â‘ -ç¬¬ä¸€æ¡ä¸»çº¿ï¼šæ•°æ®æ–¹å‘ï¼ˆæœ€é‡è¦ï¼‰"><a href="#â‘ -ç¬¬ä¸€æ¡ä¸»çº¿ï¼šæ•°æ®æ–¹å‘ï¼ˆæœ€é‡è¦ï¼‰" class="headerlink" title="â‘  ç¬¬ä¸€æ¡ä¸»çº¿ï¼šæ•°æ®æ–¹å‘ï¼ˆæœ€é‡è¦ï¼‰"></a>â‘  ç¬¬ä¸€æ¡ä¸»çº¿ï¼šæ•°æ®æ–¹å‘ï¼ˆæœ€é‡è¦ï¼‰</h3><p>åªä¿ç•™ 90% æ­£å¸¸æµé‡ä¼šç»è¿‡çš„è·¯å¾„,å¿½ç•¥å¼‚å¸¸ã€é‡ä¼ ã€è¾¹è§’çŠ¶æ€æœº</p>
<p>TXï¼šç”¨æˆ· â†’ TCP â†’ IP â†’ è®¾å¤‡ â†’ ç½‘å¡<br>RXï¼šç½‘å¡ â†’ IP â†’ TCP â†’ Socket â†’ ç”¨æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·æ€</span><br><span class="line"> â†“</span><br><span class="line">ç³»ç»Ÿè°ƒç”¨</span><br><span class="line"> â†“</span><br><span class="line">åè®®æ ˆï¼ˆL4 â†’ L3 â†’ L2ï¼‰</span><br><span class="line"> â†“</span><br><span class="line">é©±åŠ¨</span><br><span class="line"> â†“</span><br><span class="line">ç½‘å¡</span><br></pre></td></tr></table></figure>

<h4 id="å‘é€è·¯å¾„ï¼ˆå·¦åŠè¾¹ä¸ºä¸»ï¼‰"><a href="#å‘é€è·¯å¾„ï¼ˆå·¦åŠè¾¹ä¸ºä¸»ï¼‰" class="headerlink" title="å‘é€è·¯å¾„ï¼ˆå·¦åŠè¾¹ä¸ºä¸»ï¼‰"></a><strong>å‘é€è·¯å¾„ï¼ˆå·¦åŠè¾¹ä¸ºä¸»ï¼‰</strong></h4><ul>
<li>write &#x2F; send &#x2F; sendmsg</li>
<li>tcp_sendmsg</li>
<li>tcp_push_one</li>
<li>ip_output</li>
<li>dev_queue_xmit</li>
<li>driver â†’ NIC</li>
</ul>
<h4 id="æ¥æ”¶è·¯å¾„ï¼ˆå³åŠè¾¹ä¸ºä¸»ï¼‰"><a href="#æ¥æ”¶è·¯å¾„ï¼ˆå³åŠè¾¹ä¸ºä¸»ï¼‰" class="headerlink" title="æ¥æ”¶è·¯å¾„ï¼ˆå³åŠè¾¹ä¸ºä¸»ï¼‰"></a><strong>æ¥æ”¶è·¯å¾„ï¼ˆå³åŠè¾¹ä¸ºä¸»ï¼‰</strong></h4><ul>
<li>NIC ä¸­æ–­</li>
<li>NAPI poll</li>
<li>netif_receive_skb</li>
<li>ip_rcv</li>
<li>tcp_v4_rcv</li>
<li>sock_recvmsg &#x2F; read</li>
</ul>
<h3 id="ç¬¬äºŒæ¡ä¸»çº¿ï¼šæ§åˆ¶é¢-vs-æ•°æ®é¢"><a href="#ç¬¬äºŒæ¡ä¸»çº¿ï¼šæ§åˆ¶é¢-vs-æ•°æ®é¢" class="headerlink" title="ç¬¬äºŒæ¡ä¸»çº¿ï¼šæ§åˆ¶é¢ vs æ•°æ®é¢"></a>ç¬¬äºŒæ¡ä¸»çº¿ï¼šæ§åˆ¶é¢ vs æ•°æ®é¢</h3><p>å›¾ä¸­æ··æ‚äº†ä¸¤ç±»ä¸œè¥¿ï¼Œä½ è¦å¼ºè¡ŒæŠŠå®ƒä»¬åˆ†å¼€ï¼š</p>
<h4 id="ğŸŸ¨-æ•°æ®é¢ï¼ˆä½ -80-å…³æ³¨çš„ï¼‰"><a href="#ğŸŸ¨-æ•°æ®é¢ï¼ˆä½ -80-å…³æ³¨çš„ï¼‰" class="headerlink" title="ğŸŸ¨ æ•°æ®é¢ï¼ˆä½  80% å…³æ³¨çš„ï¼‰"></a>ğŸŸ¨ æ•°æ®é¢ï¼ˆä½  80% å…³æ³¨çš„ï¼‰</h4><ul>
<li>skbï¼ˆsk_buffï¼‰</li>
<li>é˜Ÿåˆ—ï¼ˆqueueï¼‰</li>
<li>copy &#x2F; zero-copy</li>
<li>push &#x2F; pull</li>
</ul>
<p>å…³é”®è¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">skb</span><br><span class="line">queue</span><br><span class="line">xmit</span><br><span class="line">rcv</span><br><span class="line">copy</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="ğŸŸ¥-æ§åˆ¶é¢ï¼ˆæš‚æ—¶åªè¯†åˆ«ï¼Œä¸æ·±æŒ–ï¼‰"><a href="#ğŸŸ¥-æ§åˆ¶é¢ï¼ˆæš‚æ—¶åªè¯†åˆ«ï¼Œä¸æ·±æŒ–ï¼‰" class="headerlink" title="ğŸŸ¥ æ§åˆ¶é¢ï¼ˆæš‚æ—¶åªè¯†åˆ«ï¼Œä¸æ·±æŒ–ï¼‰"></a>ğŸŸ¥ æ§åˆ¶é¢ï¼ˆæš‚æ—¶åªè¯†åˆ«ï¼Œä¸æ·±æŒ–ï¼‰</h4><ul>
<li>socket çŠ¶æ€æœº</li>
<li>TCP çŠ¶æ€ï¼ˆESTABLISHED &#x2F; TIME_WAITï¼‰</li>
<li>ACK &#x2F; é‡ä¼  &#x2F; å®šæ—¶å™¨</li>
</ul>
<p>å…³é”®è¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state</span><br><span class="line">timer</span><br><span class="line">ack</span><br><span class="line">retrans</span><br></pre></td></tr></table></figure>

<p>äºŒã€å·¥ç¨‹ä¸Šè¯¥å…³å¿ƒä»€ä¹ˆ</p>
<p>â‘  User &#x2F; Syscall å±‚</p>
<p>ä½ å…³å¿ƒä»€ä¹ˆï¼š<br>  â€¢ åº”ç”¨æ˜¯å¦é˜»å¡ï¼Ÿ<br>  â€¢ write&#x2F;send æ˜¯ä¸æ˜¯æ…¢ï¼Ÿ<br>  â€¢ æ˜¯å¦é¢‘ç¹ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</p>
<p>å¸¸è§é—®é¢˜ï¼š<br>  â€¢ å°åŒ… writeï¼ˆsyscall è¿‡å¤šï¼‰<br>  â€¢ æœªå¼€å¯ sendfile &#x2F; splice</p>
<p>â¸»</p>
<p>â‘¡ TCP å±‚ï¼ˆtcp_sendmsg &#x2F; tcp_v4_rcvï¼‰</p>
<p>ä½ å…³å¿ƒä»€ä¹ˆï¼š<br>  â€¢ é˜Ÿåˆ—æ˜¯å¦æ»¡ï¼Ÿ<br>  â€¢ æ˜¯å¦åœ¨é‡ä¼ ï¼Ÿ<br>  â€¢ å»¶è¿Ÿæ˜¯å¦åœ¨ TCP å†…éƒ¨ï¼Ÿ</p>
<p>æŒ‡æ ‡ &#x2F; å·¥å…·ï¼š</p>
<p>ss -ti<br>netstat -s</p>
<p>â¸»</p>
<p>â‘¢ IP å±‚ï¼ˆip_output &#x2F; ip_rcvï¼‰</p>
<p>ä½ å…³å¿ƒä»€ä¹ˆï¼š<br>  â€¢ è·¯ç”±æ˜¯å¦æ­£ç¡®ï¼Ÿ<br>  â€¢ æ˜¯å¦è¢« netfilter &#x2F; iptables æ‹–æ…¢ï¼Ÿ<br>  â€¢ MTU &#x2F; åˆ†ç‰‡é—®é¢˜ï¼Ÿ</p>
<p>å…¸å‹åœºæ™¯ï¼š<br>  â€¢ kube-proxy iptables æ¨¡å¼<br>  â€¢ å¤§é‡è§„åˆ™å¯¼è‡´ ip_rcv æ…¢</p>
<p>â¸»</p>
<p>â‘£ Qdisc &#x2F; dev_queue_xmitï¼ˆæ€§èƒ½é«˜å‘åŒºï¼‰</p>
<p>è¿™æ˜¯å·¥ç¨‹äº‹æ•…é«˜å‘åŒº</p>
<p>ä½ å…³å¿ƒï¼š<br>  â€¢ é˜Ÿåˆ—æ˜¯å¦å †ç§¯ï¼Ÿ<br>  â€¢ qdisc æ˜¯å¦æˆä¸ºç“¶é¢ˆï¼Ÿ<br>  â€¢ ç½‘å¡ TX æ˜¯å¦ backpressureï¼Ÿ</p>
<p>å·¥å…·ï¼š</p>
<p>tc -s qdisc</p>
<p>â¸»</p>
<p>â‘¤ NAPI &#x2F; softirqï¼ˆRX æ€§èƒ½å…³é”®ï¼‰</p>
<p>è¿™æ˜¯ RX ä¾§æœ€é‡è¦çš„åœ°æ–¹</p>
<p>ä½ å…³å¿ƒï¼š<br>  â€¢ softirq æ˜¯å¦æ‰“æ»¡ CPUï¼Ÿ<br>  â€¢ backlog æ˜¯å¦ä¸¢åŒ…ï¼Ÿ<br>  â€¢ æ˜¯å¦è¿›å…¥ ksoftirqdï¼Ÿ</p>
<p>å·¥å…·ï¼š</p>
<p>cat &#x2F;proc&#x2F;net&#x2F;softnet_stat<br>top<br>perf top</p>
<p>ä¸‰ã€å·¥ç¨‹çº§ã€Œæ€ä¹ˆç”¨è¿™å¼ å›¾ã€</p>
<p>åœºæ™¯ 1ï¼šQPS ä¸Šä¸å»ï¼Œä½† CPU å¾ˆé«˜</p>
<p>ç›´æ¥å¥—è·¯å¾„ï¼š</p>
<p>RX â†’ NAPI â†’ netif_receive_skb â†’ tcp_v4_rcv</p>
<p>ä¼˜å…ˆçœ‹ï¼š<br>  â€¢ softirq<br>  â€¢ backlog<br>  â€¢ TCP æ¥æ”¶é˜Ÿåˆ—</p>
<p>â¸»</p>
<p>åœºæ™¯ 2ï¼šå»¶è¿Ÿé«˜ï¼Œä½†æ²¡æœ‰ä¸¢åŒ…</p>
<p>ä¼˜å…ˆæ€€ç–‘ï¼š</p>
<p>TCP â†’ é˜Ÿåˆ— â†’ è°ƒåº¦</p>
<p>æ’æŸ¥ï¼š<br>  â€¢ TCP send&#x2F;recv queue<br>  â€¢ Nagle &#x2F; delayed ACK<br>  â€¢ cgroup CPU é™åˆ¶</p>
<p>â¸»</p>
<p>åœºæ™¯ 3ï¼šIngress &#x2F; Service æ€§èƒ½å¼‚å¸¸</p>
<p>è·¯å¾„æ˜ å°„ï¼š</p>
<p>NIC<br>â†’ Linux RX<br>â†’ iptables &#x2F; conntrack<br>â†’ Pod veth<br>â†’ å®¹å™¨ TCP</p>
<p>é‡ç‚¹ï¼š<br>  â€¢ netfilter<br>  â€¢ conntrack<br>  â€¢ veth + qdisc</p>
<p>â¸»</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/ip%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/ip%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4/" class="post-title-link" itemprop="url">Linuxç½‘ç»œç»Ÿè®¡ã€æ€§èƒ½å·¥å…·/å‘½ä»¤</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-27 15:53:50 / ä¿®æ”¹æ—¶é—´ï¼š16:21:41" itemprop="dateCreated datePublished" datetime="2026-01-27T15:53:50+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç½‘ç»œç»Ÿè®¡"><a href="#ç½‘ç»œç»Ÿè®¡" class="headerlink" title="ç½‘ç»œç»Ÿè®¡"></a>ç½‘ç»œç»Ÿè®¡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iproute2 ç”¨æ³•</span><br><span class="line"># åˆ—å‡ºæ‰€æœ‰ veth è®¾å¤‡</span><br><span class="line">ip -c link show type veth</span><br><span class="line"># åˆ—å‡ºæ‰€æœ‰ tunnel è®¾å¤‡</span><br><span class="line">ip tunnel show</span><br></pre></td></tr></table></figure>
<h2 id="ç½‘ç»œç»Ÿè®¡å·¥å…·"><a href="#ç½‘ç»œç»Ÿè®¡å·¥å…·" class="headerlink" title="ç½‘ç»œç»Ÿè®¡å·¥å…·"></a>ç½‘ç»œç»Ÿè®¡å·¥å…·</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">nstat å‘½ä»¤ï¼šç½‘ç»œç»Ÿè®¡å·¥å…·</span><br><span class="line"># nstat</span><br><span class="line"></span><br><span class="line">ss å‘½ä»¤ï¼šç”¨äºè°ƒæŸ¥å¥—æ¥å­—çš„å®ç”¨ç¨‹åº</span><br><span class="line"># ss -s</span><br><span class="line"></span><br><span class="line">netstat å‘½ä»¤ï¼šæ˜¾ç¤ºå¥—æ¥å­—çš„ç»å…¸å®ç”¨å·¥å…·</span><br><span class="line"># netstat -i</span><br><span class="line"></span><br><span class="line"># netstat -s</span><br><span class="line"></span><br><span class="line">ip/ifconfig å‘½ä»¤ï¼šé…ç½®æˆ–æ˜¾ç¤ºç½‘ç»œæ¥å£ä¿¡æ¯</span><br><span class="line"># ifconfig</span><br><span class="line"></span><br><span class="line"># ifconfig eth0</span><br><span class="line"></span><br><span class="line">è¦æ˜¾ç¤ºç½‘ç»œæ¥å£ç»Ÿè®¡ä¿¡æ¯</span><br><span class="line"># ip -c -s link</span><br><span class="line"></span><br><span class="line">sar å‘½ä»¤ï¼šæ˜¾ç¤ºç½‘ç»œç»Ÿè®¡ä¿¡æ¯</span><br><span class="line"># sar -n DEV 1</span><br><span class="line"></span><br><span class="line">æ¯ç§’1æ¬¡ï¼Œç»Ÿè®¡ä¸‰æ¬¡</span><br><span class="line"># sar -n DEV 1 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ dropwatchï¼ˆKernel dropped packet monitorï¼‰ å¯ä»¥ç›‘æµ‹å†…æ ¸ä¸¢åŒ…ä¿¡æ¯ ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç„¶åè¾“å…¥ start</span><br><span class="line"># dropwatch -l kas</span><br><span class="line">Initalizing kallsyms db</span><br><span class="line">dropwatch&gt; start    </span><br><span class="line">xxx</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ç½‘ç»œæ€§èƒ½æµ‹è¯•"><a href="#ç½‘ç»œæ€§èƒ½æµ‹è¯•" class="headerlink" title="ç½‘ç»œæ€§èƒ½æµ‹è¯•"></a>ç½‘ç»œæ€§èƒ½æµ‹è¯•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨ iperf3 è¿›è¡Œæ€§èƒ½æµ‹è¯•</span><br><span class="line"># å¯åŠ¨æœåŠ¡ç«¯ -s æ„æ€æ˜¯æœåŠ¡ç«¯</span><br><span class="line">iperf3 -s </span><br><span class="line"># åå°è¿›ç¨‹æ–¹å¼å¯åŠ¨æœåŠ¡ç«¯ï¼Œ-D æ„æ€æ˜¯ Daemon è¿›ç¨‹å¯åŠ¨</span><br><span class="line">iperf3 -s -D</span><br><span class="line"># åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ TCP æµ‹è¯•ï¼Œ -c æŒ‡çš„æ˜¯å®¢æˆ·ç«¯ï¼Œ-b ç›®æ ‡å¸¦å®½ï¼ˆä¸€èˆ¬ä¸ç½‘å¡å¸¦å®½ç›¸åŒ¹é…ï¼‰ï¼Œ-n å‘é€å­—èŠ‚æ•°</span><br><span class="line">iperf3 -c 10.10.140.95 -b 10000M -n 10G</span><br><span class="line"># æ‰§è¡Œ UDP æµ‹è¯•ï¼Œ-u ä½¿ç”¨ UDP åè®®ï¼Œ-l æŒ‡å®šæ•°æ®åŒ…å¤§å°ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ TCP æˆ– UDP æ•°æ®éƒ¨åˆ†çš„å¤§å°ä¸º 1400</span><br><span class="line"># å®é™…å‘é€æ—¶çš„ MAC å¸§é•¿ä¼šæ˜¯ 1454 ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="line"># 26 ä¸ªå­—èŠ‚çš„ MAC å¸§å¤´ï¼š7 ä¸ªå­—èŠ‚çš„å‰å¯¼ç ï¼Œ1 ä¸ªå­—èŠ‚çš„å¸§èµ·å§‹ç¬¦ï¼Œ6 å­—èŠ‚ç›®çš„ MAC ï¼Œ6 å­—èŠ‚æº MAC ï¼Œ2 å­—èŠ‚å¸§é•¿åº¦ï¼Œä»¥åŠä½äºå¸§æœ«å°¾çš„ 4 å­—èŠ‚ CRC æ ¡éªŒå’Œ</span><br><span class="line"># 20 å­—èŠ‚çš„ IP å¤´éƒ¨</span><br><span class="line"># 8 å­—èŠ‚ UDP å¤´éƒ¨</span><br><span class="line">iperf3 -u -c 10.10.140.95 -b 10000M -n 10G -l1400</span><br><span class="line"># ç”±äº iperf3 åªæ˜¾ç¤ºå¸¦å®½ï¼Œå¯ä»¥å€ŸåŠ© sar æŸ¥çœ‹åŒ…é‡</span><br><span class="line"># sar å·¥å…·åŒ…å«åœ¨ sysstat ä¸­</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ç½‘ç»œæ€§èƒ½è°ƒä¼˜"><a href="#ç½‘ç»œæ€§èƒ½è°ƒä¼˜" class="headerlink" title="ç½‘ç»œæ€§èƒ½è°ƒä¼˜"></a>ç½‘ç»œæ€§èƒ½è°ƒä¼˜</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 1ã€ç½‘å¡æ”¶å‘æ•°æ®å¤„ç†é€Ÿåº¦æˆä¸ºç“¶é¢ˆæ—¶ï¼Œ è®¾ç½® CPU äº²å’Œæ€§ï¼ˆ irqbalance çš„è‡ªåŠ¨è´Ÿè½½å‡è¡¡å¾ˆå¤šæ—¶å€™ä¸å¥½ç”¨ï¼‰ å°†ä¸­æ–­å¤„ç†åˆ†å‘åˆ°ä¸åŒçš„ CPU ä¸Šï¼Œé¿å…é›†ä¸­åœ¨ä¸€ä¸ª CPU ä¸Š</span><br><span class="line"># æ‰¾åˆ°åº•å±‚è®¾å¤‡</span><br><span class="line">readlink -e /sys/class/net/eth0/</span><br><span class="line">/sys/devices/pci0000:17/0000:17:00.0/0000:18:00.0/0000:19:03.0/0000:1a:00.0/net/eth0</span><br><span class="line"></span><br><span class="line">#2ã€å½“ç¼“å†²åŒºå¤§å°æˆä¸ºç“¶é¢ˆæ—¶ï¼Œå¯è°ƒæ•´å†…æ ¸å‚æ•°è¿›è¡Œä¼˜åŒ–</span><br><span class="line"># è¯¥å‚æ•°å†³å®šäº†ï¼Œç½‘ç»œè®¾å¤‡æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚</span><br><span class="line">net.core.netdev_max_backlog = 400000</span><br><span class="line"># è¯¥å‚æ•°æŒ‡å®šäº†æ¯ä¸ªå¥—æ¥å­—æ‰€å…è®¸çš„æœ€å¤§ç¼“å†²åŒºçš„å¤§å°</span><br><span class="line">net.core.optmem_max = 10000000</span><br><span class="line"># æŒ‡å®šäº†æ¥æ”¶å¥—æ¥å­—ç¼“å†²åŒºå¤§å°çš„ç¼ºçœå€¼ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span><br><span class="line">net.core.rmem_default = 16777216</span><br><span class="line"># æŒ‡å®šäº†æ¥æ”¶å¥—æ¥å­—ç¼“å†²åŒºå¤§å°çš„æœ€å¤§å€¼ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line"># è¡¨ç¤ºsocketç›‘å¬çš„backlog(ç›‘å¬é˜Ÿåˆ—)ä¸Šé™</span><br><span class="line">net.core.somaxconn = 100000</span><br><span class="line"># å®šä¹‰é»˜è®¤çš„å‘é€çª—å£å¤§å°</span><br><span class="line">net.core.wmem_default = 16777216</span><br><span class="line"># å®šä¹‰å‘é€çª—å£çš„æœ€å¤§å¤§å°</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line"># ç¡®å®š TCP æ ˆåº”è¯¥å¦‚ä½•åæ˜ å†…å­˜ä½¿ç”¨ï¼›æ¯ä¸ªå€¼çš„å•ä½éƒ½æ˜¯å†…å­˜é¡µï¼ˆé€šå¸¸æ˜¯ 4KBï¼‰ã€‚</span><br><span class="line"># ç¬¬ä¸€ä¸ªå€¼æ˜¯å†…å­˜ä½¿ç”¨çš„ä¸‹é™ã€‚</span><br><span class="line"># ç¬¬äºŒä¸ªå€¼æ˜¯å†…å­˜å‹åŠ›æ¨¡å¼å¼€å§‹å¯¹ç¼“å†²åŒºä½¿ç”¨åº”ç”¨å‹åŠ›çš„ä¸Šé™ã€‚</span><br><span class="line"># ç¬¬ä¸‰ä¸ªå€¼æ˜¯å†…å­˜ä¸Šé™ã€‚åœ¨è¿™ä¸ªå±‚æ¬¡ä¸Šå¯ä»¥å°†æŠ¥æ–‡ä¸¢å¼ƒï¼Œä»è€Œå‡å°‘å¯¹å†…å­˜çš„ä½¿ç”¨ã€‚</span><br><span class="line">net.ipv4.tcp_mem=91650	122203	183300</span><br><span class="line"># ä¸ºè‡ªåŠ¨è°ƒä¼˜å®šä¹‰æ¯ä¸ª socket ä½¿ç”¨çš„å†…å­˜ã€‚</span><br><span class="line"># ç¬¬ä¸€ä¸ªå€¼æ˜¯ä¸º socket çš„å‘é€ç¼“å†²åŒºåˆ†é…çš„æœ€å°‘å­—èŠ‚æ•°ã€‚</span><br><span class="line"># ç¬¬äºŒä¸ªå€¼æ˜¯é»˜è®¤å€¼ï¼ˆè¯¥å€¼ä¼šè¢« wmem_default è¦†ç›–ï¼‰ï¼Œç¼“å†²åŒºåœ¨ç³»ç»Ÿè´Ÿè½½ä¸é‡çš„æƒ…å†µä¸‹å¯ä»¥å¢é•¿åˆ°è¿™ä¸ªå€¼ã€‚</span><br><span class="line"># ç¬¬ä¸‰ä¸ªå€¼æ˜¯å‘é€ç¼“å†²åŒºç©ºé—´çš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆè¯¥å€¼ä¼šè¢« wmem_max è¦†ç›–ï¼‰ã€‚</span><br><span class="line">net.ipv4.tcp_wmem=4096 16384 16777216</span><br><span class="line">net.ipv4.tcp_rmem=4096 131072 16777216</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ç½‘ç»œæ ˆçš„ç›‘æ§"><a href="#ç½‘ç»œæ ˆçš„ç›‘æ§" class="headerlink" title="ç½‘ç»œæ ˆçš„ç›‘æ§"></a>ç½‘ç»œæ ˆçš„ç›‘æ§</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/monitoring-network-stack/">https://arthurchiao.art/blog/monitoring-network-stack/</a></p>
</blockquote>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.xiayinchang.top/post/cf4d6f51.html">https://www.xiayinchang.top/post/cf4d6f51.html</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/%E8%B7%AF%E7%94%B1Demo%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/%E8%B7%AF%E7%94%B1Demo%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">è·¯ç”±Demoè§£æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-27 15:34:10 / ä¿®æ”¹æ—¶é—´ï¼š15:38:43" itemprop="dateCreated datePublished" datetime="2026-01-27T15:34:10+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="æ—¶åºæµç¨‹å›¾ï¼ˆMermaidï¼‰"><a href="#æ—¶åºæµç¨‹å›¾ï¼ˆMermaidï¼‰" class="headerlink" title="æ—¶åºæµç¨‹å›¾ï¼ˆMermaidï¼‰"></a>æ—¶åºæµç¨‹å›¾ï¼ˆMermaidï¼‰</h2><p><img src="https://raw.githubusercontent.com/shispring/picgo/master/route-case.png" alt="route-demo" title="route demo"></p>
<hr>
<h2 id="ä¸€ã€â€œæ€»çº²å¼ç»“è®ºâ€"><a href="#ä¸€ã€â€œæ€»çº²å¼ç»“è®ºâ€" class="headerlink" title="ä¸€ã€â€œæ€»çº²å¼ç»“è®ºâ€"></a>ä¸€ã€â€œæ€»çº²å¼ç»“è®ºâ€</h2><blockquote>
<p><strong>è·¨ä¸‰å±‚é€šä¿¡çš„æœ¬è´¨æ˜¯ï¼š</strong></p>
<ul>
<li><strong>IP åœ°å€ï¼šç«¯åˆ°ç«¯ä¸å˜ï¼ˆé€»è¾‘å¯»å€ï¼‰</strong></li>
<li><strong>MAC åœ°å€ï¼šé€è·³æ”¹å˜ï¼ˆç‰©ç†è½¬å‘ï¼‰</strong></li>
<li><strong>ARPï¼šåªè§£å†³â€œä¸‹ä¸€è·³æ˜¯è°â€ï¼Œè€Œä¸æ˜¯â€œæœ€ç»ˆæ˜¯è°â€</strong></li>
</ul>
</blockquote>
<hr>
<h2 id="äºŒã€æ‹“æ‰‘ä¸è§’è‰²æ˜ç¡®"><a href="#äºŒã€æ‹“æ‰‘ä¸è§’è‰²æ˜ç¡®" class="headerlink" title="äºŒã€æ‹“æ‰‘ä¸è§’è‰²æ˜ç¡®"></a>äºŒã€æ‹“æ‰‘ä¸è§’è‰²æ˜ç¡®</h2><p>æ‹“æ‰‘å¦‚ä¸‹ï¼ˆä½ ç»™çš„ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Host1 â€” Router A â€” Router B â€” Router C â€” Host2</span><br></pre></td></tr></table></figure>

<ul>
<li>Host1 çš„é»˜è®¤ç½‘å…³ï¼šRouter A</li>
<li>Host2 ç›´è¿åœ¨ Router C çš„ LAN ä¸Š</li>
<li>è·¯ç”±å™¨ä¹‹é—´éƒ½æ˜¯ä¸‰å±‚è½¬å‘</li>
<li>ç»ˆç«¯å’Œè·¯ç”±å™¨ä¹‹é—´æ˜¯äºŒå±‚é€šä¿¡</li>
</ul>
<hr>
<h2 id="ä¸‰ã€å®Œæ•´è·¯ç”±è¿‡ç¨‹ï¼ˆæŒ‰æ­¥éª¤æ‹†è§£ï¼‰"><a href="#ä¸‰ã€å®Œæ•´è·¯ç”±è¿‡ç¨‹ï¼ˆæŒ‰æ­¥éª¤æ‹†è§£ï¼‰" class="headerlink" title="ä¸‰ã€å®Œæ•´è·¯ç”±è¿‡ç¨‹ï¼ˆæŒ‰æ­¥éª¤æ‹†è§£ï¼‰"></a>ä¸‰ã€å®Œæ•´è·¯ç”±è¿‡ç¨‹ï¼ˆæŒ‰æ­¥éª¤æ‹†è§£ï¼‰</h2><h3 id="é˜¶æ®µ-1ï¼šHost1-å†³å®šâ€œæˆ‘è¯¥æŠŠåŒ…äº¤ç»™è°â€"><a href="#é˜¶æ®µ-1ï¼šHost1-å†³å®šâ€œæˆ‘è¯¥æŠŠåŒ…äº¤ç»™è°â€" class="headerlink" title="é˜¶æ®µ 1ï¼šHost1 å†³å®šâ€œæˆ‘è¯¥æŠŠåŒ…äº¤ç»™è°â€"></a><strong>é˜¶æ®µ 1ï¼šHost1 å†³å®šâ€œæˆ‘è¯¥æŠŠåŒ…äº¤ç»™è°â€</strong></h3><h4 id="Step-1ï¼šHost1-åˆ¤æ–­ç›®çš„-IP-æ˜¯å¦æœ¬åœ°"><a href="#Step-1ï¼šHost1-åˆ¤æ–­ç›®çš„-IP-æ˜¯å¦æœ¬åœ°" class="headerlink" title="Step 1ï¼šHost1 åˆ¤æ–­ç›®çš„ IP æ˜¯å¦æœ¬åœ°"></a>Step 1ï¼šHost1 åˆ¤æ–­ç›®çš„ IP æ˜¯å¦æœ¬åœ°</h4><ul>
<li><p>Host1 æ‹¿åˆ° <strong>Host2 çš„ IP</strong></p>
</li>
<li><p>ç”¨è‡ªå·±çš„ï¼š</p>
<ul>
<li>IP</li>
<li>å­ç½‘æ©ç </li>
</ul>
</li>
<li><p>è®¡ç®—åå‘ç°ï¼š<br><strong>Host2 ä¸åœ¨æœ¬åœ°å­ç½‘</strong></p>
</li>
</ul>
<p>ğŸ‘‰ ç»“è®ºï¼š<strong>å¿…é¡»äº¤ç»™é»˜è®¤ç½‘å…³ï¼ˆRouter Aï¼‰</strong></p>
<hr>
<h4 id="Step-2ï¼šHost1-é€šè¿‡-ARP-æ‰¾é»˜è®¤ç½‘å…³çš„-MAC"><a href="#Step-2ï¼šHost1-é€šè¿‡-ARP-æ‰¾é»˜è®¤ç½‘å…³çš„-MAC" class="headerlink" title="Step 2ï¼šHost1 é€šè¿‡ ARP æ‰¾é»˜è®¤ç½‘å…³çš„ MAC"></a>Step 2ï¼šHost1 é€šè¿‡ ARP æ‰¾é»˜è®¤ç½‘å…³çš„ MAC</h4><ul>
<li><p>æŸ¥çœ‹ ARP è¡¨ï¼š</p>
<ul>
<li>æœ‰ Router A MAC â†’ ç›´æ¥ç”¨</li>
<li>æ²¡æœ‰ â†’ ARP Broadcast</li>
</ul>
</li>
<li><p>å¾—åˆ°ï¼š</p>
<ul>
<li>Router Aï¼ˆLAN å£ï¼‰çš„ MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-3ï¼šHost1-å°è£…ç¬¬ä¸€ä¸ªä»¥å¤ªç½‘å¸§"><a href="#Step-3ï¼šHost1-å°è£…ç¬¬ä¸€ä¸ªä»¥å¤ªç½‘å¸§" class="headerlink" title="Step 3ï¼šHost1 å°è£…ç¬¬ä¸€ä¸ªä»¥å¤ªç½‘å¸§"></a>Step 3ï¼šHost1 å°è£…ç¬¬ä¸€ä¸ªä»¥å¤ªç½‘å¸§</h4><p>æ­¤æ—¶æ•°æ®åŒ…çŠ¶æ€æ˜¯ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Host1 MAC</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router Aï¼ˆLAN å£ï¼‰MAC</td>
</tr>
</tbody></table>
<p>ğŸ‘‰ <strong>å…³é”®ç‚¹</strong>ï¼š<br>Host1 <strong>ä¸çŸ¥é“ Router B &#x2F; C &#x2F; Host2 çš„ MAC</strong>ï¼Œä¹Ÿä¸éœ€è¦çŸ¥é“ã€‚</p>
<hr>
<h3 id="é˜¶æ®µ-2ï¼šRouter-A-â†’-Router-B"><a href="#é˜¶æ®µ-2ï¼šRouter-A-â†’-Router-B" class="headerlink" title="é˜¶æ®µ 2ï¼šRouter A â†’ Router B"></a><strong>é˜¶æ®µ 2ï¼šRouter A â†’ Router B</strong></h3><h4 id="Step-4ï¼šRouter-A-æ”¶åˆ°å¸§ï¼ˆL2-â†’-L3ï¼‰"><a href="#Step-4ï¼šRouter-A-æ”¶åˆ°å¸§ï¼ˆL2-â†’-L3ï¼‰" class="headerlink" title="Step 4ï¼šRouter A æ”¶åˆ°å¸§ï¼ˆL2 â†’ L3ï¼‰"></a>Step 4ï¼šRouter A æ”¶åˆ°å¸§ï¼ˆL2 â†’ L3ï¼‰</h4><p>Router A åšä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li><p>çœ‹ <strong>ç›®çš„ MAC</strong> â†’ æ˜¯è‡ªå·± â†’ æ”¶åŒ…</p>
</li>
<li><p>å‰¥æ‰äºŒå±‚å¤´ï¼Œæ£€æŸ¥ <strong>ç›®çš„ IP</strong></p>
</li>
<li><p>æŸ¥è·¯ç”±è¡¨ï¼š</p>
<ul>
<li>Host2 ä¸ç›´è¿</li>
<li>æ‰¾åˆ°ä¸‹ä¸€è·³ï¼š<strong>Router B</strong></li>
</ul>
</li>
</ol>
<hr>
<h4 id="Step-5ï¼šRouter-A-é€šè¿‡-ARP-æ‰¾-Router-B-çš„-MAC"><a href="#Step-5ï¼šRouter-A-é€šè¿‡-ARP-æ‰¾-Router-B-çš„-MAC" class="headerlink" title="Step 5ï¼šRouter A é€šè¿‡ ARP æ‰¾ Router B çš„ MAC"></a>Step 5ï¼šRouter A é€šè¿‡ ARP æ‰¾ Router B çš„ MAC</h4><ul>
<li><p>ARP æŸ¥è¯¢ï¼š</p>
<ul>
<li>IPï¼šRouter Bï¼ˆA-B é“¾è·¯ä¸Šçš„ IPï¼‰</li>
<li>å¾—åˆ° Router B æ¥å£ MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-6ï¼šRouter-A-é‡æ–°å°è£…å¸§å¹¶è½¬å‘"><a href="#Step-6ï¼šRouter-A-é‡æ–°å°è£…å¸§å¹¶è½¬å‘" class="headerlink" title="Step 6ï¼šRouter A é‡æ–°å°è£…å¸§å¹¶è½¬å‘"></a>Step 6ï¼šRouter A é‡æ–°å°è£…å¸§å¹¶è½¬å‘</h4><p>æ–°çš„å¸§ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router Aï¼ˆå‘å¾€ B çš„æ¥å£ MACï¼‰</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router Bï¼ˆé¢å‘ A çš„æ¥å£ MACï¼‰</td>
</tr>
</tbody></table>
<p>ğŸ‘‰ <strong>IP æ²¡å˜ï¼ŒMAC æ¢äº†</strong></p>
<hr>
<h3 id="é˜¶æ®µ-3ï¼šRouter-B-â†’-Router-Cï¼ˆåŒç†ï¼‰"><a href="#é˜¶æ®µ-3ï¼šRouter-B-â†’-Router-Cï¼ˆåŒç†ï¼‰" class="headerlink" title="é˜¶æ®µ 3ï¼šRouter B â†’ Router Cï¼ˆåŒç†ï¼‰"></a><strong>é˜¶æ®µ 3ï¼šRouter B â†’ Router Cï¼ˆåŒç†ï¼‰</strong></h3><p>Router B åšçš„äº‹æƒ…å’Œ Router A <strong>å®Œå…¨ä¸€æ ·</strong>ï¼š</p>
<ol>
<li>æ”¶åˆ°å¸§ï¼ˆMAC æ˜¯è‡ªå·±ï¼‰</li>
<li>è§£å°è£…</li>
<li>æŸ¥è·¯ç”±è¡¨</li>
<li>ä¸‹ä¸€è·³æ˜¯ Router C</li>
<li>ARP æ‰¾ Router C MAC</li>
<li>é‡æ–°å°è£…å¹¶è½¬å‘</li>
</ol>
<p>æ–°çš„å¸§ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router Bï¼ˆé¢å‘ C çš„æ¥å£ MACï¼‰</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router Cï¼ˆé¢å‘ B çš„æ¥å£ MACï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3 id="é˜¶æ®µ-4ï¼šRouter-C-â†’-Host2ï¼ˆæœ€åä¸€è·³ï¼‰"><a href="#é˜¶æ®µ-4ï¼šRouter-C-â†’-Host2ï¼ˆæœ€åä¸€è·³ï¼‰" class="headerlink" title="é˜¶æ®µ 4ï¼šRouter C â†’ Host2ï¼ˆæœ€åä¸€è·³ï¼‰"></a><strong>é˜¶æ®µ 4ï¼šRouter C â†’ Host2ï¼ˆæœ€åä¸€è·³ï¼‰</strong></h3><h4 id="Step-7ï¼šRouter-C-å‘ç°ç›®çš„-IP-æ˜¯æœ¬åœ°ç›´è¿"><a href="#Step-7ï¼šRouter-C-å‘ç°ç›®çš„-IP-æ˜¯æœ¬åœ°ç›´è¿" class="headerlink" title="Step 7ï¼šRouter C å‘ç°ç›®çš„ IP æ˜¯æœ¬åœ°ç›´è¿"></a>Step 7ï¼šRouter C å‘ç°ç›®çš„ IP æ˜¯æœ¬åœ°ç›´è¿</h4><ul>
<li><p>æŸ¥è·¯ç”±è¡¨ï¼š</p>
<ul>
<li>Host2 IP åœ¨æœ¬åœ° LAN</li>
</ul>
</li>
<li><p>ä¸å†éœ€è¦â€œä¸‹ä¸€è·³è·¯ç”±å™¨â€</p>
</li>
</ul>
<hr>
<h4 id="Step-8ï¼šRouter-C-ARP-æŸ¥è¯¢-Host2-çš„-MAC"><a href="#Step-8ï¼šRouter-C-ARP-æŸ¥è¯¢-Host2-çš„-MAC" class="headerlink" title="Step 8ï¼šRouter C ARP æŸ¥è¯¢ Host2 çš„ MAC"></a>Step 8ï¼šRouter C ARP æŸ¥è¯¢ Host2 çš„ MAC</h4><ul>
<li><p>ARPï¼š</p>
<ul>
<li>IPï¼šHost2</li>
<li>å¾—åˆ° Host2 MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-9ï¼šRouter-C-å‘é€æœ€ç»ˆå¸§"><a href="#Step-9ï¼šRouter-C-å‘é€æœ€ç»ˆå¸§" class="headerlink" title="Step 9ï¼šRouter C å‘é€æœ€ç»ˆå¸§"></a>Step 9ï¼šRouter C å‘é€æœ€ç»ˆå¸§</h4><p>æœ€ç»ˆå¸§ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router Cï¼ˆLAN å£ MACï¼‰</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Host2 MAC</td>
</tr>
</tbody></table>
<hr>
<h4 id="Step-10ï¼šäº¤æ¢æœºï¼ˆäºŒå±‚ï¼‰è½¬å‘"><a href="#Step-10ï¼šäº¤æ¢æœºï¼ˆäºŒå±‚ï¼‰è½¬å‘" class="headerlink" title="Step 10ï¼šäº¤æ¢æœºï¼ˆäºŒå±‚ï¼‰è½¬å‘"></a>Step 10ï¼šäº¤æ¢æœºï¼ˆäºŒå±‚ï¼‰è½¬å‘</h4><ul>
<li>äº¤æ¢æœºåªçœ‹ <strong>Destination MAC</strong></li>
<li>æŸ¥ MAC è¡¨</li>
<li>å‘ç»™ Host2 æ‰€åœ¨ç«¯å£</li>
</ul>
<p>ğŸ‘‰ Host2 æ”¶åˆ°æ•°æ®ï¼Œ<strong>å»ç¨‹å®Œæˆ</strong></p>
<hr>
<h2 id="å››ã€ä¸€è·¯ä¸Šå“ªäº›ä¸œè¥¿ã€Œä¸€ç›´ä¸å˜ã€ï¼Œå“ªäº›ã€Œä¸€ç›´åœ¨å˜ã€"><a href="#å››ã€ä¸€è·¯ä¸Šå“ªäº›ä¸œè¥¿ã€Œä¸€ç›´ä¸å˜ã€ï¼Œå“ªäº›ã€Œä¸€ç›´åœ¨å˜ã€" class="headerlink" title="å››ã€ä¸€è·¯ä¸Šå“ªäº›ä¸œè¥¿ã€Œä¸€ç›´ä¸å˜ã€ï¼Œå“ªäº›ã€Œä¸€ç›´åœ¨å˜ã€"></a>å››ã€ä¸€è·¯ä¸Šå“ªäº›ä¸œè¥¿ã€Œä¸€ç›´ä¸å˜ã€ï¼Œå“ªäº›ã€Œä¸€ç›´åœ¨å˜ã€</h2><h3 id="âœ…-ä¸€ç›´ä¸å˜çš„"><a href="#âœ…-ä¸€ç›´ä¸å˜çš„" class="headerlink" title="âœ… ä¸€ç›´ä¸å˜çš„"></a>âœ… ä¸€ç›´ä¸å˜çš„</h3><ul>
<li>Source IPï¼šHost1</li>
<li>Destination IPï¼šHost2</li>
</ul>
<h3 id="ğŸ”„-æ¯ä¸€è·³éƒ½ä¼šå˜çš„"><a href="#ğŸ”„-æ¯ä¸€è·³éƒ½ä¼šå˜çš„" class="headerlink" title="ğŸ”„ æ¯ä¸€è·³éƒ½ä¼šå˜çš„"></a>ğŸ”„ æ¯ä¸€è·³éƒ½ä¼šå˜çš„</h3><ul>
<li>Source MAC</li>
<li>Destination MAC</li>
</ul>
<h3 id="ğŸ§ -å†³ç­–é€»è¾‘"><a href="#ğŸ§ -å†³ç­–é€»è¾‘" class="headerlink" title="ğŸ§  å†³ç­–é€»è¾‘"></a>ğŸ§  å†³ç­–é€»è¾‘</h3><ul>
<li><strong>IP å†³å®šâ€œå»å“ªé‡Œâ€</strong></li>
<li><strong>MAC å†³å®šâ€œä¸‹ä¸€è·³äº¤ç»™è°â€</strong></li>
</ul>
<hr>
<h2 id="äº”ã€ä¸ºä»€ä¹ˆä¸èƒ½â€œå…¨ç½‘-ARPâ€ï¼ˆä½ åŸæ–‡æœ€åçš„ç‚¹ç›ï¼‰"><a href="#äº”ã€ä¸ºä»€ä¹ˆä¸èƒ½â€œå…¨ç½‘-ARPâ€ï¼ˆä½ åŸæ–‡æœ€åçš„ç‚¹ç›ï¼‰" class="headerlink" title="äº”ã€ä¸ºä»€ä¹ˆä¸èƒ½â€œå…¨ç½‘ ARPâ€ï¼ˆä½ åŸæ–‡æœ€åçš„ç‚¹ç›ï¼‰"></a>äº”ã€ä¸ºä»€ä¹ˆä¸èƒ½â€œå…¨ç½‘ ARPâ€ï¼ˆä½ åŸæ–‡æœ€åçš„ç‚¹ç›ï¼‰</h2><p>å¦‚æœæ²¡æœ‰è·¯ç”±å™¨ï¼š</p>
<ul>
<li>æ‰€æœ‰è®¾å¤‡åœ¨ä¸€ä¸ªå¹¿æ’­åŸŸ</li>
<li>æ¯ä¸€æ¬¡é€šä¿¡éƒ½ ARP å…¨ç½‘</li>
<li>å¹¿æ’­é£æš´</li>
<li>ç½‘ç»œç›´æ¥ç˜«ç—ª</li>
</ul>
<p>ğŸ‘‰ <strong>è·¯ç”±å™¨çš„æ ¸å¿ƒä»·å€¼ï¼š</strong></p>
<ul>
<li>åˆ‡å‰²å¹¿æ’­åŸŸ</li>
<li>é™åˆ¶ ARP çš„ä½œç”¨èŒƒå›´</li>
<li>è®© Internet æˆä¸ºå¯èƒ½</li>
</ul>
<hr>
<h2 id="å…­ã€ä¸€å¥â€œå·¥ç¨‹å¸ˆçº§æ€»ç»“â€"><a href="#å…­ã€ä¸€å¥â€œå·¥ç¨‹å¸ˆçº§æ€»ç»“â€" class="headerlink" title="å…­ã€ä¸€å¥â€œå·¥ç¨‹å¸ˆçº§æ€»ç»“â€"></a>å…­ã€ä¸€å¥â€œå·¥ç¨‹å¸ˆçº§æ€»ç»“â€</h2><blockquote>
<p><strong>ä¸‰å±‚å†³å®šæ–¹å‘ï¼ŒäºŒå±‚è´Ÿè´£æ¬è¿ã€‚<br>è·¯ç”±å™¨æ¯ä¸€è·³åªå…³å¿ƒï¼š<br>â€œä¸‹ä¸€æ­¥æˆ‘è¯¥æŠŠåŒ…äº¤ç»™è°ï¼Ÿâ€</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/21/%E7%90%86%E8%A7%A3CNI%E5%8F%8A%E5%AE%9E%E8%B7%B5%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/21/%E7%90%86%E8%A7%A3CNI%E5%8F%8A%E5%AE%9E%E8%B7%B5%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">ç†è§£CNIåŠå®è·µæ“ä½œ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-21 22:15:13" itemprop="dateCreated datePublished" datetime="2026-01-21T22:15:13+08:00">2026-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2026-01-27 15:53:05" itemprop="dateModified" datetime="2026-01-27T15:53:05+08:00">2026-01-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloudpods.csdn.net/6578109cb8e5f01e1e4496fd.html">https://cloudpods.csdn.net/6578109cb8e5f01e1e4496fd.html</a></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/shispring/picgo/master/c54b0cea8c10edba2f581d573f58ee01.png" alt="cni" title="cni"></p>
<hr>
<h1 id="ä¸€ã€åˆ†æå›¾ç‰‡çš„-3-ä¸ªæ­¥éª¤"><a href="#ä¸€ã€åˆ†æå›¾ç‰‡çš„-3-ä¸ªæ­¥éª¤" class="headerlink" title="ä¸€ã€åˆ†æå›¾ç‰‡çš„ 3 ä¸ªæ­¥éª¤"></a>ä¸€ã€åˆ†æå›¾ç‰‡çš„ 3 ä¸ªæ­¥éª¤</h1><h2 id="Step-1ï¼šç»™-Pod-æ’ä¸Šâ€œç½‘çº¿â€ï¼ˆvethï¼‰"><a href="#Step-1ï¼šç»™-Pod-æ’ä¸Šâ€œç½‘çº¿â€ï¼ˆvethï¼‰" class="headerlink" title="Step 1ï¼šç»™ Pod æ’ä¸Šâ€œç½‘çº¿â€ï¼ˆvethï¼‰"></a>Step 1ï¼šç»™ Pod æ’ä¸Šâ€œç½‘çº¿â€ï¼ˆvethï¼‰</h2><blockquote>
<p>åˆ›å»º veth pairï¼Œä¸€ç«¯è¿› Podï¼Œä¸€ç«¯ç•™åœ¨ Node</p>
</blockquote>
<h3 id="ğŸ‘-è¿™æ˜¯-CNI-çš„æ ¸å¿ƒèŒè´£ä¹‹ä¸€"><a href="#ğŸ‘-è¿™æ˜¯-CNI-çš„æ ¸å¿ƒèŒè´£ä¹‹ä¸€" class="headerlink" title="ğŸ‘ è¿™æ˜¯ CNI çš„æ ¸å¿ƒèŒè´£ä¹‹ä¸€"></a>ğŸ‘ è¿™æ˜¯ CNI çš„<strong>æ ¸å¿ƒèŒè´£ä¹‹ä¸€</strong></h3><p><strong>åº•å±‚åŸç†</strong>ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ Pod netns ] eth0  &lt;==== veth pair ====  vethXXXX [ Node ]</span><br></pre></td></tr></table></figure>

<ul>
<li>veth æ˜¯ Linux æä¾›çš„â€œè™šæ‹Ÿç½‘çº¿â€</li>
<li>Pod é‡Œçœ‹åˆ°çš„æ˜¯ <code>eth0</code></li>
<li>Node ä¸Šçœ‹åˆ°çš„æ˜¯ <code>vethxxxx</code><br>ğŸ‘‰ <strong>CNI æ’ä»¶æœ€åŸºç¡€çš„èŒè´£ï¼š</strong><blockquote>
<p>æŠŠ Pod çš„ network namespace æ¥å…¥å®¿ä¸»æœºç½‘ç»œ</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="Step-2ï¼šç»™-Pod-åˆ†é…-IPï¼ˆIPAMï¼‰"><a href="#Step-2ï¼šç»™-Pod-åˆ†é…-IPï¼ˆIPAMï¼‰" class="headerlink" title="Step 2ï¼šç»™ Pod åˆ†é… IPï¼ˆIPAMï¼‰"></a>Step 2ï¼šç»™ Pod åˆ†é… IPï¼ˆIPAMï¼‰</h2><blockquote>
<p>æ¯ä¸ª Pod ä¸€ä¸ªå”¯ä¸€ IPï¼Œé€šå¸¸ Node æ‹¿ä¸€ä¸ªå­ç½‘</p>
</blockquote>
<h3 id="ğŸ‘-è¿™ä¹Ÿæ˜¯-CNI-çš„æ ‡å‡†è®¾è®¡"><a href="#ğŸ‘-è¿™ä¹Ÿæ˜¯-CNI-çš„æ ‡å‡†è®¾è®¡" class="headerlink" title="ğŸ‘ è¿™ä¹Ÿæ˜¯ CNI çš„æ ‡å‡†è®¾è®¡"></a>ğŸ‘ è¿™ä¹Ÿæ˜¯ CNI çš„æ ‡å‡†è®¾è®¡</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Node1: 172.16.0.0/24</span><br><span class="line">  Pod1: 172.16.0.1</span><br><span class="line">  Pod2: 172.16.0.2</span><br><span class="line">Node2: 172.16.1.0/24</span><br></pre></td></tr></table></figure>
<h2 id="è¿™æ˜¯ï¼š-Node-çº§å­ç½‘åˆ’åˆ†-Pod-ä»-Node-å­ç½‘é‡Œåˆ†-IPğŸ‘‰-è¿™æ˜¯éå¸¸å…¸å‹çš„-Node-scoped-IPAM-æ¨¡å‹Flannel-Calico-Cilium-éƒ½æ”¯æŒè¿™ä¸ªæ¨¡å‹"><a href="#è¿™æ˜¯ï¼š-Node-çº§å­ç½‘åˆ’åˆ†-Pod-ä»-Node-å­ç½‘é‡Œåˆ†-IPğŸ‘‰-è¿™æ˜¯éå¸¸å…¸å‹çš„-Node-scoped-IPAM-æ¨¡å‹Flannel-Calico-Cilium-éƒ½æ”¯æŒè¿™ä¸ªæ¨¡å‹" class="headerlink" title="è¿™æ˜¯ï¼š* Node çº§å­ç½‘åˆ’åˆ†* Pod ä» Node å­ç½‘é‡Œåˆ† IPğŸ‘‰ è¿™æ˜¯éå¸¸å…¸å‹çš„ Node-scoped IPAM æ¨¡å‹Flannel &#x2F; Calico &#x2F; Cilium éƒ½æ”¯æŒè¿™ä¸ªæ¨¡å‹"></a>è¿™æ˜¯ï¼š<br>* <strong>Node çº§å­ç½‘åˆ’åˆ†</strong><br>* Pod ä» Node å­ç½‘é‡Œåˆ† IP<br>ğŸ‘‰ è¿™æ˜¯éå¸¸å…¸å‹çš„ <strong>Node-scoped IPAM æ¨¡å‹</strong><br><strong>Flannel &#x2F; Calico &#x2F; Cilium éƒ½æ”¯æŒè¿™ä¸ªæ¨¡å‹</strong></h2><h2 id="Step-3ï¼šé…ç½®-IP-è·¯ç”±ï¼ˆL3-é€šï¼‰"><a href="#Step-3ï¼šé…ç½®-IP-è·¯ç”±ï¼ˆL3-é€šï¼‰" class="headerlink" title="Step 3ï¼šé…ç½® IP + è·¯ç”±ï¼ˆL3 é€šï¼‰"></a>Step 3ï¼šé…ç½® IP + è·¯ç”±ï¼ˆL3 é€šï¼‰</h2><blockquote>
<p>Pod èƒ½å‡ºç½‘ï¼ŒNode çŸ¥é“æ€ä¹ˆæŠŠåŒ…é€å› Pod</p>
</blockquote>
<h3 id="ğŸ‘-è¿™æ˜¯æœ€å®¹æ˜“è¢«ä½ä¼°ï¼Œä½†æœ€é‡è¦çš„ä¸€æ­¥"><a href="#ğŸ‘-è¿™æ˜¯æœ€å®¹æ˜“è¢«ä½ä¼°ï¼Œä½†æœ€é‡è¦çš„ä¸€æ­¥" class="headerlink" title="ğŸ‘ è¿™æ˜¯æœ€å®¹æ˜“è¢«ä½ä¼°ï¼Œä½†æœ€é‡è¦çš„ä¸€æ­¥"></a>ğŸ‘ è¿™æ˜¯æœ€å®¹æ˜“è¢«ä½ä¼°ï¼Œä½†æœ€é‡è¦çš„ä¸€æ­¥</h3><h2 id="å›¾é‡Œæåˆ°ä¸‰ä»¶äº‹ï¼š1-ç»™-Pod-eth0-é…-IP2-ç»™-Pod-é…é»˜è®¤è·¯ç”±3-ç»™-Node-é…åˆ°-Pod-IP-çš„è·¯ç”±è¿™æ˜¯-â€œPod-èƒ½é€šä¿¡â€æˆç«‹çš„æœ€å°æ¡ä»¶ã€‚"><a href="#å›¾é‡Œæåˆ°ä¸‰ä»¶äº‹ï¼š1-ç»™-Pod-eth0-é…-IP2-ç»™-Pod-é…é»˜è®¤è·¯ç”±3-ç»™-Node-é…åˆ°-Pod-IP-çš„è·¯ç”±è¿™æ˜¯-â€œPod-èƒ½é€šä¿¡â€æˆç«‹çš„æœ€å°æ¡ä»¶ã€‚" class="headerlink" title="å›¾é‡Œæåˆ°ä¸‰ä»¶äº‹ï¼š1. ç»™ Pod eth0 é… IP2. ç»™ Pod é…é»˜è®¤è·¯ç”±3. ç»™ Node é…åˆ° Pod IP çš„è·¯ç”±è¿™æ˜¯ â€œPod èƒ½é€šä¿¡â€æˆç«‹çš„æœ€å°æ¡ä»¶ã€‚"></a>å›¾é‡Œæåˆ°ä¸‰ä»¶äº‹ï¼š<br>1. ç»™ Pod eth0 é… IP<br>2. ç»™ Pod é…é»˜è®¤è·¯ç”±<br>3. ç»™ Node é…åˆ° Pod IP çš„è·¯ç”±<br>è¿™æ˜¯ <strong>â€œPod èƒ½é€šä¿¡â€æˆç«‹çš„æœ€å°æ¡ä»¶</strong>ã€‚</h2><h1 id="äºŒã€å¦‚æœä½ æ‰‹åŠ¨â€œå®Œæ•´ä½“éªŒä¸€é-CNIâ€ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ"><a href="#äºŒã€å¦‚æœä½ æ‰‹åŠ¨â€œå®Œæ•´ä½“éªŒä¸€é-CNIâ€ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ" class="headerlink" title="äºŒã€å¦‚æœä½ æ‰‹åŠ¨â€œå®Œæ•´ä½“éªŒä¸€é CNIâ€ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ"></a>äºŒã€å¦‚æœä½ æ‰‹åŠ¨â€œå®Œæ•´ä½“éªŒä¸€é CNIâ€ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ</h1><h2 id="ä¸‹é¢æ˜¯ä¸€å¥—å®Œå…¨å¯æ‰‹åŠ¨å¤ç°çš„-CNI-è¡Œä¸º"><a href="#ä¸‹é¢æ˜¯ä¸€å¥—å®Œå…¨å¯æ‰‹åŠ¨å¤ç°çš„-CNI-è¡Œä¸º" class="headerlink" title="ä¸‹é¢æ˜¯ä¸€å¥—å®Œå…¨å¯æ‰‹åŠ¨å¤ç°çš„ CNI è¡Œä¸º"></a>ä¸‹é¢æ˜¯ä¸€å¥—<strong>å®Œå…¨å¯æ‰‹åŠ¨å¤ç°çš„ CNI è¡Œä¸º</strong></h2><h2 id="ğŸ”§-å®éªŒå‰å‡†å¤‡"><a href="#ğŸ”§-å®éªŒå‰å‡†å¤‡" class="headerlink" title="ğŸ”§ å®éªŒå‰å‡†å¤‡"></a>ğŸ”§ å®éªŒå‰å‡†å¤‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿ Pod çš„ netns</span></span><br><span class="line">ip netns add pod1</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-1ï¼šåˆ›å»º-veth-pair"><a href="#Step-1ï¼šåˆ›å»º-veth-pair" class="headerlink" title="Step 1ï¼šåˆ›å»º veth pair"></a>Step 1ï¼šåˆ›å»º veth pair</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> add veth-pod1 <span class="built_in">type</span> veth peer name veth-host1</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-2ï¼šæŠŠä¸€ç«¯æ”¾è¿›-Pod-netns"><a href="#Step-2ï¼šæŠŠä¸€ç«¯æ”¾è¿›-Pod-netns" class="headerlink" title="Step 2ï¼šæŠŠä¸€ç«¯æ”¾è¿› Pod netns"></a>Step 2ï¼šæŠŠä¸€ç«¯æ”¾è¿› Pod netns</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-pod1 netns pod1</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯-1"><a href="#éªŒè¯-1" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span></span><br></pre></td></tr></table></figure>
<h2 id="ä½ ä¼šçœ‹åˆ°-veth-pod1"><a href="#ä½ ä¼šçœ‹åˆ°-veth-pod1" class="headerlink" title="ä½ ä¼šçœ‹åˆ° veth-pod1"></a>ä½ ä¼šçœ‹åˆ° <code>veth-pod1</code></h2><h2 id="Step-3ï¼šç»™-Pod-ç½‘å¡æ”¹åä¸º-eth0-é…-IP"><a href="#Step-3ï¼šç»™-Pod-ç½‘å¡æ”¹åä¸º-eth0-é…-IP" class="headerlink" title="Step 3ï¼šç»™ Pod ç½‘å¡æ”¹åä¸º eth0 + é… IP"></a>Step 3ï¼šç»™ Pod ç½‘å¡æ”¹åä¸º eth0 + é… IP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span> <span class="built_in">set</span> veth-pod1 name eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> pod1 ip addr add 172.16.0.2/24 dev eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-4ï¼šé…ç½®-Pod-é»˜è®¤è·¯ç”±"><a href="#Step-4ï¼šé…ç½®-Pod-é»˜è®¤è·¯ç”±" class="headerlink" title="Step 4ï¼šé…ç½® Pod é»˜è®¤è·¯ç”±"></a>Step 4ï¼šé…ç½® Pod é»˜è®¤è·¯ç”±</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip route add default via 172.16.0.1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™ä¸ª <code>172.16.0.1</code> é€šå¸¸å°±æ˜¯ Node ä¾§ veth çš„ IP</p>
</blockquote>
<hr>
<h2 id="Step-5ï¼šé…ç½®-Node-ä¾§-veth"><a href="#Step-5ï¼šé…ç½®-Node-ä¾§-veth" class="headerlink" title="Step 5ï¼šé…ç½® Node ä¾§ veth"></a>Step 5ï¼šé…ç½® Node ä¾§ veth</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 172.16.0.1/24 dev veth-host1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-host1 up</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-6ï¼šNode-â†’-Pod-è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰"><a href="#Step-6ï¼šNode-â†’-Pod-è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰" class="headerlink" title="Step 6ï¼šNode â†’ Pod è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰"></a>Step 6ï¼šNode â†’ Pod è·¯ç”±ï¼ˆå¦‚æœéœ€è¦ï¼‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route add 172.16.0.2 dev veth-host1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®é™… CNI ä¸­ï¼Œè¿™æ­¥é€šå¸¸ç”±å†…æ ¸è‡ªåŠ¨å®Œæˆæˆ–ç”±æ›´ä¸Šå±‚ç»„ä»¶ï¼ˆBGP &#x2F; overlayï¼‰è´Ÿè´£</p>
</blockquote>
<hr>
<h2 id="Step-7ï¼šéªŒè¯é€šä¿¡"><a href="#Step-7ï¼šéªŒè¯é€šä¿¡" class="headerlink" title="Step 7ï¼šéªŒè¯é€šä¿¡"></a>Step 7ï¼šéªŒè¯é€šä¿¡</h2><h3 id="Pod-â†’-Node"><a href="#Pod-â†’-Node" class="headerlink" title="Pod â†’ Node"></a>Pod â†’ Node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ping 172.16.0.1</span><br></pre></td></tr></table></figure>
<h3 id="Node-â†’-Pod"><a href="#Node-â†’-Pod" class="headerlink" title="Node â†’ Pod"></a>Node â†’ Pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 172.16.0.2</span><br></pre></td></tr></table></figure>
<h2 id="âœ…-é€šäº†ï¼Œè¯´æ˜ä½ å·²ç»æ‰‹æ“äº†ä¸€ä¸ªæœ€å°-CNI"><a href="#âœ…-é€šäº†ï¼Œè¯´æ˜ä½ å·²ç»æ‰‹æ“äº†ä¸€ä¸ªæœ€å°-CNI" class="headerlink" title="âœ… é€šäº†ï¼Œè¯´æ˜ä½ å·²ç»æ‰‹æ“äº†ä¸€ä¸ªæœ€å° CNI"></a>âœ… é€šäº†ï¼Œè¯´æ˜ä½ å·²ç»<strong>æ‰‹æ“äº†ä¸€ä¸ªæœ€å° CNI</strong></h2><h1 id="ä¸‰ã€å’Œâ€œçœŸå®-CNI-æ’ä»¶â€çš„å·®è·åœ¨å“ªï¼Ÿ"><a href="#ä¸‰ã€å’Œâ€œçœŸå®-CNI-æ’ä»¶â€çš„å·®è·åœ¨å“ªï¼Ÿ" class="headerlink" title="ä¸‰ã€å’Œâ€œçœŸå® CNI æ’ä»¶â€çš„å·®è·åœ¨å“ªï¼Ÿ"></a>ä¸‰ã€å’Œâ€œçœŸå® CNI æ’ä»¶â€çš„å·®è·åœ¨å“ªï¼Ÿ</h1><table>
<thead>
<tr>
<th>èƒ½åŠ›</th>
<th>å›¾ä¸­æ˜¯å¦æ¶‰åŠ</th>
<th>ç”Ÿäº§ CNI</th>
</tr>
</thead>
<tbody><tr>
<td>veth ç®¡ç†</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>IPAM</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Node é—´äº’é€š</td>
<td>âŒ</td>
<td>å¿…é¡»</td>
</tr>
<tr>
<td>Overlay &#x2F; BGP</td>
<td>âŒ</td>
<td>å¿…é¡»</td>
</tr>
<tr>
<td>NetworkPolicy</td>
<td>âŒ</td>
<td>å¿…é¡»</td>
</tr>
<tr>
<td>ç”Ÿå‘½å‘¨æœŸå›æ”¶</td>
<td>âŒ</td>
<td>å¿…é¡»</td>
</tr>
<tr>
<td>é«˜æ€§èƒ½</td>
<td>âŒ</td>
<td>eBPF &#x2F; XDP</td>
</tr>
</tbody></table>
<hr>
<h1 id="å››ã€â€œæ‰‹åŠ¨-CNIâ€çš„çœŸå®ç½‘ç»œæ‹“æ‰‘"><a href="#å››ã€â€œæ‰‹åŠ¨-CNIâ€çš„çœŸå®ç½‘ç»œæ‹“æ‰‘" class="headerlink" title="å››ã€â€œæ‰‹åŠ¨ CNIâ€çš„çœŸå®ç½‘ç»œæ‹“æ‰‘"></a>å››ã€â€œæ‰‹åŠ¨ CNIâ€çš„çœŸå®ç½‘ç»œæ‹“æ‰‘</h1><h2 id="1ï¸âƒ£-é€»è¾‘ç½‘ç»œæ‹“æ‰‘ï¼ˆå¼ºçƒˆæ¨èå…ˆçœ‹è¿™ä¸ªï¼‰"><a href="#1ï¸âƒ£-é€»è¾‘ç½‘ç»œæ‹“æ‰‘ï¼ˆå¼ºçƒˆæ¨èå…ˆçœ‹è¿™ä¸ªï¼‰" class="headerlink" title="1ï¸âƒ£ é€»è¾‘ç½‘ç»œæ‹“æ‰‘ï¼ˆå¼ºçƒˆæ¨èå…ˆçœ‹è¿™ä¸ªï¼‰"></a>1ï¸âƒ£ é€»è¾‘ç½‘ç»œæ‹“æ‰‘ï¼ˆå¼ºçƒˆæ¨èå…ˆçœ‹è¿™ä¸ªï¼‰</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------+</span><br><span class="line">|                     Node (Host)                    |</span><br><span class="line">|                                                    |</span><br><span class="line">|   veth-host1                                       |</span><br><span class="line">|   IP: 172.16.0.1/24                                |</span><br><span class="line">|        |                                           |</span><br><span class="line">|        |  (veth pair)                              |</span><br><span class="line">|        |                                           |</span><br><span class="line">|   +----+-----------------------------+             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   |        Pod Network Namespace     |             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   |   eth0                           |             |</span><br><span class="line">|   |   IP: 172.16.0.2/24              |             |</span><br><span class="line">|   |   Default GW: 172.16.0.1         |             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   +----------------------------------+             |</span><br><span class="line">|                                                    |</span><br><span class="line">+----------------------------------------------------+</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2ï¸âƒ£-æ•°æ®åŒ…æµå‘ï¼ˆping-æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼‰"><a href="#2ï¸âƒ£-æ•°æ®åŒ…æµå‘ï¼ˆping-æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼‰" class="headerlink" title="2ï¸âƒ£ æ•°æ®åŒ…æµå‘ï¼ˆping æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼‰"></a>2ï¸âƒ£ æ•°æ®åŒ…æµå‘ï¼ˆping æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼‰</h2><h3 id="Pod-â†’-Node-1"><a href="#Pod-â†’-Node-1" class="headerlink" title="Pod â†’ Node"></a>Pod â†’ Node</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Pod eth0 (172.16.0.2)</span><br><span class="line">  |</span><br><span class="line">  |  ICMP Echo Request</span><br><span class="line">  |</span><br><span class="line">veth-pod1  ====== veth-host1</span><br><span class="line">                          |</span><br><span class="line">                          |</span><br><span class="line">                    Node ç½‘ç»œåè®®æ ˆ</span><br></pre></td></tr></table></figure>
<h3 id="Node-â†’-Pod-1"><a href="#Node-â†’-Pod-1" class="headerlink" title="Node â†’ Pod"></a>Node â†’ Pod</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Node IP stack</span><br><span class="line">  |</span><br><span class="line">  |  æŸ¥è·¯ç”±ï¼š172.16.0.2 dev veth-host1</span><br><span class="line">  |</span><br><span class="line">veth-host1 ====== veth-pod1</span><br><span class="line">                          |</span><br><span class="line">                          |</span><br><span class="line">                      Pod eth0</span><br></pre></td></tr></table></figure>
<h2 id="ğŸ‘‰-å…³é”®ç‚¹-veth-â‰ˆ-ä¸€æ ¹è™šæ‹Ÿç½‘çº¿-ä¸éœ€è¦-NAT-ä¸éœ€è¦-iptables-è¿™æ˜¯çº¯-L3-è·¯ç”±æ¨¡å‹"><a href="#ğŸ‘‰-å…³é”®ç‚¹-veth-â‰ˆ-ä¸€æ ¹è™šæ‹Ÿç½‘çº¿-ä¸éœ€è¦-NAT-ä¸éœ€è¦-iptables-è¿™æ˜¯çº¯-L3-è·¯ç”±æ¨¡å‹" class="headerlink" title="ğŸ‘‰ å…³é”®ç‚¹* veth â‰ˆ ä¸€æ ¹è™šæ‹Ÿç½‘çº¿* ä¸éœ€è¦ NAT* ä¸éœ€è¦ iptables* è¿™æ˜¯çº¯ L3 è·¯ç”±æ¨¡å‹"></a>ğŸ‘‰ <strong>å…³é”®ç‚¹</strong><br>* veth â‰ˆ ä¸€æ ¹è™šæ‹Ÿç½‘çº¿<br>* ä¸éœ€è¦ NAT<br>* ä¸éœ€è¦ iptables<br>* è¿™æ˜¯çº¯ L3 è·¯ç”±æ¨¡å‹</h2><h2 id="3ï¸âƒ£-ç”¨ä¸€å¥è¯æ€»ç»“ä½ ç°åœ¨çš„ç»“æ„"><a href="#3ï¸âƒ£-ç”¨ä¸€å¥è¯æ€»ç»“ä½ ç°åœ¨çš„ç»“æ„" class="headerlink" title="3ï¸âƒ£ ç”¨ä¸€å¥è¯æ€»ç»“ä½ ç°åœ¨çš„ç»“æ„"></a>3ï¸âƒ£ ç”¨ä¸€å¥è¯æ€»ç»“ä½ ç°åœ¨çš„ç»“æ„</h2><blockquote>
<p><strong>Pod æ˜¯ Node ç½‘ç»œçš„ä¸€éƒ¨åˆ†ï¼Œåªæ˜¯é€šè¿‡ veth è¢«â€œå»¶é•¿â€åˆ°äº†å¦ä¸€ä¸ª namespace</strong><br>è¿™æ­£æ˜¯ <strong>Kubernetes CNI çš„æ ¸å¿ƒå“²å­¦</strong>ã€‚</p>
</blockquote>
<hr>
<h1 id="äº”ã€å®Œæ•´çš„ã€Œæ¸…ç†æ­¥éª¤ï¼ˆDELï¼‰ã€"><a href="#äº”ã€å®Œæ•´çš„ã€Œæ¸…ç†æ­¥éª¤ï¼ˆDELï¼‰ã€" class="headerlink" title="äº”ã€å®Œæ•´çš„ã€Œæ¸…ç†æ­¥éª¤ï¼ˆDELï¼‰ã€"></a>äº”ã€å®Œæ•´çš„ã€Œæ¸…ç†æ­¥éª¤ï¼ˆDELï¼‰ã€</h1><h2 id="ä½ ç°åœ¨åšçš„æ˜¯-ADDï¼Œä½†ç”Ÿäº§-CNI-æœ€å®¹æ˜“å‡º-bug-çš„æ˜¯-DELã€‚ä¸‹é¢æ˜¯å®Œå…¨å¯¹ç§°ã€ä¸”å®‰å…¨çš„æ¸…ç†é¡ºåºã€‚"><a href="#ä½ ç°åœ¨åšçš„æ˜¯-ADDï¼Œä½†ç”Ÿäº§-CNI-æœ€å®¹æ˜“å‡º-bug-çš„æ˜¯-DELã€‚ä¸‹é¢æ˜¯å®Œå…¨å¯¹ç§°ã€ä¸”å®‰å…¨çš„æ¸…ç†é¡ºåºã€‚" class="headerlink" title="ä½ ç°åœ¨åšçš„æ˜¯ ADDï¼Œä½†ç”Ÿäº§ CNI æœ€å®¹æ˜“å‡º bug çš„æ˜¯ DELã€‚ä¸‹é¢æ˜¯å®Œå…¨å¯¹ç§°ã€ä¸”å®‰å…¨çš„æ¸…ç†é¡ºåºã€‚"></a>ä½ ç°åœ¨åšçš„æ˜¯ <code>ADD</code>ï¼Œä½†<strong>ç”Ÿäº§ CNI æœ€å®¹æ˜“å‡º bug çš„æ˜¯ <code>DEL</code><strong>ã€‚<br>ä¸‹é¢æ˜¯</strong>å®Œå…¨å¯¹ç§°ã€ä¸”å®‰å…¨çš„æ¸…ç†é¡ºåº</strong>ã€‚</h2><h2 id="Step-1ï¼šåˆ é™¤-Pod-netnsï¼ˆæœ€å½»åº•ï¼‰"><a href="#Step-1ï¼šåˆ é™¤-Pod-netnsï¼ˆæœ€å½»åº•ï¼‰" class="headerlink" title="Step 1ï¼šåˆ é™¤ Pod netnsï¼ˆæœ€å½»åº•ï¼‰"></a>Step 1ï¼šåˆ é™¤ Pod netnsï¼ˆæœ€å½»åº•ï¼‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns del pod1</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯-2"><a href="#éªŒè¯-2" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns list</span><br></pre></td></tr></table></figure>
<h2 id="âœ…-pod1-ä¸å­˜åœ¨-âš ï¸-æ³¨æ„ï¼š-å¦‚æœä½ åˆ çš„æ˜¯-netnsï¼Œnetns-å†…çš„-veth-ä¼šè¢«è‡ªåŠ¨å›æ”¶"><a href="#âœ…-pod1-ä¸å­˜åœ¨-âš ï¸-æ³¨æ„ï¼š-å¦‚æœä½ åˆ çš„æ˜¯-netnsï¼Œnetns-å†…çš„-veth-ä¼šè¢«è‡ªåŠ¨å›æ”¶" class="headerlink" title="âœ… pod1 ä¸å­˜åœ¨&gt; âš ï¸ æ³¨æ„ï¼š&gt; å¦‚æœä½ åˆ çš„æ˜¯ netnsï¼Œnetns å†…çš„ veth ä¼šè¢«è‡ªåŠ¨å›æ”¶"></a>âœ… pod1 ä¸å­˜åœ¨<br>&gt; âš ï¸ æ³¨æ„ï¼š<br>&gt; å¦‚æœä½ åˆ çš„æ˜¯ netnsï¼Œ<strong>netns å†…çš„ veth ä¼šè¢«è‡ªåŠ¨å›æ”¶</strong></h2><h2 id="Step-2ï¼šç¡®è®¤-Node-ä¾§-veth-æ˜¯å¦è¿˜å­˜åœ¨"><a href="#Step-2ï¼šç¡®è®¤-Node-ä¾§-veth-æ˜¯å¦è¿˜å­˜åœ¨" class="headerlink" title="Step 2ï¼šç¡®è®¤ Node ä¾§ veth æ˜¯å¦è¿˜å­˜åœ¨"></a>Step 2ï¼šç¡®è®¤ Node ä¾§ veth æ˜¯å¦è¿˜å­˜åœ¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth-host1</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <strong>è¿˜å­˜åœ¨</strong>ï¼ˆå°‘è§ï¼Œä½†å¯èƒ½ï¼‰ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> del veth-host1</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="Step-3ï¼šæ¸…ç†è·¯ç”±ï¼ˆå¦‚æœä½ æ˜¯æ‰‹åŠ¨åŠ çš„ï¼‰"><a href="#Step-3ï¼šæ¸…ç†è·¯ç”±ï¼ˆå¦‚æœä½ æ˜¯æ‰‹åŠ¨åŠ çš„ï¼‰" class="headerlink" title="Step 3ï¼šæ¸…ç†è·¯ç”±ï¼ˆå¦‚æœä½ æ˜¯æ‰‹åŠ¨åŠ çš„ï¼‰"></a>Step 3ï¼šæ¸…ç†è·¯ç”±ï¼ˆå¦‚æœä½ æ˜¯æ‰‹åŠ¨åŠ çš„ï¼‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route del 172.16.0.2 dev veth-host1</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯-3"><a href="#éªŒè¯-3" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route | grep 172.16.0.2</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-4ï¼šæ¸…ç†-IPï¼ˆä¸€èˆ¬éš-veth-ä¸€èµ·æ¶ˆå¤±ï¼‰"><a href="#Step-4ï¼šæ¸…ç†-IPï¼ˆä¸€èˆ¬éš-veth-ä¸€èµ·æ¶ˆå¤±ï¼‰" class="headerlink" title="Step 4ï¼šæ¸…ç† IPï¼ˆä¸€èˆ¬éš veth ä¸€èµ·æ¶ˆå¤±ï¼‰"></a>Step 4ï¼šæ¸…ç† IPï¼ˆä¸€èˆ¬éš veth ä¸€èµ·æ¶ˆå¤±ï¼‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr del 172.16.0.1/24 dev veth-host1</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-5ï¼šæœ€ç»ˆéªŒè¯"><a href="#Step-5ï¼šæœ€ç»ˆéªŒè¯" class="headerlink" title="Step 5ï¼šæœ€ç»ˆéªŒè¯"></a>Step 5ï¼šæœ€ç»ˆéªŒè¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth</span><br><span class="line">ip route | grep 172.16</span><br></pre></td></tr></table></figure>
<h2 id="âœ…-å¹²å‡€ï¼Œç¯å¢ƒæ¢å¤"><a href="#âœ…-å¹²å‡€ï¼Œç¯å¢ƒæ¢å¤" class="headerlink" title="âœ… å¹²å‡€ï¼Œç¯å¢ƒæ¢å¤"></a>âœ… å¹²å‡€ï¼Œç¯å¢ƒæ¢å¤</h2><h1 id="å…­ã€åœ¨â€œçœŸå®-CNI-IPAMâ€ä¸­ï¼Œè¿™äº›æ­¥éª¤æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ï¼Ÿ"><a href="#å…­ã€åœ¨â€œçœŸå®-CNI-IPAMâ€ä¸­ï¼Œè¿™äº›æ­¥éª¤æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ï¼Ÿ" class="headerlink" title="å…­ã€åœ¨â€œçœŸå® CNI &#x2F; IPAMâ€ä¸­ï¼Œè¿™äº›æ­¥éª¤æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ï¼Ÿ"></a>å…­ã€åœ¨â€œçœŸå® CNI &#x2F; IPAMâ€ä¸­ï¼Œè¿™äº›æ­¥éª¤æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ï¼Ÿ</h1><h2 id="ä½ åˆšæ‰æ˜¯â€œäººè‚‰-IPAMâ€ï¼Œç°åœ¨æˆ‘ä»¬ç³»ç»ŸåŒ–ä¸€ä¸‹ã€‚"><a href="#ä½ åˆšæ‰æ˜¯â€œäººè‚‰-IPAMâ€ï¼Œç°åœ¨æˆ‘ä»¬ç³»ç»ŸåŒ–ä¸€ä¸‹ã€‚" class="headerlink" title="ä½ åˆšæ‰æ˜¯â€œäººè‚‰ IPAMâ€ï¼Œç°åœ¨æˆ‘ä»¬ç³»ç»ŸåŒ–ä¸€ä¸‹ã€‚"></a>ä½ åˆšæ‰æ˜¯<strong>â€œäººè‚‰ IPAMâ€</strong>ï¼Œç°åœ¨æˆ‘ä»¬ç³»ç»ŸåŒ–ä¸€ä¸‹ã€‚</h2><h2 id="1ï¸âƒ£-IPAM-çš„èŒè´£è¾¹ç•Œï¼ˆéå¸¸é‡è¦ï¼‰"><a href="#1ï¸âƒ£-IPAM-çš„èŒè´£è¾¹ç•Œï¼ˆéå¸¸é‡è¦ï¼‰" class="headerlink" title="1ï¸âƒ£ IPAM çš„èŒè´£è¾¹ç•Œï¼ˆéå¸¸é‡è¦ï¼‰"></a>1ï¸âƒ£ IPAM çš„èŒè´£è¾¹ç•Œï¼ˆéå¸¸é‡è¦ï¼‰</h2><h2 id="IPAM-åªåšä¸‰ä»¶äº‹ï¼š1-åˆ†é…-IP2-å›æ”¶-IP3-æŒä¹…åŒ–-IP-ä½¿ç”¨çŠ¶æ€å®ƒä¸ï¼š-åˆ›å»º-veth-é…è·¯ç”±-ç®¡ç½‘ç»œç­–ç•¥"><a href="#IPAM-åªåšä¸‰ä»¶äº‹ï¼š1-åˆ†é…-IP2-å›æ”¶-IP3-æŒä¹…åŒ–-IP-ä½¿ç”¨çŠ¶æ€å®ƒä¸ï¼š-åˆ›å»º-veth-é…è·¯ç”±-ç®¡ç½‘ç»œç­–ç•¥" class="headerlink" title="IPAM åªåšä¸‰ä»¶äº‹ï¼š1. åˆ†é… IP2. å›æ”¶ IP3. æŒä¹…åŒ– IP ä½¿ç”¨çŠ¶æ€å®ƒä¸ï¼š* åˆ›å»º veth* é…è·¯ç”±* ç®¡ç½‘ç»œç­–ç•¥"></a><strong>IPAM åªåšä¸‰ä»¶äº‹ï¼š</strong><br>1. åˆ†é… IP<br>2. å›æ”¶ IP<br>3. æŒä¹…åŒ– IP ä½¿ç”¨çŠ¶æ€<br><strong>å®ƒä¸ï¼š</strong><br>* åˆ›å»º veth<br>* é…è·¯ç”±<br>* ç®¡ç½‘ç»œç­–ç•¥</h2><h2 id="2ï¸âƒ£-å¸¸è§-IPAM-æ¨¡å‹-å‘½ä»¤æŠ½è±¡"><a href="#2ï¸âƒ£-å¸¸è§-IPAM-æ¨¡å‹-å‘½ä»¤æŠ½è±¡" class="headerlink" title="2ï¸âƒ£ å¸¸è§ IPAM æ¨¡å‹ &amp; å‘½ä»¤æŠ½è±¡"></a>2ï¸âƒ£ å¸¸è§ IPAM æ¨¡å‹ &amp; å‘½ä»¤æŠ½è±¡</h2><h3 id="ğŸ”¹-æ¨¡å‹ä¸€ï¼šNode-å­ç½‘ï¼ˆä½ ç°åœ¨ç”¨çš„ï¼‰"><a href="#ğŸ”¹-æ¨¡å‹ä¸€ï¼šNode-å­ç½‘ï¼ˆä½ ç°åœ¨ç”¨çš„ï¼‰" class="headerlink" title="ğŸ”¹ æ¨¡å‹ä¸€ï¼šNode å­ç½‘ï¼ˆä½ ç°åœ¨ç”¨çš„ï¼‰"></a>ğŸ”¹ æ¨¡å‹ä¸€ï¼šNode å­ç½‘ï¼ˆä½ ç°åœ¨ç”¨çš„ï¼‰</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Node1: 172.16.0.0/24</span><br><span class="line">Node2: 172.16.1.0/24</span><br></pre></td></tr></table></figure>
<h2 id="IPAM-å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰ï¼š"><a href="#IPAM-å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰ï¼š" class="headerlink" title="IPAM å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰ï¼š"></a><strong>IPAM å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰</strong>ï¼š<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ALLOCATE:</span><br><span class="line">  æ‰¾ä¸€ä¸ª free IP</span><br><span class="line">  æ ‡è®°ä¸º used</span><br><span class="line">  è¿”å› IP + mask + gateway</span><br><span class="line">RELEASE:</span><br><span class="line">  æ ‡è®° IP ä¸º free</span><br></pre></td></tr></table></figure></h2><h3 id="ğŸ”¹-æ‰‹åŠ¨æ¨¡æ‹Ÿ-IPAM-çš„å¸¸è§å‘½ä»¤"><a href="#ğŸ”¹-æ‰‹åŠ¨æ¨¡æ‹Ÿ-IPAM-çš„å¸¸è§å‘½ä»¤" class="headerlink" title="ğŸ”¹ æ‰‹åŠ¨æ¨¡æ‹Ÿ IPAM çš„å¸¸è§å‘½ä»¤"></a>ğŸ”¹ æ‰‹åŠ¨æ¨¡æ‹Ÿ IPAM çš„å¸¸è§å‘½ä»¤</h3><h4 id="æŸ¥çœ‹å½“å‰-Node-ä¸Šçš„-Pod-IPï¼ˆæ¨¡æ‹Ÿï¼‰"><a href="#æŸ¥çœ‹å½“å‰-Node-ä¸Šçš„-Pod-IPï¼ˆæ¨¡æ‹Ÿï¼‰" class="headerlink" title="æŸ¥çœ‹å½“å‰ Node ä¸Šçš„ Pod IPï¼ˆæ¨¡æ‹Ÿï¼‰"></a>æŸ¥çœ‹å½“å‰ Node ä¸Šçš„ Pod IPï¼ˆæ¨¡æ‹Ÿï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr | grep 172.16</span><br></pre></td></tr></table></figure>
<h4 id="æŸ¥çœ‹â€œå·²å ç”¨-IPâ€ï¼ˆç²—æš´ç‰ˆï¼‰"><a href="#æŸ¥çœ‹â€œå·²å ç”¨-IPâ€ï¼ˆç²—æš´ç‰ˆï¼‰" class="headerlink" title="æŸ¥çœ‹â€œå·²å ç”¨ IPâ€ï¼ˆç²—æš´ç‰ˆï¼‰"></a>æŸ¥çœ‹â€œå·²å ç”¨ IPâ€ï¼ˆç²—æš´ç‰ˆï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route | grep veth</span><br></pre></td></tr></table></figure>
<h4 id="å›æ”¶-IPï¼ˆæœ¬è´¨ï¼‰"><a href="#å›æ”¶-IPï¼ˆæœ¬è´¨ï¼‰" class="headerlink" title="å›æ”¶ IPï¼ˆæœ¬è´¨ï¼‰"></a>å›æ”¶ IPï¼ˆæœ¬è´¨ï¼‰</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åˆ é™¤ netns + åˆ é™¤ veth + åˆ é™¤è·¯ç”±</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3ï¸âƒ£-å¸¸è§çœŸå®-IPAM-å®ç°"><a href="#3ï¸âƒ£-å¸¸è§çœŸå®-IPAM-å®ç°" class="headerlink" title="3ï¸âƒ£ å¸¸è§çœŸå® IPAM å®ç°"></a>3ï¸âƒ£ å¸¸è§çœŸå® IPAM å®ç°</h2><table>
<thead>
<tr>
<th>IPAM</th>
<th>åº•å±‚</th>
</tr>
</thead>
<tbody><tr>
<td>host-local</td>
<td>æ–‡ä»¶ <code>/var/lib/cni/networks/</code></td>
</tr>
<tr>
<td>calico-ipam</td>
<td>etcd &#x2F; CRD</td>
</tr>
<tr>
<td>cilium IPAM</td>
<td>KVStore &#x2F; Kubernetes</td>
</tr>
<tr>
<td>whereabouts</td>
<td>åˆ†å¸ƒå¼é”</td>
</tr>
</tbody></table>
<h3 id="ä»¥-host-local-IPAM-ä¸ºä¾‹"><a href="#ä»¥-host-local-IPAM-ä¸ºä¾‹" class="headerlink" title="ä»¥ host-local IPAM ä¸ºä¾‹"></a>ä»¥ <strong>host-local IPAM</strong> ä¸ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /var/lib/cni/networks/&lt;network-name&gt;/</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šçœ‹åˆ°ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.0.2</span><br><span class="line">172.16.0.3</span><br><span class="line">last_reserved_ip</span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯ <strong>æœ€åŸå§‹çš„ IPAM çŠ¶æ€å­˜å‚¨</strong></p>
<h2 id="æ•…éšœè¯Šæ–­å‘½ä»¤"><a href="#æ•…éšœè¯Šæ–­å‘½ä»¤" class="headerlink" title="æ•…éšœè¯Šæ–­å‘½ä»¤"></a>æ•…éšœè¯Šæ–­å‘½ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># ç½‘ç»œè™šæ‹ŸåŒ–ç¯å¢ƒè¯Šæ–­è„šæœ¬</span><br><span class="line"></span><br><span class="line">echo &quot;=== ç½‘ç»œå‘½åç©ºé—´æ£€æŸ¥ ===&quot;</span><br><span class="line">ip netns list</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== ç½‘æ¡¥ä¿¡æ¯ ===&quot;</span><br><span class="line">bridge link show 2&gt;/dev/null || ip link show type bridge</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== vethè®¾å¤‡æ£€æŸ¥ ===&quot;</span><br><span class="line">ip link show type veth</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== è·¯ç”±è¡¨æ£€æŸ¥ ===&quot;</span><br><span class="line">for ns in $(ip netns list | awk &#x27;&#123;print $1&#125;&#x27;); do</span><br><span class="line">    echo &quot;--- å‘½åç©ºé—´ $ns è·¯ç”±è¡¨ ---&quot;</span><br><span class="line">    ip netns exec $ns ip route show</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== ARPè¡¨æ£€æŸ¥ ===&quot;</span><br><span class="line">for ns in $(ip netns list | awk &#x27;&#123;print $1&#125;&#x27;); do</span><br><span class="line">    echo &quot;--- å‘½åç©ºé—´ $ns ARPè¡¨ ---&quot;</span><br><span class="line">    ip netns exec $ns ip neighbor show</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== è¿é€šæ€§æµ‹è¯• ===&quot;</span><br><span class="line"># æµ‹è¯•ç½‘æ¡¥å†…éƒ¨é€šä¿¡</span><br><span class="line">if ip netns list | grep -q ns0; then</span><br><span class="line">    ip netns exec ns0 ping -c 2 172.17.0.1 &gt;/dev/null 2&gt;&amp;1 &amp;&amp; \</span><br><span class="line">        echo &quot;ç½‘æ¡¥å†…éƒ¨é€šä¿¡: æ­£å¸¸&quot; || echo &quot;ç½‘æ¡¥å†…éƒ¨é€šä¿¡: å¤±è´¥&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== iptablesè§„åˆ™æ£€æŸ¥ ===&quot;</span><br><span class="line">iptables -t nat -L -n -v</span><br><span class="line">iptables -L FORWARD -n -v</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/21/BCC-BPF-Compiler-Collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/21/BCC-BPF-Compiler-Collection/" class="post-title-link" itemprop="url">BCC(BPF Compiler Collection)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-21 15:33:50 / ä¿®æ”¹æ—¶é—´ï¼š15:48:41" itemprop="dateCreated datePublished" datetime="2026-01-21T15:33:50+08:00">2026-01-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="BCCåŒ…æ‹¬çš„ä¸€äº›å·¥å…·"><a href="#BCCåŒ…æ‹¬çš„ä¸€äº›å·¥å…·" class="headerlink" title="BCCåŒ…æ‹¬çš„ä¸€äº›å·¥å…·"></a>BCCåŒ…æ‹¬çš„ä¸€äº›å·¥å…·</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://tonydeng.github.io/sdn-handbook/linux/bpf/bcc.html">https://tonydeng.github.io/sdn-handbook/linux/bpf/bcc.html</a><br><img src="https://raw.githubusercontent.com/shispring/picgo/master/bcc_tracing_tools_2016.png" alt="bcc" title="bcc"></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#CentOS</span><br><span class="line">yum install -y bcc-tools</span><br><span class="line"></span><br><span class="line">ls /usr/share/bcc/tools</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/20/tcp%E5%8D%8A%E8%BF%9E%E6%8E%A5-%E5%85%A8%E8%BF%9E%E6%8E%A5%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/20/tcp%E5%8D%8A%E8%BF%9E%E6%8E%A5-%E5%85%A8%E8%BF%9E%E6%8E%A5%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">tcpåŠè¿æ¥/å…¨è¿æ¥æ ¸å¿ƒå‚æ•°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-20 14:34:27 / ä¿®æ”¹æ—¶é—´ï¼š14:35:01" itemprop="dateCreated datePublished" datetime="2026-01-20T14:34:27+08:00">2026-01-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä¸€ã€TCP-åŠè¿æ¥-å…¨è¿æ¥æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨"><a href="#ä¸€ã€TCP-åŠè¿æ¥-å…¨è¿æ¥æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨" class="headerlink" title="ä¸€ã€TCP åŠè¿æ¥ &#x2F; å…¨è¿æ¥æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨"></a>ä¸€ã€TCP åŠè¿æ¥ &#x2F; å…¨è¿æ¥æ ¸å¿ƒå‚æ•°å¯¹ç…§è¡¨</h2><h3 id="1ï¸âƒ£-net-ipv4-tcp-max-syn-backlog"><a href="#1ï¸âƒ£-net-ipv4-tcp-max-syn-backlog" class="headerlink" title="1ï¸âƒ£ net.ipv4.tcp_max_syn_backlog"></a>1ï¸âƒ£ <code>net.ipv4.tcp_max_syn_backlog</code></h3><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åç§°</strong></td>
<td>tcp_max_syn_backlog</td>
</tr>
<tr>
<td><strong>ä½œç”¨é˜¶æ®µ</strong></td>
<td>åŠè¿æ¥é˜Ÿåˆ—ï¼ˆSYN_RECV é˜¶æ®µï¼‰</td>
</tr>
<tr>
<td><strong>å«ä¹‰</strong></td>
<td>å†…æ ¸å…è®¸çš„æœ€å¤§ <strong>åŠè¿æ¥ï¼ˆSYN å·²æ”¶åˆ°ï¼Œä¸‰æ¬¡æ¡æ‰‹æœªå®Œæˆï¼‰</strong> æ•°é‡</td>
</tr>
<tr>
<td><strong>å…¸å‹ç°è±¡</strong></td>
<td>é˜Ÿåˆ—æ»¡æ—¶ï¼šä¸å› SYN+ACK æˆ–å¯ç”¨ syncookies</td>
</tr>
<tr>
<td><strong>ä½ çš„å½“å‰å€¼</strong></td>
<td><code>4096</code></td>
</tr>
<tr>
<td><strong>ä¸åŒå€¼çš„å½±å“</strong></td>
<td><ul><li>å°ï¼šçªå‘è¿æ¥æ—¶å¤§é‡ SYN è¶…æ—¶</li><li>å¤§ï¼šæå‡å¹¶å‘è¿æ¥å»ºç«‹èƒ½åŠ›ï¼ˆéœ€å†…å­˜ï¼‰</li></ul></td>
</tr>
<tr>
<td><strong>æŸ¥çœ‹æ–¹å¼</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_max_syn_backlog</code></td>
</tr>
<tr>
<td><strong>æ˜¯å¦å•ç‹¬ç”Ÿæ•ˆ</strong></td>
<td>âŒ å¦ï¼ˆå— somaxconnã€listen backlog å…±åŒé™åˆ¶ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3 id="2ï¸âƒ£-net-ipv4-tcp-syncookies"><a href="#2ï¸âƒ£-net-ipv4-tcp-syncookies" class="headerlink" title="2ï¸âƒ£ net.ipv4.tcp_syncookies"></a>2ï¸âƒ£ <code>net.ipv4.tcp_syncookies</code></h3><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åç§°</strong></td>
<td>tcp_syncookies</td>
</tr>
<tr>
<td><strong>ä½œç”¨é˜¶æ®µ</strong></td>
<td>åŠè¿æ¥é˜Ÿåˆ—æº¢å‡ºæ—¶</td>
</tr>
<tr>
<td><strong>å«ä¹‰</strong></td>
<td>åŠè¿æ¥é˜Ÿåˆ—æ»¡æ—¶ï¼Œæ˜¯å¦å¯ç”¨ <strong>SYN Cookies</strong></td>
</tr>
<tr>
<td><strong>ä½ çš„å½“å‰å€¼</strong></td>
<td><code>1</code></td>
</tr>
<tr>
<td><strong>ä¸åŒå€¼çš„ä½œç”¨</strong></td>
<td><ul><li><code>0</code>ï¼šå…³é—­ï¼ˆé˜Ÿåˆ—æ»¡ç›´æ¥ä¸¢ SYNï¼‰</li><li><code>1</code>ï¼šä»…é˜Ÿåˆ—æ»¡æ—¶å¯ç”¨ï¼ˆâ­æ¨èï¼‰</li><li><code>2</code>ï¼šæ— æ¡ä»¶å¯ç”¨ï¼ˆé˜² SYN floodï¼‰</li></ul></td>
</tr>
<tr>
<td><strong>æŸ¥çœ‹æ–¹å¼</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_syncookies</code></td>
</tr>
<tr>
<td><strong>æ³¨æ„ç‚¹</strong></td>
<td>å¼€å¯æ—¶éƒ¨åˆ† TCP æ‰©å±•ï¼ˆçª—å£æ‰©å¤§ã€æ—¶é—´æˆ³ï¼‰å¯èƒ½å—é™</td>
</tr>
</tbody></table>
<p>âœ… <strong>ç»“è®º</strong>ï¼šä½ çš„é…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒ<strong>æœ€åˆç†å€¼</strong></p>
<hr>
<h3 id="3ï¸âƒ£-net-core-somaxconn"><a href="#3ï¸âƒ£-net-core-somaxconn" class="headerlink" title="3ï¸âƒ£ net.core.somaxconn"></a>3ï¸âƒ£ <code>net.core.somaxconn</code></h3><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åç§°</strong></td>
<td>somaxconn</td>
</tr>
<tr>
<td><strong>ä½œç”¨é˜¶æ®µ</strong></td>
<td>å…¨è¿æ¥é˜Ÿåˆ—ï¼ˆaccept queueï¼‰</td>
</tr>
<tr>
<td><strong>å«ä¹‰</strong></td>
<td>ç³»ç»Ÿå±‚é¢å…è®¸çš„ <strong>listen backlog æœ€å¤§å€¼</strong></td>
</tr>
<tr>
<td><strong>ä½ çš„å½“å‰å€¼</strong></td>
<td><code>4096</code></td>
</tr>
<tr>
<td><strong>ä¸åŒå€¼çš„å½±å“</strong></td>
<td><ul><li>å°ï¼šaccept é˜Ÿåˆ—å¾ˆå®¹æ˜“æ»¡</li><li>å¤§ï¼šæ”¯æ’‘é«˜å¹¶å‘ accept</li></ul></td>
</tr>
<tr>
<td><strong>æŸ¥çœ‹æ–¹å¼</strong></td>
<td><code>cat /proc/sys/net/core/somaxconn</code></td>
</tr>
<tr>
<td><strong>æ˜¯å¦å†³å®šæœ€ç»ˆå€¼</strong></td>
<td>âŒ å¦ï¼ˆè¿˜å–å†³äºåº”ç”¨ listen backlogï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3 id="4ï¸âƒ£-net-ipv4-tcp-abort-on-overflow"><a href="#4ï¸âƒ£-net-ipv4-tcp-abort-on-overflow" class="headerlink" title="4ï¸âƒ£ net.ipv4.tcp_abort_on_overflow"></a>4ï¸âƒ£ <code>net.ipv4.tcp_abort_on_overflow</code></h3><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åç§°</strong></td>
<td>tcp_abort_on_overflow</td>
</tr>
<tr>
<td><strong>ä½œç”¨é˜¶æ®µ</strong></td>
<td>å…¨è¿æ¥é˜Ÿåˆ—æ»¡</td>
</tr>
<tr>
<td><strong>å«ä¹‰</strong></td>
<td>accept é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚ä½•å¤„ç†å®¢æˆ·ç«¯ ACK</td>
</tr>
<tr>
<td><strong>ä½ çš„å½“å‰å€¼</strong></td>
<td><code>0</code></td>
</tr>
<tr>
<td><strong>ä¸åŒå€¼çš„ä½œç”¨</strong></td>
<td><ul><li><code>0</code>ï¼šä¸¢ ACKï¼ˆå®¢æˆ·ç«¯é‡è¯• â†’ çœ‹èµ·æ¥åƒè¶…æ—¶ï¼‰</li><li><code>1</code>ï¼šå› RSTï¼ˆå®¢æˆ·ç«¯ç«‹åˆ»å¤±è´¥ï¼‰</li></ul></td>
</tr>
<tr>
<td><strong>æŸ¥çœ‹æ–¹å¼</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_abort_on_overflow</code></td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td><ul><li>0ï¼šçº¿ä¸Šä¸šåŠ¡ï¼ˆé¿å…è¯¯ä¼¤ï¼‰</li><li>1ï¼šå‹æµ‹&#x2F;å®šä½é—®é¢˜</li></ul></td>
</tr>
</tbody></table>
<p>âš ï¸ <strong>è¿™æ˜¯æ’éšœç¥å™¨ï¼Œä½†ä¸å»ºè®®é•¿æœŸçº¿ä¸Šå¼€å¯ 1</strong></p>
<hr>
<h3 id="5ï¸âƒ£-net-ipv4-tcp-synack-retries"><a href="#5ï¸âƒ£-net-ipv4-tcp-synack-retries" class="headerlink" title="5ï¸âƒ£ net.ipv4.tcp_synack_retries"></a>5ï¸âƒ£ <code>net.ipv4.tcp_synack_retries</code></h3><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åç§°</strong></td>
<td>tcp_synack_retries</td>
</tr>
<tr>
<td><strong>ä½œç”¨é˜¶æ®µ</strong></td>
<td>åŠè¿æ¥ä¿æ´»</td>
</tr>
<tr>
<td><strong>å«ä¹‰</strong></td>
<td>SYN+ACK æœ€å¤§é‡ä¼ æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>ä½ çš„å½“å‰å€¼</strong></td>
<td><code>5</code></td>
</tr>
<tr>
<td><strong>é»˜è®¤å€¼</strong></td>
<td>é€šå¸¸æ˜¯ 5</td>
</tr>
<tr>
<td><strong>ä¸åŒå€¼çš„å½±å“</strong></td>
<td><ul><li>å¤§ï¼šåŠè¿æ¥é©»ç•™æ—¶é—´é•¿</li><li>å°ï¼šæ›´å¿«é‡Šæ”¾åŠè¿æ¥</li></ul></td>
</tr>
<tr>
<td><strong>æŸ¥çœ‹æ–¹å¼</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_synack_retries</code></td>
</tr>
<tr>
<td><strong>ç»éªŒå€¼</strong></td>
<td>2ï½5ï¼ˆå†…ç½‘æœåŠ¡å¯é€‚å½“è°ƒå°ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="äºŒã€ä¸€ä¸ªéå¸¸é‡è¦ä½†å¸¸è¢«å¿½ç•¥çš„äº‹å®"><a href="#äºŒã€ä¸€ä¸ªéå¸¸é‡è¦ä½†å¸¸è¢«å¿½ç•¥çš„äº‹å®" class="headerlink" title="äºŒã€ä¸€ä¸ªéå¸¸é‡è¦ä½†å¸¸è¢«å¿½ç•¥çš„äº‹å®"></a>äºŒã€ä¸€ä¸ª<strong>éå¸¸é‡è¦ä½†å¸¸è¢«å¿½ç•¥çš„äº‹å®</strong></h2><h3 id="â—-åŠè¿æ¥-å…¨è¿æ¥çœŸæ­£çš„â€œç”Ÿæ•ˆé•¿åº¦â€å…¬å¼"><a href="#â—-åŠè¿æ¥-å…¨è¿æ¥çœŸæ­£çš„â€œç”Ÿæ•ˆé•¿åº¦â€å…¬å¼" class="headerlink" title="â— åŠè¿æ¥ &#x2F; å…¨è¿æ¥çœŸæ­£çš„â€œç”Ÿæ•ˆé•¿åº¦â€å…¬å¼"></a>â— åŠè¿æ¥ &#x2F; å…¨è¿æ¥çœŸæ­£çš„â€œç”Ÿæ•ˆé•¿åº¦â€å…¬å¼</h3><h4 id="ğŸ”¹-åŠè¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦"><a href="#ğŸ”¹-åŠè¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦" class="headerlink" title="ğŸ”¹ åŠè¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦"></a>ğŸ”¹ åŠè¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">min(</span><br><span class="line">  net.ipv4.tcp_max_syn_backlog,</span><br><span class="line">  net.core.somaxconn,</span><br><span class="line">  listen(backlog)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="ğŸ”¹-å…¨è¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦"><a href="#ğŸ”¹-å…¨è¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦" class="headerlink" title="ğŸ”¹ å…¨è¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦"></a>ğŸ”¹ å…¨è¿æ¥é˜Ÿåˆ—æœ€å¤§é•¿åº¦</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">min(</span><br><span class="line">  net.core.somaxconn,</span><br><span class="line">  listen(backlog)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ğŸ‘‰ <strong>åªè°ƒå†…æ ¸å‚æ•°ï¼Œä¸è°ƒåº”ç”¨ backlog &#x3D; ç™½è°ƒ</strong></p>
<hr>
<h2 id="ä¸‰ã€Redis-NGINX-backlog-é…ç½®å¯¹ç…§"><a href="#ä¸‰ã€Redis-NGINX-backlog-é…ç½®å¯¹ç…§" class="headerlink" title="ä¸‰ã€Redis &#x2F; NGINX backlog é…ç½®å¯¹ç…§"></a>ä¸‰ã€Redis &#x2F; NGINX backlog é…ç½®å¯¹ç…§</h2><h3 id="ğŸŸ¥-Redis"><a href="#ğŸŸ¥-Redis" class="headerlink" title="ğŸŸ¥ Redis"></a>ğŸŸ¥ Redis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># redis.conf</span><br><span class="line">tcp-backlog 511</span><br></pre></td></tr></table></figure>

<ul>
<li>å®é™…ç”Ÿæ•ˆå€¼ï¼š</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min(tcp-backlog, somaxconn)</span><br></pre></td></tr></table></figure>

<p>ğŸ“Œ å»ºè®®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp-backlog 4096</span><br></pre></td></tr></table></figure>

<p>å¹¶é…åˆï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.core.somaxconn=4096</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸŸ©-NGINX"><a href="#ğŸŸ©-NGINX" class="headerlink" title="ğŸŸ© NGINX"></a>ğŸŸ© NGINX</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">listen</span> <span class="number">80</span> backlog=<span class="number">4096</span>;</span><br></pre></td></tr></table></figure>

<p>âš ï¸ å¦‚æœä¸æ˜¾å¼é…ç½®ï¼š</p>
<ul>
<li>ç”± NGINX å†…éƒ¨é»˜è®¤å€¼å†³å®š</li>
<li>å¾ˆå¤šç‰ˆæœ¬é»˜è®¤ <strong>511</strong></li>
</ul>
<p>ğŸ“Œ é«˜å¹¶å‘å…¥å£ï¼ˆIngress &#x2F; API Gatewayï¼‰<strong>ä¸€å®šè¦æ˜¾å¼å†™ backlog</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/19/tc%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/19/tc%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">tcæµé‡æ§åˆ¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-19 11:07:52 / ä¿®æ”¹æ—¶é—´ï¼š12:15:03" itemprop="dateCreated datePublished" datetime="2026-01-19T11:07:52+08:00">2026-01-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æµé‡æ§åˆ¶å¤„ç†å¯¹è±¡"><a href="#æµé‡æ§åˆ¶å¤„ç†å¯¹è±¡" class="headerlink" title="æµé‡æ§åˆ¶å¤„ç†å¯¹è±¡"></a>æµé‡æ§åˆ¶å¤„ç†å¯¹è±¡</h2><ul>
<li>æµé‡çš„å¤„ç†ç”±ä¸‰ç§å¯¹è±¡æ§åˆ¶ï¼Œå®ƒä»¬æ˜¯ï¼šqdiscï¼ˆæ’é˜Ÿè§„åˆ™ï¼‰ã€classï¼ˆç±»åˆ«ï¼‰å’Œfilterï¼ˆè¿‡æ»¤å™¨ï¼‰</li>
</ul>
<h2 id="TCå¸¸ç”¨å‘½ä»¤"><a href="#TCå¸¸ç”¨å‘½ä»¤" class="headerlink" title="TCå¸¸ç”¨å‘½ä»¤"></a>TCå¸¸ç”¨å‘½ä»¤</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">1ï¼‰æ¨¡æ‹Ÿå»¶è¿Ÿä¼ è¾“ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºå»¶è¿Ÿ 100 æ¯«ç§’å‘é€ï¼Œæ›´çœŸå®çš„æƒ…å†µä¸‹,å»¶è¿Ÿå€¼ä¸ä¼šè¿™ä¹ˆç²¾ç¡®ï¼Œä¼šæœ‰ä¸€å®šçš„æ³¢åŠ¨ï¼Œåé¢ç”¨ä¸‹é¢çš„æƒ…å†µæ¥æ¨¡æ‹Ÿå‡ºå¸¦æœ‰æ³¢åŠ¨æ€§çš„å»¶è¿Ÿå€¼</span><br><span class="line"></span><br><span class="line">2ï¼‰æ¨¡æ‹Ÿå»¶è¿Ÿæ³¢åŠ¨ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms 10ms</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºå»¶è¿Ÿ 100ms Â± 10ms (90 ~ 110 ms ä¹‹é—´çš„ä»»æ„å€¼)å‘é€ã€‚ è¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥åŠ å¼ºè¿™ç§æ³¢åŠ¨çš„éšæœºæ€§</span><br><span class="line"></span><br><span class="line">3ï¼‰å»¶è¿Ÿæ³¢åŠ¨éšæœºæ€§ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms 10ms 30%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸º 100ms ,åŒæ—¶,å¤§çº¦æœ‰ 30% çš„åŒ…ä¼šå»¶è¿Ÿ Â± 10ms å‘é€ã€‚</span><br><span class="line"></span><br><span class="line">4ï¼‰æ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem loss 1%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºéšæœºä¸¢æ‰ 1% çš„æ•°æ®åŒ…</span><br><span class="line"></span><br><span class="line">5ï¼‰ç½‘ç»œä¸¢åŒ…æˆåŠŸç‡ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem loss 1% 30%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºéšæœºä¸¢æ‰ 1% çš„æ•°æ®åŒ…,æˆåŠŸç‡ä¸º 30%</span><br><span class="line"></span><br><span class="line">6ï¼‰åˆ é™¤ç›¸å…³é…ç½®ï¼ˆå°†ä¹‹å‰å‘½ä»¤ä¸­çš„ add æ”¹ä¸º del å³å¯åˆ é™¤é…ç½®ï¼‰ï¼š</span><br><span class="line"># tc qdisc del dev eth0 root netem delay 100ms</span><br><span class="line"></span><br><span class="line">7ï¼‰æ¨¡æ‹ŸåŒ…é‡å¤ï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem duplicate 1%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºéšæœºäº§ç”Ÿ 1% çš„é‡å¤æ•°æ®åŒ…</span><br><span class="line"></span><br><span class="line">8ï¼‰æ¨¡æ‹ŸåŒ…æŸåï¼š</span><br><span class="line"># tc qdisc add dev eth0 root netem corrupt 0.2%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸ºéšæœºäº§ç”Ÿ 0.2% çš„æŸåçš„æ•°æ®åŒ… ã€‚ (å†…æ ¸ç‰ˆæœ¬éœ€åœ¨ 2.6.16 ä»¥ä¸Š)</span><br><span class="line"></span><br><span class="line">9ï¼‰æ¨¡æ‹ŸåŒ…ä¹±åºï¼š</span><br><span class="line"># tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%</span><br><span class="line">è¯¥å‘½ä»¤å°† eth0 ç½‘å¡çš„ä¼ è¾“è®¾ç½®ä¸º:æœ‰ 25% çš„æ•°æ®åŒ…(50%ç›¸å…³)ä¼šè¢«ç«‹å³å‘é€,å…¶ä»–çš„å»¶è¿Ÿ10 ç§’ã€‚</span><br><span class="line">æ–°ç‰ˆæœ¬ä¸­,å¦‚ä¸‹å‘½ä»¤ä¹Ÿä¼šåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‰“ä¹±å‘åŒ…çš„æ¬¡åº:# tc qdisc add dev eth0 root netem delay 100ms 10ms</span><br><span class="line"> </span><br><span class="line">10ï¼‰æŸ¥çœ‹ç½‘å¡é…ç½®ï¼š</span><br><span class="line"># tc qdisc show dev eth0</span><br><span class="line">è¯¥å‘½ä»¤å°† æŸ¥çœ‹å¹¶æ˜¾ç¤º eth0 ç½‘å¡çš„ç›¸å…³ä¼ è¾“é…ç½®</span><br><span class="line"></span><br><span class="line">11ï¼‰æŸ¥çœ‹ä¸¢åŒ…ç‡ï¼š</span><br><span class="line"># tc -s qdisc show dev eth0</span><br></pre></td></tr></table></figure>

<h2 id="æ¶æ„å‚è€ƒ"><a href="#æ¶æ„å‚è€ƒ" class="headerlink" title="æ¶æ„å‚è€ƒ"></a>æ¶æ„å‚è€ƒ</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/traffic-control-from-queue-to-edt-zh/">https://arthurchiao.art/blog/traffic-control-from-queue-to-edt-zh/</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2045045">https://cloud.tencent.com/developer/article/2045045</a><br><a target="_blank" rel="noopener" href="https://wiki.dreamrunner.org/public_html/Linux/Networks/netfilter.html">https://wiki.dreamrunner.org/public_html/Linux/Networks/netfilter.html</a><br>å¯è§†åŒ–å·¥å…·ï¼š<a target="_blank" rel="noopener" href="https://github.com/vitawasalreadytaken/tcviz">https://github.com/vitawasalreadytaken/tcviz</a><br>è·¯å¾„åˆ†æ:<a target="_blank" rel="noopener" href="https://just4coding.com/2023/08/24/docker-bridge/">https://just4coding.com/2023/08/24/docker-bridge/</a><br>ç½‘ç»œè™šæ‹Ÿè®¾å¤‡ï¼š<a target="_blank" rel="noopener" href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#">https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/16/GPU-vs-CPU-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/16/GPU-vs-CPU-%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">GPU vs CPU åŸºå‡†æµ‹è¯•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-16 19:44:17 / ä¿®æ”¹æ—¶é—´ï¼š20:05:22" itemprop="dateCreated datePublished" datetime="2026-01-16T19:44:17+08:00">2026-01-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi               # GPU ä¿¡æ¯</span><br><span class="line">nvidia-smi topo -m</span><br><span class="line">nvcc --version</span><br><span class="line">nvidia-smi dmon          # è¯¦ç»†ç›‘æ§</span><br><span class="line"></span><br><span class="line"># æ¯ 0.5 ç§’åˆ·æ–°ä¸€æ¬¡</span><br><span class="line">watch -n 0.5 nvidia-smi</span><br><span class="line"></span><br><span class="line"># æ¯ç§’åˆ·æ–°ï¼ˆå†…ç½®ï¼‰</span><br><span class="line">nvidia-smi -l 1</span><br><span class="line"></span><br><span class="line"># è®¾å¤‡ç›‘æ§æ¨¡å¼ï¼ˆæ›´è¯¦ç»†ï¼‰</span><br><span class="line">nvidia-smi dmon -s pucvmet</span><br><span class="line"></span><br><span class="line">#åªçœ‹å…³é”®æŒ‡æ ‡</span><br><span class="line">nvidia-smi --query-gpu=timestamp,name,temperature.gpu,utilization.gpu,utilization.memory,memory.used,memory.total,power.draw --format=csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">python3 -c &quot;</span><br><span class="line">import torch</span><br><span class="line">print(&#x27;PyTorchç‰ˆæœ¬:&#x27;, torch.__version__)</span><br><span class="line">print(&#x27;CUDAæ˜¯å¦å¯ç”¨:&#x27;, torch.cuda.is_available())</span><br><span class="line">print(&#x27;GPUè®¾å¤‡æ•°é‡:&#x27;, torch.cuda.device_count())</span><br><span class="line">print(&#x27;å½“å‰GPU:&#x27;, torch.cuda.get_device_name(0))</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">nvidia-smi pmon -c 1</span><br><span class="line"># gpu        pid  type    sm   mem   enc   dec   command</span><br><span class="line"># Idx          #   C/G     %     %     %     %   name</span><br><span class="line">    0     917801     C    61     9     -     -   python3</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•è„šæœ¬"><a href="#æµ‹è¯•è„šæœ¬" class="headerlink" title="æµ‹è¯•è„šæœ¬"></a>æµ‹è¯•è„šæœ¬</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">import torch</span><br><span class="line">import numpy as np</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def benchmark_gpu(size=5000, iterations=10, warmup=3):</span><br><span class="line">    &quot;&quot;&quot;GPU åŸºå‡†æµ‹è¯•&quot;&quot;&quot;</span><br><span class="line">    print(f&quot;=== GPU åŸºå‡†æµ‹è¯• (PyTorch + CUDA) ===&quot;)</span><br><span class="line">    print(f&quot;çŸ©é˜µå¤§å°: &#123;size&#125;x&#123;size&#125;, è¿­ä»£æ¬¡æ•°: &#123;iterations&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    # é¢„çƒ­ GPU</span><br><span class="line">    for _ in range(warmup):</span><br><span class="line">        a = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        b = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        c = torch.matmul(a, b)</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line">    </span><br><span class="line">    # æ­£å¼æµ‹è¯•</span><br><span class="line">    times = []</span><br><span class="line">    for i in range(iterations):</span><br><span class="line">        a = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        b = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line">        </span><br><span class="line">        t0 = time.time()</span><br><span class="line">        c = torch.matmul(a, b)</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line">        </span><br><span class="line">        elapsed = time.time() - t0</span><br><span class="line">        times.append(elapsed)</span><br><span class="line">        print(f&quot;  è¿­ä»£ &#123;i+1&#125;: &#123;elapsed:.4f&#125;s&quot;)</span><br><span class="line">    </span><br><span class="line">    avg_time = np.mean(times)</span><br><span class="line">    std_time = np.std(times)</span><br><span class="line">    print(f&quot;å¹³å‡æ—¶é—´: &#123;avg_time:.4f&#125;s Â± &#123;std_time:.4f&#125;s&quot;)</span><br><span class="line">    print(f&quot;GPU ä¿¡æ¯: &#123;torch.cuda.get_device_name(0)&#125;&quot;)</span><br><span class="line">    return avg_time</span><br><span class="line"></span><br><span class="line">def benchmark_cpu(size=5000, iterations=10):</span><br><span class="line">    &quot;&quot;&quot;CPU åŸºå‡†æµ‹è¯•&quot;&quot;&quot;</span><br><span class="line">    print(f&quot;\n=== CPU åŸºå‡†æµ‹è¯• (NumPy) ===&quot;)</span><br><span class="line">    print(f&quot;çŸ©é˜µå¤§å°: &#123;size&#125;x&#123;size&#125;, è¿­ä»£æ¬¡æ•°: &#123;iterations&#125;&quot;)</span><br><span class="line">    </span><br><span class="line">    times = []</span><br><span class="line">    for i in range(iterations):</span><br><span class="line">        a = np.random.rand(size, size)</span><br><span class="line">        b = np.random.rand(size, size)</span><br><span class="line">        </span><br><span class="line">        t0 = time.time()</span><br><span class="line">        c = np.dot(a, b)</span><br><span class="line">        elapsed = time.time() - t0</span><br><span class="line">        </span><br><span class="line">        times.append(elapsed)</span><br><span class="line">        print(f&quot;  è¿­ä»£ &#123;i+1&#125;: &#123;elapsed:.4f&#125;s&quot;)</span><br><span class="line">    </span><br><span class="line">    avg_time = np.mean(times)</span><br><span class="line">    std_time = np.std(times)</span><br><span class="line">    print(f&quot;å¹³å‡æ—¶é—´: &#123;avg_time:.4f&#125;s Â± &#123;std_time:.4f&#125;s&quot;)</span><br><span class="line">    return avg_time</span><br><span class="line"></span><br><span class="line">def benchmark_different_sizes():</span><br><span class="line">    &quot;&quot;&quot;æµ‹è¯•ä¸åŒçŸ©é˜µå¤§å°&quot;&quot;&quot;</span><br><span class="line">    print(&quot;\n=== ä¸åŒçŸ©é˜µå¤§å°å¯¹æ¯” ===&quot;)</span><br><span class="line">    sizes = [1000, 2000, 5000, 8000]</span><br><span class="line">    </span><br><span class="line">    for size in sizes:</span><br><span class="line">        print(f&quot;\nçŸ©é˜µå¤§å°: &#123;size&#125;x&#123;size&#125;&quot;)</span><br><span class="line">        </span><br><span class="line">        # GPU</span><br><span class="line">        a = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        b = torch.randn(size, size, device=&quot;cuda&quot;)</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line">        t0 = time.time()</span><br><span class="line">        c = torch.matmul(a, b)</span><br><span class="line">        torch.cuda.synchronize()</span><br><span class="line">        gpu_time = time.time() - t0</span><br><span class="line">        </span><br><span class="line">        # CPU</span><br><span class="line">        a_np = np.random.rand(size, size)</span><br><span class="line">        b_np = np.random.rand(size, size)</span><br><span class="line">        t0 = time.time()</span><br><span class="line">        c_np = np.dot(a_np, b_np)</span><br><span class="line">        cpu_time = time.time() - t0</span><br><span class="line">        </span><br><span class="line">        speedup = cpu_time / gpu_time</span><br><span class="line">        print(f&quot;  GPU: &#123;gpu_time:.4f&#125;s | CPU: &#123;cpu_time:.4f&#125;s | åŠ é€Ÿæ¯”: &#123;speedup:.2f&#125;x&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    # æ£€æŸ¥ CUDA æ˜¯å¦å¯ç”¨</span><br><span class="line">    if not torch.cuda.is_available():</span><br><span class="line">        print(&quot;é”™è¯¯: CUDA ä¸å¯ç”¨ï¼Œæ— æ³•è¿è¡Œ GPU æµ‹è¯•&quot;)</span><br><span class="line">        exit(1)</span><br><span class="line">    </span><br><span class="line">    # è¿è¡ŒåŸºå‡†æµ‹è¯•</span><br><span class="line">    gpu_avg = benchmark_gpu(size=5000, iterations=10)</span><br><span class="line">    cpu_avg = benchmark_cpu(size=5000, iterations=10)</span><br><span class="line">    </span><br><span class="line">    print(f&quot;\n=== æ€»ç»“ ===&quot;)</span><br><span class="line">    print(f&quot;GPU å¹³å‡æ—¶é—´: &#123;gpu_avg:.4f&#125;s&quot;)</span><br><span class="line">    print(f&quot;CPU å¹³å‡æ—¶é—´: &#123;cpu_avg:.4f&#125;s&quot;)</span><br><span class="line">    print(f&quot;GPU åŠ é€Ÿæ¯”: &#123;cpu_avg/gpu_avg:.2f&#125;x&quot;)</span><br><span class="line">    </span><br><span class="line">    # ä¸åŒçŸ©é˜µå¤§å°æµ‹è¯•</span><br><span class="line">    benchmark_different_sizes()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/12/ksoftirqd%E5%BB%B6%E8%BF%9F%E5%8F%8Abpftrace%E7%94%A8%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/12/ksoftirqd%E5%BB%B6%E8%BF%9F%E5%8F%8Abpftrace%E7%94%A8%E6%B3%95/" class="post-title-link" itemprop="url">ksoftirqdå»¶è¿ŸåŠbpftraceç”¨æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2026-01-12 10:14:14 / ä¿®æ”¹æ—¶é—´ï¼š10:22:58" itemprop="dateCreated datePublished" datetime="2026-01-12T10:14:14+08:00">2026-01-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å»¶è¿Ÿæ’æŸ¥è¯´æ˜"><a href="#å»¶è¿Ÿæ’æŸ¥è¯´æ˜" class="headerlink" title="å»¶è¿Ÿæ’æŸ¥è¯´æ˜"></a>å»¶è¿Ÿæ’æŸ¥è¯´æ˜</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.alibabacloud.com/help/zh/alinux/user-guide/use-ksoftirqd-to-troubleshoot-latency-issues">https://www.alibabacloud.com/help/zh/alinux/user-guide/use-ksoftirqd-to-troubleshoot-latency-issues</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#ä¸‹è½½</span><br><span class="line">sudo wget https://gitee.com/dtcccccc/softirq_net_latency/raw/master/softirq_net_latency.bt</span><br><span class="line"></span><br><span class="line">#å®‰è£…</span><br><span class="line">yum install -y bpftrace</span><br><span class="line">#ä½¿ç”¨ï¼šé€šè¿‡bpftraceæ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨è¶…è¿‡100msçš„NET_RXç±»å‹çš„softirqå»¶è¿Ÿ</span><br><span class="line">bpftrace ./softirq_net_latency.bt 100000</span><br><span class="line">Attaching 5 probes...</span><br><span class="line">Tracing softirq wait-time latency ... Hit Ctrl-C to end.</span><br><span class="line"> - Will report on latency above 10000 usecs (= 10 ms)</span><br><span class="line">20:07:05 High IRQ-to-softirq latency: 11155 usec (11 ms) on CPU:3 comm:nginx</span><br><span class="line">20:07:05 High IRQ-to-softirq latency: 28662 usec (28 ms) on CPU:29 comm:cron</span><br><span class="line">20:07:05 High IRQ-to-softirq latency: 37188 usec (37 ms) on CPU:41 comm:vector-worker</span><br><span class="line"></span><br><span class="line">@softirq_wait_nanosec:</span><br><span class="line">[128, 256)           187 |                                                    |</span><br><span class="line">[256, 512)       1733833 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|</span><br><span class="line">[512, 1K)        1195045 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                 |</span><br><span class="line">[1K, 2K)          252455 |@@@@@@@                                             |</span><br><span class="line">[2K, 4K)           72816 |@@                                                  |</span><br><span class="line">[4K, 8K)           77342 |@@                                                  |</span><br><span class="line">[8K, 16K)          36643 |@                                                   |</span><br><span class="line">[16K, 32K)          8618 |                                                    |</span><br><span class="line">[32K, 64K)           926 |                                                    |</span><br><span class="line">[64K, 128K)           59 |                                                    |</span><br><span class="line">[128K, 256K)          21 |                                                    |</span><br><span class="line">[256K, 512K)          23 |                                                    |</span><br><span class="line">[512K, 1M)            22 |                                                    |</span><br><span class="line">[1M, 2M)               5 |                                                    |</span><br><span class="line">[2M, 4M)               0 |                                                    |</span><br><span class="line">[4M, 8M)               0 |                                                    |</span><br><span class="line">[8M, 16M)              1 |                                                    |</span><br><span class="line">[16M, 32M)             1 |                                                    |</span><br><span class="line">[32M, 64M)             1 |                                                    |</span><br><span class="line"></span><br><span class="line">#æ³¨</span><br><span class="line">å¦‚æœæŠ¥å‘Šçš„è¿›ç¨‹åç§°ï¼ˆcommï¼‰ä¸ºksoftirqd/$cpuï¼Œåˆ™è¯´æ˜å»¶è¿Ÿæ˜¯ç”±äºksoftirqdçº¿ç¨‹å¾—ä¸åˆ°è°ƒåº¦å¯¼è‡´çš„ã€‚</span><br><span class="line">å°½ç®¡softirqä»»åŠ¡å·²è¢«è½¬ç§»è‡³æ™®é€šä¼˜å…ˆçº§çš„ksoftirqdå†…æ ¸çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä½†ç”±äºè¯¥çº¿ç¨‹å¤„ç†ä»»åŠ¡æ‰€éœ€æ—¶é—´ç›¸å¯¹è¾ƒçŸ­ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´å¤„äºç¡çœ çŠ¶æ€ï¼Œå› æ­¤å†…æ ¸è°ƒåº¦ç­–ç•¥ä»ç„¶å€¾å‘äºä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°ƒåº¦å»¶è¿Ÿä¾ç„¶æ˜¾è‘—ï¼Œéœ€å¯¹å¯èƒ½çš„å¼‚å¸¸æƒ…å†µè¿›è¡Œæ’æŸ¥ï¼Œä¾‹å¦‚å½“å‰CPUä¸Šæ˜¯å¦å­˜åœ¨ä¼˜å…ˆçº§æ›´é«˜çš„å®æ—¶ä»»åŠ¡ï¼Œæˆ–æŸä¸ªä»»åŠ¡åœ¨å†…æ ¸æ€ä¸­è€—æ—¶è¿‡é•¿ï¼Œå¯¼è‡´ksoftirqdå†…æ ¸çº¿ç¨‹æ— æ³•è·å¾—è°ƒåº¦ç­‰ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="softirq-net-latency-btæ–‡ä»¶å†…å®¹"><a href="#softirq-net-latency-btæ–‡ä»¶å†…å®¹" class="headerlink" title="softirq_net_latency.btæ–‡ä»¶å†…å®¹"></a>softirq_net_latency.btæ–‡ä»¶å†…å®¹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bpftrace</span><br><span class="line">/* SPDX-License-Identifier: GPL-2.0+</span><br><span class="line"> *</span><br><span class="line"> * Catching high network IRQ-to-softirq latency by measuing time</span><br><span class="line"> * between softirq &quot;raise&quot; until softirq function is called.  Limited</span><br><span class="line"> * to network via softirq vector NET_RX_SOFTIRQ (3).</span><br><span class="line"> *</span><br><span class="line"> * This script was used for detecting latency issues described in blog:</span><br><span class="line"> *  https://github.blog/2019-11-21-debugging-network-stalls-on-kubernetes/</span><br><span class="line"> *</span><br><span class="line"> * Output examples from this script can be seen in:</span><br><span class="line"> *  https://bugzilla.redhat.com/show_bug.cgi?id=1795049#c8</span><br><span class="line"> *</span><br><span class="line"> * 26-Jan-2020	Jesper Dangaard Brouer	Created this</span><br><span class="line"> * 27-Feb-2024	Jesper Dangaard Brouer	Updated based on production usage</span><br><span class="line"> */</span><br><span class="line">BEGIN</span><br><span class="line">&#123;</span><br><span class="line">	/* Cmdline arg#1: latency threshold input in usec */</span><br><span class="line">	@threshold_usecs = $1 ? $1: 2000;</span><br><span class="line">	/* Cmdline arg#2: enable measuring runtime of softirq func */</span><br><span class="line">	@measure_runtime = $2;</span><br><span class="line">	printf(&quot;Tracing softirq wait-time latency ... Hit Ctrl-C to end.\n&quot;);</span><br><span class="line">	printf(&quot; - Will report on latency above %d usecs (= %d ms)\n&quot;,</span><br><span class="line">	       @threshold_usecs, @threshold_usecs / 1000);</span><br><span class="line">	if (@measure_runtime) &#123;</span><br><span class="line">		printf(&quot; - Also record runtime of softirq func call\n&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	@threshold_ns = @threshold_usecs * 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:irq:softirq_raise</span><br><span class="line">/args-&gt;vec == 3/   /* NET_RX_SOFTIRQ = 3 */</span><br><span class="line">&#123;</span><br><span class="line">	if (!@start[cpu]) &#123;</span><br><span class="line">		/* Only catch first softirq_raise, to measure time</span><br><span class="line">		 * until softirq_entry happens.  Other raise events</span><br><span class="line">		 * could be triggered by other NICs.</span><br><span class="line">		 */</span><br><span class="line">		@start[cpu] = nsecs;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:irq:softirq_entry</span><br><span class="line">/args-&gt;vec == 3/</span><br><span class="line">&#123;</span><br><span class="line">	if (@start[cpu] &gt; 0) &#123;</span><br><span class="line">		$lat = nsecs - @start[cpu];</span><br><span class="line">		@softirq_wait_nanosec = hist($lat);</span><br><span class="line"></span><br><span class="line">		/* Report on &quot;not-able-to-run&quot; events over threshold */</span><br><span class="line">		if ($lat &gt;= @threshold_ns) &#123;</span><br><span class="line">			// @stack[cpu, $lat] = kstack; //no useful stack</span><br><span class="line">			time(&quot;%H:%M:%S &quot;);</span><br><span class="line">			printf(&quot;High IRQ-to-softirq latency: %d usec (%d ms) on CPU:%d comm:%s\n&quot;,</span><br><span class="line">			       $lat / 1000, $lat / 1000000, cpu, comm);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	delete(@start[cpu]);</span><br><span class="line">	if (@measure_runtime) &#123;</span><br><span class="line">		@runtime[cpu] = nsecs;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tracepoint:irq:softirq_exit</span><br><span class="line">/args-&gt;vec == 3/</span><br><span class="line">&#123;</span><br><span class="line">	if (@measure_runtime &amp;&amp; @runtime[cpu] &gt; 0) &#123;</span><br><span class="line">		$lat = nsecs - @runtime[cpu];</span><br><span class="line">		@runtime_nanosec = hist($lat);</span><br><span class="line"></span><br><span class="line">		/* Report on &quot;runtime&quot; events over threshold */</span><br><span class="line">		if ($lat &gt;= @threshold_ns) &#123;</span><br><span class="line">			time(&quot;%H:%M:%S &quot;);</span><br><span class="line">			printf(&quot;Long softirq runtime: %d usec (%d ms) on CPU:%d comm:%s\n&quot;,</span><br><span class="line">			       $lat / 1000, $lat / 1000000, cpu, comm);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	delete(@runtime[cpu]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line">&#123;	/* Default bpftrace will print all remaining maps at END */</span><br><span class="line">	clear(@measure_runtime);</span><br><span class="line">	clear(@threshold_usecs);</span><br><span class="line">	clear(@threshold_ns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">173</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
