<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shispring.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shispring">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/02/04/kafka%E5%AE%9E%E8%B7%B5Demo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/02/04/kafka%E5%AE%9E%E8%B7%B5Demo/" class="post-title-link" itemprop="url">kafka实践Demo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-02-04 15:16:27 / 修改时间：18:07:59" itemprop="dateCreated datePublished" datetime="2026-02-04T15:16:27+08:00">2026-02-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="docker-compose-yaml"><a href="#docker-compose-yaml" class="headerlink" title="docker-compose.yaml"></a>docker-compose.yaml</h2><ul>
<li>10.147.100.100为宿主机ip</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.8&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  zookeeper:</span><br><span class="line">    image: bitnami/zookeeper:3.9.3</span><br><span class="line">    container_name: zookeeper</span><br><span class="line">    environment:</span><br><span class="line">      - ALLOW_ANONYMOUS_LOGIN=yes</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line"></span><br><span class="line">  kafka:</span><br><span class="line">    image: bitnami/kafka:3.6.2</span><br><span class="line">    container_name: kafka</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;19092:19092&quot;   # 给宿主机用</span><br><span class="line">    environment:</span><br><span class="line">      - KAFKA_BROKER_ID=1</span><br><span class="line">      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181</span><br><span class="line"></span><br><span class="line">      # 两个 listener</span><br><span class="line">      - KAFKA_CFG_LISTENERS=INTERNAL://:9092,EXTERNAL://:19092</span><br><span class="line">      - KAFKA_CFG_ADVERTISED_LISTENERS=INTERNAL://kafka:9092,EXTERNAL://10.147.100.100:19092</span><br><span class="line">      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT</span><br><span class="line">      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL</span><br><span class="line"></span><br><span class="line">      - ALLOW_PLAINTEXT_LISTENER=yes</span><br><span class="line">    depends_on:</span><br><span class="line">      - zookeeper</span><br><span class="line"></span><br><span class="line">  kafka-ui:</span><br><span class="line">    image: provectuslabs/kafka-ui:latest</span><br><span class="line">    container_name: kafka-ui</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8080:8080&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - KAFKA_CLUSTERS_0_NAME=local</span><br><span class="line">      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092</span><br></pre></td></tr></table></figure>

<h2 id="cli操作"><a href="#cli操作" class="headerlink" title="cli操作"></a>cli操作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#进入容器操作</span><br><span class="line">docker exec -it kafka bash</span><br><span class="line"></span><br><span class="line"># 生产</span><br><span class="line">kafka-console-producer.sh \</span><br><span class="line">  --bootstrap-server kafka:9092 \</span><br><span class="line">  --topic test-topic \</span><br><span class="line">  --property parse.key=true \</span><br><span class="line">  --property key.separator=:</span><br><span class="line">#输入</span><br><span class="line">&gt;a:hello</span><br><span class="line">&gt;b:world</span><br><span class="line">&gt;c:kafka</span><br><span class="line"></span><br><span class="line"># 消费</span><br><span class="line"># 一个 partition，在同一个 group 内，只会被一个 consumer 消费</span><br><span class="line">kafka-console-consumer.sh \</span><br><span class="line">  --bootstrap-server kafka:9092 \</span><br><span class="line">  --topic test-topic \</span><br><span class="line">  --group g1 \</span><br><span class="line">  --from-beginning \</span><br><span class="line">  --property print.key=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="go版本消费者"><a href="#go版本消费者" class="headerlink" title="go版本消费者"></a>go版本消费者</h2><blockquote>
<p>代理处置：<br>go env -w GOPROXY&#x3D;<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/goproxy/,direct">https://mirrors.aliyun.com/goproxy/,direct</a>  或者 go env -w GOPROXY&#x3D;<a target="_blank" rel="noopener" href="https://goproxy.cn,direct/">https://goproxy.cn,direct</a><br>go env -w GOSUMDB&#x3D;sum.golang.org</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line">	&quot;os/signal&quot;</span><br><span class="line">	&quot;syscall&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com/IBM/sarama&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">type Consumer struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">func (Consumer) Setup(sarama.ConsumerGroupSession) error   &#123; return nil &#125;</span><br><span class="line">func (Consumer) Cleanup(sarama.ConsumerGroupSession) error &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">func (Consumer) ConsumeClaim(</span><br><span class="line">	session sarama.ConsumerGroupSession,</span><br><span class="line">	claim sarama.ConsumerGroupClaim,</span><br><span class="line">) error &#123;</span><br><span class="line">	for msg := range claim.Messages() &#123;</span><br><span class="line">		fmt.Printf(</span><br><span class="line">			&quot;partition=%d offset=%d key=%s value=%s\n&quot;,</span><br><span class="line">			msg.Partition,</span><br><span class="line">			msg.Offset,</span><br><span class="line">			string(msg.Key),</span><br><span class="line">			string(msg.Value),</span><br><span class="line">		)</span><br><span class="line">		session.MarkMessage(msg, &quot;&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	config := sarama.NewConfig()</span><br><span class="line">	config.Version = sarama.V3_6_0_0</span><br><span class="line">	config.Consumer.Offsets.Initial = sarama.OffsetOldest</span><br><span class="line"></span><br><span class="line">	brokers := []string&#123;&quot;10.147.100.100:19092&quot;&#125;</span><br><span class="line">	groupID := &quot;g1&quot;</span><br><span class="line">	topics := []string&#123;&quot;test-topic&quot;&#125;</span><br><span class="line"></span><br><span class="line">	consumerGroup, err := sarama.NewConsumerGroup(brokers, groupID, config)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	go func() &#123;</span><br><span class="line">		for &#123;</span><br><span class="line">			if err := consumerGroup.Consume(ctx, topics, Consumer&#123;&#125;); err != nil &#123;</span><br><span class="line">				log.Println(&quot;consume error:&quot;, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	// 优雅退出</span><br><span class="line">	sig := make(chan os.Signal, 1)</span><br><span class="line">	signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">	&lt;-sig</span><br><span class="line">	cancel()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="验证零拷贝"><a href="#验证零拷贝" class="headerlink" title="验证零拷贝"></a>验证零拷贝</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#编译消费二进程程序</span><br><span class="line">#go build -o kafka-consumer main.go</span><br><span class="line"></span><br><span class="line">#查找kafka进程</span><br><span class="line">docker inspect kafka | grep -i pid</span><br><span class="line"></span><br><span class="line">#找到容器内运行的Java进程</span><br><span class="line">pstree -p 168412</span><br><span class="line">docker-init(168412)───java(168525)─┬─&#123;java&#125;(169263)</span><br><span class="line">                                   ├─&#123;java&#125;(169264)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 生产数据</span><br><span class="line"># 消费数据</span><br><span class="line">[root@def0702n3 kafka-demo]$ ./kafka-consumer</span><br><span class="line">partition=0 offset=11 key=test value=111</span><br><span class="line">partition=0 offset=12 key=test value=222</span><br><span class="line"></span><br><span class="line"># 查看抓取内核调用</span><br><span class="line"># Kakfa 服务端向 Consumer 发送消息的场景下使用 sendfile 机制</span><br><span class="line">[root@def0702n3 kafka]# strace -f -p 168525 -e trace=sendfile</span><br><span class="line">strace: Process 168525 attached with 119 threads</span><br><span class="line">[pid 169557] sendfile(163, 161, [836] =&gt; [911], 75) = 75</span><br><span class="line">[pid 169557] sendfile(163, 161, [911] =&gt; [986], 75) = 75</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="零拷贝技术"><a href="#零拷贝技术" class="headerlink" title="零拷贝技术"></a>零拷贝技术</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sendfile</span><br><span class="line">mmap</span><br><span class="line">splice</span><br><span class="line">直接 Direct I/O</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<h3 id="传统方式（有拷贝）"><a href="#传统方式（有拷贝）" class="headerlink" title="传统方式（有拷贝）"></a>传统方式（有拷贝）</h3><p>如果不使用零拷贝，数据传输需要经过<strong>4次拷贝和2次上下文切换</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">磁盘 → 内核缓冲区 → 用户空间缓冲区 → Socket 缓冲区 → 网卡</span><br><span class="line">     (DMA拷贝)    (CPU拷贝)       (CPU拷贝)    (DMA拷贝)</span><br></pre></td></tr></table></figure>

<h3 id="零拷贝方式（sendfile）"><a href="#零拷贝方式（sendfile）" class="headerlink" title="零拷贝方式（sendfile）"></a>零拷贝方式（sendfile）</h3><p><code>sendfile</code> 实现了<strong>数据直接在内核态传输</strong>，只需要<strong>2次拷贝和2次上下文切换</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">磁盘 → 内核缓冲区 → Socket 缓冲区 → 网卡</span><br><span class="line">     (DMA拷贝)    (CPU拷贝)     (DMA拷贝)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/02/04/controller-runtime%E4%B8%ADBuilder%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/02/04/controller-runtime%E4%B8%ADBuilder%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">controller-runtime中Builder模式设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-02-04 10:32:21 / 修改时间：10:33:02" itemprop="dateCreated datePublished" datetime="2026-02-04T10:32:21+08:00">2026-02-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-Builder-结构体属性分析"><a href="#1-Builder-结构体属性分析" class="headerlink" title="1. Builder 结构体属性分析"></a>1. Builder 结构体属性分析</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Builder <span class="keyword">struct</span> &#123;</span><br><span class="line">    forInput         ForInput           <span class="comment">// 核心：我们要Reconcile的主资源（如Deployment）</span></span><br><span class="line">    ownsInput        []OwnsInput        <span class="comment">// 归属资源：由主资源创建并控制的子资源（如ReplicaSet）</span></span><br><span class="line">    watchesInput     []WatchesInput     <span class="comment">// 监控资源：需要监控的其他相关资源</span></span><br><span class="line">    mgr              manager.Manager    <span class="comment">// 管理器：提供Client, Cache, Scheme等基础设施</span></span><br><span class="line">    globalPredicates []predicate.Predicate <span class="comment">// 全局过滤器：过滤不需要处理的事件</span></span><br><span class="line">    ctrl             controller.Controller <span class="comment">// 最终构建出的Controller实例</span></span><br><span class="line">    ctrlOptions      controller.Options <span class="comment">// Controller的配置项（如并发数）</span></span><br><span class="line">    name             <span class="type">string</span>             <span class="comment">// Controller名称</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-核心方法解释"><a href="#2-核心方法解释" class="headerlink" title="2. 核心方法解释"></a>2. 核心方法解释</h2><h3 id="For-object-client-Object-opts-ForOption"><a href="#For-object-client-Object-opts-ForOption" class="headerlink" title="For(object client.Object, opts ...ForOption)"></a><code>For(object client.Object, opts ...ForOption)</code></h3><ul>
<li><strong>作用</strong>：定义 Controller <strong>主要负责</strong>的资源类型。</li>
<li><strong>底层逻辑</strong>：相当于调用 <code>Watches(&amp;source.Kind&#123;Type: apiType&#125;, &amp;handler.EnqueueRequestForObject&#123;&#125;)</code>。</li>
<li><strong>意义</strong>：告诉 Controller，当这个资源发生变化（增删改）时，触发 Reconcile 逻辑，且 Request 对象就是该资源的 NamespacedName。</li>
</ul>
<h3 id="Owns-object-client-Object-opts-OwnsOption"><a href="#Owns-object-client-Object-opts-OwnsOption" class="headerlink" title="Owns(object client.Object, opts ...OwnsOption)"></a><code>Owns(object client.Object, opts ...OwnsOption)</code></h3><ul>
<li><strong>作用</strong>：定义 Controller <strong>拥有</strong>的子资源类型。</li>
<li><strong>底层逻辑</strong>：相当于调用 <code>Watches(&amp;source.Kind&#123;Type: &lt;ForType&gt;&#125;, &amp;handler.EnqueueRequestForOwner&#123;OwnerType: apiType, IsController: true&#125;)</code>。</li>
<li><strong>意义</strong>：当子资源（如 Pod）发生变化时，Controller 会通过 OwnerReference 找到它的”主人”（如 ReplicaSet），并触发”主人”的 Reconcile。这是 K8s 控制器模式的核心之一。</li>
</ul>
<h3 id="Watches-src-source-Source-eventhandler-handler-EventHandler-opts-WatchesOption"><a href="#Watches-src-source-Source-eventhandler-handler-EventHandler-opts-WatchesOption" class="headerlink" title="Watches(src source.Source, eventhandler handler.EventHandler, opts ...WatchesOption)"></a><code>Watches(src source.Source, eventhandler handler.EventHandler, opts ...WatchesOption)</code></h3><ul>
<li><strong>作用</strong>：定义监控任意资源的通用方法。</li>
<li><strong>底层逻辑</strong>：最底层的监控注册接口。</li>
<li><strong>意义</strong>：处理复杂场景。例如，当 ConfigMap 变化时，你可能想 Reconcile 使用了该 ConfigMap 的 Deployment。这时 <code>For</code> 和 <code>Owns</code> 都不适用，需要用 <code>Watches</code> 配合自定义的 <code>EventHandler</code>（如 <code>EnqueueRequestsFromMapFunc</code>）来实现。</li>
</ul>
<h3 id="Complete-r-reconcile-Reconciler"><a href="#Complete-r-reconcile-Reconciler" class="headerlink" title="Complete(r reconcile.Reconciler)"></a><code>Complete(r reconcile.Reconciler)</code></h3><ul>
<li><strong>作用</strong>：完成构建过程。</li>
<li><strong>逻辑</strong>：<ol>
<li>调用 <code>doController</code>：初始化 Controller 实例，设置并发数、日志等。</li>
<li>调用 <code>doWatch</code>：将 <code>For</code>、<code>Owns</code>、<code>Watches</code> 中定义的监控规则注册到 Controller 中。</li>
<li>返回构建好的 Controller。</li>
</ol>
</li>
</ul>
<h2 id="3-设计的好处"><a href="#3-设计的好处" class="headerlink" title="3. 设计的好处"></a>3. 设计的好处</h2><h3 id="简化复杂性-Abstraction"><a href="#简化复杂性-Abstraction" class="headerlink" title="简化复杂性 (Abstraction)"></a>简化复杂性 (Abstraction)</h3><ul>
<li><strong>原始方式</strong>：如果不使用 Builder，你需要手动创建 Controller，手动实例化 Source、Handler、Predicate，并调用 <code>ctrl.Watch</code>。这需要对底层组件非常熟悉，代码量大且容易出错。</li>
<li><strong>Builder方式</strong>：通过 <code>For</code> 和 <code>Owns</code> 这种语义化的 API，开发者只需声明”我关心什么资源”和”我拥有什么资源”，底层复杂的 Watch 注册逻辑被封装起来了。</li>
</ul>
<h3 id="声明式编程-Declarative"><a href="#声明式编程-Declarative" class="headerlink" title="声明式编程 (Declarative)"></a>声明式编程 (Declarative)</h3><ul>
<li>Builder 模式允许开发者以声明式的方式配置 Controller，而不是编写一系列命令式的初始化代码。代码可读性更强，意图更清晰。<ul>
<li><em>例如：<code>NewControllerManagedBy(mgr).For(&amp;Deployment&#123;&#125;).Owns(&amp;ReplicaSet&#123;&#125;).Complete(r)</code> 就像一句话一样清晰。</em></li>
</ul>
</li>
</ul>
<h3 id="最佳实践封装-Best-Practices"><a href="#最佳实践封装-Best-Practices" class="headerlink" title="最佳实践封装 (Best Practices)"></a>最佳实践封装 (Best Practices)</h3><ul>
<li>Builder 默认集成了 K8s 社区的最佳实践。<ul>
<li>例如，<code>Owns</code> 自动配置了 <code>EnqueueRequestForOwner</code>，这是处理 OwnerReference 的标准方式。</li>
<li><code>For</code> 自动配置了 <code>EnqueueRequestForObject</code>，这是 Reconcile 自身资源的标准方式。</li>
</ul>
</li>
</ul>
<h3 id="灵活性与扩展性-Flexibility"><a href="#灵活性与扩展性-Flexibility" class="headerlink" title="灵活性与扩展性 (Flexibility)"></a>灵活性与扩展性 (Flexibility)</h3><ul>
<li>虽然提供了 <code>For</code> 和 <code>Owns</code> 这种便捷方法，但也保留了 <code>Watches</code> 和 <code>WithOptions</code> 等底层接口，允许高级用户处理复杂的边缘情况（如监控外部事件、自定义队列处理逻辑等）。</li>
</ul>
<h3 id="依赖注入-Dependency-Injection"><a href="#依赖注入-Dependency-Injection" class="headerlink" title="依赖注入 (Dependency Injection)"></a>依赖注入 (Dependency Injection)</h3><ul>
<li>通过 <code>ControllerManagedBy(mgr)</code> 传入 Manager，Builder 可以自动获取所需的 Client、Scheme、Logger 等依赖，无需开发者手动传递，降低了组件间的耦合度。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/28/%E9%99%90%E6%B5%81%E5%AE%9E%E6%93%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/28/%E9%99%90%E6%B5%81%E5%AE%9E%E6%93%8D/" class="post-title-link" itemprop="url">限流实操</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-28 17:43:21 / 修改时间：18:22:38" itemprop="dateCreated datePublished" datetime="2026-01-28T17:43:21+08:00">2026-01-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h2><table>
<thead>
<tr>
<th>算法名称</th>
<th>原理一句话</th>
<th>优点</th>
<th>缺点</th>
<th>典型案例 &#x2F; 场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>计数器（Counter）</strong></td>
<td>累加请求数，超过阈值拒绝</td>
<td>实现极简单</td>
<td>无时间维度；洪峰瞬间失效</td>
<td>Demo &#x2F; 教学</td>
</tr>
<tr>
<td><strong>固定窗口（Fixed Window）</strong></td>
<td>每个时间窗口内最多 N 次</td>
<td>简单、易理解</td>
<td>窗口边界突刺</td>
<td>简单接口限流</td>
</tr>
<tr>
<td><strong>滑动窗口（Sliding Window）</strong></td>
<td>统计最近 T 时间内请求数</td>
<td>平滑、精确</td>
<td>实现复杂、存储成本高</td>
<td>SDK &#x2F; API 网关</td>
</tr>
<tr>
<td><strong>漏桶（Leaky Bucket）</strong></td>
<td>请求进桶，固定速率漏出</td>
<td>输出稳定、可整形</td>
<td>不支持突发流量</td>
<td>网络整形、QoS</td>
</tr>
<tr>
<td>⭐ <strong>令牌桶（Token Bucket）</strong></td>
<td>定速生成令牌，请求消耗</td>
<td>支持突发、弹性好</td>
<td>实现略复杂</td>
<td><strong>生产主流方案</strong></td>
</tr>
</tbody></table>
<blockquote>
<p>限流 ≠ 平滑<br>限流 &#x3D; 允许爆发，但要兜底</p>
</blockquote>
<h2 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h2><h3 id="核心参数"><a href="#核心参数" class="headerlink" title="核心参数"></a>核心参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>rate</td>
<td>每秒生成多少令牌</td>
</tr>
<tr>
<td>capacity</td>
<td>桶最大容量</td>
</tr>
<tr>
<td>tokens</td>
<td>当前可用令牌</td>
</tr>
<tr>
<td>timestamp</td>
<td>上次更新时间</td>
</tr>
</tbody></table>
<h3 id="行为特性"><a href="#行为特性" class="headerlink" title="行为特性"></a>行为特性</h3><ul>
<li>平时没流量 → 令牌累积</li>
<li>突发流量 → 快速消耗</li>
<li>超出能力 → 直接拒绝（429）</li>
</ul>
<blockquote>
<p><strong>Lua 在 Redis 中是：单线程、原子执行</strong><br>✅ Redis Lua 脚本执行是 <strong>单线程、原子、阻塞</strong><br>所以不要在 Lua 中做“慢逻辑”。</p>
</blockquote>
<p>✅ Redis Lua 脚本不会自动持久化源代码<br>只能通过 <code>EVALSHA</code> 调用。</p>
<h2 id="结合-docker-compose：完整加载流程"><a href="#结合-docker-compose：完整加载流程" class="headerlink" title="结合 docker-compose：完整加载流程"></a>结合 docker-compose：完整加载流程</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rate-limit-demo/</span><br><span class="line">├── app.py</span><br><span class="line">├── token_bucket.lua</span><br><span class="line">├── Dockerfile</span><br><span class="line">└── docker-compose.yml</span><br></pre></td></tr></table></figure>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"># cat token_bucket.lua</span><br><span class="line">-- token_bucket.lua</span><br><span class="line">local key = KEYS[1]</span><br><span class="line">local rate = tonumber(ARGV[1])</span><br><span class="line">local capacity = tonumber(ARGV[2])</span><br><span class="line">local now = tonumber(ARGV[3])</span><br><span class="line">local requested = tonumber(ARGV[4])</span><br><span class="line"></span><br><span class="line">local data = redis.call(&quot;HMGET&quot;, key, &quot;tokens&quot;, &quot;timestamp&quot;)</span><br><span class="line">local tokens = tonumber(data[1]) or capacity</span><br><span class="line">local last = tonumber(data[2]) or now</span><br><span class="line"></span><br><span class="line">-- 生成新令牌</span><br><span class="line">local delta = math.max(0, now - last)</span><br><span class="line">tokens = math.min(capacity, tokens + delta * rate)</span><br><span class="line"></span><br><span class="line">if tokens &lt; requested then</span><br><span class="line">    redis.call(&quot;HMSET&quot;, key, &quot;tokens&quot;, tokens, &quot;timestamp&quot;, now)</span><br><span class="line">    return 0</span><br><span class="line">else</span><br><span class="line">    tokens = tokens - requested</span><br><span class="line">    redis.call(&quot;HMSET&quot;, key, &quot;tokens&quot;, tokens, &quot;timestamp&quot;, now)</span><br><span class="line">    return 1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># cat app.py</span><br><span class="line">from fastapi import FastAPI, Request, HTTPException</span><br><span class="line">import redis</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">r = redis.Redis(host=&quot;redis&quot;, port=6379, decode_responses=True)</span><br><span class="line"></span><br><span class="line">with open(&quot;token_bucket.lua&quot;) as f:</span><br><span class="line">    LUA_SCRIPT = r.register_script(f.read())</span><br><span class="line"></span><br><span class="line">RATE = 5</span><br><span class="line">CAPACITY = 10</span><br><span class="line"></span><br><span class="line">@app.get(&quot;/api&quot;)</span><br><span class="line">def api(request: Request):</span><br><span class="line">    now = int(time.time())</span><br><span class="line">    allowed = LUA_SCRIPT(</span><br><span class="line">        keys=[&quot;token_bucket:api&quot;],</span><br><span class="line">        args=[RATE, CAPACITY, now, 1]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    if allowed == 0:</span><br><span class="line">        raise HTTPException(status_code=429, detail=&quot;Too Many Requests&quot;)</span><br><span class="line"></span><br><span class="line">    return &#123;&quot;msg&quot;: &quot;ok&quot;&#125;</span><br><span class="line"></span><br><span class="line"># cat Dockerfile</span><br><span class="line">FROM docker.io/python:3.12.9</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY app.py token_bucket.lua ./</span><br><span class="line">RUN pip install fastapi uvicorn redis</span><br><span class="line"></span><br><span class="line">CMD [&quot;uvicorn&quot;, &quot;app:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]</span><br><span class="line"></span><br><span class="line"># cat docker-compose.yml</span><br><span class="line">services:</span><br><span class="line">  api:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: docker.io/redis:7.4.7</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;6379:6379&quot;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br><span class="line">   ↓</span><br><span class="line">redis 容器启动</span><br><span class="line">   ↓</span><br><span class="line">api 容器启动</span><br><span class="line">   ↓</span><br><span class="line">Python import app.py</span><br><span class="line">   ↓</span><br><span class="line">读取 token_bucket.lua</span><br><span class="line">   ↓</span><br><span class="line">SCRIPT LOAD 到 Redis</span><br><span class="line">   ↓</span><br><span class="line">返回 SHA1</span><br><span class="line">   ↓</span><br><span class="line">后续请求 → EVALSHA</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="启动及验证命令"><a href="#启动及验证命令" class="headerlink" title="启动及验证命令"></a>启动及验证命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#start</span><br><span class="line">docker compose up --build</span><br><span class="line"></span><br><span class="line">#观察token变化</span><br><span class="line">while true; do   curl http://localhost:8000/api;  sleep 0.1; done</span><br><span class="line"></span><br><span class="line">#在宿主机上观测</span><br><span class="line">#装客户端：yum install -y redis</span><br><span class="line">watch -n 0.1 &quot;redis-cli HGETALL token_bucket:api&quot;</span><br><span class="line"></span><br><span class="line">#替代ab的压测方案</span><br><span class="line">hey -n 100 -c 5 -q 5 http://localhost:8000/api</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="✅-初始状态的影响"><a href="#✅-初始状态的影响" class="headerlink" title="✅ 初始状态的影响"></a>✅ 初始状态的影响</h3><table>
<thead>
<tr>
<th>初始状态</th>
<th>影响</th>
</tr>
</thead>
<tbody><tr>
<td>令牌桶满</td>
<td>更友好突发体验</td>
</tr>
<tr>
<td>令牌桶空</td>
<td>更严格控制 steady 速率</td>
</tr>
<tr>
<td>Warm-Up</td>
<td>更稳定保护系统</td>
</tr>
<tr>
<td>显式 Bootstrap</td>
<td>服务重启时更可控</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/linux%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/linux%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88/" class="post-title-link" itemprop="url">linux内核协议栈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-27 17:34:36 / 修改时间：17:48:59" itemprop="dateCreated datePublished" datetime="2026-01-27T17:34:36+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h2><p><img src="https://raw.githubusercontent.com/shispring/picgo/master/Network-API-and-data-flow-within-Linux-kernel-1.png" alt="linux-kernel-network" title="linux kernel network"></p>
<hr>
<h2 id="🧠-主线口诀"><a href="#🧠-主线口诀" class="headerlink" title="🧠 主线口诀"></a>🧠 主线口诀</h2><h3 id="①-第一条主线：数据方向（最重要）"><a href="#①-第一条主线：数据方向（最重要）" class="headerlink" title="① 第一条主线：数据方向（最重要）"></a>① 第一条主线：数据方向（最重要）</h3><p>只保留 90% 正常流量会经过的路径,忽略异常、重传、边角状态机</p>
<p>TX：用户 → TCP → IP → 设备 → 网卡<br>RX：网卡 → IP → TCP → Socket → 用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户态</span><br><span class="line"> ↓</span><br><span class="line">系统调用</span><br><span class="line"> ↓</span><br><span class="line">协议栈（L4 → L3 → L2）</span><br><span class="line"> ↓</span><br><span class="line">驱动</span><br><span class="line"> ↓</span><br><span class="line">网卡</span><br></pre></td></tr></table></figure>

<h4 id="发送路径（左半边为主）"><a href="#发送路径（左半边为主）" class="headerlink" title="发送路径（左半边为主）"></a><strong>发送路径（左半边为主）</strong></h4><ul>
<li>write &#x2F; send &#x2F; sendmsg</li>
<li>tcp_sendmsg</li>
<li>tcp_push_one</li>
<li>ip_output</li>
<li>dev_queue_xmit</li>
<li>driver → NIC</li>
</ul>
<h4 id="接收路径（右半边为主）"><a href="#接收路径（右半边为主）" class="headerlink" title="接收路径（右半边为主）"></a><strong>接收路径（右半边为主）</strong></h4><ul>
<li>NIC 中断</li>
<li>NAPI poll</li>
<li>netif_receive_skb</li>
<li>ip_rcv</li>
<li>tcp_v4_rcv</li>
<li>sock_recvmsg &#x2F; read</li>
</ul>
<h3 id="第二条主线：控制面-vs-数据面"><a href="#第二条主线：控制面-vs-数据面" class="headerlink" title="第二条主线：控制面 vs 数据面"></a>第二条主线：控制面 vs 数据面</h3><p>图中混杂了两类东西，你要强行把它们分开：</p>
<h4 id="🟨-数据面（你-80-关注的）"><a href="#🟨-数据面（你-80-关注的）" class="headerlink" title="🟨 数据面（你 80% 关注的）"></a>🟨 数据面（你 80% 关注的）</h4><ul>
<li>skb（sk_buff）</li>
<li>队列（queue）</li>
<li>copy &#x2F; zero-copy</li>
<li>push &#x2F; pull</li>
</ul>
<p>关键词：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">skb</span><br><span class="line">queue</span><br><span class="line">xmit</span><br><span class="line">rcv</span><br><span class="line">copy</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="🟥-控制面（暂时只识别，不深挖）"><a href="#🟥-控制面（暂时只识别，不深挖）" class="headerlink" title="🟥 控制面（暂时只识别，不深挖）"></a>🟥 控制面（暂时只识别，不深挖）</h4><ul>
<li>socket 状态机</li>
<li>TCP 状态（ESTABLISHED &#x2F; TIME_WAIT）</li>
<li>ACK &#x2F; 重传 &#x2F; 定时器</li>
</ul>
<p>关键词：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">state</span><br><span class="line">timer</span><br><span class="line">ack</span><br><span class="line">retrans</span><br></pre></td></tr></table></figure>

<p>二、工程上该关心什么</p>
<p>① User &#x2F; Syscall 层</p>
<p>你关心什么：<br>  • 应用是否阻塞？<br>  • write&#x2F;send 是不是慢？<br>  • 是否频繁系统调用？</p>
<p>常见问题：<br>  • 小包 write（syscall 过多）<br>  • 未开启 sendfile &#x2F; splice</p>
<p>⸻</p>
<p>② TCP 层（tcp_sendmsg &#x2F; tcp_v4_rcv）</p>
<p>你关心什么：<br>  • 队列是否满？<br>  • 是否在重传？<br>  • 延迟是否在 TCP 内部？</p>
<p>指标 &#x2F; 工具：</p>
<p>ss -ti<br>netstat -s</p>
<p>⸻</p>
<p>③ IP 层（ip_output &#x2F; ip_rcv）</p>
<p>你关心什么：<br>  • 路由是否正确？<br>  • 是否被 netfilter &#x2F; iptables 拖慢？<br>  • MTU &#x2F; 分片问题？</p>
<p>典型场景：<br>  • kube-proxy iptables 模式<br>  • 大量规则导致 ip_rcv 慢</p>
<p>⸻</p>
<p>④ Qdisc &#x2F; dev_queue_xmit（性能高发区）</p>
<p>这是工程事故高发区</p>
<p>你关心：<br>  • 队列是否堆积？<br>  • qdisc 是否成为瓶颈？<br>  • 网卡 TX 是否 backpressure？</p>
<p>工具：</p>
<p>tc -s qdisc</p>
<p>⸻</p>
<p>⑤ NAPI &#x2F; softirq（RX 性能关键）</p>
<p>这是 RX 侧最重要的地方</p>
<p>你关心：<br>  • softirq 是否打满 CPU？<br>  • backlog 是否丢包？<br>  • 是否进入 ksoftirqd？</p>
<p>工具：</p>
<p>cat &#x2F;proc&#x2F;net&#x2F;softnet_stat<br>top<br>perf top</p>
<p>三、工程级「怎么用这张图」</p>
<p>场景 1：QPS 上不去，但 CPU 很高</p>
<p>直接套路径：</p>
<p>RX → NAPI → netif_receive_skb → tcp_v4_rcv</p>
<p>优先看：<br>  • softirq<br>  • backlog<br>  • TCP 接收队列</p>
<p>⸻</p>
<p>场景 2：延迟高，但没有丢包</p>
<p>优先怀疑：</p>
<p>TCP → 队列 → 调度</p>
<p>排查：<br>  • TCP send&#x2F;recv queue<br>  • Nagle &#x2F; delayed ACK<br>  • cgroup CPU 限制</p>
<p>⸻</p>
<p>场景 3：Ingress &#x2F; Service 性能异常</p>
<p>路径映射：</p>
<p>NIC<br>→ Linux RX<br>→ iptables &#x2F; conntrack<br>→ Pod veth<br>→ 容器 TCP</p>
<p>重点：<br>  • netfilter<br>  • conntrack<br>  • veth + qdisc</p>
<p>⸻</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/ip%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/ip%E7%9A%84%E4%B8%80%E4%BA%9B%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4/" class="post-title-link" itemprop="url">Linux网络统计、性能工具/命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-27 15:53:50 / 修改时间：16:21:41" itemprop="dateCreated datePublished" datetime="2026-01-27T15:53:50+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="网络统计"><a href="#网络统计" class="headerlink" title="网络统计"></a>网络统计</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iproute2 用法</span><br><span class="line"># 列出所有 veth 设备</span><br><span class="line">ip -c link show type veth</span><br><span class="line"># 列出所有 tunnel 设备</span><br><span class="line">ip tunnel show</span><br></pre></td></tr></table></figure>
<h2 id="网络统计工具"><a href="#网络统计工具" class="headerlink" title="网络统计工具"></a>网络统计工具</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">nstat 命令：网络统计工具</span><br><span class="line"># nstat</span><br><span class="line"></span><br><span class="line">ss 命令：用于调查套接字的实用程序</span><br><span class="line"># ss -s</span><br><span class="line"></span><br><span class="line">netstat 命令：显示套接字的经典实用工具</span><br><span class="line"># netstat -i</span><br><span class="line"></span><br><span class="line"># netstat -s</span><br><span class="line"></span><br><span class="line">ip/ifconfig 命令：配置或显示网络接口信息</span><br><span class="line"># ifconfig</span><br><span class="line"></span><br><span class="line"># ifconfig eth0</span><br><span class="line"></span><br><span class="line">要显示网络接口统计信息</span><br><span class="line"># ip -c -s link</span><br><span class="line"></span><br><span class="line">sar 命令：显示网络统计信息</span><br><span class="line"># sar -n DEV 1</span><br><span class="line"></span><br><span class="line">每秒1次，统计三次</span><br><span class="line"># sar -n DEV 1 3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用 dropwatch（Kernel dropped packet monitor） 可以监测内核丢包信息 ，执行以下命令，然后输入 start</span><br><span class="line"># dropwatch -l kas</span><br><span class="line">Initalizing kallsyms db</span><br><span class="line">dropwatch&gt; start    </span><br><span class="line">xxx</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="网络性能测试"><a href="#网络性能测试" class="headerlink" title="网络性能测试"></a>网络性能测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 使用 iperf3 进行性能测试</span><br><span class="line"># 启动服务端 -s 意思是服务端</span><br><span class="line">iperf3 -s </span><br><span class="line"># 后台进程方式启动服务端，-D 意思是 Daemon 进程启动</span><br><span class="line">iperf3 -s -D</span><br><span class="line"># 在客户端执行 TCP 测试， -c 指的是客户端，-b 目标带宽（一般与网卡带宽相匹配），-n 发送字节数</span><br><span class="line">iperf3 -c 10.10.140.95 -b 10000M -n 10G</span><br><span class="line"># 执行 UDP 测试，-u 使用 UDP 协议，-l 指定数据包大小，这里指定的是 TCP 或 UDP 数据部分的大小为 1400</span><br><span class="line"># 实际发送时的 MAC 帧长会是 1454 ，包括：</span><br><span class="line"># 26 个字节的 MAC 帧头：7 个字节的前导码，1 个字节的帧起始符，6 字节目的 MAC ，6 字节源 MAC ，2 字节帧长度，以及位于帧末尾的 4 字节 CRC 校验和</span><br><span class="line"># 20 字节的 IP 头部</span><br><span class="line"># 8 字节 UDP 头部</span><br><span class="line">iperf3 -u -c 10.10.140.95 -b 10000M -n 10G -l1400</span><br><span class="line"># 由于 iperf3 只显示带宽，可以借助 sar 查看包量</span><br><span class="line"># sar 工具包含在 sysstat 中</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="网络性能调优"><a href="#网络性能调优" class="headerlink" title="网络性能调优"></a>网络性能调优</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 1、网卡收发数据处理速度成为瓶颈时， 设置 CPU 亲和性（ irqbalance 的自动负载均衡很多时候不好用） 将中断处理分发到不同的 CPU 上，避免集中在一个 CPU 上</span><br><span class="line"># 找到底层设备</span><br><span class="line">readlink -e /sys/class/net/eth0/</span><br><span class="line">/sys/devices/pci0000:17/0000:17:00.0/0000:18:00.0/0000:19:03.0/0000:1a:00.0/net/eth0</span><br><span class="line"></span><br><span class="line">#2、当缓冲区大小成为瓶颈时，可调整内核参数进行优化</span><br><span class="line"># 该参数决定了，网络设备接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。</span><br><span class="line">net.core.netdev_max_backlog = 400000</span><br><span class="line"># 该参数指定了每个套接字所允许的最大缓冲区的大小</span><br><span class="line">net.core.optmem_max = 10000000</span><br><span class="line"># 指定了接收套接字缓冲区大小的缺省值（以字节为单位）</span><br><span class="line">net.core.rmem_default = 16777216</span><br><span class="line"># 指定了接收套接字缓冲区大小的最大值（以字节为单位）</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line"># 表示socket监听的backlog(监听队列)上限</span><br><span class="line">net.core.somaxconn = 100000</span><br><span class="line"># 定义默认的发送窗口大小</span><br><span class="line">net.core.wmem_default = 16777216</span><br><span class="line"># 定义发送窗口的最大大小</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line"># 确定 TCP 栈应该如何反映内存使用；每个值的单位都是内存页（通常是 4KB）。</span><br><span class="line"># 第一个值是内存使用的下限。</span><br><span class="line"># 第二个值是内存压力模式开始对缓冲区使用应用压力的上限。</span><br><span class="line"># 第三个值是内存上限。在这个层次上可以将报文丢弃，从而减少对内存的使用。</span><br><span class="line">net.ipv4.tcp_mem=91650	122203	183300</span><br><span class="line"># 为自动调优定义每个 socket 使用的内存。</span><br><span class="line"># 第一个值是为 socket 的发送缓冲区分配的最少字节数。</span><br><span class="line"># 第二个值是默认值（该值会被 wmem_default 覆盖），缓冲区在系统负载不重的情况下可以增长到这个值。</span><br><span class="line"># 第三个值是发送缓冲区空间的最大字节数（该值会被 wmem_max 覆盖）。</span><br><span class="line">net.ipv4.tcp_wmem=4096 16384 16777216</span><br><span class="line">net.ipv4.tcp_rmem=4096 131072 16777216</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="网络栈的监控"><a href="#网络栈的监控" class="headerlink" title="网络栈的监控"></a>网络栈的监控</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/monitoring-network-stack/">https://arthurchiao.art/blog/monitoring-network-stack/</a></p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.xiayinchang.top/post/cf4d6f51.html">https://www.xiayinchang.top/post/cf4d6f51.html</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/27/%E8%B7%AF%E7%94%B1Demo%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/27/%E8%B7%AF%E7%94%B1Demo%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">路由Demo解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-27 15:34:10 / 修改时间：15:38:43" itemprop="dateCreated datePublished" datetime="2026-01-27T15:34:10+08:00">2026-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<h2 id="时序流程图（Mermaid）"><a href="#时序流程图（Mermaid）" class="headerlink" title="时序流程图（Mermaid）"></a>时序流程图（Mermaid）</h2><p><img src="https://raw.githubusercontent.com/shispring/picgo/master/route-case.png" alt="route-demo" title="route demo"></p>
<hr>
<h2 id="一、“总纲式结论”"><a href="#一、“总纲式结论”" class="headerlink" title="一、“总纲式结论”"></a>一、“总纲式结论”</h2><blockquote>
<p><strong>跨三层通信的本质是：</strong></p>
<ul>
<li><strong>IP 地址：端到端不变（逻辑寻址）</strong></li>
<li><strong>MAC 地址：逐跳改变（物理转发）</strong></li>
<li><strong>ARP：只解决“下一跳是谁”，而不是“最终是谁”</strong></li>
</ul>
</blockquote>
<hr>
<h2 id="二、拓扑与角色明确"><a href="#二、拓扑与角色明确" class="headerlink" title="二、拓扑与角色明确"></a>二、拓扑与角色明确</h2><p>拓扑如下（你给的）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Host1 — Router A — Router B — Router C — Host2</span><br></pre></td></tr></table></figure>

<ul>
<li>Host1 的默认网关：Router A</li>
<li>Host2 直连在 Router C 的 LAN 上</li>
<li>路由器之间都是三层转发</li>
<li>终端和路由器之间是二层通信</li>
</ul>
<hr>
<h2 id="三、完整路由过程（按步骤拆解）"><a href="#三、完整路由过程（按步骤拆解）" class="headerlink" title="三、完整路由过程（按步骤拆解）"></a>三、完整路由过程（按步骤拆解）</h2><h3 id="阶段-1：Host1-决定“我该把包交给谁”"><a href="#阶段-1：Host1-决定“我该把包交给谁”" class="headerlink" title="阶段 1：Host1 决定“我该把包交给谁”"></a><strong>阶段 1：Host1 决定“我该把包交给谁”</strong></h3><h4 id="Step-1：Host1-判断目的-IP-是否本地"><a href="#Step-1：Host1-判断目的-IP-是否本地" class="headerlink" title="Step 1：Host1 判断目的 IP 是否本地"></a>Step 1：Host1 判断目的 IP 是否本地</h4><ul>
<li><p>Host1 拿到 <strong>Host2 的 IP</strong></p>
</li>
<li><p>用自己的：</p>
<ul>
<li>IP</li>
<li>子网掩码</li>
</ul>
</li>
<li><p>计算后发现：<br><strong>Host2 不在本地子网</strong></p>
</li>
</ul>
<p>👉 结论：<strong>必须交给默认网关（Router A）</strong></p>
<hr>
<h4 id="Step-2：Host1-通过-ARP-找默认网关的-MAC"><a href="#Step-2：Host1-通过-ARP-找默认网关的-MAC" class="headerlink" title="Step 2：Host1 通过 ARP 找默认网关的 MAC"></a>Step 2：Host1 通过 ARP 找默认网关的 MAC</h4><ul>
<li><p>查看 ARP 表：</p>
<ul>
<li>有 Router A MAC → 直接用</li>
<li>没有 → ARP Broadcast</li>
</ul>
</li>
<li><p>得到：</p>
<ul>
<li>Router A（LAN 口）的 MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-3：Host1-封装第一个以太网帧"><a href="#Step-3：Host1-封装第一个以太网帧" class="headerlink" title="Step 3：Host1 封装第一个以太网帧"></a>Step 3：Host1 封装第一个以太网帧</h4><p>此时数据包状态是：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Host1 MAC</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router A（LAN 口）MAC</td>
</tr>
</tbody></table>
<p>👉 <strong>关键点</strong>：<br>Host1 <strong>不知道 Router B &#x2F; C &#x2F; Host2 的 MAC</strong>，也不需要知道。</p>
<hr>
<h3 id="阶段-2：Router-A-→-Router-B"><a href="#阶段-2：Router-A-→-Router-B" class="headerlink" title="阶段 2：Router A → Router B"></a><strong>阶段 2：Router A → Router B</strong></h3><h4 id="Step-4：Router-A-收到帧（L2-→-L3）"><a href="#Step-4：Router-A-收到帧（L2-→-L3）" class="headerlink" title="Step 4：Router A 收到帧（L2 → L3）"></a>Step 4：Router A 收到帧（L2 → L3）</h4><p>Router A 做三件事：</p>
<ol>
<li><p>看 <strong>目的 MAC</strong> → 是自己 → 收包</p>
</li>
<li><p>剥掉二层头，检查 <strong>目的 IP</strong></p>
</li>
<li><p>查路由表：</p>
<ul>
<li>Host2 不直连</li>
<li>找到下一跳：<strong>Router B</strong></li>
</ul>
</li>
</ol>
<hr>
<h4 id="Step-5：Router-A-通过-ARP-找-Router-B-的-MAC"><a href="#Step-5：Router-A-通过-ARP-找-Router-B-的-MAC" class="headerlink" title="Step 5：Router A 通过 ARP 找 Router B 的 MAC"></a>Step 5：Router A 通过 ARP 找 Router B 的 MAC</h4><ul>
<li><p>ARP 查询：</p>
<ul>
<li>IP：Router B（A-B 链路上的 IP）</li>
<li>得到 Router B 接口 MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-6：Router-A-重新封装帧并转发"><a href="#Step-6：Router-A-重新封装帧并转发" class="headerlink" title="Step 6：Router A 重新封装帧并转发"></a>Step 6：Router A 重新封装帧并转发</h4><p>新的帧：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router A（发往 B 的接口 MAC）</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router B（面向 A 的接口 MAC）</td>
</tr>
</tbody></table>
<p>👉 <strong>IP 没变，MAC 换了</strong></p>
<hr>
<h3 id="阶段-3：Router-B-→-Router-C（同理）"><a href="#阶段-3：Router-B-→-Router-C（同理）" class="headerlink" title="阶段 3：Router B → Router C（同理）"></a><strong>阶段 3：Router B → Router C（同理）</strong></h3><p>Router B 做的事情和 Router A <strong>完全一样</strong>：</p>
<ol>
<li>收到帧（MAC 是自己）</li>
<li>解封装</li>
<li>查路由表</li>
<li>下一跳是 Router C</li>
<li>ARP 找 Router C MAC</li>
<li>重新封装并转发</li>
</ol>
<p>新的帧：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router B（面向 C 的接口 MAC）</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Router C（面向 B 的接口 MAC）</td>
</tr>
</tbody></table>
<hr>
<h3 id="阶段-4：Router-C-→-Host2（最后一跳）"><a href="#阶段-4：Router-C-→-Host2（最后一跳）" class="headerlink" title="阶段 4：Router C → Host2（最后一跳）"></a><strong>阶段 4：Router C → Host2（最后一跳）</strong></h3><h4 id="Step-7：Router-C-发现目的-IP-是本地直连"><a href="#Step-7：Router-C-发现目的-IP-是本地直连" class="headerlink" title="Step 7：Router C 发现目的 IP 是本地直连"></a>Step 7：Router C 发现目的 IP 是本地直连</h4><ul>
<li><p>查路由表：</p>
<ul>
<li>Host2 IP 在本地 LAN</li>
</ul>
</li>
<li><p>不再需要“下一跳路由器”</p>
</li>
</ul>
<hr>
<h4 id="Step-8：Router-C-ARP-查询-Host2-的-MAC"><a href="#Step-8：Router-C-ARP-查询-Host2-的-MAC" class="headerlink" title="Step 8：Router C ARP 查询 Host2 的 MAC"></a>Step 8：Router C ARP 查询 Host2 的 MAC</h4><ul>
<li><p>ARP：</p>
<ul>
<li>IP：Host2</li>
<li>得到 Host2 MAC</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Step-9：Router-C-发送最终帧"><a href="#Step-9：Router-C-发送最终帧" class="headerlink" title="Step 9：Router C 发送最终帧"></a>Step 9：Router C 发送最终帧</h4><p>最终帧：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>Source IP</td>
<td>Host1 IP</td>
</tr>
<tr>
<td>Dest IP</td>
<td>Host2 IP</td>
</tr>
<tr>
<td>Source MAC</td>
<td>Router C（LAN 口 MAC）</td>
</tr>
<tr>
<td>Dest MAC</td>
<td>Host2 MAC</td>
</tr>
</tbody></table>
<hr>
<h4 id="Step-10：交换机（二层）转发"><a href="#Step-10：交换机（二层）转发" class="headerlink" title="Step 10：交换机（二层）转发"></a>Step 10：交换机（二层）转发</h4><ul>
<li>交换机只看 <strong>Destination MAC</strong></li>
<li>查 MAC 表</li>
<li>发给 Host2 所在端口</li>
</ul>
<p>👉 Host2 收到数据，<strong>去程完成</strong></p>
<hr>
<h2 id="四、一路上哪些东西「一直不变」，哪些「一直在变」"><a href="#四、一路上哪些东西「一直不变」，哪些「一直在变」" class="headerlink" title="四、一路上哪些东西「一直不变」，哪些「一直在变」"></a>四、一路上哪些东西「一直不变」，哪些「一直在变」</h2><h3 id="✅-一直不变的"><a href="#✅-一直不变的" class="headerlink" title="✅ 一直不变的"></a>✅ 一直不变的</h3><ul>
<li>Source IP：Host1</li>
<li>Destination IP：Host2</li>
</ul>
<h3 id="🔄-每一跳都会变的"><a href="#🔄-每一跳都会变的" class="headerlink" title="🔄 每一跳都会变的"></a>🔄 每一跳都会变的</h3><ul>
<li>Source MAC</li>
<li>Destination MAC</li>
</ul>
<h3 id="🧠-决策逻辑"><a href="#🧠-决策逻辑" class="headerlink" title="🧠 决策逻辑"></a>🧠 决策逻辑</h3><ul>
<li><strong>IP 决定“去哪里”</strong></li>
<li><strong>MAC 决定“下一跳交给谁”</strong></li>
</ul>
<hr>
<h2 id="五、为什么不能“全网-ARP”（你原文最后的点睛）"><a href="#五、为什么不能“全网-ARP”（你原文最后的点睛）" class="headerlink" title="五、为什么不能“全网 ARP”（你原文最后的点睛）"></a>五、为什么不能“全网 ARP”（你原文最后的点睛）</h2><p>如果没有路由器：</p>
<ul>
<li>所有设备在一个广播域</li>
<li>每一次通信都 ARP 全网</li>
<li>广播风暴</li>
<li>网络直接瘫痪</li>
</ul>
<p>👉 <strong>路由器的核心价值：</strong></p>
<ul>
<li>切割广播域</li>
<li>限制 ARP 的作用范围</li>
<li>让 Internet 成为可能</li>
</ul>
<hr>
<h2 id="六、一句“工程师级总结”"><a href="#六、一句“工程师级总结”" class="headerlink" title="六、一句“工程师级总结”"></a>六、一句“工程师级总结”</h2><blockquote>
<p><strong>三层决定方向，二层负责搬运。<br>路由器每一跳只关心：<br>“下一步我该把包交给谁？”</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/21/%E7%90%86%E8%A7%A3CNI%E5%8F%8A%E5%AE%9E%E8%B7%B5%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/21/%E7%90%86%E8%A7%A3CNI%E5%8F%8A%E5%AE%9E%E8%B7%B5%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">理解CNI及实践操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2026-01-21 22:15:13" itemprop="dateCreated datePublished" datetime="2026-01-21T22:15:13+08:00">2026-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-27 15:53:05" itemprop="dateModified" datetime="2026-01-27T15:53:05+08:00">2026-01-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloudpods.csdn.net/6578109cb8e5f01e1e4496fd.html">https://cloudpods.csdn.net/6578109cb8e5f01e1e4496fd.html</a></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/shispring/picgo/master/c54b0cea8c10edba2f581d573f58ee01.png" alt="cni" title="cni"></p>
<hr>
<h1 id="一、分析图片的-3-个步骤"><a href="#一、分析图片的-3-个步骤" class="headerlink" title="一、分析图片的 3 个步骤"></a>一、分析图片的 3 个步骤</h1><h2 id="Step-1：给-Pod-插上“网线”（veth）"><a href="#Step-1：给-Pod-插上“网线”（veth）" class="headerlink" title="Step 1：给 Pod 插上“网线”（veth）"></a>Step 1：给 Pod 插上“网线”（veth）</h2><blockquote>
<p>创建 veth pair，一端进 Pod，一端留在 Node</p>
</blockquote>
<h3 id="👍-这是-CNI-的核心职责之一"><a href="#👍-这是-CNI-的核心职责之一" class="headerlink" title="👍 这是 CNI 的核心职责之一"></a>👍 这是 CNI 的<strong>核心职责之一</strong></h3><p><strong>底层原理</strong>：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ Pod netns ] eth0  &lt;==== veth pair ====  vethXXXX [ Node ]</span><br></pre></td></tr></table></figure>

<ul>
<li>veth 是 Linux 提供的“虚拟网线”</li>
<li>Pod 里看到的是 <code>eth0</code></li>
<li>Node 上看到的是 <code>vethxxxx</code><br>👉 <strong>CNI 插件最基础的职责：</strong><blockquote>
<p>把 Pod 的 network namespace 接入宿主机网络</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="Step-2：给-Pod-分配-IP（IPAM）"><a href="#Step-2：给-Pod-分配-IP（IPAM）" class="headerlink" title="Step 2：给 Pod 分配 IP（IPAM）"></a>Step 2：给 Pod 分配 IP（IPAM）</h2><blockquote>
<p>每个 Pod 一个唯一 IP，通常 Node 拿一个子网</p>
</blockquote>
<h3 id="👍-这也是-CNI-的标准设计"><a href="#👍-这也是-CNI-的标准设计" class="headerlink" title="👍 这也是 CNI 的标准设计"></a>👍 这也是 CNI 的标准设计</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Node1: 172.16.0.0/24</span><br><span class="line">  Pod1: 172.16.0.1</span><br><span class="line">  Pod2: 172.16.0.2</span><br><span class="line">Node2: 172.16.1.0/24</span><br></pre></td></tr></table></figure>
<h2 id="这是：-Node-级子网划分-Pod-从-Node-子网里分-IP👉-这是非常典型的-Node-scoped-IPAM-模型Flannel-Calico-Cilium-都支持这个模型"><a href="#这是：-Node-级子网划分-Pod-从-Node-子网里分-IP👉-这是非常典型的-Node-scoped-IPAM-模型Flannel-Calico-Cilium-都支持这个模型" class="headerlink" title="这是：* Node 级子网划分* Pod 从 Node 子网里分 IP👉 这是非常典型的 Node-scoped IPAM 模型Flannel &#x2F; Calico &#x2F; Cilium 都支持这个模型"></a>这是：<br>* <strong>Node 级子网划分</strong><br>* Pod 从 Node 子网里分 IP<br>👉 这是非常典型的 <strong>Node-scoped IPAM 模型</strong><br><strong>Flannel &#x2F; Calico &#x2F; Cilium 都支持这个模型</strong></h2><h2 id="Step-3：配置-IP-路由（L3-通）"><a href="#Step-3：配置-IP-路由（L3-通）" class="headerlink" title="Step 3：配置 IP + 路由（L3 通）"></a>Step 3：配置 IP + 路由（L3 通）</h2><blockquote>
<p>Pod 能出网，Node 知道怎么把包送回 Pod</p>
</blockquote>
<h3 id="👍-这是最容易被低估，但最重要的一步"><a href="#👍-这是最容易被低估，但最重要的一步" class="headerlink" title="👍 这是最容易被低估，但最重要的一步"></a>👍 这是最容易被低估，但最重要的一步</h3><h2 id="图里提到三件事：1-给-Pod-eth0-配-IP2-给-Pod-配默认路由3-给-Node-配到-Pod-IP-的路由这是-“Pod-能通信”成立的最小条件。"><a href="#图里提到三件事：1-给-Pod-eth0-配-IP2-给-Pod-配默认路由3-给-Node-配到-Pod-IP-的路由这是-“Pod-能通信”成立的最小条件。" class="headerlink" title="图里提到三件事：1. 给 Pod eth0 配 IP2. 给 Pod 配默认路由3. 给 Node 配到 Pod IP 的路由这是 “Pod 能通信”成立的最小条件。"></a>图里提到三件事：<br>1. 给 Pod eth0 配 IP<br>2. 给 Pod 配默认路由<br>3. 给 Node 配到 Pod IP 的路由<br>这是 <strong>“Pod 能通信”成立的最小条件</strong>。</h2><h1 id="二、如果你手动“完整体验一遍-CNI”，应该怎么做？"><a href="#二、如果你手动“完整体验一遍-CNI”，应该怎么做？" class="headerlink" title="二、如果你手动“完整体验一遍 CNI”，应该怎么做？"></a>二、如果你手动“完整体验一遍 CNI”，应该怎么做？</h1><h2 id="下面是一套完全可手动复现的-CNI-行为"><a href="#下面是一套完全可手动复现的-CNI-行为" class="headerlink" title="下面是一套完全可手动复现的 CNI 行为"></a>下面是一套<strong>完全可手动复现的 CNI 行为</strong></h2><h2 id="🔧-实验前准备"><a href="#🔧-实验前准备" class="headerlink" title="🔧 实验前准备"></a>🔧 实验前准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个模拟 Pod 的 netns</span></span><br><span class="line">ip netns add pod1</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-1：创建-veth-pair"><a href="#Step-1：创建-veth-pair" class="headerlink" title="Step 1：创建 veth pair"></a>Step 1：创建 veth pair</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> add veth-pod1 <span class="built_in">type</span> veth peer name veth-host1</span><br></pre></td></tr></table></figure>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-2：把一端放进-Pod-netns"><a href="#Step-2：把一端放进-Pod-netns" class="headerlink" title="Step 2：把一端放进 Pod netns"></a>Step 2：把一端放进 Pod netns</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-pod1 netns pod1</span><br></pre></td></tr></table></figure>
<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span></span><br></pre></td></tr></table></figure>
<h2 id="你会看到-veth-pod1"><a href="#你会看到-veth-pod1" class="headerlink" title="你会看到 veth-pod1"></a>你会看到 <code>veth-pod1</code></h2><h2 id="Step-3：给-Pod-网卡改名为-eth0-配-IP"><a href="#Step-3：给-Pod-网卡改名为-eth0-配-IP" class="headerlink" title="Step 3：给 Pod 网卡改名为 eth0 + 配 IP"></a>Step 3：给 Pod 网卡改名为 eth0 + 配 IP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span> <span class="built_in">set</span> veth-pod1 name eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> pod1 ip addr add 172.16.0.2/24 dev eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> pod1 ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-4：配置-Pod-默认路由"><a href="#Step-4：配置-Pod-默认路由" class="headerlink" title="Step 4：配置 Pod 默认路由"></a>Step 4：配置 Pod 默认路由</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ip route add default via 172.16.0.1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个 <code>172.16.0.1</code> 通常就是 Node 侧 veth 的 IP</p>
</blockquote>
<hr>
<h2 id="Step-5：配置-Node-侧-veth"><a href="#Step-5：配置-Node-侧-veth" class="headerlink" title="Step 5：配置 Node 侧 veth"></a>Step 5：配置 Node 侧 veth</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 172.16.0.1/24 dev veth-host1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-host1 up</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-6：Node-→-Pod-路由（如果需要）"><a href="#Step-6：Node-→-Pod-路由（如果需要）" class="headerlink" title="Step 6：Node → Pod 路由（如果需要）"></a>Step 6：Node → Pod 路由（如果需要）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route add 172.16.0.2 dev veth-host1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实际 CNI 中，这步通常由内核自动完成或由更上层组件（BGP &#x2F; overlay）负责</p>
</blockquote>
<hr>
<h2 id="Step-7：验证通信"><a href="#Step-7：验证通信" class="headerlink" title="Step 7：验证通信"></a>Step 7：验证通信</h2><h3 id="Pod-→-Node"><a href="#Pod-→-Node" class="headerlink" title="Pod → Node"></a>Pod → Node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns <span class="built_in">exec</span> pod1 ping 172.16.0.1</span><br></pre></td></tr></table></figure>
<h3 id="Node-→-Pod"><a href="#Node-→-Pod" class="headerlink" title="Node → Pod"></a>Node → Pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 172.16.0.2</span><br></pre></td></tr></table></figure>
<h2 id="✅-通了，说明你已经手搓了一个最小-CNI"><a href="#✅-通了，说明你已经手搓了一个最小-CNI" class="headerlink" title="✅ 通了，说明你已经手搓了一个最小 CNI"></a>✅ 通了，说明你已经<strong>手搓了一个最小 CNI</strong></h2><h1 id="三、和“真实-CNI-插件”的差距在哪？"><a href="#三、和“真实-CNI-插件”的差距在哪？" class="headerlink" title="三、和“真实 CNI 插件”的差距在哪？"></a>三、和“真实 CNI 插件”的差距在哪？</h1><table>
<thead>
<tr>
<th>能力</th>
<th>图中是否涉及</th>
<th>生产 CNI</th>
</tr>
</thead>
<tbody><tr>
<td>veth 管理</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>IPAM</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Node 间互通</td>
<td>❌</td>
<td>必须</td>
</tr>
<tr>
<td>Overlay &#x2F; BGP</td>
<td>❌</td>
<td>必须</td>
</tr>
<tr>
<td>NetworkPolicy</td>
<td>❌</td>
<td>必须</td>
</tr>
<tr>
<td>生命周期回收</td>
<td>❌</td>
<td>必须</td>
</tr>
<tr>
<td>高性能</td>
<td>❌</td>
<td>eBPF &#x2F; XDP</td>
</tr>
</tbody></table>
<hr>
<h1 id="四、“手动-CNI”的真实网络拓扑"><a href="#四、“手动-CNI”的真实网络拓扑" class="headerlink" title="四、“手动 CNI”的真实网络拓扑"></a>四、“手动 CNI”的真实网络拓扑</h1><h2 id="1️⃣-逻辑网络拓扑（强烈推荐先看这个）"><a href="#1️⃣-逻辑网络拓扑（强烈推荐先看这个）" class="headerlink" title="1️⃣ 逻辑网络拓扑（强烈推荐先看这个）"></a>1️⃣ 逻辑网络拓扑（强烈推荐先看这个）</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------+</span><br><span class="line">|                     Node (Host)                    |</span><br><span class="line">|                                                    |</span><br><span class="line">|   veth-host1                                       |</span><br><span class="line">|   IP: 172.16.0.1/24                                |</span><br><span class="line">|        |                                           |</span><br><span class="line">|        |  (veth pair)                              |</span><br><span class="line">|        |                                           |</span><br><span class="line">|   +----+-----------------------------+             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   |        Pod Network Namespace     |             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   |   eth0                           |             |</span><br><span class="line">|   |   IP: 172.16.0.2/24              |             |</span><br><span class="line">|   |   Default GW: 172.16.0.1         |             |</span><br><span class="line">|   |                                  |             |</span><br><span class="line">|   +----------------------------------+             |</span><br><span class="line">|                                                    |</span><br><span class="line">+----------------------------------------------------+</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2️⃣-数据包流向（ping-时发生了什么）"><a href="#2️⃣-数据包流向（ping-时发生了什么）" class="headerlink" title="2️⃣ 数据包流向（ping 时发生了什么）"></a>2️⃣ 数据包流向（ping 时发生了什么）</h2><h3 id="Pod-→-Node-1"><a href="#Pod-→-Node-1" class="headerlink" title="Pod → Node"></a>Pod → Node</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Pod eth0 (172.16.0.2)</span><br><span class="line">  |</span><br><span class="line">  |  ICMP Echo Request</span><br><span class="line">  |</span><br><span class="line">veth-pod1  ====== veth-host1</span><br><span class="line">                          |</span><br><span class="line">                          |</span><br><span class="line">                    Node 网络协议栈</span><br></pre></td></tr></table></figure>
<h3 id="Node-→-Pod-1"><a href="#Node-→-Pod-1" class="headerlink" title="Node → Pod"></a>Node → Pod</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Node IP stack</span><br><span class="line">  |</span><br><span class="line">  |  查路由：172.16.0.2 dev veth-host1</span><br><span class="line">  |</span><br><span class="line">veth-host1 ====== veth-pod1</span><br><span class="line">                          |</span><br><span class="line">                          |</span><br><span class="line">                      Pod eth0</span><br></pre></td></tr></table></figure>
<h2 id="👉-关键点-veth-≈-一根虚拟网线-不需要-NAT-不需要-iptables-这是纯-L3-路由模型"><a href="#👉-关键点-veth-≈-一根虚拟网线-不需要-NAT-不需要-iptables-这是纯-L3-路由模型" class="headerlink" title="👉 关键点* veth ≈ 一根虚拟网线* 不需要 NAT* 不需要 iptables* 这是纯 L3 路由模型"></a>👉 <strong>关键点</strong><br>* veth ≈ 一根虚拟网线<br>* 不需要 NAT<br>* 不需要 iptables<br>* 这是纯 L3 路由模型</h2><h2 id="3️⃣-用一句话总结你现在的结构"><a href="#3️⃣-用一句话总结你现在的结构" class="headerlink" title="3️⃣ 用一句话总结你现在的结构"></a>3️⃣ 用一句话总结你现在的结构</h2><blockquote>
<p><strong>Pod 是 Node 网络的一部分，只是通过 veth 被“延长”到了另一个 namespace</strong><br>这正是 <strong>Kubernetes CNI 的核心哲学</strong>。</p>
</blockquote>
<hr>
<h1 id="五、完整的「清理步骤（DEL）」"><a href="#五、完整的「清理步骤（DEL）」" class="headerlink" title="五、完整的「清理步骤（DEL）」"></a>五、完整的「清理步骤（DEL）」</h1><h2 id="你现在做的是-ADD，但生产-CNI-最容易出-bug-的是-DEL。下面是完全对称、且安全的清理顺序。"><a href="#你现在做的是-ADD，但生产-CNI-最容易出-bug-的是-DEL。下面是完全对称、且安全的清理顺序。" class="headerlink" title="你现在做的是 ADD，但生产 CNI 最容易出 bug 的是 DEL。下面是完全对称、且安全的清理顺序。"></a>你现在做的是 <code>ADD</code>，但<strong>生产 CNI 最容易出 bug 的是 <code>DEL</code><strong>。<br>下面是</strong>完全对称、且安全的清理顺序</strong>。</h2><h2 id="Step-1：删除-Pod-netns（最彻底）"><a href="#Step-1：删除-Pod-netns（最彻底）" class="headerlink" title="Step 1：删除 Pod netns（最彻底）"></a>Step 1：删除 Pod netns（最彻底）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns del pod1</span><br></pre></td></tr></table></figure>
<h3 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns list</span><br></pre></td></tr></table></figure>
<h2 id="✅-pod1-不存在-⚠️-注意：-如果你删的是-netns，netns-内的-veth-会被自动回收"><a href="#✅-pod1-不存在-⚠️-注意：-如果你删的是-netns，netns-内的-veth-会被自动回收" class="headerlink" title="✅ pod1 不存在&gt; ⚠️ 注意：&gt; 如果你删的是 netns，netns 内的 veth 会被自动回收"></a>✅ pod1 不存在<br>&gt; ⚠️ 注意：<br>&gt; 如果你删的是 netns，<strong>netns 内的 veth 会被自动回收</strong></h2><h2 id="Step-2：确认-Node-侧-veth-是否还存在"><a href="#Step-2：确认-Node-侧-veth-是否还存在" class="headerlink" title="Step 2：确认 Node 侧 veth 是否还存在"></a>Step 2：确认 Node 侧 veth 是否还存在</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth-host1</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <strong>还存在</strong>（少见，但可能）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> del veth-host1</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="Step-3：清理路由（如果你是手动加的）"><a href="#Step-3：清理路由（如果你是手动加的）" class="headerlink" title="Step 3：清理路由（如果你是手动加的）"></a>Step 3：清理路由（如果你是手动加的）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route del 172.16.0.2 dev veth-host1</span><br></pre></td></tr></table></figure>
<h3 id="验证-3"><a href="#验证-3" class="headerlink" title="验证"></a>验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route | grep 172.16.0.2</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-4：清理-IP（一般随-veth-一起消失）"><a href="#Step-4：清理-IP（一般随-veth-一起消失）" class="headerlink" title="Step 4：清理 IP（一般随 veth 一起消失）"></a>Step 4：清理 IP（一般随 veth 一起消失）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr del 172.16.0.1/24 dev veth-host1</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Step-5：最终验证"><a href="#Step-5：最终验证" class="headerlink" title="Step 5：最终验证"></a>Step 5：最终验证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="built_in">link</span> | grep veth</span><br><span class="line">ip route | grep 172.16</span><br></pre></td></tr></table></figure>
<h2 id="✅-干净，环境恢复"><a href="#✅-干净，环境恢复" class="headerlink" title="✅ 干净，环境恢复"></a>✅ 干净，环境恢复</h2><h1 id="六、在“真实-CNI-IPAM”中，这些步骤是如何被管理的？"><a href="#六、在“真实-CNI-IPAM”中，这些步骤是如何被管理的？" class="headerlink" title="六、在“真实 CNI &#x2F; IPAM”中，这些步骤是如何被管理的？"></a>六、在“真实 CNI &#x2F; IPAM”中，这些步骤是如何被管理的？</h1><h2 id="你刚才是“人肉-IPAM”，现在我们系统化一下。"><a href="#你刚才是“人肉-IPAM”，现在我们系统化一下。" class="headerlink" title="你刚才是“人肉 IPAM”，现在我们系统化一下。"></a>你刚才是<strong>“人肉 IPAM”</strong>，现在我们系统化一下。</h2><h2 id="1️⃣-IPAM-的职责边界（非常重要）"><a href="#1️⃣-IPAM-的职责边界（非常重要）" class="headerlink" title="1️⃣ IPAM 的职责边界（非常重要）"></a>1️⃣ IPAM 的职责边界（非常重要）</h2><h2 id="IPAM-只做三件事：1-分配-IP2-回收-IP3-持久化-IP-使用状态它不：-创建-veth-配路由-管网络策略"><a href="#IPAM-只做三件事：1-分配-IP2-回收-IP3-持久化-IP-使用状态它不：-创建-veth-配路由-管网络策略" class="headerlink" title="IPAM 只做三件事：1. 分配 IP2. 回收 IP3. 持久化 IP 使用状态它不：* 创建 veth* 配路由* 管网络策略"></a><strong>IPAM 只做三件事：</strong><br>1. 分配 IP<br>2. 回收 IP<br>3. 持久化 IP 使用状态<br><strong>它不：</strong><br>* 创建 veth<br>* 配路由<br>* 管网络策略</h2><h2 id="2️⃣-常见-IPAM-模型-命令抽象"><a href="#2️⃣-常见-IPAM-模型-命令抽象" class="headerlink" title="2️⃣ 常见 IPAM 模型 &amp; 命令抽象"></a>2️⃣ 常见 IPAM 模型 &amp; 命令抽象</h2><h3 id="🔹-模型一：Node-子网（你现在用的）"><a href="#🔹-模型一：Node-子网（你现在用的）" class="headerlink" title="🔹 模型一：Node 子网（你现在用的）"></a>🔹 模型一：Node 子网（你现在用的）</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Node1: 172.16.0.0/24</span><br><span class="line">Node2: 172.16.1.0/24</span><br></pre></td></tr></table></figure>
<h2 id="IPAM-内部逻辑（抽象）："><a href="#IPAM-内部逻辑（抽象）：" class="headerlink" title="IPAM 内部逻辑（抽象）："></a><strong>IPAM 内部逻辑（抽象）</strong>：<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ALLOCATE:</span><br><span class="line">  找一个 free IP</span><br><span class="line">  标记为 used</span><br><span class="line">  返回 IP + mask + gateway</span><br><span class="line">RELEASE:</span><br><span class="line">  标记 IP 为 free</span><br></pre></td></tr></table></figure></h2><h3 id="🔹-手动模拟-IPAM-的常见命令"><a href="#🔹-手动模拟-IPAM-的常见命令" class="headerlink" title="🔹 手动模拟 IPAM 的常见命令"></a>🔹 手动模拟 IPAM 的常见命令</h3><h4 id="查看当前-Node-上的-Pod-IP（模拟）"><a href="#查看当前-Node-上的-Pod-IP（模拟）" class="headerlink" title="查看当前 Node 上的 Pod IP（模拟）"></a>查看当前 Node 上的 Pod IP（模拟）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr | grep 172.16</span><br></pre></td></tr></table></figure>
<h4 id="查看“已占用-IP”（粗暴版）"><a href="#查看“已占用-IP”（粗暴版）" class="headerlink" title="查看“已占用 IP”（粗暴版）"></a>查看“已占用 IP”（粗暴版）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route | grep veth</span><br></pre></td></tr></table></figure>
<h4 id="回收-IP（本质）"><a href="#回收-IP（本质）" class="headerlink" title="回收 IP（本质）"></a>回收 IP（本质）</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">删除 netns + 删除 veth + 删除路由</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3️⃣-常见真实-IPAM-实现"><a href="#3️⃣-常见真实-IPAM-实现" class="headerlink" title="3️⃣ 常见真实 IPAM 实现"></a>3️⃣ 常见真实 IPAM 实现</h2><table>
<thead>
<tr>
<th>IPAM</th>
<th>底层</th>
</tr>
</thead>
<tbody><tr>
<td>host-local</td>
<td>文件 <code>/var/lib/cni/networks/</code></td>
</tr>
<tr>
<td>calico-ipam</td>
<td>etcd &#x2F; CRD</td>
</tr>
<tr>
<td>cilium IPAM</td>
<td>KVStore &#x2F; Kubernetes</td>
</tr>
<tr>
<td>whereabouts</td>
<td>分布式锁</td>
</tr>
</tbody></table>
<h3 id="以-host-local-IPAM-为例"><a href="#以-host-local-IPAM-为例" class="headerlink" title="以 host-local IPAM 为例"></a>以 <strong>host-local IPAM</strong> 为例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /var/lib/cni/networks/&lt;network-name&gt;/</span><br></pre></td></tr></table></figure>
<p>你会看到：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.16.0.2</span><br><span class="line">172.16.0.3</span><br><span class="line">last_reserved_ip</span><br></pre></td></tr></table></figure>
<p>这就是 <strong>最原始的 IPAM 状态存储</strong></p>
<h2 id="故障诊断命令"><a href="#故障诊断命令" class="headerlink" title="故障诊断命令"></a>故障诊断命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># 网络虚拟化环境诊断脚本</span><br><span class="line"></span><br><span class="line">echo &quot;=== 网络命名空间检查 ===&quot;</span><br><span class="line">ip netns list</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== 网桥信息 ===&quot;</span><br><span class="line">bridge link show 2&gt;/dev/null || ip link show type bridge</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== veth设备检查 ===&quot;</span><br><span class="line">ip link show type veth</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== 路由表检查 ===&quot;</span><br><span class="line">for ns in $(ip netns list | awk &#x27;&#123;print $1&#125;&#x27;); do</span><br><span class="line">    echo &quot;--- 命名空间 $ns 路由表 ---&quot;</span><br><span class="line">    ip netns exec $ns ip route show</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== ARP表检查 ===&quot;</span><br><span class="line">for ns in $(ip netns list | awk &#x27;&#123;print $1&#125;&#x27;); do</span><br><span class="line">    echo &quot;--- 命名空间 $ns ARP表 ---&quot;</span><br><span class="line">    ip netns exec $ns ip neighbor show</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== 连通性测试 ===&quot;</span><br><span class="line"># 测试网桥内部通信</span><br><span class="line">if ip netns list | grep -q ns0; then</span><br><span class="line">    ip netns exec ns0 ping -c 2 172.17.0.1 &gt;/dev/null 2&gt;&amp;1 &amp;&amp; \</span><br><span class="line">        echo &quot;网桥内部通信: 正常&quot; || echo &quot;网桥内部通信: 失败&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n=== iptables规则检查 ===&quot;</span><br><span class="line">iptables -t nat -L -n -v</span><br><span class="line">iptables -L FORWARD -n -v</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/21/BCC-BPF-Compiler-Collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/21/BCC-BPF-Compiler-Collection/" class="post-title-link" itemprop="url">BCC(BPF Compiler Collection)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-21 15:33:50 / 修改时间：15:48:41" itemprop="dateCreated datePublished" datetime="2026-01-21T15:33:50+08:00">2026-01-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="BCC包括的一些工具"><a href="#BCC包括的一些工具" class="headerlink" title="BCC包括的一些工具"></a>BCC包括的一些工具</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://tonydeng.github.io/sdn-handbook/linux/bpf/bcc.html">https://tonydeng.github.io/sdn-handbook/linux/bpf/bcc.html</a><br><img src="https://raw.githubusercontent.com/shispring/picgo/master/bcc_tracing_tools_2016.png" alt="bcc" title="bcc"></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#CentOS</span><br><span class="line">yum install -y bcc-tools</span><br><span class="line"></span><br><span class="line">ls /usr/share/bcc/tools</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/20/tcp%E5%8D%8A%E8%BF%9E%E6%8E%A5-%E5%85%A8%E8%BF%9E%E6%8E%A5%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/20/tcp%E5%8D%8A%E8%BF%9E%E6%8E%A5-%E5%85%A8%E8%BF%9E%E6%8E%A5%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">tcp半连接/全连接核心参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-20 14:34:27 / 修改时间：14:35:01" itemprop="dateCreated datePublished" datetime="2026-01-20T14:34:27+08:00">2026-01-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、TCP-半连接-全连接核心参数对照表"><a href="#一、TCP-半连接-全连接核心参数对照表" class="headerlink" title="一、TCP 半连接 &#x2F; 全连接核心参数对照表"></a>一、TCP 半连接 &#x2F; 全连接核心参数对照表</h2><h3 id="1️⃣-net-ipv4-tcp-max-syn-backlog"><a href="#1️⃣-net-ipv4-tcp-max-syn-backlog" class="headerlink" title="1️⃣ net.ipv4.tcp_max_syn_backlog"></a>1️⃣ <code>net.ipv4.tcp_max_syn_backlog</code></h3><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td>tcp_max_syn_backlog</td>
</tr>
<tr>
<td><strong>作用阶段</strong></td>
<td>半连接队列（SYN_RECV 阶段）</td>
</tr>
<tr>
<td><strong>含义</strong></td>
<td>内核允许的最大 <strong>半连接（SYN 已收到，三次握手未完成）</strong> 数量</td>
</tr>
<tr>
<td><strong>典型现象</strong></td>
<td>队列满时：不回 SYN+ACK 或启用 syncookies</td>
</tr>
<tr>
<td><strong>你的当前值</strong></td>
<td><code>4096</code></td>
</tr>
<tr>
<td><strong>不同值的影响</strong></td>
<td><ul><li>小：突发连接时大量 SYN 超时</li><li>大：提升并发连接建立能力（需内存）</li></ul></td>
</tr>
<tr>
<td><strong>查看方式</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_max_syn_backlog</code></td>
</tr>
<tr>
<td><strong>是否单独生效</strong></td>
<td>❌ 否（受 somaxconn、listen backlog 共同限制）</td>
</tr>
</tbody></table>
<hr>
<h3 id="2️⃣-net-ipv4-tcp-syncookies"><a href="#2️⃣-net-ipv4-tcp-syncookies" class="headerlink" title="2️⃣ net.ipv4.tcp_syncookies"></a>2️⃣ <code>net.ipv4.tcp_syncookies</code></h3><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td>tcp_syncookies</td>
</tr>
<tr>
<td><strong>作用阶段</strong></td>
<td>半连接队列溢出时</td>
</tr>
<tr>
<td><strong>含义</strong></td>
<td>半连接队列满时，是否启用 <strong>SYN Cookies</strong></td>
</tr>
<tr>
<td><strong>你的当前值</strong></td>
<td><code>1</code></td>
</tr>
<tr>
<td><strong>不同值的作用</strong></td>
<td><ul><li><code>0</code>：关闭（队列满直接丢 SYN）</li><li><code>1</code>：仅队列满时启用（⭐推荐）</li><li><code>2</code>：无条件启用（防 SYN flood）</li></ul></td>
</tr>
<tr>
<td><strong>查看方式</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_syncookies</code></td>
</tr>
<tr>
<td><strong>注意点</strong></td>
<td>开启时部分 TCP 扩展（窗口扩大、时间戳）可能受限</td>
</tr>
</tbody></table>
<p>✅ <strong>结论</strong>：你的配置是生产环境<strong>最合理值</strong></p>
<hr>
<h3 id="3️⃣-net-core-somaxconn"><a href="#3️⃣-net-core-somaxconn" class="headerlink" title="3️⃣ net.core.somaxconn"></a>3️⃣ <code>net.core.somaxconn</code></h3><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td>somaxconn</td>
</tr>
<tr>
<td><strong>作用阶段</strong></td>
<td>全连接队列（accept queue）</td>
</tr>
<tr>
<td><strong>含义</strong></td>
<td>系统层面允许的 <strong>listen backlog 最大值</strong></td>
</tr>
<tr>
<td><strong>你的当前值</strong></td>
<td><code>4096</code></td>
</tr>
<tr>
<td><strong>不同值的影响</strong></td>
<td><ul><li>小：accept 队列很容易满</li><li>大：支撑高并发 accept</li></ul></td>
</tr>
<tr>
<td><strong>查看方式</strong></td>
<td><code>cat /proc/sys/net/core/somaxconn</code></td>
</tr>
<tr>
<td><strong>是否决定最终值</strong></td>
<td>❌ 否（还取决于应用 listen backlog）</td>
</tr>
</tbody></table>
<hr>
<h3 id="4️⃣-net-ipv4-tcp-abort-on-overflow"><a href="#4️⃣-net-ipv4-tcp-abort-on-overflow" class="headerlink" title="4️⃣ net.ipv4.tcp_abort_on_overflow"></a>4️⃣ <code>net.ipv4.tcp_abort_on_overflow</code></h3><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td>tcp_abort_on_overflow</td>
</tr>
<tr>
<td><strong>作用阶段</strong></td>
<td>全连接队列满</td>
</tr>
<tr>
<td><strong>含义</strong></td>
<td>accept 队列满时，如何处理客户端 ACK</td>
</tr>
<tr>
<td><strong>你的当前值</strong></td>
<td><code>0</code></td>
</tr>
<tr>
<td><strong>不同值的作用</strong></td>
<td><ul><li><code>0</code>：丢 ACK（客户端重试 → 看起来像超时）</li><li><code>1</code>：回 RST（客户端立刻失败）</li></ul></td>
</tr>
<tr>
<td><strong>查看方式</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_abort_on_overflow</code></td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td><ul><li>0：线上业务（避免误伤）</li><li>1：压测&#x2F;定位问题</li></ul></td>
</tr>
</tbody></table>
<p>⚠️ <strong>这是排障神器，但不建议长期线上开启 1</strong></p>
<hr>
<h3 id="5️⃣-net-ipv4-tcp-synack-retries"><a href="#5️⃣-net-ipv4-tcp-synack-retries" class="headerlink" title="5️⃣ net.ipv4.tcp_synack_retries"></a>5️⃣ <code>net.ipv4.tcp_synack_retries</code></h3><table>
<thead>
<tr>
<th>项目</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td><strong>名称</strong></td>
<td>tcp_synack_retries</td>
</tr>
<tr>
<td><strong>作用阶段</strong></td>
<td>半连接保活</td>
</tr>
<tr>
<td><strong>含义</strong></td>
<td>SYN+ACK 最大重传次数</td>
</tr>
<tr>
<td><strong>你的当前值</strong></td>
<td><code>5</code></td>
</tr>
<tr>
<td><strong>默认值</strong></td>
<td>通常是 5</td>
</tr>
<tr>
<td><strong>不同值的影响</strong></td>
<td><ul><li>大：半连接驻留时间长</li><li>小：更快释放半连接</li></ul></td>
</tr>
<tr>
<td><strong>查看方式</strong></td>
<td><code>cat /proc/sys/net/ipv4/tcp_synack_retries</code></td>
</tr>
<tr>
<td><strong>经验值</strong></td>
<td>2～5（内网服务可适当调小）</td>
</tr>
</tbody></table>
<hr>
<h2 id="二、一个非常重要但常被忽略的事实"><a href="#二、一个非常重要但常被忽略的事实" class="headerlink" title="二、一个非常重要但常被忽略的事实"></a>二、一个<strong>非常重要但常被忽略的事实</strong></h2><h3 id="❗-半连接-全连接真正的“生效长度”公式"><a href="#❗-半连接-全连接真正的“生效长度”公式" class="headerlink" title="❗ 半连接 &#x2F; 全连接真正的“生效长度”公式"></a>❗ 半连接 &#x2F; 全连接真正的“生效长度”公式</h3><h4 id="🔹-半连接队列最大长度"><a href="#🔹-半连接队列最大长度" class="headerlink" title="🔹 半连接队列最大长度"></a>🔹 半连接队列最大长度</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">min(</span><br><span class="line">  net.ipv4.tcp_max_syn_backlog,</span><br><span class="line">  net.core.somaxconn,</span><br><span class="line">  listen(backlog)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="🔹-全连接队列最大长度"><a href="#🔹-全连接队列最大长度" class="headerlink" title="🔹 全连接队列最大长度"></a>🔹 全连接队列最大长度</h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">min(</span><br><span class="line">  net.core.somaxconn,</span><br><span class="line">  listen(backlog)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>👉 <strong>只调内核参数，不调应用 backlog &#x3D; 白调</strong></p>
<hr>
<h2 id="三、Redis-NGINX-backlog-配置对照"><a href="#三、Redis-NGINX-backlog-配置对照" class="headerlink" title="三、Redis &#x2F; NGINX backlog 配置对照"></a>三、Redis &#x2F; NGINX backlog 配置对照</h2><h3 id="🟥-Redis"><a href="#🟥-Redis" class="headerlink" title="🟥 Redis"></a>🟥 Redis</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># redis.conf</span><br><span class="line">tcp-backlog 511</span><br></pre></td></tr></table></figure>

<ul>
<li>实际生效值：</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">min(tcp-backlog, somaxconn)</span><br></pre></td></tr></table></figure>

<p>📌 建议：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp-backlog 4096</span><br></pre></td></tr></table></figure>

<p>并配合：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.core.somaxconn=4096</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="🟩-NGINX"><a href="#🟩-NGINX" class="headerlink" title="🟩 NGINX"></a>🟩 NGINX</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">listen</span> <span class="number">80</span> backlog=<span class="number">4096</span>;</span><br></pre></td></tr></table></figure>

<p>⚠️ 如果不显式配置：</p>
<ul>
<li>由 NGINX 内部默认值决定</li>
<li>很多版本默认 <strong>511</strong></li>
</ul>
<p>📌 高并发入口（Ingress &#x2F; API Gateway）<strong>一定要显式写 backlog</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2026/01/19/tc%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2026/01/19/tc%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">tc流量控制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2026-01-19 11:07:52 / 修改时间：12:15:03" itemprop="dateCreated datePublished" datetime="2026-01-19T11:07:52+08:00">2026-01-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="流量控制处理对象"><a href="#流量控制处理对象" class="headerlink" title="流量控制处理对象"></a>流量控制处理对象</h2><ul>
<li>流量的处理由三种对象控制，它们是：qdisc（排队规则）、class（类别）和filter（过滤器）</li>
</ul>
<h2 id="TC常用命令"><a href="#TC常用命令" class="headerlink" title="TC常用命令"></a>TC常用命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">1）模拟延迟传输：</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms</span><br><span class="line">该命令将 eth0 网卡的传输设置为延迟 100 毫秒发送，更真实的情况下,延迟值不会这么精确，会有一定的波动，后面用下面的情况来模拟出带有波动性的延迟值</span><br><span class="line"></span><br><span class="line">2）模拟延迟波动：</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms 10ms</span><br><span class="line">该命令将 eth0 网卡的传输设置为延迟 100ms ± 10ms (90 ~ 110 ms 之间的任意值)发送。 还可以更进一步加强这种波动的随机性</span><br><span class="line"></span><br><span class="line">3）延迟波动随机性：</span><br><span class="line"># tc qdisc add dev eth0 root netem delay 100ms 10ms 30%</span><br><span class="line">该命令将 eth0 网卡的传输设置为 100ms ,同时,大约有 30% 的包会延迟 ± 10ms 发送。</span><br><span class="line"></span><br><span class="line">4）模拟网络丢包：</span><br><span class="line"># tc qdisc add dev eth0 root netem loss 1%</span><br><span class="line">该命令将 eth0 网卡的传输设置为随机丢掉 1% 的数据包</span><br><span class="line"></span><br><span class="line">5）网络丢包成功率：</span><br><span class="line"># tc qdisc add dev eth0 root netem loss 1% 30%</span><br><span class="line">该命令将 eth0 网卡的传输设置为随机丢掉 1% 的数据包,成功率为 30%</span><br><span class="line"></span><br><span class="line">6）删除相关配置（将之前命令中的 add 改为 del 即可删除配置）：</span><br><span class="line"># tc qdisc del dev eth0 root netem delay 100ms</span><br><span class="line"></span><br><span class="line">7）模拟包重复：</span><br><span class="line"># tc qdisc add dev eth0 root netem duplicate 1%</span><br><span class="line">该命令将 eth0 网卡的传输设置为随机产生 1% 的重复数据包</span><br><span class="line"></span><br><span class="line">8）模拟包损坏：</span><br><span class="line"># tc qdisc add dev eth0 root netem corrupt 0.2%</span><br><span class="line">该命令将 eth0 网卡的传输设置为随机产生 0.2% 的损坏的数据包 。 (内核版本需在 2.6.16 以上)</span><br><span class="line"></span><br><span class="line">9）模拟包乱序：</span><br><span class="line"># tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%</span><br><span class="line">该命令将 eth0 网卡的传输设置为:有 25% 的数据包(50%相关)会被立即发送,其他的延迟10 秒。</span><br><span class="line">新版本中,如下命令也会在一定程度上打乱发包的次序:# tc qdisc add dev eth0 root netem delay 100ms 10ms</span><br><span class="line"> </span><br><span class="line">10）查看网卡配置：</span><br><span class="line"># tc qdisc show dev eth0</span><br><span class="line">该命令将 查看并显示 eth0 网卡的相关传输配置</span><br><span class="line"></span><br><span class="line">11）查看丢包率：</span><br><span class="line"># tc -s qdisc show dev eth0</span><br></pre></td></tr></table></figure>

<h2 id="架构参考"><a href="#架构参考" class="headerlink" title="架构参考"></a>架构参考</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/traffic-control-from-queue-to-edt-zh/">https://arthurchiao.art/blog/traffic-control-from-queue-to-edt-zh/</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2045045">https://cloud.tencent.com/developer/article/2045045</a><br><a target="_blank" rel="noopener" href="https://wiki.dreamrunner.org/public_html/Linux/Networks/netfilter.html">https://wiki.dreamrunner.org/public_html/Linux/Networks/netfilter.html</a><br>可视化工具：<a target="_blank" rel="noopener" href="https://github.com/vitawasalreadytaken/tcviz">https://github.com/vitawasalreadytaken/tcviz</a><br>路径分析:<a target="_blank" rel="noopener" href="https://just4coding.com/2023/08/24/docker-bridge/">https://just4coding.com/2023/08/24/docker-bridge/</a><br>网络虚拟设备：<a target="_blank" rel="noopener" href="https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#">https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">175</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
