<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shispring.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shispring">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>èµ„æº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/08/05/zap%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/05/zap%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB/" class="post-title-link" itemprop="url">zapæ—¥å¿—çº§åˆ«</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-05 16:21:34 / ä¿®æ”¹æ—¶é—´ï¼š16:23:24" itemprop="dateCreated datePublished" datetime="2025-08-05T16:21:34+08:00">2025-08-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="zapè°ƒè¯•"><a href="#zapè°ƒè¯•" class="headerlink" title="zapè°ƒè¯•"></a>zapè°ƒè¯•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;flag&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">	ctrl &quot;sigs.k8s.io/controller-runtime&quot;</span><br><span class="line">	&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	var opts zap.Options</span><br><span class="line">	opts.BindFlags(flag.CommandLine)</span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	ctrl.SetLogger(zap.New(zap.UseFlagOptions(&amp;opts)))</span><br><span class="line">	log := ctrl.Log.WithName(&quot;TestLogger&quot;)</span><br><span class="line"></span><br><span class="line">	fmt.Println(&quot;Testing different log levels:&quot;)</span><br><span class="line"></span><br><span class="line">	log.Info(&quot;This is Info level&quot;)</span><br><span class="line">	log.V(1).Info(&quot;This is V(1) level&quot;)</span><br><span class="line">	log.V(2).Info(&quot;This is V(2) level&quot;)</span><br><span class="line">	log.V(3).Info(&quot;This is V(3) level&quot;)</span><br><span class="line"></span><br><span class="line">	fmt.Println(&quot;Test completed&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œæ–¹å¼"><a href="#è¿è¡Œæ–¹å¼" class="headerlink" title="è¿è¡Œæ–¹å¼"></a>è¿è¡Œæ–¹å¼</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">go run test-zap-levels.go --zap-log-level=1</span><br><span class="line">go run test-zap-levels.go --zap-log-level=debug</span><br><span class="line">go run test-zap-levels.go --zap-log-level=9</span><br><span class="line"></span><br><span class="line">V(1) â†’ æ˜¾ç¤ºä¸º debug çº§åˆ«</span><br><span class="line">V(2) â†’ æ˜¾ç¤ºä¸º Level(-2) çº§åˆ«</span><br><span class="line">V(3) â†’ æ˜¾ç¤ºä¸º Level(-3) çº§åˆ«</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/08/01/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8Ewebhook%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/01/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8Ewebhook%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">podç”Ÿå‘½å‘¨æœŸä¸webhookç®¡æ§åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 14:56:23 / ä¿®æ”¹æ—¶é—´ï¼š14:59:16" itemprop="dateCreated datePublished" datetime="2025-08-01T14:56:23+08:00">2025-08-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Pod-ç”Ÿå‘½å‘¨æœŸä¸-Webhook-ç®¡æ§åˆ†æ"><a href="#Kubernetes-Pod-ç”Ÿå‘½å‘¨æœŸä¸-Webhook-ç®¡æ§åˆ†æ" class="headerlink" title="Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æ"></a>Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æ</h1><h2 id="ğŸ¯-ç›®å½•"><a href="#ğŸ¯-ç›®å½•" class="headerlink" title="ğŸ¯ ç›®å½•"></a>ğŸ¯ ç›®å½•</h2><ul>
<li><a href="#pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%8A%B6%E6%80%81%E8%AF%A6%E8%A7%A3">Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</a></li>
<li><a href="#webhook-%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA">Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº</a></li>
<li><a href="#%E5%90%84%E9%98%B6%E6%AE%B5-webhook-%E7%AE%A1%E6%8E%A7%E8%83%BD%E5%8A%9B">å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›</a></li>
<li><a href="#pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B%E5%9B%BE">Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B">å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</a></li>
</ul>
<hr>
<h2 id="Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"><a href="#Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£" class="headerlink" title="Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"></a>Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</h2><h3 id="ğŸ“Š-Pod-çŠ¶æ€è½¬æ¢è¡¨"><a href="#ğŸ“Š-Pod-çŠ¶æ€è½¬æ¢è¡¨" class="headerlink" title="ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨"></a>ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨</h3><table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>Pod Phase</th>
<th>Pod Condition</th>
<th>Container State</th>
<th>Webhook è§¦å‘</th>
<th>ç®¡æ§èƒ½åŠ›</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åˆ›å»ºå‰</strong></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>âœ… ValidatingAdmissionWebhook<br>âœ… MutatingAdmissionWebhook</td>
<td>ğŸ”¥ <strong>å®Œå…¨ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>åˆ›å»ºä¸­</strong></td>
<td>Pending</td>
<td>PodScheduled: False</td>
<td>Waiting</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>è°ƒåº¦ä¸­</strong></td>
<td>Pending</td>
<td>PodScheduled: True</td>
<td>Waiting</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>åˆå§‹åŒ–</strong></td>
<td>Pending</td>
<td>Initialized: False</td>
<td>Waiting&#x2F;Running</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>è¿è¡Œä¸­</strong></td>
<td>Running</td>
<td>Ready: True</td>
<td>Running</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>ç»ˆæ­¢å‰</strong></td>
<td>Running â†’ Terminating</td>
<td>-</td>
<td>Running</td>
<td>âœ… Lifecycle PreStop Hook</td>
<td>âš ï¸ <strong>æœ‰é™ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>ç»ˆæ­¢ä¸­</strong></td>
<td>Terminating</td>
<td>-</td>
<td>Terminating</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>å®Œæˆ&#x2F;å¤±è´¥</strong></td>
<td>Succeeded&#x2F;Failed</td>
<td>-</td>
<td>Terminated</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
</tbody></table>
<h3 id="ğŸ”-å…³é”®è§‚å¯Ÿç‚¹"><a href="#ğŸ”-å…³é”®è§‚å¯Ÿç‚¹" class="headerlink" title="ğŸ” å…³é”®è§‚å¯Ÿç‚¹"></a>ğŸ” å…³é”®è§‚å¯Ÿç‚¹</h3><h4 id="1-Webhook-ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»"><a href="#1-Webhook-ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»" class="headerlink" title="1. Webhook ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»"></a>1. Webhook ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»</h4><ul>
<li><strong>Pod åˆ›å»ºå‰</strong>ï¼šAdmission Controller é˜¶æ®µï¼Œæœ€å¼ºç®¡æ§èƒ½åŠ›</li>
<li><strong>Pod ç»ˆæ­¢å‰</strong>ï¼šPreStop Hook é˜¶æ®µï¼Œæœ‰é™çš„ä¼˜é›…å…³é—­æ§åˆ¶</li>
</ul>
<h4 id="2-æ— æ³•ç®¡æ§çš„é˜¶æ®µ"><a href="#2-æ— æ³•ç®¡æ§çš„é˜¶æ®µ" class="headerlink" title="2. æ— æ³•ç®¡æ§çš„é˜¶æ®µ"></a>2. æ— æ³•ç®¡æ§çš„é˜¶æ®µ</h4><ul>
<li>Pod åˆ›å»ºåçš„æ•´ä¸ªè¿è¡Œç”Ÿå‘½å‘¨æœŸ</li>
<li>å®¹å™¨å¯åŠ¨ã€å¥åº·æ£€æŸ¥ã€é‡å¯ç­‰è¿‡ç¨‹</li>
<li>èµ„æºè°ƒåº¦å’ŒèŠ‚ç‚¹åˆ†é…è¿‡ç¨‹</li>
</ul>
<hr>
<h2 id="Webhook-ç±»å‹ä¸è§¦å‘æ—¶æœº"><a href="#Webhook-ç±»å‹ä¸è§¦å‘æ—¶æœº" class="headerlink" title="Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº"></a>Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº</h2><h3 id="ğŸ£-Admission-Controller-Webhook"><a href="#ğŸ£-Admission-Controller-Webhook" class="headerlink" title="ğŸ£ Admission Controller Webhook"></a>ğŸ£ Admission Controller Webhook</h3><h4 id="ValidatingAdmissionWebhook"><a href="#ValidatingAdmissionWebhook" class="headerlink" title="ValidatingAdmissionWebhook"></a>ValidatingAdmissionWebhook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate-pod.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/validate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>è§¦å‘æ—¶æœºï¼š</strong></p>
<ul>
<li>âœ… Pod CREATE è¯·æ±‚</li>
<li>âœ… Pod UPDATE è¯·æ±‚  </li>
<li>âœ… åœ¨ etcd å­˜å‚¨ä¹‹å‰</li>
<li>âœ… åœ¨è°ƒåº¦å™¨åˆ†é…ä¹‹å‰</li>
</ul>
<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>ğŸ”¥ <strong>æ‹’ç»åˆ›å»º</strong>ï¼šè¿”å›é”™è¯¯é˜»æ­¢ Pod åˆ›å»º</li>
<li>ğŸ”¥ <strong>éªŒè¯è§„åˆ™</strong>ï¼šæ£€æŸ¥èµ„æºé™åˆ¶ã€æ ‡ç­¾ã€æ³¨è§£ç­‰</li>
<li>ğŸ”¥ <strong>å®‰å…¨ç­–ç•¥</strong>ï¼šå¼ºåˆ¶å®‰å…¨ç­–ç•¥åˆè§„</li>
</ul>
<h4 id="MutatingAdmissionWebhook"><a href="#MutatingAdmissionWebhook" class="headerlink" title="MutatingAdmissionWebhook"></a>MutatingAdmissionWebhook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-mutator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mutate-pod.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/mutate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>ğŸ”¥ <strong>ä¿®æ”¹é…ç½®</strong>ï¼šæ³¨å…¥ sidecar å®¹å™¨</li>
<li>ğŸ”¥ <strong>æ·»åŠ èµ„æº</strong>ï¼šè®¾ç½®é»˜è®¤èµ„æºé™åˆ¶</li>
<li>ğŸ”¥ <strong>å®‰å…¨å¢å¼º</strong>ï¼šæ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡</li>
<li>ğŸ”¥ <strong>ç¯å¢ƒæ³¨å…¥</strong>ï¼šæ·»åŠ ç¯å¢ƒå˜é‡ã€æŒ‚è½½ç‚¹</li>
</ul>
<h3 id="ğŸª-Lifecycle-Hook"><a href="#ğŸª-Lifecycle-Hook" class="headerlink" title="ğŸª Lifecycle Hook"></a>ğŸª Lifecycle Hook</h3><h4 id="PreStop-Hook"><a href="#PreStop-Hook" class="headerlink" title="PreStop Hook"></a>PreStop Hook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;nginx -s quit; while killall -0 nginx; do sleep 1; done&quot;</span>]</span><br><span class="line">        <span class="comment"># æˆ–è€… HTTP è°ƒç”¨</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/shutdown</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>

<p><strong>è§¦å‘æ—¶æœºï¼š</strong></p>
<ul>
<li>âœ… Pod æ”¶åˆ° SIGTERM ä¹‹å‰</li>
<li>âœ… åˆ é™¤ Pod æ—¶</li>
<li>âœ… èŠ‚ç‚¹é©±é€æ—¶</li>
<li>âœ… Deployment æ»šåŠ¨æ›´æ–°æ—¶</li>
</ul>
<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>âš ï¸ <strong>ä¼˜é›…å…³é—­</strong>ï¼šæ¸…ç†èµ„æºã€ä¿å­˜çŠ¶æ€</li>
<li>âš ï¸ <strong>å®Œæˆå¤„ç†</strong>ï¼šå¤„ç†å‰©ä½™è¯·æ±‚</li>
<li>âš ï¸ <strong>é€šçŸ¥æœåŠ¡</strong>ï¼šé€šçŸ¥å…¶ä»–æœåŠ¡ä¸‹çº¿</li>
<li>âš ï¸ <strong>æœ‰æ—¶é—´é™åˆ¶</strong>ï¼šé»˜è®¤ 30s (terminationGracePeriodSeconds)</li>
</ul>
<hr>
<h2 id="å„é˜¶æ®µ-Webhook-ç®¡æ§èƒ½åŠ›"><a href="#å„é˜¶æ®µ-Webhook-ç®¡æ§èƒ½åŠ›" class="headerlink" title="å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›"></a>å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›</h2><h3 id="ğŸš€-Pod-åˆ›å»ºé˜¶æ®µ-æœ€å¼ºç®¡æ§"><a href="#ğŸš€-Pod-åˆ›å»ºé˜¶æ®µ-æœ€å¼ºç®¡æ§" class="headerlink" title="ğŸš€ Pod åˆ›å»ºé˜¶æ®µ (æœ€å¼ºç®¡æ§)"></a>ğŸš€ Pod åˆ›å»ºé˜¶æ®µ (æœ€å¼ºç®¡æ§)</h3><h4 id="Mutating-Webhook-å…¸å‹ç”¨ä¾‹"><a href="#Mutating-Webhook-å…¸å‹ç”¨ä¾‹" class="headerlink" title="Mutating Webhook å…¸å‹ç”¨ä¾‹"></a>Mutating Webhook å…¸å‹ç”¨ä¾‹</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Sidecar æ³¨å…¥</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">sidecar.istio.io/inject:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line"><span class="comment"># ç»è¿‡ Mutating Webhook å:</span></span><br><span class="line"><span class="comment"># + istio-proxy sidecar å®¹å™¨</span></span><br><span class="line"><span class="comment"># + ç›¸å…³ volume å’Œ æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="comment"># + ç½‘ç»œé…ç½®ä¿®æ”¹</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. å®‰å…¨ç­–ç•¥æ³¨å…¥</span></span><br><span class="line"><span class="comment"># åŸå§‹ Pod è§„èŒƒ</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># ç»è¿‡ Mutating Webhook å:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">drop:</span> [<span class="string">&quot;ALL&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Validating-Webhook-å…¸å‹åœºæ™¯"><a href="#Validating-Webhook-å…¸å‹åœºæ™¯" class="headerlink" title="Validating Webhook å…¸å‹åœºæ™¯"></a>Validating Webhook å…¸å‹åœºæ™¯</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Webhook éªŒè¯é€»è¾‘ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validatePod</span><span class="params">(pod *corev1.Pod)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. èµ„æºé™åˆ¶æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> container.Resources.Limits == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;container %s must have resource limits&quot;</span>, container.Name)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        cpuLimit := container.Resources.Limits[corev1.ResourceCPU]</span><br><span class="line">        <span class="keyword">if</span> cpuLimit.IsZero() || cpuLimit.Cmp(resource.MustParse(<span class="string">&quot;2&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;CPU limit must be between 0 and 2 cores&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. é•œåƒå®‰å…¨æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> !strings.HasPrefix(container.Image, <span class="string">&quot;registry.company.com/&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;only internal registry images are allowed&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ ‡ç­¾å¿…éœ€æ€§æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Labels[<span class="string">&quot;app&quot;</span>] == <span class="string">&quot;&quot;</span> || pod.Labels[<span class="string">&quot;version&quot;</span>] == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;app and version labels are required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-Pod-ç»ˆæ­¢é˜¶æ®µ-æœ‰é™ç®¡æ§"><a href="#âš ï¸-Pod-ç»ˆæ­¢é˜¶æ®µ-æœ‰é™ç®¡æ§" class="headerlink" title="âš ï¸ Pod ç»ˆæ­¢é˜¶æ®µ (æœ‰é™ç®¡æ§)"></a>âš ï¸ Pod ç»ˆæ­¢é˜¶æ®µ (æœ‰é™ç®¡æ§)</h3><h4 id="PreStop-Hook-ä½¿ç”¨åœºæ™¯"><a href="#PreStop-Hook-ä½¿ç”¨åœºæ™¯" class="headerlink" title="PreStop Hook ä½¿ç”¨åœºæ™¯"></a>PreStop Hook ä½¿ç”¨åœºæ™¯</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ•°æ®åº“è¿æ¥æ± ä¼˜é›…å…³é—­</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            # åœæ­¢æ¥å—æ–°è¯·æ±‚</span></span><br><span class="line"><span class="string">            curl -X POST http://localhost:8080/admin/shutdown</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ</span></span><br><span class="line">            <span class="string">while</span> [ <span class="string">$(curl</span> <span class="string">-s</span> <span class="string">http://localhost:8080/admin/connections)</span> <span class="string">-gt</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">&quot;Waiting for connections to drain...&quot;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">2</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ¸…ç†ç¼“å­˜</span></span><br><span class="line">            <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://localhost:8080/admin/flush-cache</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…ä¼˜é›…å…³é—­</span></span><br><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">preStop:</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        # åœæ­¢æ¶ˆè´¹æ–°æ¶ˆæ¯</span></span><br><span class="line"><span class="string">        kill -USR1 $(pgrep consumer)</span></span><br><span class="line"><span class="string"></span>        </span><br><span class="line">        <span class="comment"># ç­‰å¾…å½“å‰æ¶ˆæ¯å¤„ç†å®Œæˆ</span></span><br><span class="line">        <span class="string">while</span> <span class="string">pgrep</span> <span class="string">-f</span> <span class="string">&quot;processing_message&quot;</span> <span class="string">&gt;</span> <span class="string">/dev/null;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Waiting for message processing...&quot;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">1</span></span><br><span class="line">        <span class="string">done</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æäº¤åç§»é‡</span></span><br><span class="line">        <span class="string">/app/commit_offsets.sh</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸš«-æ— æ³•ç®¡æ§çš„é˜¶æ®µ"><a href="#ğŸš«-æ— æ³•ç®¡æ§çš„é˜¶æ®µ" class="headerlink" title="ğŸš« æ— æ³•ç®¡æ§çš„é˜¶æ®µ"></a>ğŸš« æ— æ³•ç®¡æ§çš„é˜¶æ®µ</h3><h4 id="è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–"><a href="#è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–" class="headerlink" title="è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–"></a>è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™äº›çŠ¶æ€å˜åŒ–æ— æ³•é€šè¿‡ Webhook ç®¡æ§:</span></span><br><span class="line"><span class="comment"># - å®¹å™¨å¯åŠ¨å¤±è´¥ (CrashLoopBackOff)</span></span><br><span class="line"><span class="comment"># - å¥åº·æ£€æŸ¥å¤±è´¥ (Liveness/Readiness Probe)</span></span><br><span class="line"><span class="comment"># - èµ„æºä¸è¶³å¯¼è‡´é©±é€ (Evicted)</span></span><br><span class="line"><span class="comment"># - èŠ‚ç‚¹æ•…éšœå¯¼è‡´çš„ Pod é‡æ–°è°ƒåº¦</span></span><br><span class="line"><span class="comment"># - OOMKilled çŠ¶æ€</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Pod-ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾"><a href="#Pod-ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾" class="headerlink" title="Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾"></a>Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[kubectl apply pod.yaml] --&gt; B&#123;Mutating Admission Webhook&#125;</span><br><span class="line">    B --&gt; C&#123;Validating Admission Webhook&#125;</span><br><span class="line">    C --&gt;|Approved| D[Pod Stored in etcd]</span><br><span class="line">    C --&gt;|Rejected| E[Creation Failed]</span><br><span class="line">    B --&gt;|Modified| C</span><br><span class="line">    </span><br><span class="line">    D --&gt; F[Scheduler Assigns Node]</span><br><span class="line">    F --&gt; G[Kubelet Pulls Images]</span><br><span class="line">    G --&gt; H[Init Containers]</span><br><span class="line">    H --&gt; I[Main Containers Start]</span><br><span class="line">    I --&gt; J&#123;Health Checks&#125;</span><br><span class="line">    J --&gt;|Pass| K[Pod Running]</span><br><span class="line">    J --&gt;|Fail| L[Container Restart]</span><br><span class="line">    L --&gt; I</span><br><span class="line">    </span><br><span class="line">    K --&gt; M[Application Serving]</span><br><span class="line">    M --&gt; N&#123;Termination Signal?&#125;</span><br><span class="line">    N --&gt;|No| M</span><br><span class="line">    N --&gt;|Yes| O[PreStop Hook Execution]</span><br><span class="line">    </span><br><span class="line">    O --&gt; P[SIGTERM Sent]</span><br><span class="line">    P --&gt; Q[Graceful Shutdown Period]</span><br><span class="line">    Q --&gt; R&#123;Containers Stopped?&#125;</span><br><span class="line">    R --&gt;|Yes| S[Pod Terminated]</span><br><span class="line">    R --&gt;|No| T[SIGKILL After Grace Period]</span><br><span class="line">    T --&gt; S</span><br><span class="line">    </span><br><span class="line">    S --&gt; U[Pod Removed from etcd]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ffeb3b</span><br><span class="line">    style C fill:#ffeb3b</span><br><span class="line">    style O fill:#ff9800</span><br><span class="line">    style E fill:#f44336</span><br><span class="line">    style K fill:#4caf50</span><br><span class="line">    style S fill:#9e9e9e</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ¯-å…³é”®æ§åˆ¶ç‚¹è¯´æ˜"><a href="#ğŸ¯-å…³é”®æ§åˆ¶ç‚¹è¯´æ˜" class="headerlink" title="ğŸ¯ å…³é”®æ§åˆ¶ç‚¹è¯´æ˜"></a>ğŸ¯ å…³é”®æ§åˆ¶ç‚¹è¯´æ˜</h3><h4 id="1-åˆ›å»ºå‰æ§åˆ¶ç‚¹-æœ€å¼ºç®¡æ§"><a href="#1-åˆ›å»ºå‰æ§åˆ¶ç‚¹-æœ€å¼ºç®¡æ§" class="headerlink" title="1. åˆ›å»ºå‰æ§åˆ¶ç‚¹ (æœ€å¼ºç®¡æ§)"></a>1. <strong>åˆ›å»ºå‰æ§åˆ¶ç‚¹</strong> (æœ€å¼ºç®¡æ§)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶æœºï¼šPod å¯¹è±¡åˆ›å»ºä¹‹å‰</span></span><br><span class="line"><span class="comment"># ä½ç½®ï¼šAPI Server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå­˜å‚¨åˆ° etcd ä¹‹å‰</span></span><br><span class="line"><span class="comment"># èƒ½åŠ›ï¼š</span></span><br><span class="line"><span class="comment"># - å®Œå…¨æ‹’ç»åˆ›å»º</span></span><br><span class="line"><span class="comment"># - ä¿®æ”¹ Pod è§„èŒƒ</span></span><br><span class="line"><span class="comment"># - æ³¨å…¥é¢å¤–é…ç½®</span></span><br><span class="line"><span class="comment"># - å¼ºåˆ¶å®‰å…¨ç­–ç•¥</span></span><br></pre></td></tr></table></figure>

<h4 id="2-ç»ˆæ­¢å‰æ§åˆ¶ç‚¹-æœ‰é™ç®¡æ§"><a href="#2-ç»ˆæ­¢å‰æ§åˆ¶ç‚¹-æœ‰é™ç®¡æ§" class="headerlink" title="2. ç»ˆæ­¢å‰æ§åˆ¶ç‚¹ (æœ‰é™ç®¡æ§)"></a>2. <strong>ç»ˆæ­¢å‰æ§åˆ¶ç‚¹</strong> (æœ‰é™ç®¡æ§)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶æœºï¼šPod æ”¶åˆ°åˆ é™¤ä¿¡å·åï¼ŒSIGTERM å‘é€å‰</span></span><br><span class="line"><span class="comment"># ä½ç½®ï¼šå®¹å™¨è¿è¡Œæ—¶å‡†å¤‡ç»ˆæ­¢å®¹å™¨æ—¶</span></span><br><span class="line"><span class="comment"># èƒ½åŠ›ï¼š</span></span><br><span class="line"><span class="comment"># - ä¼˜é›…å…³é—­å¤„ç†</span></span><br><span class="line"><span class="comment"># - æ¸…ç†èµ„æº</span></span><br><span class="line"><span class="comment"># - ä¿å­˜çŠ¶æ€</span></span><br><span class="line"><span class="comment"># - é€šçŸ¥å…¶ä»–æœåŠ¡</span></span><br><span class="line"><span class="comment"># é™åˆ¶ï¼š</span></span><br><span class="line"><span class="comment"># - æœ‰æ—¶é—´é™åˆ¶ (terminationGracePeriodSeconds)</span></span><br><span class="line"><span class="comment"># - æ— æ³•é˜»æ­¢åˆ é™¤</span></span><br><span class="line"><span class="comment"># - æ— æ³•ä¿®æ”¹ Pod è§„èŒƒ</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹"><a href="#å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹" class="headerlink" title="å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹"></a>å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹</h2><h3 id="åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥"><a href="#åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥" class="headerlink" title="åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥"></a>åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥</h3><h4 id="Validating-Webhook-å®ç°"><a href="#Validating-Webhook-å®ç°" class="headerlink" title="Validating Webhook å®ç°"></a>Validating Webhook å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    </span><br><span class="line">    admissionv1 <span class="string">&quot;k8s.io/api/admission/v1&quot;</span></span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SecurityValidator <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> ValidatePod(pod *corev1.Pod) []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> violations []<span class="type">string</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç‰¹æƒå®¹å™¨</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> container.SecurityContext != <span class="literal">nil</span> &amp;&amp; </span><br><span class="line">           container.SecurityContext.Privileged != <span class="literal">nil</span> &amp;&amp; </span><br><span class="line">           *container.SecurityContext.Privileged &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Privileged container not allowed: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥ root ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> container.SecurityContext == <span class="literal">nil</span> || </span><br><span class="line">           container.SecurityContext.RunAsNonRoot == <span class="literal">nil</span> || </span><br><span class="line">           !*container.SecurityContext.RunAsNonRoot &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Container must run as non-root: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥èµ„æºé™åˆ¶</span></span><br><span class="line">        <span class="keyword">if</span> container.Resources.Limits == <span class="literal">nil</span> &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Resource limits required: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç½‘ç»œç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Spec.HostNetwork &#123;</span><br><span class="line">        violations = <span class="built_in">append</span>(violations, <span class="string">&quot;Host network not allowed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥å·æŒ‚è½½</span></span><br><span class="line">    <span class="keyword">for</span> _, volume := <span class="keyword">range</span> pod.Spec.Volumes &#123;</span><br><span class="line">        <span class="keyword">if</span> volume.HostPath != <span class="literal">nil</span> &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;HostPath volume not allowed: %s&quot;</span>, volume.Name))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> violations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">    <span class="keyword">var</span> body []<span class="type">byte</span></span><br><span class="line">    <span class="keyword">if</span> r.Body != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> data, err := io.ReadAll(r.Body); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            body = data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> admissionResponse *admissionv1.AdmissionResponse</span><br><span class="line">    ar := admissionv1.AdmissionReview&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(body, &amp;ar); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        admissionResponse = &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: err.Error(),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        admissionResponse = sv.validate(&amp;ar)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    admissionReview := admissionv1.AdmissionReview&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> admissionResponse != <span class="literal">nil</span> &#123;</span><br><span class="line">        admissionReview.Response = admissionResponse</span><br><span class="line">        <span class="keyword">if</span> ar.Request != <span class="literal">nil</span> &#123;</span><br><span class="line">            admissionReview.Response.UID = ar.Request.UID</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    respBytes, _ := json.Marshal(admissionReview)</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    w.Write(respBytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> validate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    req := ar.Request</span><br><span class="line">    <span class="keyword">var</span> pod corev1.Pod</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(req.Object.Raw, &amp;pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: err.Error(),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    violations := sv.ValidatePod(&amp;pod)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(violations) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Allowed: <span class="literal">false</span>,</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: fmt.Sprintf(<span class="string">&quot;Security violations: %v&quot;</span>, violations),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯2ï¼šSidecar-è‡ªåŠ¨æ³¨å…¥"><a href="#åœºæ™¯2ï¼šSidecar-è‡ªåŠ¨æ³¨å…¥" class="headerlink" title="åœºæ™¯2ï¼šSidecar è‡ªåŠ¨æ³¨å…¥"></a>åœºæ™¯2ï¼šSidecar è‡ªåŠ¨æ³¨å…¥</h3><h4 id="Mutating-Webhook-å®ç°"><a href="#Mutating-Webhook-å®ç°" class="headerlink" title="Mutating Webhook å®ç°"></a>Mutating Webhook å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    </span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/api/resource&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SidecarInjector <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si *SidecarInjector)</span></span> InjectSidecar(pod *corev1.Pod) []<span class="type">byte</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations == <span class="literal">nil</span> || pod.Annotations[<span class="string">&quot;sidecar.example.com/inject&quot;</span>] != <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> patches []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å…¥ sidecar å®¹å™¨</span></span><br><span class="line">    sidecarContainer := corev1.Container&#123;</span><br><span class="line">        Name:  <span class="string">&quot;logging-sidecar&quot;</span>,</span><br><span class="line">        Image: <span class="string">&quot;fluent/fluent-bit:1.8&quot;</span>,</span><br><span class="line">        Resources: corev1.ResourceRequirements&#123;</span><br><span class="line">            Limits: corev1.ResourceList&#123;</span><br><span class="line">                corev1.ResourceCPU:    resource.MustParse(<span class="string">&quot;100m&quot;</span>),</span><br><span class="line">                corev1.ResourceMemory: resource.MustParse(<span class="string">&quot;128Mi&quot;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            Requests: corev1.ResourceList&#123;</span><br><span class="line">                corev1.ResourceCPU:    resource.MustParse(<span class="string">&quot;50m&quot;</span>),</span><br><span class="line">                corev1.ResourceMemory: resource.MustParse(<span class="string">&quot;64Mi&quot;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        VolumeMounts: []corev1.VolumeMount&#123;</span><br><span class="line">            &#123;</span><br><span class="line">                Name:      <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/var/log/app&quot;</span>,</span><br><span class="line">                ReadOnly:  <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                Name:      <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/fluent-bit/etc&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å®¹å™¨çš„ patch</span></span><br><span class="line">    patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/containers/-&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: sidecarContainer,</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å…¥å…±äº«å·</span></span><br><span class="line">    logVolume := corev1.Volume&#123;</span><br><span class="line">        Name: <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">        VolumeSource: corev1.VolumeSource&#123;</span><br><span class="line">            EmptyDir: &amp;corev1.EmptyDirVolumeSource&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    configVolume := corev1.Volume&#123;</span><br><span class="line">        Name: <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">        VolumeSource: corev1.VolumeSource&#123;</span><br><span class="line">            ConfigMap: &amp;corev1.ConfigMapVolumeSource&#123;</span><br><span class="line">                LocalObjectReference: corev1.LocalObjectReference&#123;</span><br><span class="line">                    Name: <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pod.Spec.Volumes) == <span class="number">0</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: []corev1.Volume&#123;logVolume, configVolume&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes/-&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: logVolume,</span><br><span class="line">        &#125;)</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes/-&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: configVolume,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ºä¸»å®¹å™¨æ·»åŠ æ—¥å¿—å·æŒ‚è½½</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:   <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: fmt.Sprintf(<span class="string">&quot;/spec/containers/%d/volumeMounts/-&quot;</span>, i),</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: corev1.VolumeMount&#123;</span><br><span class="line">                Name:      <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/var/log/app&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    patchBytes, _ := json.Marshal(patches)</span><br><span class="line">    <span class="keyword">return</span> patchBytes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†"><a href="#åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†" class="headerlink" title="åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†"></a>åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†</h3><h4 id="PreStop-Hook-é…ç½®"><a href="#PreStop-Hook-é…ç½®" class="headerlink" title="PreStop Hook é…ç½®"></a>PreStop Hook é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.21</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">                echo &quot;Starting graceful shutdown...&quot;</span></span><br><span class="line"><span class="string"></span>                </span><br><span class="line">                <span class="comment"># 1. åœæ­¢æ¥å—æ–°è¿æ¥ (ä»è´Ÿè½½å‡è¡¡å™¨æ‘˜é™¤)</span></span><br><span class="line">                <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://localhost:8080/admin/health/disable</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 2. ç­‰å¾…ç°æœ‰è¿æ¥å®Œæˆ</span></span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;Waiting for connections to finish...&quot;</span></span><br><span class="line">                <span class="string">timeout=50</span></span><br><span class="line">                <span class="string">while</span> [ <span class="string">$timeout</span> <span class="string">-gt</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">do</span></span><br><span class="line">                  <span class="string">active_conn=$(netstat</span> <span class="string">-an</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">:80</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ESTABLISHED</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span></span><br><span class="line">                  <span class="string">if</span> [ <span class="string">$active_conn</span> <span class="string">-eq</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">                    <span class="string">echo</span> <span class="string">&quot;All connections closed&quot;</span></span><br><span class="line">                    <span class="string">break</span></span><br><span class="line">                  <span class="string">fi</span></span><br><span class="line">                  <span class="string">echo</span> <span class="string">&quot;Active connections: $active_conn, waiting...&quot;</span></span><br><span class="line">                  <span class="string">sleep</span> <span class="number">1</span></span><br><span class="line">                  <span class="string">timeout=$((timeout-1))</span></span><br><span class="line">                <span class="string">done</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 3. åˆ·æ–°ç¼“å­˜åˆ°æŒä¹…å­˜å‚¨</span></span><br><span class="line">                <span class="string">if</span> [ <span class="string">-f</span> <span class="string">/app/flush_cache.sh</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">                  <span class="string">echo</span> <span class="string">&quot;Flushing cache...&quot;</span></span><br><span class="line">                  <span class="string">/app/flush_cache.sh</span></span><br><span class="line">                <span class="string">fi</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 4. é€šçŸ¥ç›‘æ§ç³»ç»Ÿ</span></span><br><span class="line">                <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://monitoring-service/api/v1/shutdown</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-H</span> <span class="string">&quot;Content-Type: application/json&quot;</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-d</span> <span class="string">&quot;&#123;\&quot;pod\&quot;:\&quot;$HOSTNAME\&quot;,\&quot;timestamp\&quot;:\&quot;$(date -Iseconds)\&quot;&#125;&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¥åº·æ£€æŸ¥é…ç½®</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"><a href="#æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"></a>æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h2><h3 id="âœ…-Admission-Webhook-æœ€ä½³å®è·µ"><a href="#âœ…-Admission-Webhook-æœ€ä½³å®è·µ" class="headerlink" title="âœ… Admission Webhook æœ€ä½³å®è·µ"></a>âœ… Admission Webhook æœ€ä½³å®è·µ</h3><h4 id="1-æ€§èƒ½ä¼˜åŒ–"><a href="#1-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="1. æ€§èƒ½ä¼˜åŒ–"></a>1. æ€§èƒ½ä¼˜åŒ–</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Webhook é…ç½®ä¼˜åŒ–</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">optimized-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/validate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span>          <span class="comment"># è®¾ç½®é€‚å½“è¶…æ—¶</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span>         <span class="comment"># æ˜ç¡®å¤±è´¥ç­–ç•¥</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span>          <span class="comment"># å£°æ˜æ— å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span>   <span class="comment"># é¿å…é‡å¤è°ƒç”¨</span></span><br></pre></td></tr></table></figure>

<h4 id="2-é”™è¯¯å¤„ç†"><a href="#2-é”™è¯¯å¤„ç†" class="headerlink" title="2. é”™è¯¯å¤„ç†"></a>2. é”™è¯¯å¤„ç†</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Webhook)</span></span> validate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    <span class="comment">// å®ç°è¶…æ—¶æ§åˆ¶</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®ç°é‡è¯•æœºåˆ¶</span></span><br><span class="line">    <span class="keyword">var</span> lastErr <span class="type">error</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> result, err := w.doValidation(ctx, ar); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastErr = err</span><br><span class="line">            time.Sleep(time.Duration(i+<span class="number">1</span>) * time.Millisecond * <span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®ç­–ç•¥å¤„ç†å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> w.config.FailurePolicy == <span class="string">&quot;Ignore&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Allowed: <span class="literal">true</span>,</span><br><span class="line">            Warnings: []<span class="type">string</span>&#123;fmt.Sprintf(<span class="string">&quot;Validation failed but ignored: %v&quot;</span>, lastErr)&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">false</span>,</span><br><span class="line">        Result: &amp;metav1.Status&#123;</span><br><span class="line">            Code:    http.StatusInternalServerError,</span><br><span class="line">            Message: lastErr.Error(),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-å®‰å…¨è€ƒè™‘"><a href="#3-å®‰å…¨è€ƒè™‘" class="headerlink" title="3. å®‰å…¨è€ƒè™‘"></a>3. å®‰å…¨è€ƒè™‘</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TLS é…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="comment"># Base64 encoded certificate</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="comment"># Base64 encoded private key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># RBAC é…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;configmaps&quot;</span>, <span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>, <span class="string">&quot;replicasets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader-binding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-PreStop-Hook-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-PreStop-Hook-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ PreStop Hook æ³¨æ„äº‹é¡¹"></a>âš ï¸ PreStop Hook æ³¨æ„äº‹é¡¹</h3><h4 id="1-æ—¶é—´é™åˆ¶ç®¡ç†"><a href="#1-æ—¶é—´é™åˆ¶ç®¡ç†" class="headerlink" title="1. æ—¶é—´é™åˆ¶ç®¡ç†"></a>1. æ—¶é—´é™åˆ¶ç®¡ç†</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span>  <span class="comment"># æ ¹æ®åº”ç”¨éœ€è¦è°ƒæ•´</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            # é¢„ç•™æ—¶é—´ç»™ SIGTERM å¤„ç†</span></span><br><span class="line"><span class="string">            available_time=50  # æ¯” terminationGracePeriodSeconds å°‘ 10 ç§’</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># åˆ†é˜¶æ®µå¤„ç†</span></span><br><span class="line">            <span class="comment"># é˜¶æ®µ1: åœæ­¢æ¥å—æ–°è¯·æ±‚ (5ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 1: Stopping new requests...&quot;</span></span><br><span class="line">            <span class="string">/app/stop_accepting_requests.sh</span></span><br><span class="line">            <span class="string">sleep</span> <span class="number">5</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é˜¶æ®µ2: ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ (35ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 2: Waiting for existing requests...&quot;</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">35</span> <span class="string">/app/wait_for_requests.sh</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é˜¶æ®µ3: æ¸…ç†èµ„æº (10ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 3: Cleanup...&quot;</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">10</span> <span class="string">/app/cleanup.sh</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;PreStop hook completed&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-å¹‚ç­‰æ€§ä¿è¯"><a href="#2-å¹‚ç­‰æ€§ä¿è¯" class="headerlink" title="2. å¹‚ç­‰æ€§ä¿è¯"></a>2. å¹‚ç­‰æ€§ä¿è¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># graceful_shutdown.sh - å¹‚ç­‰çš„å…³é—­è„šæœ¬</span></span><br><span class="line"></span><br><span class="line">SHUTDOWN_FLAG=<span class="string">&quot;/tmp/shutdown_initiated&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹å…³é—­æµç¨‹</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Shutdown already in progress, skipping...&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå…³é—­æ ‡è®°</span></span><br><span class="line"><span class="built_in">touch</span> <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting graceful shutdown process...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Performing cleanup...&quot;</span></span><br><span class="line">    <span class="comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    <span class="built_in">rm</span> -f /tmp/app_*.tmp</span><br><span class="line">    <span class="comment"># å…³é—­æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="built_in">exec</span> 3&gt;&amp;-</span><br><span class="line">    <span class="comment"># ç§»é™¤å…³é—­æ ‡è®°</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¿¡å·å¤„ç†</span></span><br><span class="line"><span class="built_in">trap</span> cleanup EXIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå…³é—­æ­¥éª¤</span></span><br><span class="line">/app/shutdown_steps.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸš¨-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#ğŸš¨-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-Webhook-è¶…æ—¶é—®é¢˜"><a href="#1-Webhook-è¶…æ—¶é—®é¢˜" class="headerlink" title="1. Webhook è¶…æ—¶é—®é¢˜"></a>1. Webhook è¶…æ—¶é—®é¢˜</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šWebhook å“åº”æ—¶é—´è¿‡é•¿å¯¼è‡´ Pod åˆ›å»ºå¤±è´¥</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼š</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fast-validator</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">5</span>          <span class="comment"># è®¾ç½®åˆç†è¶…æ—¶</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Ignore</span>      <span class="comment"># è¶…æ—¶æ—¶å…è®¸é€šè¿‡</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># åœ¨ Webhook ä»£ç ä¸­å®ç°å¿«é€Ÿè·¯å¾„</span></span><br><span class="line">  <span class="string">func</span> <span class="string">quickValidation(pod</span> <span class="string">*corev1.Pod)</span> <span class="string">bool</span> &#123;</span><br><span class="line">      <span class="string">//</span> <span class="string">åªæ£€æŸ¥å…³é”®é¡¹ï¼Œè·³è¿‡è€—æ—¶éªŒè¯</span></span><br><span class="line">      <span class="string">return</span> <span class="string">pod.Spec.SecurityContext</span> <span class="type">!=</span> <span class="string">nil</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-PreStop-Hook-æ‰§è¡Œå¤±è´¥"><a href="#2-PreStop-Hook-æ‰§è¡Œå¤±è´¥" class="headerlink" title="2. PreStop Hook æ‰§è¡Œå¤±è´¥"></a>2. PreStop Hook æ‰§è¡Œå¤±è´¥</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šPreStop hook è„šæœ¬æ‰§è¡Œå¤±è´¥æˆ–è¶…æ—¶</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼š</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">90</span>  <span class="comment"># å¢åŠ ä¼˜é›…å…³é—­æ—¶é—´</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># æ·»åŠ è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">            <span class="string">exec</span> <span class="string">&gt;</span> <span class="string">/var/log/prestop.log</span> <span class="number">2</span><span class="string">&gt;&amp;1</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$(date): Starting PreStop hook&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä½¿ç”¨ timeout å‘½ä»¤é˜²æ­¢å¡æ­»</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">30</span> <span class="string">/app/graceful_shutdown.sh</span> <span class="string">||</span> &#123;</span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;$(date): Graceful shutdown timeout, forcing cleanup&quot;</span></span><br><span class="line">                <span class="string">/app/force_cleanup.sh</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$(date): PreStop hook completed&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-å¾ªç¯ä¾èµ–é—®é¢˜"><a href="#3-å¾ªç¯ä¾èµ–é—®é¢˜" class="headerlink" title="3. å¾ªç¯ä¾èµ–é—®é¢˜"></a>3. å¾ªç¯ä¾èµ–é—®é¢˜</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šWebhook æœ¬èº«çš„ Pod ä¹Ÿè¢« Webhook æ‹¦æˆª</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ namespaceSelector æ’é™¤</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate-app-pods</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">      <span class="attr">values:</span> [<span class="string">&quot;webhook-system&quot;</span>, <span class="string">&quot;kube-system&quot;</span>]  <span class="comment"># æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="4-èµ„æºç«äº‰é—®é¢˜"><a href="#4-èµ„æºç«äº‰é—®é¢˜" class="headerlink" title="4. èµ„æºç«äº‰é—®é¢˜"></a>4. èµ„æºç«äº‰é—®é¢˜</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šå¤šä¸ª Webhook åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ª Pod</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å’Œæ¡ä»¶æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MutatingWebhook)</span></span> mutate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    <span class="keyword">var</span> pod corev1.Pod</span><br><span class="line">    json.Unmarshal(ar.Request.Object.Raw, &amp;pod)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å…¶ä»– Webhook å¤„ç†è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations[<span class="string">&quot;webhook.example.com/processed&quot;</span>] == <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;Allowed: <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> patches []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†æ ‡è®°</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations == <span class="literal">nil</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/metadata/annotations&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/metadata/annotations/webhook.example.com~1processed&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå®é™…çš„å˜æ›´</span></span><br><span class="line">    patches = <span class="built_in">append</span>(patches, m.addSidecar(&amp;pod)...)</span><br><span class="line">    </span><br><span class="line">    patchBytes, _ := json.Marshal(patches)</span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">true</span>,</span><br><span class="line">        Patch:   patchBytes,</span><br><span class="line">        PatchType: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> *admissionv1.PatchType &#123;</span><br><span class="line">            pt := admissionv1.PatchTypeJSONPatch</span><br><span class="line">            <span class="keyword">return</span> &amp;pt</span><br><span class="line">        &#125;(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="é«˜çº§åœºæ™¯ä¸æ‰©å±•"><a href="#é«˜çº§åœºæ™¯ä¸æ‰©å±•" class="headerlink" title="é«˜çº§åœºæ™¯ä¸æ‰©å±•"></a>é«˜çº§åœºæ™¯ä¸æ‰©å±•</h2><h3 id="ğŸ¯-åŠ¨æ€ç­–ç•¥ç®¡ç†"><a href="#ğŸ¯-åŠ¨æ€ç­–ç•¥ç®¡ç†" class="headerlink" title="ğŸ¯ åŠ¨æ€ç­–ç•¥ç®¡ç†"></a>ğŸ¯ åŠ¨æ€ç­–ç•¥ç®¡ç†</h3><h4 id="åŸºäº-ConfigMap-çš„ç­–ç•¥é…ç½®"><a href="#åŸºäº-ConfigMap-çš„ç­–ç•¥é…ç½®" class="headerlink" title="åŸºäº ConfigMap çš„ç­–ç•¥é…ç½®"></a>åŸºäº ConfigMap çš„ç­–ç•¥é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-policies</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">security-policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">      - name: &quot;no-privileged-containers&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;error&quot;</span></span><br><span class="line"><span class="string">        check: &quot;privileged_container&quot;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      - name: &quot;resource-limits-required&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;warning&quot;</span></span><br><span class="line"><span class="string">        check: &quot;resource_limits&quot;</span></span><br><span class="line"><span class="string">        config:</span></span><br><span class="line"><span class="string">          max_cpu: &quot;2&quot;</span></span><br><span class="line"><span class="string">          max_memory: &quot;4Gi&quot;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      - name: &quot;trusted-registries-only&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;error&quot;</span></span><br><span class="line"><span class="string">        check: &quot;image_registry&quot;</span></span><br><span class="line"><span class="string">        config:</span></span><br><span class="line"><span class="string">          allowed_registries:</span></span><br><span class="line"><span class="string">            - &quot;registry.company.com&quot;</span></span><br><span class="line"><span class="string">            - &quot;gcr.io/company-project&quot;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">injection-policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    sidecars:</span></span><br><span class="line"><span class="string">      - name: &quot;logging-sidecar&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        trigger:</span></span><br><span class="line"><span class="string">          annotation: &quot;logging.company.com/enabled&quot;</span></span><br><span class="line"><span class="string">          value: &quot;true&quot;</span></span><br><span class="line"><span class="string">        container:</span></span><br><span class="line"><span class="string">          image: &quot;fluent/fluent-bit:1.8&quot;</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">            requests:</span></span><br><span class="line"><span class="string">              cpu: &quot;50m&quot;</span></span><br><span class="line"><span class="string">              memory: &quot;64Mi&quot;</span></span><br><span class="line"><span class="string">            limits:</span></span><br><span class="line"><span class="string">              cpu: &quot;100m&quot;</span></span><br><span class="line"><span class="string">              memory: &quot;128Mi&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="åŠ¨æ€ç­–ç•¥åŠ è½½å™¨"><a href="#åŠ¨æ€ç­–ç•¥åŠ è½½å™¨" class="headerlink" title="åŠ¨æ€ç­–ç•¥åŠ è½½å™¨"></a>åŠ¨æ€ç­–ç•¥åŠ è½½å™¨</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">    <span class="string">&quot;gopkg.in/yaml.v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PolicyManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    client       kubernetes.Interface</span><br><span class="line">    policies     *PolicyConfig</span><br><span class="line">    lastUpdate   time.Time</span><br><span class="line">    updateChan   <span class="keyword">chan</span> *PolicyConfig</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PolicyConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Rules    []ValidationRule <span class="string">`yaml:&quot;rules&quot;`</span></span><br><span class="line">    Sidecars []SidecarConfig  <span class="string">`yaml:&quot;sidecars&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PolicyManager)</span></span> WatchPolicies(ctx context.Context) &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            <span class="keyword">if</span> err := pm.reloadPolicies(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Printf(<span class="string">&quot;Failed to reload policies: %v&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PolicyManager)</span></span> reloadPolicies() <span class="type">error</span> &#123;</span><br><span class="line">    cm, err := pm.client.CoreV1().ConfigMaps(<span class="string">&quot;webhook-system&quot;</span>).</span><br><span class="line">        Get(context.TODO(), <span class="string">&quot;webhook-policies&quot;</span>, metav1.GetOptions&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ ConfigMap æ˜¯å¦æœ‰æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> cm.ResourceVersion == pm.policies.Version &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> newPolicies PolicyConfig</span><br><span class="line">    <span class="keyword">if</span> securityData, ok := cm.Data[<span class="string">&quot;security-policy.yaml&quot;</span>]; ok &#123;</span><br><span class="line">        <span class="keyword">if</span> err := yaml.Unmarshal([]<span class="type">byte</span>(securityData), &amp;newPolicies); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŸå­æ€§æ›´æ–°ç­–ç•¥</span></span><br><span class="line">    pm.policies = &amp;newPolicies</span><br><span class="line">    pm.lastUpdate = time.Now()</span><br><span class="line">    </span><br><span class="line">    log.Printf(<span class="string">&quot;Policies updated at %v&quot;</span>, pm.lastUpdate)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”-å®¡è®¡ä¸ç›‘æ§"><a href="#ğŸ”-å®¡è®¡ä¸ç›‘æ§" class="headerlink" title="ğŸ” å®¡è®¡ä¸ç›‘æ§"></a>ğŸ” å®¡è®¡ä¸ç›‘æ§</h3><h4 id="Webhook-æ‰§è¡Œç›‘æ§"><a href="#Webhook-æ‰§è¡Œç›‘æ§" class="headerlink" title="Webhook æ‰§è¡Œç›‘æ§"></a>Webhook æ‰§è¡Œç›‘æ§</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    webhookDuration = prometheus.NewHistogramVec(</span><br><span class="line">        prometheus.HistogramOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_duration_seconds&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;Time spent processing admission webhook requests&quot;</span>,</span><br><span class="line">            Buckets: prometheus.DefBuckets,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;operation&quot;</span>, <span class="string">&quot;resource&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    webhookRequests = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_requests_total&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;Total number of admission webhook requests&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;operation&quot;</span>, <span class="string">&quot;resource&quot;</span>, <span class="string">&quot;result&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    webhookErrors = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_errors_total&quot;</span>, </span><br><span class="line">            Help: <span class="string">&quot;Total number of admission webhook errors&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;error_type&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    prometheus.MustRegister(webhookDuration, webhookRequests, webhookErrors)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *AdmissionWebhook)</span></span> ServeHTTP(writer http.ResponseWriter, request *http.Request) &#123;</span><br><span class="line">    start := time.Now()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è§£æè¯·æ±‚</span></span><br><span class="line">    ar, err := w.parseAdmissionRequest(request)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        webhookErrors.WithLabelValues(w.name, <span class="string">&quot;parse_error&quot;</span>).Inc()</span><br><span class="line">        http.Error(writer, err.Error(), http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">    response := w.processAdmissionRequest(ar)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•æŒ‡æ ‡</span></span><br><span class="line">    duration := time.Since(start).Seconds()</span><br><span class="line">    labels := []<span class="type">string</span>&#123;</span><br><span class="line">        w.name,</span><br><span class="line">        <span class="type">string</span>(ar.Request.Operation),</span><br><span class="line">        ar.Request.Kind.Kind,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response.Allowed &#123;</span><br><span class="line">        webhookRequests.WithLabelValues(<span class="built_in">append</span>(labels, <span class="string">&quot;allowed&quot;</span>)...).Inc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        webhookRequests.WithLabelValues(<span class="built_in">append</span>(labels, <span class="string">&quot;denied&quot;</span>)...).Inc()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    webhookDuration.WithLabelValues(labels...).Observe(duration)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€å“åº”</span></span><br><span class="line">    w.sendAdmissionResponse(writer, response)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å®¡è®¡æ—¥å¿—ç»“æ„åŒ–"><a href="#å®¡è®¡æ—¥å¿—ç»“æ„åŒ–" class="headerlink" title="å®¡è®¡æ—¥å¿—ç»“æ„åŒ–"></a>å®¡è®¡æ—¥å¿—ç»“æ„åŒ–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AuditEvent <span class="keyword">struct</span> &#123;</span><br><span class="line">    Timestamp     time.Time                 <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">    WebhookName   <span class="type">string</span>                   <span class="string">`json:&quot;webhook_name&quot;`</span></span><br><span class="line">    Operation     <span class="type">string</span>                   <span class="string">`json:&quot;operation&quot;`</span></span><br><span class="line">    Resource      <span class="type">string</span>                   <span class="string">`json:&quot;resource&quot;`</span></span><br><span class="line">    Namespace     <span class="type">string</span>                   <span class="string">`json:&quot;namespace&quot;`</span></span><br><span class="line">    ObjectName    <span class="type">string</span>                   <span class="string">`json:&quot;object_name&quot;`</span></span><br><span class="line">    UserInfo      *authenticationv1.UserInfo <span class="string">`json:&quot;user_info&quot;`</span></span><br><span class="line">    Decision      <span class="type">string</span>                   <span class="string">`json:&quot;decision&quot;`</span></span><br><span class="line">    Reason        <span class="type">string</span>                   <span class="string">`json:&quot;reason,omitempty&quot;`</span></span><br><span class="line">    Modifications []<span class="type">string</span>                 <span class="string">`json:&quot;modifications,omitempty&quot;`</span></span><br><span class="line">    Duration      time.Duration            <span class="string">`json:&quot;duration&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *AdmissionWebhook)</span></span> auditLog(ar *admissionv1.AdmissionReview, response *admissionv1.AdmissionResponse, duration time.Duration) &#123;</span><br><span class="line">    event := AuditEvent&#123;</span><br><span class="line">        Timestamp:   time.Now(),</span><br><span class="line">        WebhookName: w.name,</span><br><span class="line">        Operation:   <span class="type">string</span>(ar.Request.Operation),</span><br><span class="line">        Resource:    ar.Request.Kind.Kind,</span><br><span class="line">        Namespace:   ar.Request.Namespace,</span><br><span class="line">        ObjectName:  ar.Request.Name,</span><br><span class="line">        UserInfo:    &amp;ar.Request.UserInfo,</span><br><span class="line">        Duration:    duration,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response.Allowed &#123;</span><br><span class="line">        event.Decision = <span class="string">&quot;ALLOW&quot;</span></span><br><span class="line">        <span class="keyword">if</span> response.Patch != <span class="literal">nil</span> &#123;</span><br><span class="line">            event.Modifications = w.extractModifications(response.Patch)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        event.Decision = <span class="string">&quot;DENY&quot;</span></span><br><span class="line">        <span class="keyword">if</span> response.Result != <span class="literal">nil</span> &#123;</span><br><span class="line">            event.Reason = response.Result.Message</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€åˆ°å®¡è®¡ç³»ç»Ÿ</span></span><br><span class="line">    w.auditLogger.Log(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ› ï¸-æµ‹è¯•ä¸è°ƒè¯•"><a href="#ğŸ› ï¸-æµ‹è¯•ä¸è°ƒè¯•" class="headerlink" title="ğŸ› ï¸ æµ‹è¯•ä¸è°ƒè¯•"></a>ğŸ› ï¸ æµ‹è¯•ä¸è°ƒè¯•</h3><h4 id="Webhook-å•å…ƒæµ‹è¯•"><a href="#Webhook-å•å…ƒæµ‹è¯•" class="headerlink" title="Webhook å•å…ƒæµ‹è¯•"></a>Webhook å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">    </span><br><span class="line">    admissionv1 <span class="string">&quot;k8s.io/api/admission/v1&quot;</span></span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSecurityValidator_ValidatePod</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name     <span class="type">string</span></span><br><span class="line">        pod      *corev1.Pod</span><br><span class="line">        wantErr  <span class="type">bool</span></span><br><span class="line">        wantMsgs []<span class="type">string</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;valid pod&quot;</span>,</span><br><span class="line">            pod: &amp;corev1.Pod&#123;</span><br><span class="line">                Spec: corev1.PodSpec&#123;</span><br><span class="line">                    Containers: []corev1.Container&#123;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                            Image: <span class="string">&quot;registry.company.com/app:v1.0&quot;</span>,</span><br><span class="line">                            SecurityContext: &amp;corev1.SecurityContext&#123;</span><br><span class="line">                                RunAsNonRoot: &amp;[]<span class="type">bool</span>&#123;<span class="literal">true</span>&#125;[<span class="number">0</span>],</span><br><span class="line">                            &#125;,</span><br><span class="line">                            Resources: corev1.ResourceRequirements&#123;</span><br><span class="line">                                Limits: corev1.ResourceList&#123;</span><br><span class="line">                                    corev1.ResourceCPU: resource.MustParse(<span class="string">&quot;1&quot;</span>),</span><br><span class="line">                                &#125;,</span><br><span class="line">                            &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            wantErr: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;privileged container&quot;</span>,</span><br><span class="line">            pod: &amp;corev1.Pod&#123;</span><br><span class="line">                Spec: corev1.PodSpec&#123;</span><br><span class="line">                    Containers: []corev1.Container&#123;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                            Image: <span class="string">&quot;registry.company.com/app:v1.0&quot;</span>,</span><br><span class="line">                            SecurityContext: &amp;corev1.SecurityContext&#123;</span><br><span class="line">                                Privileged: &amp;[]<span class="type">bool</span>&#123;<span class="literal">true</span>&#125;[<span class="number">0</span>],</span><br><span class="line">                            &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            wantErr:  <span class="literal">true</span>,</span><br><span class="line">            wantMsgs: []<span class="type">string</span>&#123;<span class="string">&quot;Privileged container not allowed: app&quot;</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    validator := &amp;SecurityValidator&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            violations := validator.ValidatePod(tt.pod)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> tt.wantErr &amp;&amp; <span class="built_in">len</span>(violations) == <span class="number">0</span> &#123;</span><br><span class="line">                t.Error(<span class="string">&quot;Expected violations but got none&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> !tt.wantErr &amp;&amp; <span class="built_in">len</span>(violations) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;Unexpected violations: %v&quot;</span>, violations)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> _, expectedMsg := <span class="keyword">range</span> tt.wantMsgs &#123;</span><br><span class="line">                found := <span class="literal">false</span></span><br><span class="line">                <span class="keyword">for</span> _, violation := <span class="keyword">range</span> violations &#123;</span><br><span class="line">                    <span class="keyword">if</span> violation == expectedMsg &#123;</span><br><span class="line">                        found = <span class="literal">true</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> !found &#123;</span><br><span class="line">                    t.Errorf(<span class="string">&quot;Expected violation message %q not found&quot;</span>, expectedMsg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAdmissionWebhook_Integration</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæµ‹è¯•ç”¨çš„ admission request</span></span><br><span class="line">    pod := &amp;corev1.Pod&#123;</span><br><span class="line">        ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">            Name:      <span class="string">&quot;test-pod&quot;</span>,</span><br><span class="line">            Namespace: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        Spec: corev1.PodSpec&#123;</span><br><span class="line">            Containers: []corev1.Container&#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                    Image: <span class="string">&quot;nginx:latest&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    podBytes, _ := json.Marshal(pod)</span><br><span class="line">    ar := &amp;admissionv1.AdmissionReview&#123;</span><br><span class="line">        Request: &amp;admissionv1.AdmissionRequest&#123;</span><br><span class="line">            UID:       <span class="string">&quot;test-uid&quot;</span>,</span><br><span class="line">            Operation: admissionv1.Create,</span><br><span class="line">            Object: runtime.RawExtension&#123;</span><br><span class="line">                Raw: podBytes,</span><br><span class="line">            &#125;,</span><br><span class="line">            Kind: metav1.GroupVersionKind&#123;</span><br><span class="line">                Kind: <span class="string">&quot;Pod&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    webhook := NewSecurityValidator()</span><br><span class="line">    response := webhook.validate(ar)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> !response.Allowed &#123;</span><br><span class="line">        t.Errorf(<span class="string">&quot;Expected pod to be allowed, but was denied: %v&quot;</span>, response.Result.Message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è°ƒè¯•å·¥å…·è„šæœ¬"><a href="#è°ƒè¯•å·¥å…·è„šæœ¬" class="headerlink" title="è°ƒè¯•å·¥å…·è„šæœ¬"></a>è°ƒè¯•å·¥å…·è„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># webhook_debug.sh - Webhook è°ƒè¯•å·¥å…·</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">WEBHOOK_NAME=<span class="variable">$&#123;1:-&quot;security-validator&quot;&#125;</span></span><br><span class="line">NAMESPACE=<span class="variable">$&#123;2:-&quot;webhook-system&quot;&#125;</span></span><br><span class="line">TEST_POD=<span class="variable">$&#123;3:-&quot;test-pod.yaml&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Webhook è°ƒè¯•å·¥å…· ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Webhook: <span class="variable">$WEBHOOK_NAME</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Namespace: <span class="variable">$NAMESPACE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Test Pod: <span class="variable">$TEST_POD</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ£€æŸ¥ Webhook é…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. æ£€æŸ¥ Webhook é…ç½®:&quot;</span></span><br><span class="line">kubectl get validatingadmissionwebhooks.admissionregistration.k8s.io <span class="variable">$WEBHOOK_NAME</span> -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥ Webhook æœåŠ¡çŠ¶æ€</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. æ£€æŸ¥ Webhook æœåŠ¡:&quot;</span></span><br><span class="line">kubectl get pods -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span></span><br><span class="line">kubectl get svc -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. æ£€æŸ¥ TLS è¯ä¹¦:&quot;</span></span><br><span class="line">kubectl get secret -n <span class="variable">$NAMESPACE</span> webhook-certs -o jsonpath=<span class="string">&#x27;&#123;.data.tls\.crt&#125;&#x27;</span> | \</span><br><span class="line">    <span class="built_in">base64</span> -d | openssl x509 -text -noout | grep -A2 <span class="string">&quot;Validity&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æµ‹è¯• Webhook è¿é€šæ€§</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. æµ‹è¯• Webhook è¿é€šæ€§:&quot;</span></span><br><span class="line">WEBHOOK_SVC=$(kubectl get svc -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>)</span><br><span class="line">kubectl run webhook-test --image=curlimages/curl --<span class="built_in">rm</span> -it --restart=Never -- \</span><br><span class="line">    curl -k https://<span class="variable">$WEBHOOK_SVC</span>.<span class="variable">$NAMESPACE</span>.svc.cluster.local/validate -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. å¹²è¿è¡Œæµ‹è¯• Pod</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. å¹²è¿è¡Œæµ‹è¯• Pod:&quot;</span></span><br><span class="line">kubectl apply -f <span class="variable">$TEST_POD</span> --dry-run=server -v=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. æŸ¥çœ‹ Webhook æ—¥å¿—</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;6. Webhook æ—¥å¿— (æœ€è¿‘ 50 è¡Œ):&quot;</span></span><br><span class="line">kubectl logs -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span> --<span class="built_in">tail</span>=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. æŸ¥çœ‹ API Server å®¡è®¡æ—¥å¿— (å¦‚æœå¯ç”¨)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;7. API Server ç›¸å…³æ—¥å¿—:&quot;</span></span><br><span class="line">kubectl logs -n kube-system -l component=kube-apiserver --<span class="built_in">tail</span>=20 | grep -i admission</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== è°ƒè¯•å®Œæˆ ===&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æ€»ç»“ä¸å»ºè®®"><a href="#æ€»ç»“ä¸å»ºè®®" class="headerlink" title="æ€»ç»“ä¸å»ºè®®"></a>æ€»ç»“ä¸å»ºè®®</h2><h3 id="ğŸ¯-å…³é”®è¦ç‚¹æ€»ç»“"><a href="#ğŸ¯-å…³é”®è¦ç‚¹æ€»ç»“" class="headerlink" title="ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“"></a>ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“</h3><h4 id="1-Webhook-ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£"><a href="#1-Webhook-ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£" class="headerlink" title="1. Webhook ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£"></a>1. <strong>Webhook ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£</strong></h4><ul>
<li><strong>Pod åˆ›å»ºå‰</strong>ï¼šæœ€å¼ºç®¡æ§èƒ½åŠ›ï¼Œå¯ä»¥å®Œå…¨æ‹’ç»æˆ–ä¿®æ”¹ Pod</li>
<li><strong>Pod ç»ˆæ­¢å‰</strong>ï¼šæœ‰é™ç®¡æ§èƒ½åŠ›ï¼Œåªèƒ½æ‰§è¡Œæ¸…ç†å’Œé€šçŸ¥æ“ä½œ</li>
<li><strong>è¿è¡ŒæœŸé—´</strong>ï¼šæ— æ³•é€šè¿‡ Webhook ç®¡æ§ï¼Œéœ€è¦å…¶ä»–æœºåˆ¶</li>
</ul>
<h4 id="2-è®¾è®¡åŸåˆ™"><a href="#2-è®¾è®¡åŸåˆ™" class="headerlink" title="2. è®¾è®¡åŸåˆ™"></a>2. <strong>è®¾è®¡åŸåˆ™</strong></h4><ul>
<li><strong>å¿«é€Ÿå“åº”</strong>ï¼šWebhook åº”è¯¥åœ¨æ¯«ç§’çº§å®Œæˆå¤„ç†</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šåŒæ ·çš„è¾“å…¥æ€»æ˜¯äº§ç”ŸåŒæ ·çš„è¾“å‡º</li>
<li><strong>å®¹é”™æ€§</strong>ï¼šåˆç†è®¾ç½® failurePolicy å’Œè¶…æ—¶æ—¶é—´</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šæä¾›è¯¦ç»†çš„æ—¥å¿—å’ŒæŒ‡æ ‡</li>
</ul>
<h4 id="3-å¸¸è§é™·é˜±"><a href="#3-å¸¸è§é™·é˜±" class="headerlink" title="3. å¸¸è§é™·é˜±"></a>3. <strong>å¸¸è§é™·é˜±</strong></h4><ul>
<li>é¿å… Webhook å¤„ç†è‡ªèº« Pod (ä½¿ç”¨ namespaceSelector)</li>
<li>é˜²æ­¢æ— é™é€’å½’è°ƒç”¨ (ä½¿ç”¨ reinvocationPolicy)</li>
<li>æ³¨æ„æ—¶é—´é™åˆ¶ (PreStop Hook æœ‰ terminationGracePeriodSeconds é™åˆ¶)</li>
<li>å¤„ç†ç½‘ç»œåˆ†åŒºå’Œè¶…æ—¶æƒ…å†µ</li>
</ul>
<h3 id="ğŸš€-è¿›é˜¶å»ºè®®"><a href="#ğŸš€-è¿›é˜¶å»ºè®®" class="headerlink" title="ğŸš€ è¿›é˜¶å»ºè®®"></a>ğŸš€ è¿›é˜¶å»ºè®®</h3><h4 id="1-å¤šå±‚é˜²æŠ¤ç­–ç•¥"><a href="#1-å¤šå±‚é˜²æŠ¤ç­–ç•¥" class="headerlink" title="1. å¤šå±‚é˜²æŠ¤ç­–ç•¥"></a>1. <strong>å¤šå±‚é˜²æŠ¤ç­–ç•¥</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»„åˆä½¿ç”¨å¤šç§ Webhook å®ç°æ·±åº¦é˜²æŠ¤</span></span><br><span class="line"><span class="comment"># Layer 1: Mutating Webhook (æ³¨å…¥å®‰å…¨é…ç½®)</span></span><br><span class="line"><span class="comment"># Layer 2: Validating Webhook (éªŒè¯å®‰å…¨ç­–ç•¥)  </span></span><br><span class="line"><span class="comment"># Layer 3: OPA Gatekeeper (ç­–ç•¥å³ä»£ç )</span></span><br><span class="line"><span class="comment"># Layer 4: Pod Security Standards (è¿è¡Œæ—¶å®‰å…¨)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-æ¸è¿›å¼éƒ¨ç½²"><a href="#2-æ¸è¿›å¼éƒ¨ç½²" class="headerlink" title="2. æ¸è¿›å¼éƒ¨ç½²"></a>2. <strong>æ¸è¿›å¼éƒ¨ç½²</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å®½æ¾åˆ°ä¸¥æ ¼çš„ç­–ç•¥æ¼”è¿›</span></span><br><span class="line"><span class="attr">Phase 1: failurePolicy:</span> <span class="string">Ignore</span>  <span class="comment"># è§‚å¯Ÿæ¨¡å¼ï¼Œè®°å½•ä½†ä¸é˜»æ­¢</span></span><br><span class="line"><span class="attr">Phase 2:</span> <span class="string">åªé’ˆå¯¹ç‰¹å®šå‘½åç©ºé—´å¯ç”¨</span></span><br><span class="line"><span class="attr">Phase 3: failurePolicy:</span> <span class="string">Fail</span>    <span class="comment"># å¼ºåˆ¶æ‰§è¡Œ</span></span><br><span class="line"><span class="attr">Phase 4:</span> <span class="string">æ‰©å±•åˆ°æ‰€æœ‰å‘½åç©ºé—´</span></span><br></pre></td></tr></table></figure>

<h4 id="3-ç›‘æ§å‘Šè­¦ä½“ç³»"><a href="#3-ç›‘æ§å‘Šè­¦ä½“ç³»" class="headerlink" title="3. ç›‘æ§å‘Šè­¦ä½“ç³»"></a>3. <strong>ç›‘æ§å‘Šè­¦ä½“ç³»</strong></h4><ul>
<li>Webhook å“åº”æ—¶é—´ç›‘æ§</li>
<li>æ‹’ç»ç‡å’Œé€šè¿‡ç‡ç»Ÿè®¡</li>
<li>é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡</li>
<li>èµ„æºä½¿ç”¨æƒ…å†µç›‘æ§</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/07/31/tcpdump%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/31/tcpdump%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">tcpdumpè§£æåŠåˆ†ææŒ‡å—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-31 13:30:06 / ä¿®æ”¹æ—¶é—´ï¼š13:32:13" itemprop="dateCreated datePublished" datetime="2025-07-31T13:30:06+08:00">2025-07-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="tcpdump-è¾“å‡ºè§£æä¸ç½‘ç»œåˆ†ææŒ‡å—"><a href="#tcpdump-è¾“å‡ºè§£æä¸ç½‘ç»œåˆ†ææŒ‡å—" class="headerlink" title="tcpdump è¾“å‡ºè§£æä¸ç½‘ç»œåˆ†ææŒ‡å—"></a>tcpdump è¾“å‡ºè§£æä¸ç½‘ç»œåˆ†ææŒ‡å—</h1><h2 id="ğŸ¯-ç›®å½•"><a href="#ğŸ¯-ç›®å½•" class="headerlink" title="ğŸ¯ ç›®å½•"></a>ğŸ¯ ç›®å½•</h2><ul>
<li><a href="#tcp-flags-%E8%AF%A6%E8%A7%A3">TCP Flags è¯¦è§£</a></li>
<li><a href="#tcpdump-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90">tcpdump è¾“å‡ºæ ¼å¼è§£æ</a></li>
<li><a href="#%E5%85%B3%E9%94%AE%E5%AD%97%E6%AE%B5%E5%88%86%E6%9E%90">å…³é”®å­—æ®µåˆ†æ</a></li>
<li><a href="#%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90">å…¸å‹åœºæ™¯åˆ†æ</a></li>
<li><a href="#4%E5%B1%827%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%86%E6%9E%90">4å±‚&#x2F;7å±‚è´Ÿè½½å‡è¡¡åˆ†æ</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BF%85%E7%9F%A5%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86">æœåŠ¡ç«¯å¼€å‘å¿…çŸ¥ç½‘ç»œçŸ¥è¯†</a></li>
</ul>
<hr>
<h2 id="TCP-Flags-è¯¦è§£"><a href="#TCP-Flags-è¯¦è§£" class="headerlink" title="TCP Flags è¯¦è§£"></a>TCP Flags è¯¦è§£</h2><h3 id="ğŸ-TCP-Flags-æ ‡å¿—ä½"><a href="#ğŸ-TCP-Flags-æ ‡å¿—ä½" class="headerlink" title="ğŸ TCP Flags æ ‡å¿—ä½"></a>ğŸ TCP Flags æ ‡å¿—ä½</h3><table>
<thead>
<tr>
<th>Flag</th>
<th>ç¬¦å·</th>
<th>å«ä¹‰</th>
<th>ä½œç”¨</th>
<th>å…³æ³¨åº¦</th>
</tr>
</thead>
<tbody><tr>
<td><strong>SYN</strong></td>
<td><code>[S]</code></td>
<td>Synchronize</td>
<td>å‘èµ·è¿æ¥è¯·æ±‚</td>
<td>â­â­â­</td>
</tr>
<tr>
<td><strong>ACK</strong></td>
<td><code>[.]</code></td>
<td>Acknowledge</td>
<td>ç¡®è®¤æ”¶åˆ°æ•°æ®</td>
<td>â­â­â­</td>
</tr>
<tr>
<td><strong>FIN</strong></td>
<td><code>[F]</code></td>
<td>Finish</td>
<td>è¯·æ±‚å…³é—­è¿æ¥</td>
<td>â­â­â­</td>
</tr>
<tr>
<td><strong>RST</strong></td>
<td><code>[R]</code></td>
<td>Reset</td>
<td>å¼ºåˆ¶é‡ç½®è¿æ¥</td>
<td>â­â­â­â­â­</td>
</tr>
<tr>
<td><strong>PSH</strong></td>
<td><code>[P]</code></td>
<td>Push</td>
<td>ç«‹å³æ¨é€æ•°æ®</td>
<td>â­â­</td>
</tr>
<tr>
<td><strong>URG</strong></td>
<td><code>[U]</code></td>
<td>Urgent</td>
<td>ç´§æ€¥æ•°æ®æŒ‡é’ˆ</td>
<td>â­</td>
</tr>
<tr>
<td><strong>ECE</strong></td>
<td><code>[E]</code></td>
<td>ECN Echo</td>
<td>æ‹¥å¡é€šçŸ¥å›æ˜¾</td>
<td>â­</td>
</tr>
<tr>
<td><strong>CWR</strong></td>
<td><code>[W]</code></td>
<td>Congestion Window Reduced</td>
<td>æ‹¥å¡çª—å£å‡å°‘</td>
<td>â­</td>
</tr>
</tbody></table>
<h3 id="ğŸ”-ç»„åˆæ ‡å¿—ä½å«ä¹‰"><a href="#ğŸ”-ç»„åˆæ ‡å¿—ä½å«ä¹‰" class="headerlink" title="ğŸ” ç»„åˆæ ‡å¿—ä½å«ä¹‰"></a>ğŸ” ç»„åˆæ ‡å¿—ä½å«ä¹‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸¸è§ç»„åˆåŠå«ä¹‰</span></span><br><span class="line">[S]      <span class="comment"># SYNï¼šè¿æ¥å»ºç«‹è¯·æ±‚</span></span><br><span class="line">[S.]     <span class="comment"># SYN+ACKï¼šè¿æ¥å»ºç«‹å“åº”  </span></span><br><span class="line">[.]      <span class="comment"># ACKï¼šæ™®é€šæ•°æ®ç¡®è®¤</span></span><br><span class="line">[P.]     <span class="comment"># PSH+ACKï¼šæ•°æ®æ¨é€å¹¶ç¡®è®¤</span></span><br><span class="line">[F.]     <span class="comment"># FIN+ACKï¼šè¿æ¥å…³é—­è¯·æ±‚</span></span><br><span class="line">[R]      <span class="comment"># RSTï¼šè¿æ¥é‡ç½®</span></span><br><span class="line">[R.]     <span class="comment"># RST+ACKï¼šé‡ç½®å¹¶ç¡®è®¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼‚å¸¸ç»„åˆ</span></span><br><span class="line">[S.R]    <span class="comment"># SYN+ACK+RSTï¼šæ‹’ç»è¿æ¥</span></span><br><span class="line">[F.R]    <span class="comment"># FIN+ACK+RSTï¼šå¼ºåˆ¶å…³é—­</span></span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-RST-æ ‡å¿—ä½æ·±åº¦è§£æ"><a href="#âš ï¸-RST-æ ‡å¿—ä½æ·±åº¦è§£æ" class="headerlink" title="âš ï¸ RST æ ‡å¿—ä½æ·±åº¦è§£æ"></a>âš ï¸ RST æ ‡å¿—ä½æ·±åº¦è§£æ</h3><p><strong>RST (Reset) çš„å«ä¹‰ï¼š</strong></p>
<ul>
<li>ç«‹å³ç»ˆæ­¢ TCP è¿æ¥</li>
<li>é‡Šæ”¾è¿æ¥å ç”¨çš„èµ„æº</li>
<li>ä¸ç»è¿‡æ­£å¸¸çš„å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹</li>
</ul>
<p><strong>RST äº§ç”Ÿçš„å¸¸è§åŸå› ï¼š</strong></p>
<ol>
<li><p><strong>ç«¯å£ä¸å¯è¾¾</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›®æ ‡ç«¯å£æ²¡æœ‰ç›‘å¬æœåŠ¡</span></span><br><span class="line">13:21:34.963769 IP client.12345 &gt; server.8080: Flags [S]</span><br><span class="line">13:21:34.963888 IP server.8080 &gt; client.12345: Flags [R.]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é˜²ç«å¢™æ‹’ç»</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é˜²ç«å¢™è§„åˆ™é˜»æ­¢è¿æ¥</span></span><br><span class="line">13:21:34.963769 IP client.12345 &gt; server.80: Flags [S]</span><br><span class="line">13:21:34.964001 IP server.80 &gt; client.12345: Flags [R.]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åº”ç”¨ç¨‹åºå¼‚å¸¸å…³é—­</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨å´©æºƒæˆ–å¼ºåˆ¶å…³é—­socket</span></span><br><span class="line">13:21:35.123456 IP client.12345 &gt; server.8080: Flags [P.]</span><br><span class="line">13:21:35.123567 IP server.8080 &gt; client.12345: Flags [R]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¶…æ—¶é‡ç½®</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿æ¥è¶…æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é‡ç½®</span></span><br><span class="line">13:21:35.500000 IP client.12345 &gt; server.8080: Flags [S]</span><br><span class="line"><span class="comment"># ... æ— å“åº” ...</span></span><br><span class="line">13:21:40.500000 IP client.12345 &gt; server.8080: Flags [R]</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="tcpdump-è¾“å‡ºæ ¼å¼è§£æ"><a href="#tcpdump-è¾“å‡ºæ ¼å¼è§£æ" class="headerlink" title="tcpdump è¾“å‡ºæ ¼å¼è§£æ"></a>tcpdump è¾“å‡ºæ ¼å¼è§£æ</h2><h3 id="ğŸ“‹-æ ‡å‡†è¾“å‡ºæ ¼å¼"><a href="#ğŸ“‹-æ ‡å‡†è¾“å‡ºæ ¼å¼" class="headerlink" title="ğŸ“‹ æ ‡å‡†è¾“å‡ºæ ¼å¼"></a>ğŸ“‹ æ ‡å‡†è¾“å‡ºæ ¼å¼</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´æˆ³ IP (IPå¤´ä¿¡æ¯) æºåœ°å€.ç«¯å£ &gt; ç›®æ ‡åœ°å€.ç«¯å£: Flags [æ ‡å¿—], åºåˆ—å·ä¿¡æ¯, é•¿åº¦ä¿¡æ¯</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”¬-è¯¦ç»†å­—æ®µè§£æ"><a href="#ğŸ”¬-è¯¦ç»†å­—æ®µè§£æ" class="headerlink" title="ğŸ”¬ è¯¦ç»†å­—æ®µè§£æ"></a>ğŸ”¬ è¯¦ç»†å­—æ®µè§£æ</h3><p>ä»¥è¿™ä¸ªä¾‹å­ä¸ºåŸºå‡†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13:21:12.082154 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 172, bad cksum 0 (-&gt;3c4a)!) 10.18.60.15.54444 &gt; 106.63.103.83.443: Flags [S], seq 123456789, win 65535, options [mss 1460], length 0</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å€¼</th>
<th>å«ä¹‰</th>
<th>å…³æ³¨ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ—¶é—´æˆ³</strong></td>
<td><code>13:21:12.082154</code></td>
<td>ç²¾ç¡®åˆ°å¾®ç§’çš„æ—¶é—´</td>
<td>ç”¨äºè®¡ç®—å»¶è¿Ÿå’Œè¶…æ—¶</td>
</tr>
<tr>
<td><strong>åè®®</strong></td>
<td><code>IP</code></td>
<td>ç½‘ç»œå±‚åè®®</td>
<td>é€šå¸¸æ˜¯ IP</td>
</tr>
<tr>
<td><strong>TOS</strong></td>
<td><code>tos 0x0</code></td>
<td>æœåŠ¡ç±»å‹</td>
<td>QoS æ ‡è®°ï¼Œå½±å“ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td><strong>TTL</strong></td>
<td><code>ttl 64</code></td>
<td>ç”Ÿå­˜æ—¶é—´</td>
<td>å‰©ä½™è·³æ•°ï¼Œç”¨äºè¯Šæ–­è·¯ç”±</td>
</tr>
<tr>
<td><strong>ID</strong></td>
<td><code>id 0</code></td>
<td>æ•°æ®åŒ…æ ‡è¯†</td>
<td>ç”¨äºåˆ†ç‰‡é‡ç»„</td>
</tr>
<tr>
<td><strong>Flags</strong></td>
<td><code>flags [DF]</code></td>
<td>IP æ ‡å¿—</td>
<td>DF&#x3D;ä¸åˆ†ç‰‡ï¼ŒMF&#x3D;æ›´å¤šåˆ†ç‰‡</td>
</tr>
<tr>
<td><strong>åè®®å·</strong></td>
<td><code>proto TCP (6)</code></td>
<td>ä¼ è¾“å±‚åè®®</td>
<td>TCP&#x3D;6, UDP&#x3D;17, ICMP&#x3D;1</td>
</tr>
<tr>
<td><strong>é•¿åº¦</strong></td>
<td><code>length 172</code></td>
<td>IP åŒ…æ€»é•¿åº¦</td>
<td>åŒ…æ‹¬å¤´éƒ¨å’Œæ•°æ®</td>
</tr>
<tr>
<td><strong>æ ¡éªŒå’Œ</strong></td>
<td><code>bad cksum</code></td>
<td>æ ¡éªŒå’Œé”™è¯¯</td>
<td>âš ï¸ æ•°æ®åŒ…å¯èƒ½æŸå</td>
</tr>
<tr>
<td><strong>æº&#x2F;ç›®æ ‡</strong></td>
<td><code>10.18.60.15.54444 &gt; 106.63.103.83.443</code></td>
<td>æºIP.ç«¯å£ &gt; ç›®æ ‡IP.ç«¯å£</td>
<td>é€šä¿¡ç«¯ç‚¹</td>
</tr>
<tr>
<td><strong>TCPæ ‡å¿—</strong></td>
<td><code>Flags [S]</code></td>
<td>TCP æ§åˆ¶ä½</td>
<td>è¿æ¥çŠ¶æ€æ§åˆ¶</td>
</tr>
<tr>
<td><strong>åºåˆ—å·</strong></td>
<td><code>seq 123456789</code></td>
<td>åºåˆ—å·</td>
<td>æ•°æ®æ’åºå’Œå»é‡</td>
</tr>
<tr>
<td><strong>çª—å£å¤§å°</strong></td>
<td><code>win 65535</code></td>
<td>æ¥æ”¶çª—å£</td>
<td>æµæ§åˆ¶</td>
</tr>
<tr>
<td><strong>é€‰é¡¹</strong></td>
<td><code>options [mss 1460]</code></td>
<td>TCP é€‰é¡¹</td>
<td>åå•†å‚æ•°</td>
</tr>
<tr>
<td><strong>æ•°æ®é•¿åº¦</strong></td>
<td><code>length 0</code></td>
<td>TCP æ•°æ®é•¿åº¦</td>
<td>å®é™…è½½è·å¤§å°</td>
</tr>
</tbody></table>
<hr>
<h2 id="å…³é”®å­—æ®µåˆ†æ"><a href="#å…³é”®å­—æ®µåˆ†æ" class="headerlink" title="å…³é”®å­—æ®µåˆ†æ"></a>å…³é”®å­—æ®µåˆ†æ</h2><h3 id="ğŸš¨-éœ€è¦é‡ç‚¹å…³æ³¨çš„å¼‚å¸¸"><a href="#ğŸš¨-éœ€è¦é‡ç‚¹å…³æ³¨çš„å¼‚å¸¸" class="headerlink" title="ğŸš¨ éœ€è¦é‡ç‚¹å…³æ³¨çš„å¼‚å¸¸"></a>ğŸš¨ éœ€è¦é‡ç‚¹å…³æ³¨çš„å¼‚å¸¸</h3><h4 id="1-æ ¡éªŒå’Œé”™è¯¯"><a href="#1-æ ¡éªŒå’Œé”™è¯¯" class="headerlink" title="1. æ ¡éªŒå’Œé”™è¯¯"></a>1. æ ¡éªŒå’Œé”™è¯¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¡¨ç¤ºæ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æŸå</span></span><br><span class="line">bad <span class="built_in">cksum</span> 0 (-&gt;3c4a)!</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯èƒ½åŸå› ï¼š</span></span><br><span class="line"><span class="comment"># - ç½‘ç»œç¡¬ä»¶æ•…éšœ</span></span><br><span class="line"><span class="comment"># - ç½‘å¡é©±åŠ¨é—®é¢˜  </span></span><br><span class="line"><span class="comment"># - ä¼ è¾“è¿‡ç¨‹ä¸­çš„å¹²æ‰°</span></span><br></pre></td></tr></table></figure>

<h4 id="2-TTL-å¼‚å¸¸"><a href="#2-TTL-å¼‚å¸¸" class="headerlink" title="2. TTL å¼‚å¸¸"></a>2. TTL å¼‚å¸¸</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TTL è¿‡å°ï¼Œå¯èƒ½ç»è¿‡å¤ªå¤šè·¯ç”±å™¨</span></span><br><span class="line">ttl 1    <span class="comment"># å³å°†è¢«ä¸¢å¼ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TTL å¼‚å¸¸å¤§ï¼Œå¯èƒ½æ˜¯ä¼ªé€ åŒ…</span></span><br><span class="line">ttl 255  <span class="comment"># å¯ç–‘çš„æœ€å¤§å€¼</span></span><br></pre></td></tr></table></figure>

<h4 id="3-åºåˆ—å·å¼‚å¸¸"><a href="#3-åºåˆ—å·å¼‚å¸¸" class="headerlink" title="3. åºåˆ—å·å¼‚å¸¸"></a>3. åºåˆ—å·å¼‚å¸¸</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åºåˆ—å·ä¸è¿ç»­ï¼Œå¯èƒ½æœ‰ä¸¢åŒ…</span></span><br><span class="line"><span class="built_in">seq</span> 1000:1500, ack 2000</span><br><span class="line"><span class="built_in">seq</span> 2000:2500, ack 2000  <span class="comment"># è·³è¿‡äº† 1500-2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¤çš„åºåˆ—å·ï¼Œè¡¨ç¤ºé‡ä¼ </span></span><br><span class="line"><span class="built_in">seq</span> 1000:1500, ack 2000</span><br><span class="line"><span class="built_in">seq</span> 1000:1500, ack 2000  <span class="comment"># é‡ä¼ </span></span><br></pre></td></tr></table></figure>

<h4 id="4-çª—å£å¤§å°å¼‚å¸¸"><a href="#4-çª—å£å¤§å°å¼‚å¸¸" class="headerlink" title="4. çª—å£å¤§å°å¼‚å¸¸"></a>4. çª—å£å¤§å°å¼‚å¸¸</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">win 0     <span class="comment"># æ¥æ”¶æ–¹ç¼“å†²åŒºæ»¡ï¼Œå‘é€æ–¹åº”è¯¥åœæ­¢å‘é€</span></span><br><span class="line">win 65535 <span class="comment"># æœ€å¤§çª—å£ï¼Œæ­£å¸¸</span></span><br><span class="line">win 1     <span class="comment"># çª—å£å¾ˆå°ï¼Œå¯èƒ½æœ‰æµæ§é—®é¢˜</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å…¸å‹åœºæ™¯åˆ†æ"><a href="#å…¸å‹åœºæ™¯åˆ†æ" class="headerlink" title="å…¸å‹åœºæ™¯åˆ†æ"></a>å…¸å‹åœºæ™¯åˆ†æ</h2><h3 id="åœºæ™¯1ï¼šæ­£å¸¸-HTTP-è¿æ¥å»ºç«‹"><a href="#åœºæ™¯1ï¼šæ­£å¸¸-HTTP-è¿æ¥å»ºç«‹" class="headerlink" title="åœºæ™¯1ï¼šæ­£å¸¸ HTTP è¿æ¥å»ºç«‹"></a>åœºæ™¯1ï¼šæ­£å¸¸ HTTP è¿æ¥å»ºç«‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®¢æˆ·ç«¯å‘èµ·è¿æ¥</span></span><br><span class="line">13:21:34.100000 IP client.54321 &gt; server.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, options [mss 1460], length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æœåŠ¡å™¨å“åº”è¿æ¥</span></span><br><span class="line">13:21:34.100500 IP server.80 &gt; client.54321: Flags [S.], <span class="built_in">seq</span> 2000, ack 1001, win 65535, options [mss 1460], length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å®¢æˆ·ç«¯ç¡®è®¤è¿æ¥</span></span><br><span class="line">13:21:34.100600 IP client.54321 &gt; server.80: Flags [.], ack 2001, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚</span></span><br><span class="line">13:21:34.100700 IP client.54321 &gt; server.80: Flags [P.], <span class="built_in">seq</span> 1001:1200, ack 2001, win 65535, length 199</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†æè¦ç‚¹ï¼š</strong></p>
<ul>
<li>âœ… ä¸‰æ¬¡æ¡æ‰‹å®Œæ•´ (SYN â†’ SYN+ACK â†’ ACK)</li>
<li>âœ… åºåˆ—å·æ­£ç¡®é€’å¢ (1000 â†’ 1001, 2000 â†’ 2001)</li>
<li>âœ… å“åº”æ—¶é—´æ­£å¸¸ (0.5ms)</li>
</ul>
<h3 id="åœºæ™¯2ï¼šè¿æ¥è¢«æ‹’ç»"><a href="#åœºæ™¯2ï¼šè¿æ¥è¢«æ‹’ç»" class="headerlink" title="åœºæ™¯2ï¼šè¿æ¥è¢«æ‹’ç»"></a>åœºæ™¯2ï¼šè¿æ¥è¢«æ‹’ç»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®¢æˆ·ç«¯å‘èµ·è¿æ¥</span></span><br><span class="line">13:21:34.100000 IP client.54321 &gt; server.8080: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æœåŠ¡å™¨ç«‹å³æ‹’ç» (ç«¯å£æœªç›‘å¬)</span></span><br><span class="line">13:21:34.100100 IP server.8080 &gt; client.54321: Flags [R.], <span class="built_in">seq</span> 0, ack 1001, win 0, length 0</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†æè¦ç‚¹ï¼š</strong></p>
<ul>
<li>âŒ æ”¶åˆ° RST æ ‡å¿—ï¼Œè¿æ¥è¢«æ‹’ç»</li>
<li>ğŸ” å¯èƒ½åŸå› ï¼šç«¯å£æœªç›‘å¬ã€é˜²ç«å¢™é˜»æ­¢ã€æœåŠ¡æœªå¯åŠ¨</li>
</ul>
<h3 id="åœºæ™¯3ï¼šè¿æ¥è¶…æ—¶é‡ä¼ "><a href="#åœºæ™¯3ï¼šè¿æ¥è¶…æ—¶é‡ä¼ " class="headerlink" title="åœºæ™¯3ï¼šè¿æ¥è¶…æ—¶é‡ä¼ "></a>åœºæ™¯3ï¼šè¿æ¥è¶…æ—¶é‡ä¼ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®¢æˆ·ç«¯å‘èµ·è¿æ¥</span></span><br><span class="line">13:21:34.100000 IP client.54321 &gt; server.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ— å“åº”ï¼Œå®¢æˆ·ç«¯é‡ä¼  (é€šå¸¸ 1 ç§’å)</span></span><br><span class="line">13:21:35.100000 IP client.54321 &gt; server.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç»§ç»­é‡ä¼  (é€šå¸¸ 2 ç§’å)</span></span><br><span class="line">13:21:37.100000 IP client.54321 &gt; server.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æœ€ç»ˆæ”¾å¼ƒæˆ–æ”¶åˆ° RST</span></span><br><span class="line">13:21:41.100000 IP client.54321 &gt; server.80: Flags [R], <span class="built_in">seq</span> 1001, win 0, length 0</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†æè¦ç‚¹ï¼š</strong></p>
<ul>
<li>âš ï¸ é‡å¤çš„ SYN åŒ…è¡¨ç¤ºé‡ä¼ </li>
<li>ğŸ” å¯èƒ½åŸå› ï¼šç½‘ç»œå»¶è¿Ÿã€æœåŠ¡å™¨è´Ÿè½½é«˜ã€ä¸¢åŒ…</li>
</ul>
<h3 id="åœºæ™¯4ï¼šæ•°æ®ä¼ è¾“ä¸­çš„é‡ä¼ "><a href="#åœºæ™¯4ï¼šæ•°æ®ä¼ è¾“ä¸­çš„é‡ä¼ " class="headerlink" title="åœºæ™¯4ï¼šæ•°æ®ä¼ è¾“ä¸­çš„é‡ä¼ "></a>åœºæ™¯4ï¼šæ•°æ®ä¼ è¾“ä¸­çš„é‡ä¼ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ­£å¸¸æ•°æ®ä¼ è¾“</span></span><br><span class="line">13:21:34.100000 IP client.54321 &gt; server.80: Flags [.], <span class="built_in">seq</span> 1001:2001, ack 2001, win 65535, length 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æœåŠ¡å™¨ç¡®è®¤</span></span><br><span class="line">13:21:34.100500 IP server.80 &gt; client.54321: Flags [.], ack 2001, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ä¸‹ä¸€ä¸ªæ•°æ®åŒ…</span></span><br><span class="line">13:21:34.101000 IP client.54321 &gt; server.80: Flags [.], <span class="built_in">seq</span> 2001:3001, ack 2001, win 65535, length 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æœåŠ¡å™¨æ²¡æœ‰ç¡®è®¤ï¼Œå®¢æˆ·ç«¯é‡ä¼ </span></span><br><span class="line">13:21:34.200000 IP client.54321 &gt; server.80: Flags [.], <span class="built_in">seq</span> 2001:3001, ack 2001, win 65535, length 1000</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†æè¦ç‚¹ï¼š</strong></p>
<ul>
<li>âš ï¸ ç›¸åŒåºåˆ—å·çš„é‡å¤åŒ…è¡¨ç¤ºé‡ä¼ </li>
<li>ğŸ” å¯èƒ½åŸå› ï¼šACK ä¸¢å¤±ã€ç½‘ç»œæ‹¥å¡ã€æ¥æ”¶æ–¹å¤„ç†æ…¢</li>
</ul>
<h3 id="åœºæ™¯5ï¼šå¼‚å¸¸è¿æ¥ç»ˆæ­¢"><a href="#åœºæ™¯5ï¼šå¼‚å¸¸è¿æ¥ç»ˆæ­¢" class="headerlink" title="åœºæ™¯5ï¼šå¼‚å¸¸è¿æ¥ç»ˆæ­¢"></a>åœºæ™¯5ï¼šå¼‚å¸¸è¿æ¥ç»ˆæ­¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ­£å¸¸è¿æ¥ä¸­</span></span><br><span class="line">13:21:34.100000 IP client.54321 &gt; server.80: Flags [P.], <span class="built_in">seq</span> 1001:1200, ack 2001, win 65535, length 199</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æœåŠ¡å™¨çªç„¶å‘é€ RST (åº”ç”¨å¼‚å¸¸)</span></span><br><span class="line">13:21:34.100500 IP server.80 &gt; client.54321: Flags [R], <span class="built_in">seq</span> 2001, win 0, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å®¢æˆ·ç«¯å¯èƒ½è¿˜ä¼šå°è¯•å‘é€æ•°æ®</span></span><br><span class="line">13:21:34.101000 IP client.54321 &gt; server.80: Flags [P.], <span class="built_in">seq</span> 1200:1400, ack 2001, win 65535, length 200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æœåŠ¡å™¨ç»§ç»­å‘é€ RST</span></span><br><span class="line">13:21:34.101100 IP server.80 &gt; client.54321: Flags [R], <span class="built_in">seq</span> 2001, win 0, length 0</span><br></pre></td></tr></table></figure>

<p><strong>åˆ†æè¦ç‚¹ï¼š</strong></p>
<ul>
<li>ğŸ’¥ æœåŠ¡å™¨ä¸»åŠ¨ RSTï¼Œåº”ç”¨å±‚é—®é¢˜</li>
<li>ğŸ” å¯èƒ½åŸå› ï¼šç¨‹åºå´©æºƒã€èµ„æºè€—å°½ã€ä¸šåŠ¡é€»è¾‘é”™è¯¯</li>
</ul>
<hr>
<h2 id="4å±‚-7å±‚è´Ÿè½½å‡è¡¡åˆ†æ"><a href="#4å±‚-7å±‚è´Ÿè½½å‡è¡¡åˆ†æ" class="headerlink" title="4å±‚&#x2F;7å±‚è´Ÿè½½å‡è¡¡åˆ†æ"></a>4å±‚&#x2F;7å±‚è´Ÿè½½å‡è¡¡åˆ†æ</h2><h3 id="ğŸ—ï¸-4å±‚è´Ÿè½½å‡è¡¡ï¼ˆä¼ è¾“å±‚ï¼‰"><a href="#ğŸ—ï¸-4å±‚è´Ÿè½½å‡è¡¡ï¼ˆä¼ è¾“å±‚ï¼‰" class="headerlink" title="ğŸ—ï¸ 4å±‚è´Ÿè½½å‡è¡¡ï¼ˆä¼ è¾“å±‚ï¼‰"></a>ğŸ—ï¸ 4å±‚è´Ÿè½½å‡è¡¡ï¼ˆä¼ è¾“å±‚ï¼‰</h3><h4 id="ç‰¹å¾åˆ†æ"><a href="#ç‰¹å¾åˆ†æ" class="headerlink" title="ç‰¹å¾åˆ†æ"></a>ç‰¹å¾åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¢æˆ·ç«¯è¿æ¥åˆ°è´Ÿè½½å‡è¡¡å™¨</span></span><br><span class="line">13:21:34.100000 IP client.12345 &gt; lb.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½å‡è¡¡å™¨è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ (æºIPå¯èƒ½å˜åŒ–)</span></span><br><span class="line">13:21:34.100100 IP lb.54321 &gt; backend1.80: Flags [S], <span class="built_in">seq</span> 2000, win 65535, length 0</span><br><span class="line"><span class="comment"># æˆ–è€…ä¿æŒæºIP (DSRæ¨¡å¼)</span></span><br><span class="line">13:21:34.100100 IP client.12345 &gt; backend1.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># åç«¯æœåŠ¡å™¨å“åº”</span></span><br><span class="line">13:21:34.100200 IP backend1.80 &gt; client.12345: Flags [S.], <span class="built_in">seq</span> 3000, ack 1001, win 65535, length 0</span><br></pre></td></tr></table></figure>

<h4 id="å…³é”®è§‚å¯Ÿç‚¹"><a href="#å…³é”®è§‚å¯Ÿç‚¹" class="headerlink" title="å…³é”®è§‚å¯Ÿç‚¹"></a>å…³é”®è§‚å¯Ÿç‚¹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. è¿æ¥åˆ†å¸ƒ - æ£€æŸ¥è´Ÿè½½å‡è¡¡æ•ˆæœ</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;port 80&quot;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¥åº·æ£€æŸ¥æµé‡ - é€šå¸¸æ˜¯çŸ­è¿æ¥</span></span><br><span class="line">13:21:34.100000 IP lb.12345 &gt; backend1.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line">13:21:34.100100 IP backend1.80 &gt; lb.12345: Flags [S.], <span class="built_in">seq</span> 2000, ack 1001, win 65535, length 0</span><br><span class="line">13:21:34.100200 IP lb.12345 &gt; backend1.80: Flags [.], ack 2001, win 65535, length 0</span><br><span class="line">13:21:34.100300 IP lb.12345 &gt; backend1.80: Flags [F.], <span class="built_in">seq</span> 1001, ack 2001, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ä¼šè¯ä¿æŒ - åŒä¸€å®¢æˆ·ç«¯IPæ€»æ˜¯è¿æ¥åŒä¸€åç«¯</span></span><br><span class="line">client.12345 -&gt; backend1.80  <span class="comment"># ç¬¬ä¸€æ¬¡è¿æ¥</span></span><br><span class="line">client.12345 -&gt; backend1.80  <span class="comment"># åç»­è¿æ¥ä¿æŒä¸€è‡´</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸŒ-7å±‚è´Ÿè½½å‡è¡¡ï¼ˆåº”ç”¨å±‚ï¼‰"><a href="#ğŸŒ-7å±‚è´Ÿè½½å‡è¡¡ï¼ˆåº”ç”¨å±‚ï¼‰" class="headerlink" title="ğŸŒ 7å±‚è´Ÿè½½å‡è¡¡ï¼ˆåº”ç”¨å±‚ï¼‰"></a>ğŸŒ 7å±‚è´Ÿè½½å‡è¡¡ï¼ˆåº”ç”¨å±‚ï¼‰</h3><h4 id="ç‰¹å¾åˆ†æ-1"><a href="#ç‰¹å¾åˆ†æ-1" class="headerlink" title="ç‰¹å¾åˆ†æ"></a>ç‰¹å¾åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¢æˆ·ç«¯è¿æ¥åˆ°è´Ÿè½½å‡è¡¡å™¨</span></span><br><span class="line">13:21:34.100000 IP client.12345 &gt; lb.80: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line">13:21:34.100100 IP lb.80 &gt; client.12345: Flags [S.], <span class="built_in">seq</span> 2000, ack 1001, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚åˆ°è´Ÿè½½å‡è¡¡å™¨</span></span><br><span class="line">13:21:34.100200 IP client.12345 &gt; lb.80: Flags [P.], <span class="built_in">seq</span> 1001:1200, ack 2001, win 65535, length 199</span><br><span class="line"><span class="comment"># HTTP å†…å®¹: GET /api/users HTTP/1.1\r\nHost: example.com\r\n...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½å‡è¡¡å™¨æ–°å»ºè¿æ¥åˆ°åç«¯ (åŸºäº HTTP å†…å®¹å†³ç­–)</span></span><br><span class="line">13:21:34.100300 IP lb.54321 &gt; backend2.8080: Flags [S], <span class="built_in">seq</span> 3000, win 65535, length 0</span><br><span class="line">13:21:34.100400 IP backend2.8080 &gt; lb.54321: Flags [S.], <span class="built_in">seq</span> 4000, ack 3001, win 65535, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½å‡è¡¡å™¨è½¬å‘ä¿®æ”¹åçš„ HTTP è¯·æ±‚</span></span><br><span class="line">13:21:34.100500 IP lb.54321 &gt; backend2.8080: Flags [P.], <span class="built_in">seq</span> 3001:3250, ack 4001, win 65535, length 249</span><br><span class="line"><span class="comment"># HTTP å†…å®¹å¯èƒ½è¢«ä¿®æ”¹: GET /api/users HTTP/1.1\r\nHost: backend2.internal\r\nX-Forwarded-For: client_ip\r\n...</span></span><br></pre></td></tr></table></figure>

<h4 id="HTTP-è¯·æ±‚è·¯ç”±åˆ†æ"><a href="#HTTP-è¯·æ±‚è·¯ç”±åˆ†æ" class="headerlink" title="HTTP è¯·æ±‚è·¯ç”±åˆ†æ"></a>HTTP è¯·æ±‚è·¯ç”±åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¹æ® URL è·¯å¾„è·¯ç”±</span></span><br><span class="line">GET /api/v1/users    -&gt; backend-api.8080</span><br><span class="line">GET /static/css/     -&gt; backend-static.80</span><br><span class="line">GET /admin/          -&gt; backend-admin.8081</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ® Host å¤´è·¯ç”±  </span></span><br><span class="line">Host: api.example.com    -&gt; backend-api.8080</span><br><span class="line">Host: www.example.com    -&gt; backend-web.80</span><br><span class="line">Host: admin.example.com  -&gt; backend-admin.8081</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®è¯·æ±‚å¤´è·¯ç”±</span></span><br><span class="line">User-Agent: Mobile*      -&gt; backend-mobile.8080</span><br><span class="line">User-Agent: Desktop*     -&gt; backend-web.80</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”-è´Ÿè½½å‡è¡¡é—®é¢˜è¯Šæ–­"><a href="#ğŸ”-è´Ÿè½½å‡è¡¡é—®é¢˜è¯Šæ–­" class="headerlink" title="ğŸ” è´Ÿè½½å‡è¡¡é—®é¢˜è¯Šæ–­"></a>ğŸ” è´Ÿè½½å‡è¡¡é—®é¢˜è¯Šæ–­</h3><h4 id="å¸¸è§é—®é¢˜æ¨¡å¼"><a href="#å¸¸è§é—®é¢˜æ¨¡å¼" class="headerlink" title="å¸¸è§é—®é¢˜æ¨¡å¼"></a>å¸¸è§é—®é¢˜æ¨¡å¼</h4><ol>
<li><p><strong>åç«¯æœåŠ¡å™¨æ•…éšœ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è´Ÿè½½å‡è¡¡å™¨æ£€æµ‹åˆ°åç«¯æ•…éšœ</span></span><br><span class="line">13:21:34.100000 IP lb.12345 &gt; backend1.8080: Flags [S], <span class="built_in">seq</span> 1000, win 65535, length 0</span><br><span class="line">13:21:34.100100 IP backend1.8080 &gt; lb.12345: Flags [R.], <span class="built_in">seq</span> 0, ack 1001, win 0, length 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½å‡è¡¡å™¨åˆ‡æ¢åˆ°å¥åº·çš„åç«¯</span></span><br><span class="line">13:21:34.100200 IP lb.12346 &gt; backend2.8080: Flags [S], <span class="built_in">seq</span> 2000, win 65535, length 0</span><br><span class="line">13:21:34.100300 IP backend2.8080 &gt; lb.12346: Flags [S.], <span class="built_in">seq</span> 3000, ack 2001, win 65535, length 0</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ä¼šè¯ä¿æŒå¤±æ•ˆ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ° backend1</span></span><br><span class="line">client.12345 -&gt; lb.80 -&gt; backend1.8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æˆ·ç¬¬äºŒæ¬¡è¯·æ±‚é”™è¯¯åœ°åˆ°äº† backend2 (ä¼šè¯ä¸¢å¤±)</span></span><br><span class="line">client.12345 -&gt; lb.80 -&gt; backend2.8080</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å¥åº·æ£€æŸ¥è¿‡äºé¢‘ç¹</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¯ç§’å¤šæ¬¡å¥åº·æ£€æŸ¥ï¼Œå½±å“åç«¯æ€§èƒ½</span></span><br><span class="line">13:21:34.100 IP lb &gt; backend1.80: GET /health</span><br><span class="line">13:21:34.200 IP lb &gt; backend1.80: GET /health  </span><br><span class="line">13:21:34.300 IP lb &gt; backend1.80: GET /health</span><br><span class="line"><span class="comment"># ... é¢‘ç‡è¿‡é«˜</span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="æœåŠ¡ç«¯å¼€å‘å¿…çŸ¥ç½‘ç»œçŸ¥è¯†"><a href="#æœåŠ¡ç«¯å¼€å‘å¿…çŸ¥ç½‘ç»œçŸ¥è¯†" class="headerlink" title="æœåŠ¡ç«¯å¼€å‘å¿…çŸ¥ç½‘ç»œçŸ¥è¯†"></a>æœåŠ¡ç«¯å¼€å‘å¿…çŸ¥ç½‘ç»œçŸ¥è¯†</h2><h3 id="ğŸš€-TCP-è¿æ¥æ± ä¼˜åŒ–"><a href="#ğŸš€-TCP-è¿æ¥æ± ä¼˜åŒ–" class="headerlink" title="ğŸš€ TCP è¿æ¥æ± ä¼˜åŒ–"></a>ğŸš€ TCP è¿æ¥æ± ä¼˜åŒ–</h3><h4 id="è¿æ¥å¤ç”¨åˆ†æ"><a href="#è¿æ¥å¤ç”¨åˆ†æ" class="headerlink" title="è¿æ¥å¤ç”¨åˆ†æ"></a>è¿æ¥å¤ç”¨åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‰¯å¥½çš„è¿æ¥å¤ç”¨æ¨¡å¼</span></span><br><span class="line">13:21:34.100 IP app.12345 &gt; db.5432: Flags [S]      <span class="comment"># å»ºç«‹è¿æ¥</span></span><br><span class="line">13:21:34.101 IP db.5432 &gt; app.12345: Flags [S.]     <span class="comment"># è¿æ¥ç¡®è®¤</span></span><br><span class="line">13:21:34.102 IP app.12345 &gt; db.5432: Flags [P.]     <span class="comment"># æŸ¥è¯¢1</span></span><br><span class="line">13:21:34.110 IP db.5432 &gt; app.12345: Flags [P.]     <span class="comment"># å“åº”1</span></span><br><span class="line">13:21:34.200 IP app.12345 &gt; db.5432: Flags [P.]     <span class="comment"># æŸ¥è¯¢2 (å¤ç”¨è¿æ¥)</span></span><br><span class="line">13:21:34.210 IP db.5432 &gt; app.12345: Flags [P.]     <span class="comment"># å“åº”2</span></span><br><span class="line">13:21:34.300 IP app.12345 &gt; db.5432: Flags [P.]     <span class="comment"># æŸ¥è¯¢3 (å¤ç”¨è¿æ¥)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸è‰¯çš„è¿æ¥æ¨¡å¼ (æ¯æ¬¡è¯·æ±‚éƒ½å»ºç«‹æ–°è¿æ¥)</span></span><br><span class="line">13:21:34.100 IP app.12345 &gt; db.5432: Flags [S]      <span class="comment"># å»ºç«‹è¿æ¥1</span></span><br><span class="line">13:21:34.102 IP app.12345 &gt; db.5432: Flags [P.]     <span class="comment"># æŸ¥è¯¢1</span></span><br><span class="line">13:21:34.110 IP app.12345 &gt; db.5432: Flags [F.]     <span class="comment"># å…³é—­è¿æ¥1</span></span><br><span class="line">13:21:34.200 IP app.12346 &gt; db.5432: Flags [S]      <span class="comment"># å»ºç«‹è¿æ¥2</span></span><br><span class="line">13:21:34.202 IP app.12346 &gt; db.5432: Flags [P.]     <span class="comment"># æŸ¥è¯¢2</span></span><br><span class="line">13:21:34.210 IP app.12346 &gt; db.5432: Flags [F.]     <span class="comment"># å…³é—­è¿æ¥2</span></span><br></pre></td></tr></table></figure>

<h4 id="è¿æ¥æ± ç›‘æ§æŒ‡æ ‡"><a href="#è¿æ¥æ± ç›‘æ§æŒ‡æ ‡" class="headerlink" title="è¿æ¥æ± ç›‘æ§æŒ‡æ ‡"></a>è¿æ¥æ± ç›‘æ§æŒ‡æ ‡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. è¿æ¥å»ºç«‹é¢‘ç‡</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-syn != 0&quot;</span> | \</span><br><span class="line">    grep <span class="string">&quot;app_server&quot;</span> | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è¿æ¥å¤ç”¨ç‡  </span></span><br><span class="line">æ€»è¯·æ±‚æ•° / æ–°å»ºè¿æ¥æ•° = å¤ç”¨ç‡</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è¿æ¥è¶…æ—¶æƒ…å†µ</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-rst != 0&quot;</span> | \</span><br><span class="line">    grep <span class="string">&quot;connection.*timeout&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”-HTTPS-TLS-ä¼˜åŒ–åˆ†æ"><a href="#ğŸ”-HTTPS-TLS-ä¼˜åŒ–åˆ†æ" class="headerlink" title="ğŸ” HTTPS&#x2F;TLS ä¼˜åŒ–åˆ†æ"></a>ğŸ” HTTPS&#x2F;TLS ä¼˜åŒ–åˆ†æ</h3><h4 id="TLS-æ¡æ‰‹æ€§èƒ½åˆ†æ"><a href="#TLS-æ¡æ‰‹æ€§èƒ½åˆ†æ" class="headerlink" title="TLS æ¡æ‰‹æ€§èƒ½åˆ†æ"></a>TLS æ¡æ‰‹æ€§èƒ½åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®Œæ•´çš„ TLS 1.2 æ¡æ‰‹è¿‡ç¨‹</span></span><br><span class="line">13:21:34.100 IP client &gt; server.443: Flags [S]           <span class="comment"># TCP SYN</span></span><br><span class="line">13:21:34.101 IP server.443 &gt; client: Flags [S.]          <span class="comment"># TCP SYN-ACK  </span></span><br><span class="line">13:21:34.102 IP client &gt; server.443: Flags [.]           <span class="comment"># TCP ACK</span></span><br><span class="line"></span><br><span class="line">13:21:34.103 IP client &gt; server.443: Flags [P.]          <span class="comment"># Client Hello</span></span><br><span class="line">13:21:34.105 IP server.443 &gt; client: Flags [P.]          <span class="comment"># Server Hello, Certificate, Server Hello Done</span></span><br><span class="line">13:21:34.108 IP client &gt; server.443: Flags [P.]          <span class="comment"># Client Key Exchange, Change Cipher Spec, Finished</span></span><br><span class="line">13:21:34.110 IP server.443 &gt; client: Flags [P.]          <span class="comment"># Change Cipher Spec, Finished</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TLS æ¡æ‰‹æ€»è€—æ—¶ = 110 - 100 = 10ms (4ä¸ªå¾€è¿”)</span></span><br></pre></td></tr></table></figure>

<h4 id="TLS-ä¼šè¯å¤ç”¨"><a href="#TLS-ä¼šè¯å¤ç”¨" class="headerlink" title="TLS ä¼šè¯å¤ç”¨"></a>TLS ä¼šè¯å¤ç”¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¼šè¯å¤ç”¨æ¨¡å¼ (Session ID æˆ– Session Ticket)</span></span><br><span class="line">13:21:34.100 IP client &gt; server.443: Flags [P.]          <span class="comment"># Client Hello (å¸¦ Session ID)</span></span><br><span class="line">13:21:34.102 IP server.443 &gt; client: Flags [P.]          <span class="comment"># Server Hello (ç¡®è®¤å¤ç”¨)</span></span><br><span class="line">13:21:34.103 IP client &gt; server.443: Flags [P.]          <span class="comment"># Change Cipher Spec, Finished</span></span><br><span class="line">13:21:34.104 IP server.443 &gt; client: Flags [P.]          <span class="comment"># Change Cipher Spec, Finished</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤ç”¨æ¡æ‰‹æ€»è€—æ—¶ = 4ms (2ä¸ªå¾€è¿”ï¼ŒèŠ‚çœ50%æ—¶é—´)</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ¯-å¾®æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–"><a href="#ğŸ¯-å¾®æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–" class="headerlink" title="ğŸ¯ å¾®æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–"></a>ğŸ¯ å¾®æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–</h3><h4 id="æœåŠ¡å‘ç°æ¨¡å¼åˆ†æ"><a href="#æœåŠ¡å‘ç°æ¨¡å¼åˆ†æ" class="headerlink" title="æœåŠ¡å‘ç°æ¨¡å¼åˆ†æ"></a>æœåŠ¡å‘ç°æ¨¡å¼åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DNS æœåŠ¡å‘ç°</span></span><br><span class="line">13:21:34.100 IP app &gt; dns.53: A? user-service.internal   <span class="comment"># DNS æŸ¥è¯¢</span></span><br><span class="line">13:21:34.101 IP dns.53 &gt; app: A 10.0.1.100              <span class="comment"># DNS å“åº”</span></span><br><span class="line">13:21:34.102 IP app &gt; 10.0.1.100.8080: Flags [S]        <span class="comment"># è¿æ¥æœåŠ¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡æ³¨å†Œä¸­å¿ƒæ¨¡å¼ (å¦‚ Consul)</span></span><br><span class="line">13:21:34.100 IP app &gt; consul.8500: GET /v1/health/service/user-service</span><br><span class="line">13:21:34.102 IP consul.8500 &gt; app: 200 OK [&#123;<span class="string">&quot;Address&quot;</span>:<span class="string">&quot;10.0.1.100&quot;</span>,<span class="string">&quot;Port&quot;</span>:8080&#125;]</span><br><span class="line">13:21:34.103 IP app &gt; 10.0.1.100.8080: Flags [S]</span><br></pre></td></tr></table></figure>

<h4 id="ç†”æ–­å™¨æ¨¡å¼è¯†åˆ«"><a href="#ç†”æ–­å™¨æ¨¡å¼è¯†åˆ«" class="headerlink" title="ç†”æ–­å™¨æ¨¡å¼è¯†åˆ«"></a>ç†”æ–­å™¨æ¨¡å¼è¯†åˆ«</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å¸¸è¯·æ±‚æ¨¡å¼</span></span><br><span class="line">13:21:34.100 IP app &gt; user-service.8080: POST /api/users</span><br><span class="line">13:21:34.110 IP user-service.8080 &gt; app: 200 OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡å¼€å§‹å‡ºç°å»¶è¿Ÿ</span></span><br><span class="line">13:21:35.100 IP app &gt; user-service.8080: POST /api/users</span><br><span class="line">13:21:35.500 IP user-service.8080 &gt; app: 200 OK          <span class="comment"># 400ms å»¶è¿Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç†”æ–­å™¨æ‰“å¼€ï¼Œè¯·æ±‚è¢«å¿«é€Ÿæ‹’ç» (æœ¬åœ°å“åº”ï¼Œæ— ç½‘ç»œè¯·æ±‚)</span></span><br><span class="line">13:21:36.100 <span class="comment"># æ— ç½‘ç»œæµé‡ï¼Œåº”ç”¨ç›´æ¥è¿”å›é™çº§å“åº”</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç†”æ–­å™¨åŠå¼€ï¼Œå°è¯•æ¢å¤</span></span><br><span class="line">13:21:37.100 IP app &gt; user-service.8080: POST /api/users <span class="comment"># æ¢æµ‹è¯·æ±‚</span></span><br><span class="line">13:21:37.120 IP user-service.8080 &gt; app: 200 OK          <span class="comment"># å¿«é€Ÿå“åº”ï¼Œç†”æ–­å™¨å…³é—­</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ“Š-æ€§èƒ½æŒ‡æ ‡ç›‘æ§"><a href="#ğŸ“Š-æ€§èƒ½æŒ‡æ ‡ç›‘æ§" class="headerlink" title="ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç›‘æ§"></a>ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç›‘æ§</h3><h4 id="å…³é”®ç½‘ç»œæŒ‡æ ‡"><a href="#å…³é”®ç½‘ç»œæŒ‡æ ‡" class="headerlink" title="å…³é”®ç½‘ç»œæŒ‡æ ‡"></a>å…³é”®ç½‘ç»œæŒ‡æ ‡</h4><ol>
<li><p><strong>è¿æ¥å»ºç«‹æ—¶é—´</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®— SYN åˆ° SYN+ACK çš„æ—¶é—´å·®</span></span><br><span class="line">tcpdump -ttt -nn <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;/SYN/ &#123;syn_time=$1&#125; /SYN.*ACK/ &#123;print &quot;Connection time:&quot;, $1-syn_time, &quot;ms&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¯·æ±‚å“åº”æ—¶é—´</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®— HTTP è¯·æ±‚åˆ°å“åº”çš„æ—¶é—´å·®  </span></span><br><span class="line">tcpdump -ttt -nn -A <span class="string">&quot;port 80&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;/GET|POST/ &#123;req_time=$1&#125; /HTTP.*200/ &#123;print &quot;Response time:&quot;, $1-req_time, &quot;ms&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>é‡ä¼ ç‡è®¡ç®—</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»Ÿè®¡é‡ä¼ åŒ…æ•°é‡</span></span><br><span class="line">total_packets=$(tcpdump -r capture.pcap -nn | <span class="built_in">wc</span> -l)</span><br><span class="line">retrans_packets=$(tcpdump -r capture.pcap -nn | grep <span class="string">&quot;retransmission&quot;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">retrans_rate=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$retrans_packets</span> * 100 / <span class="variable">$total_packets</span>&quot;</span> | bc)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;é‡ä¼ ç‡: <span class="variable">$retrans_rate</span>%&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="ğŸ› ï¸-é—®é¢˜å®šä½å·¥å…·ç»„åˆ"><a href="#ğŸ› ï¸-é—®é¢˜å®šä½å·¥å…·ç»„åˆ" class="headerlink" title="ğŸ› ï¸ é—®é¢˜å®šä½å·¥å…·ç»„åˆ"></a>ğŸ› ï¸ é—®é¢˜å®šä½å·¥å…·ç»„åˆ</h3><h4 id="åº”ç”¨å±‚é¢é—®é¢˜å®šä½"><a href="#åº”ç”¨å±‚é¢é—®é¢˜å®šä½" class="headerlink" title="åº”ç”¨å±‚é¢é—®é¢˜å®šä½"></a>åº”ç”¨å±‚é¢é—®é¢˜å®šä½</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åº”ç”¨æ—¥å¿— + ç½‘ç»œæŠ“åŒ…å¯¹æ¯”</span></span><br><span class="line"><span class="built_in">tail</span> -f app.log &amp;</span><br><span class="line">tcpdump -i any -nn -A <span class="string">&quot;port 8080&quot;</span> -w app_network.pcap &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ•°æ®åº“è¿æ¥æ± åˆ†æ</span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 5432&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1, $3, $5&#125;&#x27;</span> | \</span><br><span class="line">    <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç¼“å­˜å‘½ä¸­ç‡ç½‘ç»œè§†è§’</span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 6379&quot;</span> | \</span><br><span class="line">    grep -E <span class="string">&quot;(GET|SET|HGET)&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure>

<h4 id="å®¹å™¨ç¯å¢ƒé—®é¢˜å®šä½"><a href="#å®¹å™¨ç¯å¢ƒé—®é¢˜å®šä½" class="headerlink" title="å®¹å™¨ç¯å¢ƒé—®é¢˜å®šä½"></a>å®¹å™¨ç¯å¢ƒé—®é¢˜å®šä½</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes ç¯å¢ƒç½‘ç»œåˆ†æ</span></span><br><span class="line"><span class="comment"># 1. Pod é—´é€šä¿¡</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod1 -- tcpdump -i eth0 -nn <span class="string">&quot;host pod2_ip&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Service è´Ÿè½½å‡è¡¡</span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;<span class="subst">$(kubectl get endpoints service-name -o jsonpath=&#x27;&#123;.subsets[*].addresses[*].ip&#125;&#x27;)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Ingress æµé‡åˆ†æ  </span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 443&quot;</span> | grep -E <span class="string">&quot;SNI.*domain\.com&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“-è¿›é˜¶æŠ€å·§ä¸æœ€ä½³å®è·µ"><a href="#ğŸ“-è¿›é˜¶æŠ€å·§ä¸æœ€ä½³å®è·µ" class="headerlink" title="ğŸ“ è¿›é˜¶æŠ€å·§ä¸æœ€ä½³å®è·µ"></a>ğŸ“ è¿›é˜¶æŠ€å·§ä¸æœ€ä½³å®è·µ</h2><h3 id="ğŸ”¬-é«˜çº§è¿‡æ»¤æŠ€å·§"><a href="#ğŸ”¬-é«˜çº§è¿‡æ»¤æŠ€å·§" class="headerlink" title="ğŸ”¬ é«˜çº§è¿‡æ»¤æŠ€å·§"></a>ğŸ”¬ é«˜çº§è¿‡æ»¤æŠ€å·§</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åªæŠ“æ¡æ‰‹åŒ…ï¼Œåˆ†æè¿æ¥å»ºç«‹é—®é¢˜</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-fin|tcp-rst) != 0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŠ“å–æœ‰æ•°æ®è½½è·çš„åŒ…</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp and greater 0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æŠ“å–å¼‚å¸¸åŒ… (é‡ä¼ ã€ä¹±åºã€é‡å¤ACK)</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp and ((tcp[tcpflags] &amp; tcp-rst) != 0 or tcp[tcpflags] &amp; tcp-syn != 0)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åˆ†æç‰¹å®šåº”ç”¨åè®®</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 3306&quot;</span> | grep -E <span class="string">&quot;(SELECT|INSERT|UPDATE|DELETE)&quot;</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 6379&quot;</span> | grep -E <span class="string">&quot;(GET|SET|HGET|HSET)&quot;</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;(GET|POST|PUT|DELETE) .* HTTP&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æŠ“å–å¤§åŒ… (å¯èƒ½çš„åˆ†ç‰‡æˆ–æ€§èƒ½é—®é¢˜)</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;greater 1500&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. æŠ“å–å°åŒ… (å¯èƒ½çš„Nagleç®—æ³•é—®é¢˜)</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;less 100 and tcp&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ“ˆ-æ€§èƒ½è°ƒä¼˜å®æˆ˜"><a href="#ğŸ“ˆ-æ€§èƒ½è°ƒä¼˜å®æˆ˜" class="headerlink" title="ğŸ“ˆ æ€§èƒ½è°ƒä¼˜å®æˆ˜"></a>ğŸ“ˆ æ€§èƒ½è°ƒä¼˜å®æˆ˜</h3><h4 id="ç½‘ç»œæ‹¥å¡åˆ†æ"><a href="#ç½‘ç»œæ‹¥å¡åˆ†æ" class="headerlink" title="ç½‘ç»œæ‹¥å¡åˆ†æ"></a>ç½‘ç»œæ‹¥å¡åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æµ‹é›¶çª—å£ (æ¥æ”¶æ–¹å¤„ç†ä¸è¿‡æ¥)</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp and tcp[14:2] = 0&quot;</span> | <span class="built_in">head</span> -20</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å‡ºåˆ†æ:</span></span><br><span class="line">13:21:34.100 IP client.12345 &gt; server.80: Flags [.], ack 1000, win 0, length 0</span><br><span class="line"><span class="comment"># win 0 è¡¨ç¤ºå®¢æˆ·ç«¯ç¼“å†²åŒºæ»¡ï¼Œè¦æ±‚æœåŠ¡ç«¯åœæ­¢å‘é€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æµ‹çª—å£æ‰©å¤§ (æ‹¥å¡æ¢å¤)</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp&quot;</span> | awk <span class="string">&#x27;/win/ &#123;print $1, $NF&#125;&#x27;</span> | \</span><br><span class="line">    grep -E <span class="string">&quot;win [0-9]+&quot;</span> | <span class="built_in">sort</span> -k2 -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ†æé‡ä¼ æ¨¡å¼</span></span><br><span class="line">tcpdump -nn -r capture.pcap | \</span><br><span class="line">    awk <span class="string">&#x27;/retransmission/ &#123;retrans++&#125; END &#123;print &quot;é‡ä¼ åŒ…æ•°:&quot;, retrans&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="TCP-è°ƒä¼˜å‚æ•°éªŒè¯"><a href="#TCP-è°ƒä¼˜å‚æ•°éªŒè¯" class="headerlink" title="TCP è°ƒä¼˜å‚æ•°éªŒè¯"></a>TCP è°ƒä¼˜å‚æ•°éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. MSS (æœ€å¤§æ®µå¤§å°) åå•†åˆ†æ</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-syn != 0&quot;</span> | grep <span class="string">&quot;mss&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹:</span></span><br><span class="line">13:21:34.100 IP client &gt; server.80: Flags [S], options [mss 1460], length 0</span><br><span class="line">13:21:34.101 IP server.80 &gt; client: Flags [S.], options [mss 1460], length 0</span><br><span class="line"><span class="comment"># åŒæ–¹åå•† MSS = 1460ï¼Œè¿™æ˜¯ä»¥å¤ªç½‘æ ‡å‡†å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. çª—å£æ‰©å¤§å› å­åˆ†æ</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-syn != 0&quot;</span> | grep <span class="string">&quot;wscale&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹:</span></span><br><span class="line">options [mss 1460,sackOK,TS val 123456 ecr 0,nop,wscale 7]</span><br><span class="line"><span class="comment"># wscale 7 è¡¨ç¤ºçª—å£å¯ä»¥æ‰©å¤§ 2^7 = 128 å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. SACK (é€‰æ‹©æ€§ç¡®è®¤) æ”¯æŒæ£€æµ‹</span></span><br><span class="line">tcpdump -nn | grep <span class="string">&quot;sackOK&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸš¨-æ•…éšœæ’æŸ¥è¿›é˜¶"><a href="#ğŸš¨-æ•…éšœæ’æŸ¥è¿›é˜¶" class="headerlink" title="ğŸš¨ æ•…éšœæ’æŸ¥è¿›é˜¶"></a>ğŸš¨ æ•…éšœæ’æŸ¥è¿›é˜¶</h3><h4 id="å¤æ‚ç½‘ç»œç¯å¢ƒè°ƒè¯•"><a href="#å¤æ‚ç½‘ç»œç¯å¢ƒè°ƒè¯•" class="headerlink" title="å¤æ‚ç½‘ç»œç¯å¢ƒè°ƒè¯•"></a>å¤æ‚ç½‘ç»œç¯å¢ƒè°ƒè¯•</h4><p><strong>1. å¤šç½‘å¡ç¯å¢ƒåˆ†æ</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥æµé‡åœ¨å“ªä¸ªç½‘å¡</span></span><br><span class="line"><span class="keyword">for</span> iface <span class="keyword">in</span> $(ip <span class="built_in">link</span> show | grep -o <span class="string">&#x27;^[0-9]*: [^:]*&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27; &#x27;</span> -f2); <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== <span class="variable">$iface</span> ===&quot;</span></span><br><span class="line">    <span class="built_in">timeout</span> 5 tcpdump -i <span class="variable">$iface</span> -c 10 -nn 2&gt;/dev/null | <span class="built_in">head</span> -5</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æè·¯ç”±å†³ç­–</span></span><br><span class="line">ip route get 192.168.1.100</span><br><span class="line"><span class="comment"># via 192.168.1.1 dev eth0 src 192.168.1.50</span></span><br></pre></td></tr></table></figure>

<p><strong>2. Docker&#x2F;Kubernetes ç½‘ç»œè°ƒè¯•</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨ç½‘ç»œæ ˆåˆ†æ</span></span><br><span class="line">docker <span class="built_in">exec</span> container_name ip netns <span class="built_in">exec</span> netns_id tcpdump -i eth0 -nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes Pod ç½‘ç»œ</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod-name -c container-name -- tcpdump -i eth0 -nn</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ CNI ç½‘ç»œ</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i cni0 -nn <span class="string">&quot;host pod_ip&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service ç½‘ç»œåˆ†æ (iptables è§„åˆ™å½±å“)</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -t nat -L -n -v | grep service_name</span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn <span class="string">&quot;port service_port&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>3. è´Ÿè½½å‡è¡¡å™¨åç«¯å¥åº·æ£€æŸ¥</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯†åˆ«å¥åº·æ£€æŸ¥æ¨¡å¼</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;(GET /health|GET /status|GET /ping)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æå¥åº·æ£€æŸ¥é¢‘ç‡</span></span><br><span class="line">tcpdump -nn -c 100 <span class="string">&quot;port 80 and host lb_ip&quot;</span> | \</span><br><span class="line">    grep <span class="string">&quot;health&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="built_in">uniq</span> -c</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å¥åº·æ£€æŸ¥å“åº”æ—¶é—´</span></span><br><span class="line">tcpdump -ttt -nn <span class="string">&quot;port 80&quot;</span> | \</span><br><span class="line">    awk <span class="string">&#x27;/GET.*health/ &#123;start=$1&#125; /200 OK/ &#123;print &quot;Health check time:&quot;, $1-start, &quot;ms&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ¯-å¾®æœåŠ¡æ¶æ„ç½‘ç»œåˆ†æ"><a href="#ğŸ¯-å¾®æœåŠ¡æ¶æ„ç½‘ç»œåˆ†æ" class="headerlink" title="ğŸ¯ å¾®æœåŠ¡æ¶æ„ç½‘ç»œåˆ†æ"></a>ğŸ¯ å¾®æœåŠ¡æ¶æ„ç½‘ç»œåˆ†æ</h3><h4 id="æœåŠ¡ç½‘æ ¼-Service-Mesh-æµé‡åˆ†æ"><a href="#æœåŠ¡ç½‘æ ¼-Service-Mesh-æµé‡åˆ†æ" class="headerlink" title="æœåŠ¡ç½‘æ ¼ (Service Mesh) æµé‡åˆ†æ"></a>æœåŠ¡ç½‘æ ¼ (Service Mesh) æµé‡åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Istio/Envoy ä»£ç†æµé‡åˆ†æ</span></span><br><span class="line"><span class="comment"># 1. è¾¹è½¦ä»£ç†å…¥ç«™æµé‡</span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 15001&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è¾¹è½¦ä»£ç†å‡ºç«™æµé‡  </span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 15000&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ§åˆ¶å¹³é¢é€šä¿¡</span></span><br><span class="line">tcpdump -i any -nn <span class="string">&quot;port 15010&quot;</span> | grep -E <span class="string">&quot;(pilot|mixer|citadel)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åˆ†æ mTLS æµé‡ç‰¹å¾</span></span><br><span class="line">tcpdump -i any -nn -X <span class="string">&quot;port 15001&quot;</span> | grep -A5 -B5 <span class="string">&quot;TLS&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="API-ç½‘å…³æµé‡æ¨¡å¼"><a href="#API-ç½‘å…³æµé‡æ¨¡å¼" class="headerlink" title="API ç½‘å…³æµé‡æ¨¡å¼"></a>API ç½‘å…³æµé‡æ¨¡å¼</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. é€Ÿç‡é™åˆ¶æ£€æµ‹</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;429|Rate.*Limit&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è®¤è¯æµé‡åˆ†æ</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;Authorization:|401|403&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. API ç‰ˆæœ¬è·¯ç”±åˆ†æ</span></span><br><span class="line">tcpdump -nn -A <span class="string">&quot;port 80&quot;</span> | grep -E <span class="string">&quot;GET /v[0-9]+/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹åˆ†æï¼š</span></span><br><span class="line">GET /v1/users HTTP/1.1     -&gt; backend-v1.8080</span><br><span class="line">GET /v2/users HTTP/1.1     -&gt; backend-v2.8080</span><br><span class="line">GET /v3/users HTTP/1.1     -&gt; backend-v3.8080</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ“Š-ç›‘æ§ä¸å‘Šè­¦"><a href="#ğŸ“Š-ç›‘æ§ä¸å‘Šè­¦" class="headerlink" title="ğŸ“Š ç›‘æ§ä¸å‘Šè­¦"></a>ğŸ“Š ç›‘æ§ä¸å‘Šè­¦</h3><h4 id="è‡ªåŠ¨åŒ–ç½‘ç»œé—®é¢˜æ£€æµ‹è„šæœ¬"><a href="#è‡ªåŠ¨åŒ–ç½‘ç»œé—®é¢˜æ£€æµ‹è„šæœ¬" class="headerlink" title="è‡ªåŠ¨åŒ–ç½‘ç»œé—®é¢˜æ£€æµ‹è„šæœ¬"></a>è‡ªåŠ¨åŒ–ç½‘ç»œé—®é¢˜æ£€æµ‹è„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># network_monitor.sh - å®æ—¶ç½‘ç»œé—®é¢˜æ£€æµ‹</span></span><br><span class="line"></span><br><span class="line">LOG_FILE=<span class="string">&quot;/var/log/network_monitor.log&quot;</span></span><br><span class="line">ALERT_THRESHOLD=10  <span class="comment"># RSTåŒ…é˜ˆå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. ç›‘æ§å¼‚å¸¸è¿æ¥é‡ç½®</span></span><br><span class="line"><span class="function"><span class="title">monitor_rst</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> rst_count=$(<span class="built_in">timeout</span> 60 tcpdump -i any -nn -c 1000 2&gt;/dev/null | \</span><br><span class="line">                     grep -c <span class="string">&quot;Flags \[R\]&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$rst_count</span> -gt <span class="variable">$ALERT_THRESHOLD</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date)</span>] ALERT: High RST count: <span class="variable">$rst_count</span>&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">        <span class="comment"># å‘é€å‘Šè­¦é€šçŸ¥</span></span><br><span class="line">        curl -X POST <span class="string">&quot;http://alert-manager/api/v1/alerts&quot;</span> \</span><br><span class="line">             -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">             -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">                 &quot;labels&quot;: &#123;</span></span><br><span class="line"><span class="string">                     &quot;alertname&quot;: &quot;HighRSTCount&quot;,</span></span><br><span class="line"><span class="string">                     &quot;severity&quot;: &quot;warning&quot;,</span></span><br><span class="line"><span class="string">                     &quot;instance&quot;: &quot;&#x27;</span>$(hostname)<span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">                 &#125;,</span></span><br><span class="line"><span class="string">                 &quot;annotations&quot;: &#123;</span></span><br><span class="line"><span class="string">                     &quot;description&quot;: &quot;RST count exceeded threshold: &#x27;</span><span class="variable">$rst_count</span><span class="string">&#x27;&quot;</span></span><br><span class="line"><span class="string">                 &#125;</span></span><br><span class="line"><span class="string">             &#125;&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ç›‘æ§è¿æ¥å»ºç«‹å»¶è¿Ÿ</span></span><br><span class="line"><span class="function"><span class="title">monitor_connection_latency</span></span>() &#123;</span><br><span class="line">    <span class="built_in">timeout</span> 30 tcpdump -i any -nn -ttt <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span> 2&gt;/dev/null | \</span><br><span class="line">    awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    /Flags \[S\]/ &#123; syn_time = $1; syn_packet = $0 &#125;</span></span><br><span class="line"><span class="string">    /Flags \[S\.\]/ &#123; </span></span><br><span class="line"><span class="string">        if (syn_time &gt; 0) &#123;</span></span><br><span class="line"><span class="string">            latency = $1 - syn_time</span></span><br><span class="line"><span class="string">            if (latency &gt; 100) &#123;  # è¶…è¿‡100mså‘Šè­¦</span></span><br><span class="line"><span class="string">                print &quot;[&quot; strftime(&quot;%Y-%m-%d %H:%M:%S&quot;) &quot;] HIGH LATENCY:&quot;, latency &quot;ms&quot;</span></span><br><span class="line"><span class="string">                print &quot;SYN:&quot;, syn_packet</span></span><br><span class="line"><span class="string">                print &quot;SYN-ACK:&quot;, $0</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            syn_time = 0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç›‘æ§é‡ä¼ ç‡</span></span><br><span class="line"><span class="function"><span class="title">monitor_retransmission</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> stats=$(<span class="built_in">timeout</span> 60 tcpdump -i any -nn -c 1000 2&gt;/dev/null | \</span><br><span class="line">                 awk <span class="string">&#x27;/retransmission/ &#123;retrans++&#125; END &#123;</span></span><br><span class="line"><span class="string">                     total=NR; </span></span><br><span class="line"><span class="string">                     rate=(retrans/total)*100; </span></span><br><span class="line"><span class="string">                     print retrans&quot;,&quot;total&quot;,&quot;rate</span></span><br><span class="line"><span class="string">                 &#125;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">local</span> retrans=$(<span class="built_in">echo</span> <span class="variable">$stats</span> | <span class="built_in">cut</span> -d, -f1)</span><br><span class="line">    <span class="built_in">local</span> total=$(<span class="built_in">echo</span> <span class="variable">$stats</span> | <span class="built_in">cut</span> -d, -f2)</span><br><span class="line">    <span class="built_in">local</span> rate=$(<span class="built_in">echo</span> <span class="variable">$stats</span> | <span class="built_in">cut</span> -d, -f3)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (( $(echo &quot;<span class="variable">$rate</span> &gt; <span class="number">5.0</span>&quot; | bc -l) )); <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date)</span>] ALERT: High retransmission rate: <span class="variable">$rate</span>%&quot;</span> &gt;&gt; <span class="variable">$LOG_FILE</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»å¾ªç¯</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    monitor_rst</span><br><span class="line">    monitor_connection_latency  </span><br><span class="line">    monitor_retransmission</span><br><span class="line">    <span class="built_in">sleep</span> 60</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="ç½‘ç»œè´¨é‡æŠ¥å‘Šç”Ÿæˆ"><a href="#ç½‘ç»œè´¨é‡æŠ¥å‘Šç”Ÿæˆ" class="headerlink" title="ç½‘ç»œè´¨é‡æŠ¥å‘Šç”Ÿæˆ"></a>ç½‘ç»œè´¨é‡æŠ¥å‘Šç”Ÿæˆ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># network_quality_report.sh - ç”Ÿæˆç½‘ç»œè´¨é‡æŠ¥å‘Š</span></span><br><span class="line"></span><br><span class="line">CAPTURE_FILE=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">REPORT_FILE=<span class="string">&quot;network_quality_report_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>.html&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ HTML æŠ¥å‘Š</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$REPORT_FILE</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">    &lt;title&gt;ç½‘ç»œè´¨é‡åˆ†ææŠ¥å‘Š&lt;/title&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        body &#123; font-family: Arial, sans-serif; margin: 20px; &#125;</span><br><span class="line">        .metric &#123; background: <span class="comment">#f5f5f5; padding: 10px; margin: 10px 0; &#125;</span></span><br><span class="line">        .warning &#123; background: <span class="comment">#fff3cd; border-left: 4px solid #ffc107; &#125;</span></span><br><span class="line">        .error &#123; background: <span class="comment">#f8d7da; border-left: 4px solid #dc3545; &#125;</span></span><br><span class="line">        .success &#123; background: <span class="comment">#d4edda; border-left: 4px solid #28a745; &#125;</span></span><br><span class="line">        table &#123; border-collapse: collapse; width: 100%; &#125;</span><br><span class="line">        th, td &#123; border: 1px solid <span class="comment">#ddd; padding: 8px; text-align: left; &#125;</span></span><br><span class="line">        th &#123; background-color: <span class="comment">#f2f2f2; &#125;</span></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;ç½‘ç»œè´¨é‡åˆ†ææŠ¥å‘Š&lt;/h1&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;ç”Ÿæˆæ—¶é—´: <span class="subst">$(date)</span>&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;åˆ†ææ–‡ä»¶: <span class="variable">$CAPTURE_FILE</span>&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºç¡€ç»Ÿè®¡</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h2&gt;åŸºç¡€æµé‡ç»Ÿè®¡&lt;/h2&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;div class=&#x27;metric&#x27;&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line">total_packets=$(tcpdump -r <span class="variable">$CAPTURE_FILE</span> -nn 2&gt;/dev/null | <span class="built_in">wc</span> -l)</span><br><span class="line">tcp_packets=$(tcpdump -r <span class="variable">$CAPTURE_FILE</span> -nn <span class="string">&quot;tcp&quot;</span> 2&gt;/dev/null | <span class="built_in">wc</span> -l)</span><br><span class="line">udp_packets=$(tcpdump -r <span class="variable">$CAPTURE_FILE</span> -nn <span class="string">&quot;udp&quot;</span> 2&gt;/dev/null | <span class="built_in">wc</span> -l)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;æ€»åŒ…æ•°: <span class="variable">$total_packets</span>&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;TCP åŒ…æ•°: <span class="variable">$tcp_packets</span>&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span>  </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;UDP åŒ…æ•°: <span class="variable">$udp_packets</span>&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;/div&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥é—®é¢˜åˆ†æ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h2&gt;è¿æ¥é—®é¢˜åˆ†æ&lt;/h2&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line">rst_count=$(tcpdump -r <span class="variable">$CAPTURE_FILE</span> -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-rst != 0&quot;</span> 2&gt;/dev/null | <span class="built_in">wc</span> -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$rst_count</span> -gt 10 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;div class=&#x27;metric error&#x27;&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;âš ï¸ å‘ç°å¤§é‡ RST åŒ…: <span class="variable">$rst_count</span> ä¸ª&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;div class=&#x27;metric success&#x27;&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;âœ… RST åŒ…æ•°é‡æ­£å¸¸: <span class="variable">$rst_count</span> ä¸ª&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;/div&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡ä¼ åˆ†æ</span></span><br><span class="line">retrans_count=$(tcpdump -r <span class="variable">$CAPTURE_FILE</span> -nn 2&gt;/dev/null | grep -c <span class="string">&quot;retransmission&quot;</span>)</span><br><span class="line">retrans_rate=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$retrans_count</span> * 100 / <span class="variable">$total_packets</span>&quot;</span> | bc -l)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;h2&gt;é‡ä¼ åˆ†æ&lt;/h2&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="keyword">if</span> (( $(echo &quot;<span class="variable">$retrans_rate</span> &gt; <span class="number">3.0</span>&quot; | bc -l) )); <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;div class=&#x27;metric warning&#x27;&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;âš ï¸ é‡ä¼ ç‡è¾ƒé«˜: <span class="variable">$retrans_rate</span>%&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;div class=&#x27;metric success&#x27;&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;p&gt;âœ… é‡ä¼ ç‡æ­£å¸¸: <span class="variable">$retrans_rate</span>%&lt;/p&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;/div&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®ŒæˆæŠ¥å‘Š</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span> &gt;&gt; <span class="variable">$REPORT_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æŠ¥å‘Šå·²ç”Ÿæˆ: <span class="variable">$REPORT_FILE</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”-æ·±åº¦åŒ…æ£€æµ‹æŠ€å·§"><a href="#ğŸ”-æ·±åº¦åŒ…æ£€æµ‹æŠ€å·§" class="headerlink" title="ğŸ” æ·±åº¦åŒ…æ£€æµ‹æŠ€å·§"></a>ğŸ” æ·±åº¦åŒ…æ£€æµ‹æŠ€å·§</h3><h4 id="åº”ç”¨å±‚åè®®åˆ†æ"><a href="#åº”ç”¨å±‚åè®®åˆ†æ" class="headerlink" title="åº”ç”¨å±‚åè®®åˆ†æ"></a>åº”ç”¨å±‚åè®®åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. HTTP æ€§èƒ½åˆ†æ</span></span><br><span class="line">tcpdump -nn -A -s 0 <span class="string">&quot;port 80&quot;</span> | \</span><br><span class="line">awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">/GET|POST|PUT|DELETE/ &#123;</span></span><br><span class="line"><span class="string">    method = $1; url = $2; req_time = systime()</span></span><br><span class="line"><span class="string">    printf &quot;REQUEST: %s %s at %s\n&quot;, method, url, strftime(&quot;%H:%M:%S&quot;, req_time)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">/HTTP.*200/ &#123; </span></span><br><span class="line"><span class="string">    resp_time = systime()</span></span><br><span class="line"><span class="string">    printf &quot;RESPONSE: 200 OK at %s (duration: %ds)\n\n&quot;, strftime(&quot;%H:%M:%S&quot;, resp_time), resp_time - req_time</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. SQL æŸ¥è¯¢åˆ†æ</span></span><br><span class="line">tcpdump -nn -A -s 0 <span class="string">&quot;port 3306&quot;</span> | \</span><br><span class="line">grep -E <span class="string">&quot;(SELECT|INSERT|UPDATE|DELETE)&quot;</span> | \</span><br><span class="line">sed <span class="string">&#x27;s/.*\(SELECT\|INSERT\|UPDATE\|DELETE\)/\1/&#x27;</span> | \</span><br><span class="line"><span class="built_in">head</span> -10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Redis å‘½ä»¤åˆ†æ</span></span><br><span class="line">tcpdump -nn -A -s 0 <span class="string">&quot;port 6379&quot;</span> | \</span><br><span class="line">grep -oE <span class="string">&quot;(GET|SET|HGET|HSET|LPUSH|RPOP)[^\\r\\n]*&quot;</span> | \</span><br><span class="line"><span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. DNS æŸ¥è¯¢ç±»å‹ç»Ÿè®¡</span></span><br><span class="line">tcpdump -nn -r capture.pcap <span class="string">&quot;port 53&quot;</span> | \</span><br><span class="line">awk <span class="string">&#x27;/A\?/ &#123;a_queries++&#125; /AAAA\?/ &#123;aaaa_queries++&#125; /MX\?/ &#123;mx_queries++&#125; /CNAME\?/ &#123;cname_queries++&#125; </span></span><br><span class="line"><span class="string">END &#123;</span></span><br><span class="line"><span class="string">    print &quot;A queries:&quot;, a_queries</span></span><br><span class="line"><span class="string">    print &quot;AAAA queries:&quot;, aaaa_queries  </span></span><br><span class="line"><span class="string">    print &quot;MX queries:&quot;, mx_queries</span></span><br><span class="line"><span class="string">    print &quot;CNAME queries:&quot;, cname_queries</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="ç½‘ç»œå®‰å…¨åˆ†æ"><a href="#ç½‘ç»œå®‰å…¨åˆ†æ" class="headerlink" title="ç½‘ç»œå®‰å…¨åˆ†æ"></a>ç½‘ç»œå®‰å…¨åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ç«¯å£æ‰«ææ£€æµ‹</span></span><br><span class="line">tcpdump -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-syn != 0&quot;</span> | \</span><br><span class="line">awk <span class="string">&#x27;&#123;print $3, $5&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br><span class="line"><span class="comment"># å¦‚æœçœ‹åˆ°åŒä¸€æºIPå¯¹å¤šä¸ªç«¯å£å‘èµ·è¿æ¥ï¼Œå¯èƒ½æ˜¯ç«¯å£æ‰«æ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. DDoS æ”»å‡»æ£€æµ‹</span></span><br><span class="line">tcpdump -nn -c 10000 | \</span><br><span class="line">awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="built_in">cut</span> -d. -f1-4 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br><span class="line"><span class="comment"># å¦‚æœæŸä¸ªIPçš„è¯·æ±‚æ•°å¼‚å¸¸é«˜ï¼Œå¯èƒ½æ˜¯æ”»å‡»</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¼‚å¸¸æµé‡æ¨¡å¼æ£€æµ‹</span></span><br><span class="line">tcpdump -nn | \</span><br><span class="line">awk <span class="string">&#x27;length($0) &gt; 200 &#123;long_packets++&#125; </span></span><br><span class="line"><span class="string">     /Flags \[R\]/ &#123;rst_packets++&#125;</span></span><br><span class="line"><span class="string">     /ttl 1/ &#123;suspicious_ttl++&#125;</span></span><br><span class="line"><span class="string">     END &#123;</span></span><br><span class="line"><span class="string">         print &quot;Long packets:&quot;, long_packets</span></span><br><span class="line"><span class="string">         print &quot;RST packets:&quot;, rst_packets</span></span><br><span class="line"><span class="string">         print &quot;Suspicious TTL:&quot;, suspicious_ttl</span></span><br><span class="line"><span class="string">     &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. SSL/TLS ç‰ˆæœ¬åˆ†æ</span></span><br><span class="line">tcpdump -nn -X <span class="string">&quot;port 443&quot;</span> | \</span><br><span class="line">grep -oE <span class="string">&quot;TLS 1\.[0-3]&quot;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“-æ€»ç»“ä¸æå‡å»ºè®®"><a href="#ğŸ“-æ€»ç»“ä¸æå‡å»ºè®®" class="headerlink" title="ğŸ“ æ€»ç»“ä¸æå‡å»ºè®®"></a>ğŸ“ æ€»ç»“ä¸æå‡å»ºè®®</h2><h3 id="ğŸ“š-çŸ¥è¯†ç‚¹æ€»ç»“"><a href="#ğŸ“š-çŸ¥è¯†ç‚¹æ€»ç»“" class="headerlink" title="ğŸ“š çŸ¥è¯†ç‚¹æ€»ç»“"></a>ğŸ“š çŸ¥è¯†ç‚¹æ€»ç»“</h3><h4 id="TCP-çŠ¶æ€æœºç†è§£"><a href="#TCP-çŠ¶æ€æœºç†è§£" class="headerlink" title="TCP çŠ¶æ€æœºç†è§£"></a>TCP çŠ¶æ€æœºç†è§£</h4><ul>
<li><strong>LISTEN</strong>: æœåŠ¡ç«¯ç­‰å¾…è¿æ¥</li>
<li><strong>SYN_SENT</strong>: å®¢æˆ·ç«¯å‘èµ·è¿æ¥ç­‰å¾…å“åº”</li>
<li><strong>SYN_RECEIVED</strong>: æœåŠ¡ç«¯æ”¶åˆ°SYNç­‰å¾…ACK</li>
<li><strong>ESTABLISHED</strong>: è¿æ¥å»ºç«‹ï¼Œæ•°æ®ä¼ è¾“çŠ¶æ€</li>
<li><strong>FIN_WAIT_1&#x2F;2</strong>: ä¸»åŠ¨å…³é—­æ–¹çš„ç­‰å¾…çŠ¶æ€</li>
<li><strong>CLOSE_WAIT</strong>: è¢«åŠ¨å…³é—­æ–¹ç­‰å¾…åº”ç”¨ç¨‹åºå…³é—­</li>
<li><strong>TIME_WAIT</strong>: ä¸»åŠ¨å…³é—­æ–¹çš„æœ€ç»ˆç­‰å¾…çŠ¶æ€</li>
</ul>
<h4 id="è´Ÿè½½å‡è¡¡å™¨è¡Œä¸ºæ¨¡å¼"><a href="#è´Ÿè½½å‡è¡¡å™¨è¡Œä¸ºæ¨¡å¼" class="headerlink" title="è´Ÿè½½å‡è¡¡å™¨è¡Œä¸ºæ¨¡å¼"></a>è´Ÿè½½å‡è¡¡å™¨è¡Œä¸ºæ¨¡å¼</h4><ul>
<li><strong>4å±‚LB</strong>: åŸºäºIP+ç«¯å£è½¬å‘ï¼Œç»´æŒè¿æ¥çŠ¶æ€</li>
<li><strong>7å±‚LB</strong>: è§£æåº”ç”¨åè®®ï¼Œå¯ä»¥è·¯ç”±å’Œä¿®æ”¹å†…å®¹</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>: å®šæœŸæ¢æµ‹åç«¯æœåŠ¡å¯ç”¨æ€§</li>
<li><strong>ä¼šè¯ä¿æŒ</strong>: ç¡®ä¿åŒä¸€ç”¨æˆ·çš„è¯·æ±‚åˆ°è¾¾åŒä¸€åç«¯</li>
</ul>
<h4 id="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"><a href="#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–è¦ç‚¹"></a>æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</h4><ul>
<li><strong>è¿æ¥å¤ç”¨</strong>: å‡å°‘TCPæ¡æ‰‹å¼€é”€</li>
<li><strong>Keep-Alive</strong>: HTTPè¿æ¥ä¿æŒ</li>
<li><strong>å‹ç¼©ä¼ è¾“</strong>: å‡å°‘ç½‘ç»œä¼ è¾“é‡</li>
<li><strong>ç¼“å­˜ç­–ç•¥</strong>: å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚</li>
</ul>
<h3 id="ğŸš€-è¿›é˜¶å­¦ä¹ è·¯å¾„"><a href="#ğŸš€-è¿›é˜¶å­¦ä¹ è·¯å¾„" class="headerlink" title="ğŸš€ è¿›é˜¶å­¦ä¹ è·¯å¾„"></a>ğŸš€ è¿›é˜¶å­¦ä¹ è·¯å¾„</h3><ol>
<li><p><strong>åè®®æ·±å…¥</strong></p>
<ul>
<li>å­¦ä¹  HTTP&#x2F;2, HTTP&#x2F;3 ç‰¹æ€§</li>
<li>ç†è§£ QUIC åè®®ä¼˜åŠ¿</li>
<li>æŒæ¡ WebSocket é•¿è¿æ¥æœºåˆ¶</li>
</ul>
</li>
<li><p><strong>å®¹å™¨ç½‘ç»œ</strong></p>
<ul>
<li>Kubernetes ç½‘ç»œæ¨¡å‹</li>
<li>CNI æ’ä»¶åŸç†</li>
<li>Service Mesh æ¶æ„</li>
</ul>
</li>
<li><p><strong>ç›‘æ§å·¥å…·</strong></p>
<ul>
<li>Wireshark é«˜çº§åŠŸèƒ½</li>
<li>ç½‘ç»œç›‘æ§ç³»ç»Ÿ (Prometheus + Grafana)</li>
<li>APM å·¥å…·é›†æˆ</li>
</ul>
</li>
<li><p><strong>è‡ªåŠ¨åŒ–è¿ç»´</strong></p>
<ul>
<li>ç½‘ç»œé—®é¢˜è‡ªåŠ¨æ£€æµ‹</li>
<li>å‘Šè­¦è§„åˆ™è®¾è®¡</li>
<li>æ•…éšœè‡ªæ„ˆæœºåˆ¶</li>
</ul>
</li>
</ol>
<hr>
<p><strong>æœ€åæ›´æ–°æ—¶é—´:</strong> $(date +%Y-%m-%d)<br><strong>ç‰ˆæœ¬:</strong> v2.0<br><strong>é€‚ç”¨åœºæ™¯:</strong> æœåŠ¡ç«¯å¼€å‘ã€ç½‘ç»œè¿ç»´ã€æ€§èƒ½ä¼˜åŒ–</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/07/31/tcpdump%E6%8A%93%E5%8C%85%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/31/tcpdump%E6%8A%93%E5%8C%85%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">tcpdumpæŠ“åŒ…æŒ‡å—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-31 13:15:53 / ä¿®æ”¹æ—¶é—´ï¼š13:16:22" itemprop="dateCreated datePublished" datetime="2025-07-31T13:15:53+08:00">2025-07-31</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="tcpdump-ç½‘ç»œé—®é¢˜æ’æŸ¥å®Œæ•´æŒ‡å—"><a href="#tcpdump-ç½‘ç»œé—®é¢˜æ’æŸ¥å®Œæ•´æŒ‡å—" class="headerlink" title="tcpdump ç½‘ç»œé—®é¢˜æ’æŸ¥å®Œæ•´æŒ‡å—"></a>tcpdump ç½‘ç»œé—®é¢˜æ’æŸ¥å®Œæ•´æŒ‡å—</h1><h2 id="ğŸ¯-ç›®å½•"><a href="#ğŸ¯-ç›®å½•" class="headerlink" title="ğŸ¯ ç›®å½•"></a>ğŸ¯ ç›®å½•</h2><ul>
<li><a href="#%E6%8A%93%E5%8C%85%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">æŠ“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF">å¸¸è§ç½‘ç»œé—®é¢˜åœºæ™¯</a></li>
<li><a href="#tcpdump-%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3">tcpdump å‘½ä»¤å‚æ•°è¯¦è§£</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E4%B8%8E%E5%91%BD%E4%BB%A4">å®æˆ˜åœºæ™¯ä¸å‘½ä»¤</a></li>
<li><a href="#%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95">ç»“æœåˆ†ææ–¹æ³•</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</a></li>
</ul>
<hr>
<h2 id="æŠ“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#æŠ“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="æŠ“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ"></a>æŠ“åŒ…å‰çš„å‡†å¤‡å·¥ä½œ</h2><h3 id="1-é—®é¢˜å®šä¹‰é˜¶æ®µ"><a href="#1-é—®é¢˜å®šä¹‰é˜¶æ®µ" class="headerlink" title="1. é—®é¢˜å®šä¹‰é˜¶æ®µ"></a>1. é—®é¢˜å®šä¹‰é˜¶æ®µ</h3><p><strong>åœ¨å¼€å§‹æŠ“åŒ…å‰ï¼Œå¿…é¡»æ˜ç¡®ä»¥ä¸‹é—®é¢˜ï¼š</strong></p>
<ul>
<li>ğŸ” <strong>å…·ä½“ç°è±¡</strong>ï¼šè¿æ¥è¶…æ—¶ï¼Ÿå“åº”æ…¢ï¼Ÿæ•°æ®åŒ…ä¸¢å¤±ï¼Ÿ</li>
<li>ğŸ“ <strong>é—®é¢˜èŒƒå›´</strong>ï¼šå®¢æˆ·ç«¯ï¼ŸæœåŠ¡ç«¯ï¼Ÿä¸­é—´ç½‘ç»œè®¾å¤‡ï¼Ÿ</li>
<li>â° <strong>å‘ç”Ÿæ—¶é—´</strong>ï¼šæŒç»­å‘ç”Ÿï¼Ÿé—´æ­‡æ€§ï¼Ÿç‰¹å®šæ—¶é—´æ®µï¼Ÿ</li>
<li>ğŸŒ <strong>ç½‘ç»œæ‹“æ‰‘</strong>ï¼šäº†è§£æ•°æ®åŒ…çš„å®Œæ•´ä¼ è¾“è·¯å¾„</li>
<li>ğŸ“Š <strong>åŸºçº¿æ•°æ®</strong>ï¼šæ­£å¸¸æƒ…å†µä¸‹çš„ç½‘ç»œè¡¨ç°å¦‚ä½•ï¼Ÿ</li>
</ul>
<h3 id="2-ç¯å¢ƒä¿¡æ¯æ”¶é›†"><a href="#2-ç¯å¢ƒä¿¡æ¯æ”¶é›†" class="headerlink" title="2. ç¯å¢ƒä¿¡æ¯æ”¶é›†"></a>2. ç¯å¢ƒä¿¡æ¯æ”¶é›†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ç½‘ç»œæ¥å£</span></span><br><span class="line">ip addr show</span><br><span class="line">ifconfig -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥è·¯ç”±è¡¨</span></span><br><span class="line">ip route show</span><br><span class="line">route -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€</span></span><br><span class="line">ss -tuln</span><br><span class="line">netstat -tuln</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç³»ç»Ÿèµ„æº</span></span><br><span class="line">free -h</span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>

<h3 id="3-æƒé™å’Œå·¥å…·å‡†å¤‡"><a href="#3-æƒé™å’Œå·¥å…·å‡†å¤‡" class="headerlink" title="3. æƒé™å’Œå·¥å…·å‡†å¤‡"></a>3. æƒé™å’Œå·¥å…·å‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®ä¿æœ‰è¶³å¤Ÿæƒé™</span></span><br><span class="line"><span class="built_in">sudo</span> -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ tcpdump ç‰ˆæœ¬</span></span><br><span class="line">tcpdump --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆæŠ“åŒ…æ–‡ä»¶å¯èƒ½å¾ˆå¤§ï¼‰</span></span><br><span class="line"><span class="built_in">df</span> -h /tmp</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å¸¸è§ç½‘ç»œé—®é¢˜åœºæ™¯"><a href="#å¸¸è§ç½‘ç»œé—®é¢˜åœºæ™¯" class="headerlink" title="å¸¸è§ç½‘ç»œé—®é¢˜åœºæ™¯"></a>å¸¸è§ç½‘ç»œé—®é¢˜åœºæ™¯</h2><h3 id="ğŸš¨-åœºæ™¯åˆ†ç±»è¡¨"><a href="#ğŸš¨-åœºæ™¯åˆ†ç±»è¡¨" class="headerlink" title="ğŸš¨ åœºæ™¯åˆ†ç±»è¡¨"></a>ğŸš¨ åœºæ™¯åˆ†ç±»è¡¨</h3><table>
<thead>
<tr>
<th>åœºæ™¯ç±»å‹</th>
<th>å…¸å‹é—®é¢˜</th>
<th>å…³æ³¨é‡ç‚¹</th>
<th>é¢„æœŸç»“æœ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¿æ¥å»ºç«‹é—®é¢˜</strong></td>
<td>è¿æ¥è¶…æ—¶ã€æ‹’ç»è¿æ¥</td>
<td>TCP ä¸‰æ¬¡æ¡æ‰‹</td>
<td>SYN, SYN-ACK, ACK</td>
</tr>
<tr>
<td><strong>æ€§èƒ½é—®é¢˜</strong></td>
<td>å“åº”æ…¢ã€ååé‡ä½</td>
<td>å»¶è¿Ÿã€é‡ä¼ ã€çª—å£å¤§å°</td>
<td>RTT, é‡ä¼ ç‡</td>
</tr>
<tr>
<td><strong>DNS è§£æé—®é¢˜</strong></td>
<td>åŸŸåæ— æ³•è§£æ</td>
<td>DNS æŸ¥è¯¢å’Œå“åº”</td>
<td>Query&#x2F;Response åŒ¹é…</td>
</tr>
<tr>
<td><strong>HTTP&#x2F;HTTPS é—®é¢˜</strong></td>
<td>4xx&#x2F;5xx é”™è¯¯ã€SSL æ¡æ‰‹å¤±è´¥</td>
<td>åº”ç”¨å±‚åè®®</td>
<td>HTTP çŠ¶æ€ç ã€TLS æ¡æ‰‹</td>
</tr>
<tr>
<td><strong>é˜²ç«å¢™&#x2F;å®‰å…¨é—®é¢˜</strong></td>
<td>åŒ…è¢«ä¸¢å¼ƒã€ç«¯å£ä¸é€š</td>
<td>ICMP æ¶ˆæ¯ã€RST åŒ…</td>
<td>æ‹’ç»åŸå› åˆ†æ</td>
</tr>
<tr>
<td><strong>è´Ÿè½½å‡è¡¡é—®é¢˜</strong></td>
<td>è¯·æ±‚åˆ†å¸ƒä¸å‡ã€å¥åº·æ£€æŸ¥å¤±è´¥</td>
<td>å¤šç›®æ ‡æµé‡åˆ†æ</td>
<td>è´Ÿè½½åˆ†å¸ƒæ¨¡å¼</td>
</tr>
</tbody></table>
<hr>
<h2 id="tcpdump-å‘½ä»¤å‚æ•°è¯¦è§£"><a href="#tcpdump-å‘½ä»¤å‚æ•°è¯¦è§£" class="headerlink" title="tcpdump å‘½ä»¤å‚æ•°è¯¦è§£"></a>tcpdump å‘½ä»¤å‚æ•°è¯¦è§£</h2><h3 id="åŸºç¡€è¯­æ³•"><a href="#åŸºç¡€è¯­æ³•" class="headerlink" title="åŸºç¡€è¯­æ³•"></a>åŸºç¡€è¯­æ³•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump [é€‰é¡¹] [è¿‡æ»¤è¡¨è¾¾å¼]</span><br></pre></td></tr></table></figure>

<h3 id="æ ¸å¿ƒå‚æ•°"><a href="#æ ¸å¿ƒå‚æ•°" class="headerlink" title="æ ¸å¿ƒå‚æ•°"></a>æ ¸å¿ƒå‚æ•°</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>ä½œç”¨</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>-i</code></td>
<td>æŒ‡å®šç½‘ç»œæ¥å£</td>
<td><code>-i eth0</code>, <code>-i any</code></td>
</tr>
<tr>
<td><code>-w</code></td>
<td>å†™å…¥æ–‡ä»¶</td>
<td><code>-w capture.pcap</code></td>
</tr>
<tr>
<td><code>-r</code></td>
<td>è¯»å–æ–‡ä»¶</td>
<td><code>-r capture.pcap</code></td>
</tr>
<tr>
<td><code>-c</code></td>
<td>æ•è·åŒ…æ•°é‡</td>
<td><code>-c 1000</code></td>
</tr>
<tr>
<td><code>-n</code></td>
<td>ä¸è§£æä¸»æœºå</td>
<td><code>-n</code></td>
</tr>
<tr>
<td><code>-nn</code></td>
<td>ä¸è§£æä¸»æœºåå’Œç«¯å£å</td>
<td><code>-nn</code></td>
</tr>
<tr>
<td><code>-v/-vv/-vvv</code></td>
<td>è¯¦ç»†ç¨‹åº¦</td>
<td><code>-vv</code></td>
</tr>
<tr>
<td><code>-s</code></td>
<td>æ¯ä¸ªåŒ…çš„æ•è·é•¿åº¦</td>
<td><code>-s 65535</code> (å®Œæ•´åŒ…)</td>
</tr>
<tr>
<td><code>-X</code></td>
<td>åå…­è¿›åˆ¶å’ŒASCIIæ˜¾ç¤º</td>
<td><code>-X</code></td>
</tr>
<tr>
<td><code>-A</code></td>
<td>ASCII æ˜¾ç¤º</td>
<td><code>-A</code></td>
</tr>
<tr>
<td><code>-t</code></td>
<td>ä¸æ˜¾ç¤ºæ—¶é—´æˆ³</td>
<td><code>-t</code></td>
</tr>
<tr>
<td><code>-tt</code></td>
<td>æ˜¾ç¤ºç²¾ç¡®æ—¶é—´æˆ³</td>
<td><code>-tt</code></td>
</tr>
</tbody></table>
<h3 id="è¿‡æ»¤è¡¨è¾¾å¼"><a href="#è¿‡æ»¤è¡¨è¾¾å¼" class="headerlink" title="è¿‡æ»¤è¡¨è¾¾å¼"></a>è¿‡æ»¤è¡¨è¾¾å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»æœºè¿‡æ»¤</span></span><br><span class="line">host 192.168.1.100</span><br><span class="line">src host 192.168.1.100</span><br><span class="line">dst host 192.168.1.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«¯å£è¿‡æ»¤</span></span><br><span class="line">port 80</span><br><span class="line">src port 8080</span><br><span class="line">dst port 443</span><br><span class="line">portrange 8000-8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># åè®®è¿‡æ»¤</span></span><br><span class="line">tcp</span><br><span class="line">udp</span><br><span class="line">icmp</span><br><span class="line">arp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç»œè¿‡æ»¤</span></span><br><span class="line">net 192.168.1.0/24</span><br><span class="line">src net 10.0.0.0/8</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€»è¾‘æ“ä½œç¬¦</span></span><br><span class="line">and, or, not</span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼štcp and port 80 and host 192.168.1.100</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å®æˆ˜åœºæ™¯ä¸å‘½ä»¤"><a href="#å®æˆ˜åœºæ™¯ä¸å‘½ä»¤" class="headerlink" title="å®æˆ˜åœºæ™¯ä¸å‘½ä»¤"></a>å®æˆ˜åœºæ™¯ä¸å‘½ä»¤</h2><h3 id="åœºæ™¯1ï¼šTCP-è¿æ¥é—®é¢˜æ’æŸ¥"><a href="#åœºæ™¯1ï¼šTCP-è¿æ¥é—®é¢˜æ’æŸ¥" class="headerlink" title="åœºæ™¯1ï¼šTCP è¿æ¥é—®é¢˜æ’æŸ¥"></a>åœºæ™¯1ï¼šTCP è¿æ¥é—®é¢˜æ’æŸ¥</h3><h4 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><p>åº”ç”¨è¿æ¥æ•°æ®åº“è¶…æ—¶ï¼Œéœ€è¦ç¡®è®¤æ˜¯ç½‘ç»œé—®é¢˜è¿˜æ˜¯åº”ç”¨é—®é¢˜ã€‚</p>
<h4 id="å®šä½æ€è·¯"><a href="#å®šä½æ€è·¯" class="headerlink" title="å®šä½æ€è·¯"></a>å®šä½æ€è·¯</h4><ol>
<li>ç¡®è®¤ TCP ä¸‰æ¬¡æ¡æ‰‹æ˜¯å¦æ­£å¸¸</li>
<li>æ£€æŸ¥æ˜¯å¦æœ‰ RST åŒ…</li>
<li>åˆ†æè¿æ¥å»ºç«‹æ—¶é—´</li>
</ol>
<h4 id="æŠ“åŒ…å‘½ä»¤"><a href="#æŠ“åŒ…å‘½ä»¤" class="headerlink" title="æŠ“åŒ…å‘½ä»¤"></a>æŠ“åŒ…å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ“å–ç‰¹å®šä¸»æœºå’Œç«¯å£çš„ TCP è¿æ¥</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv -s 65535 \</span><br><span class="line">  -w tcp_connection_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;host 192.168.1.100 and port 3306 and tcp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®æ—¶æŸ¥çœ‹ TCP æ¡æ‰‹è¿‡ç¨‹</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv <span class="string">&quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åªçœ‹ SYN åŒ…</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn <span class="string">&quot;tcp[tcpflags] &amp; tcp-syn != 0&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="ç»“æœåˆ†æ"><a href="#ç»“æœåˆ†æ" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å¸¸çš„ TCP æ¡æ‰‹åº”è¯¥çœ‹åˆ°ï¼š</span></span><br><span class="line"><span class="comment"># 1. Client -&gt; Server: SYN</span></span><br><span class="line"><span class="comment"># 2. Server -&gt; Client: SYN, ACK  </span></span><br><span class="line"><span class="comment"># 3. Client -&gt; Server: ACK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼‚å¸¸æƒ…å†µï¼š</span></span><br><span class="line"><span class="comment"># - åªæœ‰ SYNï¼Œæ²¡æœ‰ SYN-ACKï¼šæœåŠ¡ç«¯æœªå“åº”</span></span><br><span class="line"><span class="comment"># - SYN-ACK åæœ‰ RSTï¼šè¿æ¥è¢«é‡ç½®</span></span><br><span class="line"><span class="comment"># - é‡å¤çš„ SYNï¼šç½‘ç»œå»¶è¿Ÿæˆ–ä¸¢åŒ…</span></span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯2ï¼šHTTP-HTTPS-é—®é¢˜æ’æŸ¥"><a href="#åœºæ™¯2ï¼šHTTP-HTTPS-é—®é¢˜æ’æŸ¥" class="headerlink" title="åœºæ™¯2ï¼šHTTP&#x2F;HTTPS é—®é¢˜æ’æŸ¥"></a>åœºæ™¯2ï¼šHTTP&#x2F;HTTPS é—®é¢˜æ’æŸ¥</h3><h4 id="é—®é¢˜æè¿°-1"><a href="#é—®é¢˜æè¿°-1" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><p>Web åº”ç”¨å“åº”æ…¢ï¼Œç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½æ—¶é—´é•¿ã€‚</p>
<h4 id="å®šä½æ€è·¯-1"><a href="#å®šä½æ€è·¯-1" class="headerlink" title="å®šä½æ€è·¯"></a>å®šä½æ€è·¯</h4><ol>
<li>åˆ†æ HTTP è¯·æ±‚å’Œå“åº”æ—¶é—´</li>
<li>æ£€æŸ¥ HTTP çŠ¶æ€ç </li>
<li>åˆ†æ SSL&#x2F;TLS æ¡æ‰‹æ—¶é—´</li>
</ol>
<h4 id="æŠ“åŒ…å‘½ä»¤-1"><a href="#æŠ“åŒ…å‘½ä»¤-1" class="headerlink" title="æŠ“åŒ…å‘½ä»¤"></a>æŠ“åŒ…å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ“å– HTTP æµé‡</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -A -s 65535 \</span><br><span class="line">  -w http_debug_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;port 80 or port 8080&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å– HTTPS æµé‡ï¼ˆåŒ…å« TLS æ¡æ‰‹ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv -s 65535 \</span><br><span class="line">  -w https_debug_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;port 443&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®æ—¶æŸ¥çœ‹ HTTP è¯·æ±‚</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -A <span class="string">&quot;port 80 and tcp and host 192.168.1.100&quot;</span> \</span><br><span class="line">  | grep -E <span class="string">&quot;(GET|POST|PUT|DELETE|HTTP)&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="ç»“æœåˆ†æ-1"><a href="#ç»“æœåˆ†æ-1" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HTTP è¯·æ±‚åˆ†æè¦ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"># 1. è¯·æ±‚æ–¹æ³•å’Œ URL</span></span><br><span class="line"><span class="comment"># 2. User-Agent å’Œå…¶ä»–å¤´ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># 3. å“åº”çŠ¶æ€ç ï¼ˆ200, 404, 500 ç­‰ï¼‰</span></span><br><span class="line"><span class="comment"># 4. Content-Length å’Œä¼ è¾“æ—¶é—´</span></span><br><span class="line"><span class="comment"># 5. Keep-Alive è¿æ¥å¤ç”¨æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTPS åˆ†æè¦ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"># 1. TLS æ¡æ‰‹æ—¶é—´</span></span><br><span class="line"><span class="comment"># 2. è¯ä¹¦äº¤æ¢è¿‡ç¨‹</span></span><br><span class="line"><span class="comment"># 3. åŠ å¯†åçš„æ•°æ®ä¼ è¾“é‡</span></span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯3ï¼šDNS-è§£æé—®é¢˜"><a href="#åœºæ™¯3ï¼šDNS-è§£æé—®é¢˜" class="headerlink" title="åœºæ™¯3ï¼šDNS è§£æé—®é¢˜"></a>åœºæ™¯3ï¼šDNS è§£æé—®é¢˜</h3><h4 id="é—®é¢˜æè¿°-2"><a href="#é—®é¢˜æè¿°-2" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><p>åŸŸåè§£æå¤±è´¥æˆ–è§£ææ…¢ï¼Œå½±å“åº”ç”¨å¯åŠ¨ã€‚</p>
<h4 id="å®šä½æ€è·¯-2"><a href="#å®šä½æ€è·¯-2" class="headerlink" title="å®šä½æ€è·¯"></a>å®šä½æ€è·¯</h4><ol>
<li>æ•è· DNS æŸ¥è¯¢å’Œå“åº”</li>
<li>åˆ†æè§£ææ—¶é—´</li>
<li>æ£€æŸ¥ DNS æœåŠ¡å™¨å“åº”</li>
</ol>
<h4 id="æŠ“åŒ…å‘½ä»¤-2"><a href="#æŠ“åŒ…å‘½ä»¤-2" class="headerlink" title="æŠ“åŒ…å‘½ä»¤"></a>æŠ“åŒ…å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ“å– DNS æŸ¥è¯¢</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv -s 65535 \</span><br><span class="line">  -w dns_debug_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;port 53&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®æ—¶æŸ¥çœ‹ DNS æŸ¥è¯¢</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn <span class="string">&quot;port 53&quot;</span> | \</span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;[<span class="subst">$(date &#x27;+%H:%M:%S&#x27;)</span>] <span class="variable">$line</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å–ç‰¹å®šåŸŸåçš„ DNS æŸ¥è¯¢</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv <span class="string">&quot;port 53 and host 8.8.8.8&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="ç»“æœåˆ†æ-2"><a href="#ç»“æœåˆ†æ-2" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DNS åˆ†æè¦ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"># 1. æŸ¥è¯¢ç±»å‹ï¼ˆA, AAAA, CNAME, MX ç­‰ï¼‰</span></span><br><span class="line"><span class="comment"># 2. æŸ¥è¯¢åŸŸåå’Œå“åº” IP</span></span><br><span class="line"><span class="comment"># 3. å“åº”æ—¶é—´ï¼ˆQuery -&gt; Response é—´éš”ï¼‰</span></span><br><span class="line"><span class="comment"># 4. DNS æœåŠ¡å™¨æ˜¯å¦å“åº”</span></span><br><span class="line"><span class="comment"># 5. NXDOMAIN é”™è¯¯ï¼ˆåŸŸåä¸å­˜åœ¨ï¼‰</span></span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯4ï¼šç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åˆ†æ"><a href="#åœºæ™¯4ï¼šç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åˆ†æ" class="headerlink" title="åœºæ™¯4ï¼šç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åˆ†æ"></a>åœºæ™¯4ï¼šç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åˆ†æ</h3><h4 id="é—®é¢˜æè¿°-3"><a href="#é—®é¢˜æè¿°-3" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><p>ç½‘ç»œä¼ è¾“æ…¢ï¼Œæ€€ç–‘æœ‰ä¸¢åŒ…æˆ–é«˜å»¶è¿Ÿã€‚</p>
<h4 id="å®šä½æ€è·¯-3"><a href="#å®šä½æ€è·¯-3" class="headerlink" title="å®šä½æ€è·¯"></a>å®šä½æ€è·¯</h4><ol>
<li>åˆ†æ RTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰</li>
<li>æ£€æµ‹é‡ä¼ åŒ…</li>
<li>åˆ†æ TCP çª—å£å¤§å°</li>
</ol>
<h4 id="æŠ“åŒ…å‘½ä»¤-3"><a href="#æŠ“åŒ…å‘½ä»¤-3" class="headerlink" title="æŠ“åŒ…å‘½ä»¤"></a>æŠ“åŒ…å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ“å– ICMP ping åŒ…åˆ†æå»¶è¿Ÿ</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv \</span><br><span class="line">  -w ping_analysis_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;icmp and host 192.168.1.100&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å– TCP é‡ä¼ åŒ…</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv \</span><br><span class="line">  <span class="string">&quot;tcp and host 192.168.1.100&quot;</span> | \</span><br><span class="line">  grep -E <span class="string">&quot;(retransmission|duplicate)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å–æ‰€æœ‰æµé‡åˆ†æçª—å£å¤§å°</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv -s 96 \</span><br><span class="line">  -w network_performance_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap \</span><br><span class="line">  <span class="string">&quot;tcp and host 192.168.1.100&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="ç»“æœåˆ†æ-3"><a href="#ç»“æœåˆ†æ-3" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å»¶è¿Ÿåˆ†æï¼š</span></span><br><span class="line"><span class="comment"># 1. ICMP ping çš„å¾€è¿”æ—¶é—´</span></span><br><span class="line"><span class="comment"># 2. TCP SYN -&gt; SYN-ACK çš„æ—¶é—´é—´éš”</span></span><br><span class="line"><span class="comment"># 3. HTTP è¯·æ±‚ -&gt; å“åº”çš„æ—¶é—´é—´éš”</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸¢åŒ…åˆ†æï¼š</span></span><br><span class="line"><span class="comment"># 1. é‡å¤çš„ ACK åŒ…</span></span><br><span class="line"><span class="comment"># 2. TCP é‡ä¼ </span></span><br><span class="line"><span class="comment"># 3. çª—å£å¤§å°å˜åŒ–</span></span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯5ï¼šå®¹å™¨ç½‘ç»œé—®é¢˜"><a href="#åœºæ™¯5ï¼šå®¹å™¨ç½‘ç»œé—®é¢˜" class="headerlink" title="åœºæ™¯5ï¼šå®¹å™¨ç½‘ç»œé—®é¢˜"></a>åœºæ™¯5ï¼šå®¹å™¨ç½‘ç»œé—®é¢˜</h3><h4 id="é—®é¢˜æè¿°-4"><a href="#é—®é¢˜æè¿°-4" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><p>Kubernetes é›†ç¾¤ä¸­ Pod é—´é€šä¿¡å¼‚å¸¸ã€‚</p>
<h4 id="å®šä½æ€è·¯-4"><a href="#å®šä½æ€è·¯-4" class="headerlink" title="å®šä½æ€è·¯"></a>å®šä½æ€è·¯</h4><ol>
<li>åœ¨ä¸åŒç½‘ç»œå±‚é¢æŠ“åŒ…</li>
<li>åˆ†æå®¹å™¨ç½‘ç»œæ¥å£</li>
<li>æ£€æŸ¥ iptables è§„åˆ™å½±å“</li>
</ol>
<h4 id="æŠ“åŒ…å‘½ä»¤-4"><a href="#æŠ“åŒ…å‘½ä»¤-4" class="headerlink" title="æŠ“åŒ…å‘½ä»¤"></a>æŠ“åŒ…å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å®¿ä¸»æœºæŠ“å–æ‰€æœ‰å®¹å™¨æµé‡</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i docker0 -nn -vv \</span><br><span class="line">  -w container_network_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å–ç‰¹å®š Pod IP çš„æµé‡</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv \</span><br><span class="line">  <span class="string">&quot;host 10.244.1.100&quot;</span> \</span><br><span class="line">  -w pod_communication_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å®¹å™¨å†…æŠ“åŒ…</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod-name -c container-name -- \</span><br><span class="line">  tcpdump -i eth0 -nn -vv -w - &gt; container_internal.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ“å– CNI ç½‘ç»œæ¥å£æµé‡</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i cni0 -nn -vv \</span><br><span class="line">  -w cni_traffic_$(<span class="built_in">date</span> +%Y%m%d_%H%M%S).pcap</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ç»“æœåˆ†ææ–¹æ³•"><a href="#ç»“æœåˆ†ææ–¹æ³•" class="headerlink" title="ç»“æœåˆ†ææ–¹æ³•"></a>ç»“æœåˆ†ææ–¹æ³•</h2><h3 id="1-ä½¿ç”¨-Wireshark-å›¾å½¢åŒ–åˆ†æ"><a href="#1-ä½¿ç”¨-Wireshark-å›¾å½¢åŒ–åˆ†æ" class="headerlink" title="1. ä½¿ç”¨ Wireshark å›¾å½¢åŒ–åˆ†æ"></a>1. ä½¿ç”¨ Wireshark å›¾å½¢åŒ–åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† pcap æ–‡ä»¶å¯¼å…¥ Wireshark</span></span><br><span class="line">wireshark capture.pcap</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸ç”¨ Wireshark è¿‡æ»¤å™¨</span></span><br><span class="line">tcp.analysis.flags</span><br><span class="line">http.response.code != 200</span><br><span class="line">dns.flags.response == 0</span><br><span class="line">tcp.analysis.retransmission</span><br></pre></td></tr></table></figure>

<h3 id="2-å‘½ä»¤è¡Œå¿«é€Ÿåˆ†æ"><a href="#2-å‘½ä»¤è¡Œå¿«é€Ÿåˆ†æ" class="headerlink" title="2. å‘½ä»¤è¡Œå¿«é€Ÿåˆ†æ"></a>2. å‘½ä»¤è¡Œå¿«é€Ÿåˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»Ÿè®¡åè®®åˆ†å¸ƒ</span></span><br><span class="line">tcpdump -r capture.pcap -nn | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡ç›®æ ‡ IP</span></span><br><span class="line">tcpdump -r capture.pcap -nn | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> | <span class="built_in">cut</span> -d: -f1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾ç‰¹å®šé”™è¯¯</span></span><br><span class="line">tcpdump -r capture.pcap -nn -A | grep -i <span class="string">&quot;error\|timeout\|refused&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æè¿æ¥æ—¶é—´</span></span><br><span class="line">tcpdump -r capture.pcap -nn -tt | grep -E <span class="string">&quot;SYN|ACK&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-æ•°æ®åŒ…åˆ†ææ¸…å•"><a href="#3-æ•°æ®åŒ…åˆ†ææ¸…å•" class="headerlink" title="3. æ•°æ®åŒ…åˆ†ææ¸…å•"></a>3. æ•°æ®åŒ…åˆ†ææ¸…å•</h3><h4 id="TCP-è¿æ¥åˆ†æ"><a href="#TCP-è¿æ¥åˆ†æ" class="headerlink" title="TCP è¿æ¥åˆ†æ"></a>TCP è¿æ¥åˆ†æ</h4><ul>
<li><input disabled="" type="checkbox"> SYN, SYN-ACK, ACK ä¸‰æ¬¡æ¡æ‰‹å®Œæ•´</li>
<li><input disabled="" type="checkbox"> åºåˆ—å·å’Œç¡®è®¤å·æ­£ç¡®é€’å¢</li>
<li><input disabled="" type="checkbox"> æ— å¼‚å¸¸ RST åŒ…</li>
<li><input disabled="" type="checkbox"> çª—å£å¤§å°åˆç†</li>
<li><input disabled="" type="checkbox"> æ— é¢‘ç¹é‡ä¼ </li>
</ul>
<h4 id="HTTP-åˆ†æ"><a href="#HTTP-åˆ†æ" class="headerlink" title="HTTP åˆ†æ"></a>HTTP åˆ†æ</h4><ul>
<li><input disabled="" type="checkbox"> è¯·æ±‚æ–¹æ³•å’Œ URL æ­£ç¡®</li>
<li><input disabled="" type="checkbox"> HTTP çŠ¶æ€ç ç¬¦åˆé¢„æœŸ</li>
<li><input disabled="" type="checkbox"> å“åº”æ—¶é—´åœ¨åˆç†èŒƒå›´</li>
<li><input disabled="" type="checkbox"> Content-Length ä¸å®é™…å†…å®¹åŒ¹é…</li>
<li><input disabled="" type="checkbox"> æ— å¼‚å¸¸é‡å®šå‘</li>
</ul>
<h4 id="DNS-åˆ†æ"><a href="#DNS-åˆ†æ" class="headerlink" title="DNS åˆ†æ"></a>DNS åˆ†æ</h4><ul>
<li><input disabled="" type="checkbox"> æŸ¥è¯¢å’Œå“åº”é…å¯¹æ­£ç¡®</li>
<li><input disabled="" type="checkbox"> å“åº”æ—¶é—´ &lt; 100ms</li>
<li><input disabled="" type="checkbox"> æ—  NXDOMAIN é”™è¯¯</li>
<li><input disabled="" type="checkbox"> DNS æœåŠ¡å™¨å¯è¾¾</li>
</ul>
<hr>
<h2 id="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"><a href="#æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"></a>æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h2><h3 id="âœ…-æœ€ä½³å®è·µ"><a href="#âœ…-æœ€ä½³å®è·µ" class="headerlink" title="âœ… æœ€ä½³å®è·µ"></a>âœ… æœ€ä½³å®è·µ</h3><h4 id="1-æŠ“åŒ…ç­–ç•¥"><a href="#1-æŠ“åŒ…ç­–ç•¥" class="headerlink" title="1. æŠ“åŒ…ç­–ç•¥"></a>1. æŠ“åŒ…ç­–ç•¥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å§‹ç»ˆä½¿ç”¨æ—¶é—´æˆ³å’Œè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -vv -tt -s 65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤§æµé‡ç¯å¢ƒä¸‹é™åˆ¶æŠ“åŒ…å¤§å°</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -c 10000 -s 128</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è½®è½¬æ–‡ä»¶é¿å…å•æ–‡ä»¶è¿‡å¤§</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -w capture.pcap -C 100 -W 5</span><br></pre></td></tr></table></figure>

<h4 id="2-è¿‡æ»¤å™¨ä¼˜åŒ–"><a href="#2-è¿‡æ»¤å™¨ä¼˜åŒ–" class="headerlink" title="2. è¿‡æ»¤å™¨ä¼˜åŒ–"></a>2. è¿‡æ»¤å™¨ä¼˜åŒ–</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç²¾ç¡®è¿‡æ»¤å‡å°‘æ— å…³æµé‡</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn \</span><br><span class="line">  <span class="string">&quot;host 192.168.1.100 and port 80 and tcp[tcpflags] &amp; tcp-syn != 0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ BPF è¿‡æ»¤å™¨æé«˜æ€§èƒ½</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn <span class="string">&quot;tcp and dst port 443&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-æ–‡ä»¶ç®¡ç†"><a href="#3-æ–‡ä»¶ç®¡ç†" class="headerlink" title="3. æ–‡ä»¶ç®¡ç†"></a>3. æ–‡ä»¶ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸“é—¨çš„æŠ“åŒ…ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /tmp/tcpdump/$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"><span class="built_in">cd</span> /tmp/tcpdump/$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æè¿°æ€§æ–‡ä»¶å</span></span><br><span class="line"><span class="built_in">sudo</span> tcpdump -i any -nn -w <span class="string">&quot;<span class="subst">$(hostname)</span>_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>_issue_description.pcap&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h3><h4 id="1-æ€§èƒ½å½±å“"><a href="#1-æ€§èƒ½å½±å“" class="headerlink" title="1. æ€§èƒ½å½±å“"></a>1. æ€§èƒ½å½±å“</h4><ul>
<li>å¤§æµé‡ç¯å¢ƒä¸‹æŠ“åŒ…ä¼šæ¶ˆè€— CPU å’Œå†…å­˜</li>
<li>ä½¿ç”¨é€‚å½“çš„è¿‡æ»¤å™¨å‡å°‘æ•°æ®é‡</li>
<li>ç›‘æ§ç£ç›˜ç©ºé—´ï¼Œé¿å…å†™æ»¡ç³»ç»Ÿç›˜</li>
</ul>
<h4 id="2-å®‰å…¨è€ƒè™‘"><a href="#2-å®‰å…¨è€ƒè™‘" class="headerlink" title="2. å®‰å…¨è€ƒè™‘"></a>2. å®‰å…¨è€ƒè™‘</h4><ul>
<li>æŠ“åŒ…æ–‡ä»¶å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯</li>
<li>åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„æŠ“åŒ…æ–‡ä»¶</li>
<li>åœ¨ç”Ÿäº§ç¯å¢ƒæŠ“åŒ…éœ€è¦é¢å¤–å®¡æ‰¹</li>
</ul>
<h4 id="3-æ³•å¾‹åˆè§„"><a href="#3-æ³•å¾‹åˆè§„" class="headerlink" title="3. æ³•å¾‹åˆè§„"></a>3. æ³•å¾‹åˆè§„</h4><ul>
<li>ç¡®ä¿æœ‰æƒé™æŠ“å–ç½‘ç»œæµé‡</li>
<li>éµå®ˆå…¬å¸ç½‘ç»œç›‘æ§æ”¿ç­–</li>
<li>ä¸è¦æŠ“å–ä»–äººéšç§æ•°æ®</li>
</ul>
<h3 id="ğŸ”§-å¸¸ç”¨è„šæœ¬æ¨¡æ¿"><a href="#ğŸ”§-å¸¸ç”¨è„šæœ¬æ¨¡æ¿" class="headerlink" title="ğŸ”§ å¸¸ç”¨è„šæœ¬æ¨¡æ¿"></a>ğŸ”§ å¸¸ç”¨è„šæœ¬æ¨¡æ¿</h3><h4 id="è‡ªåŠ¨åŒ–æŠ“åŒ…è„šæœ¬"><a href="#è‡ªåŠ¨åŒ–æŠ“åŒ…è„šæœ¬" class="headerlink" title="è‡ªåŠ¨åŒ–æŠ“åŒ…è„šæœ¬"></a>è‡ªåŠ¨åŒ–æŠ“åŒ…è„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># tcpdump_auto.sh</span></span><br><span class="line"></span><br><span class="line">INTERFACE=<span class="variable">$&#123;1:-any&#125;</span></span><br><span class="line">FILTER=<span class="variable">$&#123;2:-&quot;&quot;&#125;</span></span><br><span class="line">DURATION=<span class="variable">$&#123;3:-60&#125;</span></span><br><span class="line">OUTPUT_DIR=<span class="string">&quot;/tmp/tcpdump&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$OUTPUT_DIR</span></span><br><span class="line">FILENAME=<span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/capture_<span class="subst">$(hostname)</span>_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>.pcap&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å¼€å§‹æŠ“åŒ…: <span class="variable">$DURATION</span> ç§’&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ¥å£: <span class="variable">$INTERFACE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¿‡æ»¤å™¨: <span class="variable">$FILTER</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¾“å‡ºæ–‡ä»¶: <span class="variable">$FILENAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">timeout</span> <span class="variable">$DURATION</span> <span class="built_in">sudo</span> tcpdump -i <span class="variable">$INTERFACE</span> -nn -vv -s 65535 -w <span class="variable">$FILENAME</span> <span class="string">&quot;<span class="variable">$FILTER</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æŠ“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°: <span class="subst">$(du -h $FILENAME | cut -f1)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ†æ:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;tcpdump -r <span class="variable">$FILENAME</span> -nn -vv | less&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;wireshark <span class="variable">$FILENAME</span> &amp;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="é—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å•"><a href="#é—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å•" class="headerlink" title="é—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å•"></a>é—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å•</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># network_check.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== ç½‘ç»œé—®é¢˜è¯Šæ–­æ£€æŸ¥æ¸…å• ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. åŸºç¡€è¿é€šæ€§æµ‹è¯•&quot;</span></span><br><span class="line">ping -c 4 <span class="variable">$1</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;âœ… Ping æˆåŠŸ&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;âŒ Ping å¤±è´¥&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. ç«¯å£è¿é€šæ€§æµ‹è¯•&quot;</span>  </span><br><span class="line">nc -zv <span class="variable">$1</span> <span class="variable">$2</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;âœ… ç«¯å£ <span class="variable">$2</span> å¯è¾¾&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;âŒ ç«¯å£ <span class="variable">$2</span> ä¸å¯è¾¾&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. DNS è§£ææµ‹è¯•&quot;</span></span><br><span class="line">nslookup <span class="variable">$1</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;âœ… DNS è§£ææˆåŠŸ&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;âŒ DNS è§£æå¤±è´¥&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. è·¯ç”±è·Ÿè¸ª&quot;</span></span><br><span class="line">traceroute <span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. å¼€å§‹è¯¦ç»†æŠ“åŒ…åˆ†æ...&quot;</span></span><br><span class="line"><span class="comment"># è°ƒç”¨æŠ“åŒ…è„šæœ¬</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“š-æ‰©å±•é˜…è¯»"><a href="#ğŸ“š-æ‰©å±•é˜…è¯»" class="headerlink" title="ğŸ“š æ‰©å±•é˜…è¯»"></a>ğŸ“š æ‰©å±•é˜…è¯»</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.tcpdump.org/manpages/tcpdump.1.html">tcpdump å®˜æ–¹æ–‡æ¡£</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wireshark.org/docs/wsug_html_chunked/">Wireshark ç”¨æˆ·æŒ‡å—</a></li>
<li><a target="_blank" rel="noopener" href="https://tools.ietf.org/rfc/">ç½‘ç»œåè®®æ ˆåˆ†ææ–¹æ³•</a></li>
</ul>
<hr>
<p><strong>æœ€åæ›´æ–°æ—¶é—´ï¼š</strong> $(date +%Y-%m-%d)<br><strong>ç‰ˆæœ¬ï¼š</strong> v1.0<br><strong>ç»´æŠ¤è€…ï¼š</strong> Network Team</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/07/29/SSE-%E4%B8%8E-WebSocket-%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/29/SSE-%E4%B8%8E-WebSocket-%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">SSE ä¸ WebSocket ç¤ºä¾‹é¡¹ç›®</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-29 14:25:59 / ä¿®æ”¹æ—¶é—´ï¼š15:57:51" itemprop="dateCreated datePublished" datetime="2025-07-29T14:25:59+08:00">2025-07-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ¬é¡¹ç›®æ¼”ç¤ºï¼š</p>
<ul>
<li>ä½¿ç”¨ Go æ„å»º SSEï¼ˆServer-Sent Eventsï¼‰æœåŠ¡</li>
<li>ä½¿ç”¨ Go æ„å»º WebSocket æœåŠ¡</li>
<li>å®¢æˆ·ç«¯å¦‚ä½•æ¥æ”¶æ¶ˆæ¯</li>
<li>ä¸ nginx é…ç½®æ•´åˆæµ‹è¯•</li>
</ul>
<hr>
<h2 id="ğŸ§±-é¡¹ç›®ç»“æ„"><a href="#ğŸ§±-é¡¹ç›®ç»“æ„" class="headerlink" title="ğŸ§± é¡¹ç›®ç»“æ„"></a>ğŸ§± é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ client</span><br><span class="line">â”‚  â”œâ”€â”€ sse.go</span><br><span class="line">â”‚  â””â”€â”€ ws.go</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ nginx</span><br><span class="line">â”‚  â””â”€â”€ nginx.conf</span><br><span class="line">â””â”€â”€ server</span><br><span class="line">    â””â”€â”€ main.go</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“˜-SSE-æœåŠ¡ç«¯ï¼ˆæ”¯æŒ-idã€eventï¼‰"><a href="#ğŸ“˜-SSE-æœåŠ¡ç«¯ï¼ˆæ”¯æŒ-idã€eventï¼‰" class="headerlink" title="ğŸ“˜ SSE æœåŠ¡ç«¯ï¼ˆæ”¯æŒ idã€eventï¼‰"></a>ğŸ“˜ SSE æœåŠ¡ç«¯ï¼ˆæ”¯æŒ idã€eventï¼‰</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// æ–‡ä»¶: server/main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> upgrader = websocket.Upgrader&#123;</span><br><span class="line">  CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wsHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  upgrader := websocket.Upgrader&#123;</span><br><span class="line">    CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(<span class="string">&quot;Upgrade failed:&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    msg := fmt.Sprintf(<span class="string">&quot;WebSocket message %d&quot;</span>, i)</span><br><span class="line">    conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(msg))</span><br><span class="line">    time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SSE æœåŠ¡ç«¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sseHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  flusher, ok := w.(http.Flusher)</span><br><span class="line">  <span class="keyword">if</span> !ok &#123;</span><br><span class="line">    http.Error(w, <span class="string">&quot;Streaming unsupported!&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SSE ä½¿ç”¨ text/event-stream ç±»å‹</span></span><br><span class="line">  w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/event-stream&quot;</span>)</span><br><span class="line">  <span class="comment">// ä¸ç¼“å­˜</span></span><br><span class="line">  w.Header().Set(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>)</span><br><span class="line">  <span class="comment">// ä¿æŒè¿æ¥  </span></span><br><span class="line">  w.Header().Set(<span class="string">&quot;Connection&quot;</span>, <span class="string">&quot;keep-alive&quot;</span>)</span><br><span class="line">  w.WriteHeader(http.StatusOK)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;id: %d\n&quot;</span>, i)</span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;event: message\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SSE æ ¼å¼ï¼Œæ¯æ¡ event å¿…é¡»ä»¥ç©ºè¡Œç»“å°¾,data: æ˜¯æ ‡å‡†å‰ç¼€ï¼Œè¡¨ç¤ºæ•°æ®å†…å®¹</span></span><br><span class="line">    fmt.Fprintf(w, <span class="string">&quot;data: SSE message %d\n\n&quot;</span>, i)</span><br><span class="line">    <span class="comment">// å¼ºåˆ¶åˆ·æ–°ï¼Œç«‹å³å‘é€ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">    flusher.Flush()</span><br><span class="line">    time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/sse&quot;</span>, sseHandler)</span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/ws&quot;</span>, wsHandler)</span><br><span class="line">  log.Println(<span class="string">&quot;Listening on :8080...&quot;</span>)</span><br><span class="line">  http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ§ª-SSE-å®¢æˆ·ç«¯ï¼ˆGo-ç¤ºä¾‹ï¼‰"><a href="#ğŸ§ª-SSE-å®¢æˆ·ç«¯ï¼ˆGo-ç¤ºä¾‹ï¼‰" class="headerlink" title="ğŸ§ª SSE å®¢æˆ·ç«¯ï¼ˆGo ç¤ºä¾‹ï¼‰"></a>ğŸ§ª SSE å®¢æˆ·ç«¯ï¼ˆGo ç¤ºä¾‹ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#æ–‡ä»¶client/sse.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;bufio&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  resp, err := http.Get(<span class="string">&quot;http://localhost:8081/sse&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;Client request failed: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  scanner := bufio.NewScanner(resp.Body)</span><br><span class="line">  <span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">    line := scanner.Text()</span><br><span class="line">    <span class="keyword">if</span> strings.HasPrefix(line, <span class="string">&quot;data: &quot;</span>) &#123;</span><br><span class="line">      fmt.Println(<span class="string">&quot;Received:&quot;</span>, strings.TrimPrefix(line, <span class="string">&quot;data: &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ğŸ§ª-Websocket-å®¢æˆ·ç«¯ï¼ˆGo-ç¤ºä¾‹ï¼‰"><a href="#ğŸ§ª-Websocket-å®¢æˆ·ç«¯ï¼ˆGo-ç¤ºä¾‹ï¼‰" class="headerlink" title="ğŸ§ª Websocket å®¢æˆ·ç«¯ï¼ˆGo ç¤ºä¾‹ï¼‰"></a>ğŸ§ª Websocket å®¢æˆ·ç«¯ï¼ˆGo ç¤ºä¾‹ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#æ–‡ä»¶client/ws.go</span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  &quot;log&quot;</span><br><span class="line">  &quot;net/url&quot;</span><br><span class="line">  &quot;os&quot;</span><br><span class="line">  &quot;os/signal&quot;</span><br><span class="line">  &quot;time&quot;</span><br><span class="line"></span><br><span class="line">  &quot;github.com/gorilla/websocket&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  interrupt := make(chan os.Signal, 1)</span><br><span class="line">  signal.Notify(interrupt, os.Interrupt)</span><br><span class="line"></span><br><span class="line">  u := url.URL&#123;Scheme: &quot;ws&quot;, Host: &quot;localhost:8081&quot;, Path: &quot;/ws&quot;&#125;</span><br><span class="line">  log.Printf(&quot;connecting to %s&quot;, u.String())</span><br><span class="line"></span><br><span class="line">  c, _, err := websocket.DefaultDialer.Dial(u.String(), nil)</span><br><span class="line">  if err != nil &#123;</span><br><span class="line">    log.Fatal(&quot;dial error:&quot;, err)</span><br><span class="line">  &#125;</span><br><span class="line">  defer c.Close()</span><br><span class="line"></span><br><span class="line">  done := make(chan struct&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  go func() &#123;</span><br><span class="line">    defer close(done)</span><br><span class="line">    for &#123;</span><br><span class="line">      _, message, err := c.ReadMessage()</span><br><span class="line">      if err != nil &#123;</span><br><span class="line">        log.Println(&quot;read error:&quot;, err)</span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">      log.Printf(&quot;recv: %s&quot;, message)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  // å‘é€ä¸€æ¡æ¶ˆæ¯</span><br><span class="line">  err = c.WriteMessage(websocket.TextMessage, []byte(&quot;hello websocket&quot;))</span><br><span class="line">  if err != nil &#123;</span><br><span class="line">    log.Println(&quot;write error:&quot;, err)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // ç­‰å¾…æˆ–è€…ä¸­æ–­</span><br><span class="line">  select &#123;</span><br><span class="line">  case &lt;-time.After(time.Second * 10):</span><br><span class="line">  case &lt;-interrupt:</span><br><span class="line">    log.Println(&quot;interrupt&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // ä¼˜é›…å…³é—­</span><br><span class="line">  err = c.WriteMessage(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, &quot;&quot;))</span><br><span class="line">  if err != nil &#123;</span><br><span class="line">    log.Println(&quot;close error:&quot;, err)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âš™ï¸-Nginx-é…ç½®ï¼ˆnginx-nginx-confï¼‰"><a href="#âš™ï¸-Nginx-é…ç½®ï¼ˆnginx-nginx-confï¼‰" class="headerlink" title="âš™ï¸ Nginx é…ç½®ï¼ˆnginx&#x2F;nginx.confï¼‰"></a>âš™ï¸ Nginx é…ç½®ï¼ˆnginx&#x2F;nginx.confï¼‰</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#NGINX ä»£ç† WebSocket</span></span><br><span class="line"><span class="comment">#ç¡®ä¿ NGINX é…ç½®äº† proxy_http_version 1.1 å’Œ Upgrade å¤´</span></span><br><span class="line"><span class="comment">#å¦‚æœä½ è¦æ”¯æŒ wss://ï¼Œéœ€è¦é…ç½® TLS è¯ä¹¦æˆ–é€šè¿‡ NGINX termination</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">upstream</span> backend &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">172.17.0.1:8080</span>; //æˆ–è€…ä½¿ç”¨å®¿ä¸»æœºçš„<span class="attribute">ip</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /sse &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend/sse;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">chunked_transfer_encoding</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;   <span class="comment"># &lt;-- å…³é—­ç¼“å†²ï¼Œå¯¹ SSE éå¸¸é‡è¦</span></span><br><span class="line">            <span class="attribute">proxy_cache</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_read_timeout</span> <span class="number">3600s</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /ws &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://backend/ws;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">	    <span class="attribute">proxy_read_timeout</span> <span class="number">3600s</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸš€-å¯åŠ¨æµ‹è¯•"><a href="#ğŸš€-å¯åŠ¨æµ‹è¯•" class="headerlink" title="ğŸš€ å¯åŠ¨æµ‹è¯•"></a>ğŸš€ å¯åŠ¨æµ‹è¯•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#å®¹å™¨å¯åŠ¨nginx</span><br><span class="line">docker run --rm -v $(pwd)/nginx.conf:/etc/nginx/nginx.conf:ro -p 8081:8081 nginx</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ”¬-WebSocket-å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆä½¿ç”¨-wscat-æˆ–æµè§ˆå™¨ï¼‰"><a href="#ğŸ”¬-WebSocket-å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆä½¿ç”¨-wscat-æˆ–æµè§ˆå™¨ï¼‰" class="headerlink" title="ğŸ”¬ WebSocket å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆä½¿ç”¨ wscat æˆ–æµè§ˆå™¨ï¼‰"></a>ğŸ”¬ WebSocket å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆä½¿ç”¨ wscat æˆ–æµè§ˆå™¨ï¼‰</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åœ¨ Linux ä¸Šè¿è¡Œ Docker æ—¶ï¼Œå¦‚æœæœåŠ¡è¿è¡Œåœ¨å®¿ä¸»æœºï¼Œå¯ä»¥è®© NGINX å®¹å™¨é€šè¿‡ å®¿ä¸» IP è®¿é—®æœåŠ¡ã€‚</span></span><br><span class="line"><span class="comment">#ip addr show docker0</span></span><br><span class="line">5: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:06:96:79:9e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:6ff:fe96:799e/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#è®¿é—®æ–¹å¼</span></span><br><span class="line">SSE:</span><br><span class="line">â‘ éä»£ç†</span><br><span class="line">curl http://localhost:8080/sse</span><br><span class="line">â‘¡ä½¿ç”¨ä»£ç†</span><br><span class="line">curl http://localhost:8081/sse</span><br><span class="line"></span><br><span class="line">WebSocket:</span><br><span class="line">â‘ ä½¿ç”¨npmæ’ä»¶wscat</span><br><span class="line"><span class="comment">#npmå®‰è£…åœ°å€ï¼šhttps://nodejs.org/en/download</span></span><br><span class="line"><span class="comment">#å‡çº§ï¼šnpm install -g npm@11.5.1</span></span><br><span class="line">npm install -g wscat</span><br><span class="line"><span class="comment">#æ™®é€šæ˜æ–‡è¿æ¥ï¼ŒæœåŠ¡ç«¯ç›‘å¬çš„æ˜¯ éåŠ å¯† çš„ WebSocket</span></span><br><span class="line">wscat -c ws://localhost:8081/ws</span><br><span class="line"></span><br><span class="line"><span class="comment">#wss://...</span></span><br><span class="line">åŠ å¯†è¿æ¥ï¼ˆTLSï¼‰ï¼Œå®¢æˆ·ç«¯æœŸå¾…æœåŠ¡ç«¯æä¾› æœ‰æ•ˆçš„ HTTPS è¯ä¹¦ å’Œæ”¯æŒ TLS æ¡æ‰‹ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">â‘¡åœ¨çº¿è®¿é—®</span><br><span class="line">https://www.piesocket.com/websocket-tester</span><br><span class="line">chromeæ’ä»¶è¯·æ±‚ï¼šPieSocket WebSocket Tester</span><br><span class="line">ws://10.16.217.194:8080/ws</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h2 id="ğŸ“‘-SSE-ä¸-WebSocket-å¯¹æ¯”"><a href="#ğŸ“‘-SSE-ä¸-WebSocket-å¯¹æ¯”" class="headerlink" title="ğŸ“‘ SSE ä¸ WebSocket å¯¹æ¯”"></a>ğŸ“‘ SSE ä¸ WebSocket å¯¹æ¯”</h2><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>SSE</th>
<th>WebSocket</th>
</tr>
</thead>
<tbody><tr>
<td>åè®®</td>
<td>HTTP å•å‘</td>
<td>TCP åŒå‘</td>
</tr>
<tr>
<td>é€šä¿¡æ–¹å‘</td>
<td>æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯</td>
<td>åŒå‘</td>
</tr>
<tr>
<td>ä½¿ç”¨åœºæ™¯</td>
<td>å®æ—¶æ•°æ®æ¨é€ï¼ˆå¦‚æ—¥å¿—&#x2F;è‚¡ä»·ï¼‰</td>
<td>èŠå¤©å®¤ã€åœ¨çº¿æ¸¸æˆç­‰äº¤äº’åº”ç”¨</td>
</tr>
<tr>
<td>æµè§ˆå™¨æ”¯æŒ</td>
<td>è¾ƒå¥½ï¼ˆä½†ä¸æ”¯æŒ IEï¼‰</td>
<td>å¹¿æ³›æ”¯æŒ</td>
</tr>
<tr>
<td>è¿æ¥æ•°é‡</td>
<td>å¤š tab å…±ç”¨è¿æ¥</td>
<td>æ¯ tab ç‹¬ç«‹è¿æ¥</td>
</tr>
<tr>
<td>ä¸­é—´ä»¶å…¼å®¹æ€§</td>
<td>æ”¯æŒä¼ ç»Ÿä»£ç†ï¼ˆå¦‚ nginxï¼‰</td>
<td>éœ€æ˜¾å¼æ”¯æŒå‡çº§</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> +--------------------+</span><br><span class="line"> |     WebSocket      | &lt;-- åŒå‘ã€é•¿è¿æ¥ã€ä½å»¶è¿Ÿ</span><br><span class="line"> +--------------------+</span><br><span class="line">            â†‘</span><br><span class="line">    å®æ—¶æ€§å¼ºã€äº’åŠ¨æ€§å¼º</span><br><span class="line">            â†“</span><br><span class="line">+---------------------+</span><br><span class="line">|  HTTP Stream / SSE  | &lt;-- å•å‘ã€é•¿è¿æ¥ã€ç®€å•</span><br><span class="line">+---------------------+</span><br><span class="line">            â†‘</span><br><span class="line">   ä»…æœåŠ¡æ¨é€æ•°æ®ã€è½»å®æ—¶</span><br><span class="line">            â†“</span><br><span class="line">   +------------------+</span><br><span class="line">   | HTTP Keep-Alive  | &lt;-- çŸ­è¿æ¥çš„æ”¹è¿›ç‰ˆ</span><br><span class="line">   +------------------+</span><br><span class="line">            â†‘</span><br><span class="line">    å¸¸è§„è¯·æ±‚ï¼Œéå®æ—¶</span><br><span class="line">            â†“</span><br><span class="line">   +------------------+</span><br><span class="line">   |   çŸ­è¿æ¥ï¼ˆHTTPï¼‰ | &lt;-- æœ€åŸå§‹çš„æ–¹å¼</span><br><span class="line">   +------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/07/07/%E5%85%B3%E4%BA%8EFQDN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/07/%E5%85%B3%E4%BA%8EFQDN/" class="post-title-link" itemprop="url">å…³äºFQDN</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-07 15:23:24 / ä¿®æ”¹æ—¶é—´ï¼š15:24:58" itemprop="dateCreated datePublished" datetime="2025-07-07T15:23:24+08:00">2025-07-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿™æ˜¯ä¸ªå¾ˆæœ‰æŠ€æœ¯æ·±åº¦çš„é—®é¢˜ã€‚åœ¨ Kubernetes çš„ç½‘ç»œæ¶æ„ä¸­ï¼Œ<strong>FQDNï¼ˆFully Qualified Domain Nameï¼Œå®Œå…¨é™å®šåŸŸåï¼‰</strong> æ˜¯é›†ç¾¤å†…éƒ¨å’Œå¤–éƒ¨é€šä¿¡ä¸­éå¸¸å…³é”®çš„ä¸€ç¯ã€‚ä½ æåˆ°çš„ <code>FQDN</code> å’Œ <code>RQDN</code>ï¼ˆå¯èƒ½æ˜¯ Relative Qualified Domain Name çš„æ„æ€ï¼Œè§ä¸‹æ–‡ï¼‰æ¦‚å¿µï¼Œéƒ½å¯ä»¥å›´ç»• DNS æ¥ç³»ç»Ÿç†è§£ã€‚</p>
<hr>
<h2 id="âœ…-ä¸€ã€ä»€ä¹ˆæ˜¯-FQDNï¼Ÿ"><a href="#âœ…-ä¸€ã€ä»€ä¹ˆæ˜¯-FQDNï¼Ÿ" class="headerlink" title="âœ… ä¸€ã€ä»€ä¹ˆæ˜¯ FQDNï¼Ÿ"></a>âœ… ä¸€ã€ä»€ä¹ˆæ˜¯ FQDNï¼Ÿ</h2><p><strong>FQDNï¼ˆFully Qualified Domain Nameï¼‰</strong> æ˜¯æŒ‡ä¸€ä¸ªå®Œå…¨çš„ã€ç»å¯¹çš„ DNS åå­—ï¼Œå®ƒ<strong>ä»ä¸»æœºåå¼€å§‹ï¼Œä¸€ç›´åˆ°æ ¹åŸŸï¼ˆ<code>.</code>ï¼‰ç»“æŸ</strong>ã€‚</p>
<h3 id="ğŸ”¹-ä¸¾ä¾‹ï¼š"><a href="#ğŸ”¹-ä¸¾ä¾‹ï¼š" class="headerlink" title="ğŸ”¹ ä¸¾ä¾‹ï¼š"></a>ğŸ”¹ ä¸¾ä¾‹ï¼š</h3><table>
<thead>
<tr>
<th>åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>my-service.default.svc.cluster.local.</code></td>
<td>âœ… FQDNï¼Œåœ¨ K8s ä¸­å®Œæ•´çš„ service è§£æåŸŸå</td>
</tr>
<tr>
<td><code>my-service.default.svc.cluster.local</code></td>
<td>âœ… å‡ ä¹ç­‰ä»·ï¼ˆæ ¹ <code>.</code> å¯çœç•¥ï¼‰</td>
</tr>
<tr>
<td><code>my-service</code></td>
<td>âŒ ä¸æ˜¯ FQDNï¼Œå±äºç›¸å¯¹åŸŸåï¼ˆå¯è§£æä¾èµ– search åŸŸï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="âœ…-äºŒã€Kubernetes-ä¸­çš„-FQDN-ä½¿ç”¨åœºæ™¯"><a href="#âœ…-äºŒã€Kubernetes-ä¸­çš„-FQDN-ä½¿ç”¨åœºæ™¯" class="headerlink" title="âœ… äºŒã€Kubernetes ä¸­çš„ FQDN ä½¿ç”¨åœºæ™¯"></a>âœ… äºŒã€Kubernetes ä¸­çš„ FQDN ä½¿ç”¨åœºæ™¯</h2><p>åœ¨ Kubernetes å†…éƒ¨ï¼Œæ‰€æœ‰æœåŠ¡ã€Pod éƒ½å¯ä»¥é€šè¿‡ DNS åç§°è®¿é—®ï¼Œè€Œ <strong>KubeDNS&#x2F;CoreDNS</strong> æŒ‰å¦‚ä¸‹è§„åˆ™æ‹¼æ¥åŸŸåï¼š</p>
<h3 id="ğŸš€-Service-é»˜è®¤-FQDNï¼š"><a href="#ğŸš€-Service-é»˜è®¤-FQDNï¼š" class="headerlink" title="ğŸš€ Service é»˜è®¤ FQDNï¼š"></a>ğŸš€ Service é»˜è®¤ FQDNï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>svc.cluster.local</code> æ˜¯ service çš„é»˜è®¤ DNS åŸŸååç¼€ï¼Œå®šä¹‰åœ¨ kubelet æˆ– CoreDNS é…ç½®ä¸­ã€‚</p>
</blockquote>
<p>æ¯”å¦‚ä½ æœ‰ä¸€ä¸ª service å« <code>nginx</code> åœ¨ <code>prod</code> å‘½åç©ºé—´ï¼Œé‚£ä¹ˆå®ƒçš„ FQDN æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.prod.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä»ä»»ä½•å‘½åç©ºé—´ä½¿ç”¨è¿™ä¸ª FQDN è®¿é—®è¯¥æœåŠ¡ã€‚</p>
<hr>
<h2 id="âœ…-ä¸‰ã€FQDN-ä¸é-FQDN-çš„åŒºåˆ«"><a href="#âœ…-ä¸‰ã€FQDN-ä¸é-FQDN-çš„åŒºåˆ«" class="headerlink" title="âœ… ä¸‰ã€FQDN ä¸é FQDN çš„åŒºåˆ«"></a>âœ… ä¸‰ã€FQDN ä¸é FQDN çš„åŒºåˆ«</h2><table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç¤ºä¾‹</th>
<th>æ˜¯å¦å…¨å±€å”¯ä¸€</th>
<th>æ˜¯å¦ä¾èµ– search åŸŸ</th>
<th>æ˜¯å¦æ¨è</th>
</tr>
</thead>
<tbody><tr>
<td>FQDN</td>
<td><code>nginx.prod.svc.cluster.local</code></td>
<td>âœ… æ˜¯</td>
<td>âŒ ä¸ä¾èµ–</td>
<td>âœ… æ¨è</td>
</tr>
<tr>
<td>é FQDNï¼ˆçŸ­åŸŸåï¼‰</td>
<td><code>nginx</code> æˆ– <code>nginx.prod</code></td>
<td>âŒ å¯èƒ½å†²çª</td>
<td>âœ… ä¾èµ–</td>
<td>âŒ ä¸æ¨èè·¨å‘½åç©ºé—´</td>
</tr>
</tbody></table>
<hr>
<h2 id="âœ…-å››ã€ä½¿ç”¨-FQDN-çš„å¥½å¤„"><a href="#âœ…-å››ã€ä½¿ç”¨-FQDN-çš„å¥½å¤„" class="headerlink" title="âœ… å››ã€ä½¿ç”¨ FQDN çš„å¥½å¤„"></a>âœ… å››ã€ä½¿ç”¨ FQDN çš„å¥½å¤„</h2><ol>
<li><p><strong>è·¨å‘½åç©ºé—´é€šä¿¡ç¨³å®š</strong></p>
<ul>
<li>ä½¿ç”¨å®Œæ•´åŸŸå <code>svc.ns.svc.cluster.local</code> ä¸ä¾èµ– DNS search path</li>
</ul>
</li>
<li><p><strong>æ›´é«˜çš„å®‰å…¨æ€§å’Œç¡®å®šæ€§</strong></p>
<ul>
<li>é¿å…è®¿é—®åˆ°å…¶ä»–å‘½åç©ºé—´ä¸­é‡åçš„ serviceï¼ˆæ¯”å¦‚ <code>nginx</code>ï¼‰</li>
</ul>
</li>
<li><p><strong>è·¨é›†ç¾¤ DNS è”é€šï¼ˆä¾‹å¦‚ Service Meshã€å¤šé›†ç¾¤ï¼‰</strong></p>
<ul>
<li>å¤šé›†ç¾¤ç¯å¢ƒä¸­å¯ä»¥å€ŸåŠ© FQDN æ˜¾å¼æŒ‡å®šæœåŠ¡æº</li>
</ul>
</li>
<li><p><strong>è‡ªåŠ¨è¯ä¹¦ç»‘å®šï¼ˆå¦‚ Istioã€cert-managerï¼‰</strong></p>
<ul>
<li>è¯ä¹¦ç­¾å‘å¸¸ç”¨ FQDN ä½œä¸º <code>CommonName</code> æˆ– <code>SAN</code></li>
</ul>
</li>
</ol>
<hr>
<h2 id="âœ…-äº”ã€K8s-çœŸå®æ¡ˆä¾‹"><a href="#âœ…-äº”ã€K8s-çœŸå®æ¡ˆä¾‹" class="headerlink" title="âœ… äº”ã€K8s çœŸå®æ¡ˆä¾‹"></a>âœ… äº”ã€K8s çœŸå®æ¡ˆä¾‹</h2><h3 id="ğŸ”¸-kubectl-exec-è°ƒè¯•æ—¶ï¼š"><a href="#ğŸ”¸-kubectl-exec-è°ƒè¯•æ—¶ï¼š" class="headerlink" title="ğŸ”¸ kubectl exec è°ƒè¯•æ—¶ï¼š"></a>ğŸ”¸ <code>kubectl exec</code> è°ƒè¯•æ—¶ï¼š</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl nginx.default.svc.cluster.local:80</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”¸-Ingressã€Istio-ä¸­é…ç½®ä¸»æœºåè·¯ç”±ï¼š"><a href="#ğŸ”¸-Ingressã€Istio-ä¸­é…ç½®ä¸»æœºåè·¯ç”±ï¼š" class="headerlink" title="ğŸ”¸ Ingressã€Istio ä¸­é…ç½®ä¸»æœºåè·¯ç”±ï¼š"></a>ğŸ”¸ Ingressã€Istio ä¸­é…ç½®ä¸»æœºåè·¯ç”±ï¼š</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">host:</span> <span class="string">my-app.dev.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”¸-cert-manager-Issuer-ä¸­çš„-DNS-SAN-é…ç½®ï¼š"><a href="#ğŸ”¸-cert-manager-Issuer-ä¸­çš„-DNS-SAN-é…ç½®ï¼š" class="headerlink" title="ğŸ”¸ cert-manager Issuer ä¸­çš„ DNS SAN é…ç½®ï¼š"></a>ğŸ”¸ cert-manager Issuer ä¸­çš„ DNS SAN é…ç½®ï¼š</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dnsNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rancher.qihoo.net</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">harbor.qa.qihoo.net</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âœ…-å…­ã€å¦‚ä½•æŸ¥çœ‹å½“å‰é›†ç¾¤-FQDN-åç¼€ï¼Ÿ"><a href="#âœ…-å…­ã€å¦‚ä½•æŸ¥çœ‹å½“å‰é›†ç¾¤-FQDN-åç¼€ï¼Ÿ" class="headerlink" title="âœ… å…­ã€å¦‚ä½•æŸ¥çœ‹å½“å‰é›†ç¾¤ FQDN åç¼€ï¼Ÿ"></a>âœ… å…­ã€å¦‚ä½•æŸ¥çœ‹å½“å‰é›†ç¾¤ FQDN åç¼€ï¼Ÿ</h2><p>ä½ å¯ä»¥æŸ¥çœ‹ kubelet æˆ– CoreDNS çš„ DNS é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 10.43.0.10</span><br></pre></td></tr></table></figure>

<p>è¿™è¡¨ç¤ºä½ åœ¨ <code>default</code> å‘½åç©ºé—´æ—¶ï¼ŒçŸ­åŸŸåä¼šè‡ªåŠ¨è¡¥é½æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;name&gt;.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âœ…-æ€»ç»“è¡¨æ ¼"><a href="#âœ…-æ€»ç»“è¡¨æ ¼" class="headerlink" title="âœ… æ€»ç»“è¡¨æ ¼"></a>âœ… æ€»ç»“è¡¨æ ¼</h2><table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>æè¿°</th>
<th>å…¸å‹ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td>FQDN</td>
<td>å®Œå…¨é™å®šåŸŸåï¼Œä»ä¸»æœºååˆ°æ ¹åŸŸçš„å…¨è·¯å¾„</td>
<td><code>svc.ns.svc.cluster.local</code></td>
</tr>
<tr>
<td>ç®€çŸ­åŸŸå</td>
<td>æç®€å†™æ³•ï¼Œä»…ç”¨äºå½“å‰ namespace å†…</td>
<td><code>svc</code></td>
</tr>
<tr>
<td>æ¨èåœºæ™¯</td>
<td>è·¨å‘½åç©ºé—´è®¿é—® &#x2F; TLS ç»‘å®š &#x2F; å¤šé›†ç¾¤ &#x2F; Istio ç­‰</td>
<td>å¿…é¡»ä½¿ç”¨ FQDN</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/07/01/%E5%B8%B8%E8%A7%81runtime-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/07/01/%E5%B8%B8%E8%A7%81runtime-socket/" class="post-title-link" itemprop="url">å¸¸è§runtime socket</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-01 14:15:10 / ä¿®æ”¹æ—¶é—´ï¼š14:21:10" itemprop="dateCreated datePublished" datetime="2025-07-01T14:15:10+08:00">2025-07-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å¸¸è§-runtime-socket-è·¯å¾„"><a href="#å¸¸è§-runtime-socket-è·¯å¾„" class="headerlink" title="å¸¸è§ runtime socket è·¯å¾„"></a>å¸¸è§ runtime socket è·¯å¾„</h2><table>
<thead>
<tr>
<th>CRI å®ç°</th>
<th>Socket è·¯å¾„</th>
</tr>
</thead>
<tbody><tr>
<td>containerdï¼ˆK3sï¼‰</td>
<td><code>/run/k3s/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>containerdï¼ˆé K3sï¼‰</td>
<td><code>/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>cri-o</td>
<td><code>/run/crio/crio.sock</code></td>
</tr>
<tr>
<td>Docker + cri-dockerd</td>
<td><code>/var/run/cri-dockerd.sock</code></td>
</tr>
<tr>
<td>Dockershim</td>
<td><code>/var/run/dockershim.sock</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="crictl-WARN-è§£å†³åŠæ³•"><a href="#crictl-WARN-è§£å†³åŠæ³•" class="headerlink" title="crictl WARN è§£å†³åŠæ³•"></a>crictl WARN è§£å†³åŠæ³•</h2><ul>
<li>æ˜¾å¼æŒ‡å®š â€“runtime-endpoint å‚æ•°<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#å‘½ä»¤ä¸­æŒ‡å®š --runtime-endpoint,ä½¿ç”¨ K3s æ—¶ containerd çš„é»˜è®¤ socket è·¯å¾„</span><br><span class="line">crictl --runtime-endpoint unix:///run/k3s/containerd/containerd.sock images</span><br></pre></td></tr></table></figure></li>
<li>è®¾ç½®é…ç½®æ–‡ä»¶<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span><br><span class="line">runtime-endpoint: unix:///run/k3s/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/k3s/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">crictl images</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/06/19/cAdvisor%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/19/cAdvisor%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">cAdvisoråˆæ¢</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-19 14:16:57 / ä¿®æ”¹æ—¶é—´ï¼š14:19:11" itemprop="dateCreated datePublished" datetime="2025-06-19T14:16:57+08:00">2025-06-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="cgroup-namespace"><a href="#cgroup-namespace" class="headerlink" title="cgroup &amp; namespace"></a>cgroup &amp; namespace</h2><table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>å«ä¹‰</th>
<th>ç¤ºä¾‹ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>cgroup</code></td>
<td>æ§åˆ¶ç»„ï¼Œé™åˆ¶å®¹å™¨çš„ CPUã€å†…å­˜ç­‰</td>
<td><code>cpu.shares</code>, <code>memory.limit_in_bytes</code></td>
</tr>
<tr>
<td><code>namespace</code></td>
<td>åå­—ç©ºé—´ï¼Œéš”ç¦»å®¹å™¨è¿è¡Œç¯å¢ƒ</td>
<td><code>net</code>, <code>pid</code>, <code>mnt</code>, <code>ipc</code>, <code>uts</code>, <code>user</code></td>
</tr>
</tbody></table>
<h2 id="cAdvisor"><a href="#cAdvisor" class="headerlink" title="cAdvisor"></a>cAdvisor</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cAdvisor ç›´æ¥è¯»å–:</span><br><span class="line">â€¢ /sys/fs/cgroupï¼ˆCPUã€memoryã€blkioï¼‰</span><br><span class="line">â€¢ /proc/&lt;pid&gt;/net/devï¼ˆç½‘ç»œï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="cAdvisor-è¯»å–ç£ç›˜-I-O-æŒ‡æ ‡çš„åŸç†"><a href="#cAdvisor-è¯»å–ç£ç›˜-I-O-æŒ‡æ ‡çš„åŸç†" class="headerlink" title="cAdvisor è¯»å–ç£ç›˜ I&#x2F;O æŒ‡æ ‡çš„åŸç†"></a>cAdvisor è¯»å–ç£ç›˜ I&#x2F;O æŒ‡æ ‡çš„åŸç†</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. ä» cgroup blkio å­ç³»ç»Ÿè¯»å– I/O é™åˆ¶ä¸ç»Ÿè®¡æ•°æ®</span><br><span class="line">/sys/fs/cgroup/blkio/docker/&lt;container-id&gt;/</span><br><span class="line"></span><br><span class="line">2. é€šè¿‡ /proc/&lt;pid&gt;/io è¯»å–è¿›ç¨‹çº§ç£ç›˜æ•°æ®</span><br><span class="line">/proc/&lt;container-pid&gt;/io</span><br><span class="line"></span><br><span class="line">cAdvisor ä¼šæ±‡æ€»å±äºæŸä¸ªå®¹å™¨æ‰€æœ‰è¿›ç¨‹çš„ /proc/&lt;pid&gt;/io ç»Ÿè®¡ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="æ¨¡æ‹Ÿ-cAdvisor-çš„è¡Œä¸º"><a href="#æ¨¡æ‹Ÿ-cAdvisor-çš„è¡Œä¸º" class="headerlink" title="æ¨¡æ‹Ÿ cAdvisor çš„è¡Œä¸º"></a>æ¨¡æ‹Ÿ cAdvisor çš„è¡Œä¸º</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker ps | grep kubelet</span><br><span class="line"></span><br><span class="line">docker inspect f965002cb995 | grep -w &quot;Id&quot;</span><br><span class="line">æˆ–</span><br><span class="line">docker inspect f965002cb995 | jq &#x27;.[].Id&#x27;</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹å®¹å™¨ blkio æ•°æ®</span><br><span class="line">cat /sys/fs/cgroup/blkio/docker/f965002cb995390b763ab8abacd86cc987d223101ace612a9e16c3bac9767a80/blkio.throttle.io_service_bytes</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹æŸå®¹å™¨ä¸»è¿›ç¨‹çš„ PIDï¼š</span><br><span class="line">docker inspect f965002cb995 | grep -w &quot;Pid&quot;</span><br><span class="line">æˆ–</span><br><span class="line">docker inspect f965002cb995 | jq &#x27;.[].State.Pid&#x27;</span><br><span class="line"></span><br><span class="line">cat /proc/6687/io</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/06/19/curl%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E8%80%97%E6%97%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/19/curl%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E8%80%97%E6%97%B6/" class="post-title-link" itemprop="url">curlç½‘ç»œè¯·æ±‚è€—æ—¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-19 10:22:30 / ä¿®æ”¹æ—¶é—´ï¼š10:47:51" itemprop="dateCreated datePublished" datetime="2025-06-19T10:22:30+08:00">2025-06-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="é…ç½®è¾“å‡ºæ ¼å¼"><a href="#é…ç½®è¾“å‡ºæ ¼å¼" class="headerlink" title="é…ç½®è¾“å‡ºæ ¼å¼"></a>é…ç½®è¾“å‡ºæ ¼å¼</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#æ­¥éª¤1é…ç½®å‚æ•°</span><br><span class="line">cat &gt; curl-format.txt &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">=============== HTTPS æ€§èƒ½åˆ†ææŠ¥å‘Š ===============\n</span><br><span class="line">è¯·æ±‚ URLï¼ˆurl_effectiveï¼‰      : %&#123;url_effective&#125;\n</span><br><span class="line">HTTP çŠ¶æ€ç ï¼ˆhttp_codeï¼‰       : %&#123;http_code&#125;\n</span><br><span class="line">Content-Typeï¼ˆcontent_typeï¼‰   : %&#123;content_type&#125;\n</span><br><span class="line">\n</span><br><span class="line">========== æ—¶é—´åˆ†æï¼ˆå•ä½: ç§’ï¼‰ ==========\n</span><br><span class="line">DNS è§£ææ—¶é—´ï¼ˆtime_namelookupï¼‰      : %&#123;time_namelookup&#125;\n</span><br><span class="line">TCP è¿æ¥å»ºç«‹ï¼ˆtime_connectï¼‰         : %&#123;time_connect&#125;\n</span><br><span class="line">TLS/SSL æ¡æ‰‹ï¼ˆtime_appconnectï¼‰      : %&#123;time_appconnect&#125;\n</span><br><span class="line">ä¼ è¾“å‡†å¤‡å®Œæˆï¼ˆtime_pretransferï¼‰     : %&#123;time_pretransfer&#125;\n</span><br><span class="line">é‡å®šå‘è€—æ—¶ï¼ˆtime_redirectï¼‰          : %&#123;time_redirect&#125;\n</span><br><span class="line">é¦–å­—èŠ‚æ¥æ”¶ TTFBï¼ˆtime_starttransferï¼‰: %&#123;time_starttransfer&#125;\n</span><br><span class="line">æ€»è¯·æ±‚æ—¶é—´ï¼ˆtime_totalï¼‰             : %&#123;time_total&#125;\n</span><br><span class="line">\n</span><br><span class="line">========== æ•°æ®ä¼ è¾“åˆ†æ ==========\n</span><br><span class="line">ä¸‹è½½æ•°æ®å¤§å°ï¼ˆsize_downloadï¼‰      : %&#123;size_download&#125; bytes\n</span><br><span class="line">ä¸Šä¼ æ•°æ®å¤§å°ï¼ˆsize_uploadï¼‰        : %&#123;size_upload&#125; bytes\n</span><br><span class="line">è¯·æ±‚å¤§å°ï¼ˆsize_requestï¼‰           : %&#123;size_request&#125; bytes\n</span><br><span class="line">å“åº”å¤´å¤§å°ï¼ˆsize_headerï¼‰          : %&#123;size_header&#125; bytes\n</span><br><span class="line">å¹³å‡ä¸‹è½½é€Ÿåº¦ï¼ˆspeed_downloadï¼‰     : %&#123;speed_download&#125; bytes/sec\n</span><br><span class="line">å¹³å‡ä¸Šä¼ é€Ÿåº¦ï¼ˆspeed_uploadï¼‰       : %&#123;speed_upload&#125; bytes/sec\n</span><br><span class="line">\n</span><br><span class="line">========== è¿æ¥ä¿¡æ¯ ==========\n</span><br><span class="line">è¿œç¨‹ IPï¼ˆremote_ipï¼‰               : %&#123;remote_ip&#125;\n</span><br><span class="line">è¿œç¨‹ç«¯å£ï¼ˆremote_portï¼‰            : %&#123;remote_port&#125;\n</span><br><span class="line">æœ¬åœ° IPï¼ˆlocal_ipï¼‰                : %&#123;local_ip&#125;\n</span><br><span class="line">æœ¬åœ°ç«¯å£ï¼ˆlocal_portï¼‰             : %&#123;local_port&#125;\n</span><br><span class="line">\n</span><br><span class="line">========== SSL ç›¸å…³ ==========\n</span><br><span class="line">SSL éªŒè¯ç»“æœï¼ˆssl_verify_resultï¼‰ : %&#123;ssl_verify_result&#125;\n</span><br><span class="line">==================================================\n</span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="è¯·æ±‚"><a href="#è¯·æ±‚" class="headerlink" title="è¯·æ±‚"></a>è¯·æ±‚</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -w &quot;@curl-format.txt&quot; -o /dev/null -s http://baidu.com</span><br><span class="line"></span><br><span class="line">#curl -w &quot;@curl-format.txt&quot; -o /dev/null -s -k -H &quot;Host: test.xxx.net&quot; https://10.100.100.100:443</span><br></pre></td></tr></table></figure>

<h2 id="å¤‡æ³¨"><a href="#å¤‡æ³¨" class="headerlink" title="å¤‡æ³¨"></a>å¤‡æ³¨</h2><ul>
<li>ssl_verify_result: SSL&#x2F;TLS è¯ä¹¦éªŒè¯çš„ç»“æœä»£ç ï¼ˆreturn codeï¼‰<table>
<thead>
<tr>
<th>å€¼</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>0</code></td>
<td>âœ… <strong>éªŒè¯é€šè¿‡ï¼ˆOKï¼‰</strong>ï¼šè¯ä¹¦åˆæ³•ã€é“¾æ¡å®Œæ•´ã€å—ä¿¡ä»»</td>
</tr>
<tr>
<td>é 0</td>
<td>âŒ <strong>éªŒè¯å¤±è´¥</strong>ï¼šè¯ä¹¦ä¸åˆæ³•ã€ä¸å—ä¿¡ã€é“¾ä¸å®Œæ•´ç­‰åŸå› </td>
</tr>
</tbody></table>
</li>
<li>å¸¸è§éé›¶é”™è¯¯ä»£ç <table>
<thead>
<tr>
<th>é”™è¯¯ç </th>
<th>å«ä¹‰ï¼ˆç®€è¿°ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>2</code></td>
<td>æ— æ³•è·å–å‘è¡Œè€…è¯ä¹¦ï¼ˆé“¾ä¸å®Œæ•´ï¼‰</td>
</tr>
<tr>
<td><code>10</code></td>
<td>è¯ä¹¦è¿‡æœŸ</td>
</tr>
<tr>
<td><code>18</code></td>
<td>æ— æ³•éªŒè¯è¯ä¹¦é“¾</td>
</tr>
<tr>
<td><code>19</code></td>
<td>è‡ªç­¾åè¯ä¹¦</td>
</tr>
<tr>
<td><code>20</code></td>
<td>æ— æ³•è§£ææœ¬åœ°è¯ä¹¦</td>
</tr>
<tr>
<td><code>21</code></td>
<td>æ— æ³•éªŒè¯æ ¹è¯ä¹¦</td>
</tr>
<tr>
<td><code>27</code></td>
<td>ä¸»ä½“å’Œé¢å‘è€…ä¸åŒ¹é…</td>
</tr>
<tr>
<td><code>62</code></td>
<td>ä¸»æœºåä¸åŒ¹é…ï¼ˆè¯ä¹¦ CN&#x2F;SAN ä¸åŸŸåä¸åŒï¼‰</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="éªŒè¯è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´"><a href="#éªŒè¯è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´" class="headerlink" title="éªŒè¯è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´"></a>éªŒè¯è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹æ³•1</span><br><span class="line">curl -v https://baidu.com</span><br><span class="line">æˆåŠŸï¼šSSL certificate verify ok.</span><br><span class="line">å¦‚æœå¤±è´¥è¿”å›ï¼šSSL certificate problem: unable to verify the first certificate</span><br><span class="line"></span><br><span class="line">#æ–¹æ³•2</span><br><span class="line">openssl s_client -connect baidu.com:443 -showcerts</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>æœ€ä½³å®è·µå»ºè®®</li>
</ul>
<table>
<thead>
<tr>
<th>ç›®æ ‡</th>
<th>å»ºè®®å‘½ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td>è¯ä¹¦åŸŸåæ˜¯å¦æ­£ç¡® + è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´</td>
<td><code>curl -v --resolve your.domain.com:443:IP https://your.domain.com/</code></td>
</tr>
<tr>
<td>æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦è¯¦æƒ…</td>
<td><code>openssl s_client -connect IP:443 -servername your.domain.com -showcerts</code></td>
</tr>
<tr>
<td>ä¸´æ—¶è·³è¿‡éªŒè¯æµ‹è¯• HTTP å“åº”</td>
<td><code>curl -k -H &quot;Host: ...&quot; https://IP:443</code>ï¼ˆè°ƒè¯•ä¸“ç”¨ï¼‰</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ˜¯å¦éªŒè¯è¯ä¹¦</th>
<th>æ˜¯å¦éªŒè¯é“¾å®Œæ•´æ€§</th>
<th>SNI æ­£ç¡®</th>
<th>æ¨èç”¨äºç”Ÿäº§éªŒè¯ï¼Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td><code>curl --resolve</code></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ… å¼ºçƒˆæ¨è</td>
</tr>
<tr>
<td><code>curl -H &quot;Host:...&quot;</code></td>
<td>âœ…ï¼ˆä½†ä¼šå¤±è´¥ï¼‰</td>
<td>âŒï¼ˆå› è¯ä¹¦é“¾ä¸å®Œæ•´ï¼‰</td>
<td>âŒ</td>
<td>âŒ ä¸å»ºè®®</td>
</tr>
<tr>
<td><code>curl -H &quot;Host:...&quot; -k</code></td>
<td>âŒï¼ˆè·³è¿‡éªŒè¯ï¼‰</td>
<td>âŒ</td>
<td>âŒ</td>
<td>ğŸš« ä¸æ¨èï¼Œä»…è°ƒè¯•ç”¨</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/06/18/https%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/06/18/https%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">httpså·¥ä½œæµç¨‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-18 15:12:02 / ä¿®æ”¹æ—¶é—´ï¼š15:14:07" itemprop="dateCreated datePublished" datetime="2025-06-18T15:12:02+08:00">2025-06-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å›¾ä¾‹"><a href="#å›¾ä¾‹" class="headerlink" title="å›¾ä¾‹"></a>å›¾ä¾‹</h2><p><img src="https://raw.githubusercontent.com/shispring/picgo/master/20250618151317.png" alt="https" title="https works"></p>
<h2 id="HTTPS-å·¥ä½œæµç¨‹è¯¦è§£"><a href="#HTTPS-å·¥ä½œæµç¨‹è¯¦è§£" class="headerlink" title="HTTPS å·¥ä½œæµç¨‹è¯¦è§£"></a>HTTPS å·¥ä½œæµç¨‹è¯¦è§£</h2><h3 id="1-TCP-æ¡æ‰‹é˜¶æ®µ"><a href="#1-TCP-æ¡æ‰‹é˜¶æ®µ" class="headerlink" title="1. TCP æ¡æ‰‹é˜¶æ®µ"></a>1. TCP æ¡æ‰‹é˜¶æ®µ</h3><ul>
<li><strong>TCP SYN</strong>: å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€åŒæ­¥è¯·æ±‚ï¼Œè¯·æ±‚å»ºç«‹è¿æ¥</li>
<li><strong>TCP SYN + ACK</strong>: æœåŠ¡å™¨å“åº”å¹¶ç¡®è®¤è¿æ¥è¯·æ±‚</li>
<li><strong>TCP ACK</strong>: å®¢æˆ·ç«¯ç¡®è®¤ï¼ŒTCP è¿æ¥å»ºç«‹å®Œæˆ</li>
</ul>
<p>è¿™æ˜¯æ ‡å‡†çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸ºåç»­çš„ TLS&#x2F;SSL é€šä¿¡å»ºç«‹å¯é çš„ä¼ è¾“å±‚è¿æ¥ã€‚</p>
<h3 id="2-è¯ä¹¦éªŒè¯é˜¶æ®µ"><a href="#2-è¯ä¹¦éªŒè¯é˜¶æ®µ" class="headerlink" title="2. è¯ä¹¦éªŒè¯é˜¶æ®µ"></a>2. è¯ä¹¦éªŒè¯é˜¶æ®µ</h3><ul>
<li><strong>Client Hello</strong>: å®¢æˆ·ç«¯å‘é€æ”¯æŒçš„ TLS ç‰ˆæœ¬ã€åŠ å¯†å¥—ä»¶åˆ—è¡¨ç­‰ä¿¡æ¯</li>
<li><strong>Server Hello</strong>: æœåŠ¡å™¨é€‰æ‹© TLS ç‰ˆæœ¬å’ŒåŠ å¯†å¥—ä»¶</li>
<li><strong>Certificate</strong>: æœåŠ¡å™¨å‘é€æ•°å­—è¯ä¹¦ï¼ˆåŒ…å«å…¬é’¥ï¼‰</li>
<li><strong>Server Hello Done</strong>: æœåŠ¡å™¨è¡¨ç¤ºæ¡æ‰‹ä¿¡æ¯å‘é€å®Œæ¯•</li>
</ul>
<p>åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå®¢æˆ·ç«¯ä¼šéªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>è¯ä¹¦æ˜¯å¦ç”±å¯ä¿¡ CA ç­¾å‘</li>
<li>è¯ä¹¦æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…</li>
<li>è¯ä¹¦ä¸­çš„åŸŸåæ˜¯å¦ä¸è®¿é—®çš„åŸŸååŒ¹é…</li>
</ul>
<h3 id="3-å¯†é’¥äº¤æ¢é˜¶æ®µ"><a href="#3-å¯†é’¥äº¤æ¢é˜¶æ®µ" class="headerlink" title="3. å¯†é’¥äº¤æ¢é˜¶æ®µ"></a>3. å¯†é’¥äº¤æ¢é˜¶æ®µ</h3><p>è¿™æ˜¯ HTTPS å®‰å…¨æ€§çš„æ ¸å¿ƒéƒ¨åˆ†ï¼š</p>
<p><strong>éå¯¹ç§°åŠ å¯†è¿‡ç¨‹</strong>ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºçš„ <strong>session key</strong>ï¼ˆä¼šè¯å¯†é’¥ï¼‰</li>
<li>ä½¿ç”¨æœåŠ¡å™¨è¯ä¹¦ä¸­çš„ <strong>å…¬é’¥</strong> å¯¹ session key è¿›è¡ŒåŠ å¯†</li>
<li>å‘é€ <strong>Client Key Exchange</strong> æ¶ˆæ¯ï¼ŒåŒ…å«åŠ å¯†åçš„ session key</li>
<li>æœåŠ¡å™¨ä½¿ç”¨è‡ªå·±çš„ <strong>ç§é’¥</strong> è§£å¯†è·å¾— session key</li>
</ul>
<p><strong>æ¡æ‰‹å®Œæˆ</strong>ï¼š</p>
<ul>
<li><strong>Change Cipher Spec</strong>: åŒæ–¹é€šçŸ¥å¯¹æ–¹åç»­é€šä¿¡å°†ä½¿ç”¨åå•†å¥½çš„åŠ å¯†å‚æ•°</li>
<li><strong>Finished</strong>: ä½¿ç”¨æ–°çš„åŠ å¯†å‚æ•°å‘é€æ¡æ‰‹å®Œæˆæ¶ˆæ¯</li>
</ul>
<h3 id="4-æ•°æ®ä¼ è¾“é˜¶æ®µ"><a href="#4-æ•°æ®ä¼ è¾“é˜¶æ®µ" class="headerlink" title="4. æ•°æ®ä¼ è¾“é˜¶æ®µ"></a>4. æ•°æ®ä¼ è¾“é˜¶æ®µ</h3><p><strong>å¯¹ç§°åŠ å¯†é€šä¿¡</strong>ï¼š</p>
<ul>
<li>åŒæ–¹éƒ½æ‹¥æœ‰ç›¸åŒçš„ session key</li>
<li>ä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆå¦‚ AESï¼‰å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†&#x2F;è§£å¯†</li>
<li>æ‰€æœ‰ HTTP æ•°æ®éƒ½é€šè¿‡è¿™ä¸ªåŠ å¯†é€šé“ä¼ è¾“</li>
</ul>
<h2 id="åŠ å¯†æœºåˆ¶è¯´æ˜"><a href="#åŠ å¯†æœºåˆ¶è¯´æ˜" class="headerlink" title="åŠ å¯†æœºåˆ¶è¯´æ˜"></a>åŠ å¯†æœºåˆ¶è¯´æ˜</h2><h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨æ··åˆåŠ å¯†ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨æ··åˆåŠ å¯†ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨æ··åˆåŠ å¯†ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨æ··åˆåŠ å¯†ï¼Ÿ</h3><ol>
<li><p><strong>éå¯¹ç§°åŠ å¯†</strong>ï¼ˆRSA&#x2F;ECDHï¼‰ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå¯†é’¥åˆ†å‘å®‰å…¨ï¼Œæ— éœ€é¢„å…±äº«å¯†é’¥</li>
<li>ç¼ºç‚¹ï¼šè®¡ç®—å¼€é”€å¤§ï¼Œé€Ÿåº¦æ…¢</li>
</ul>
</li>
<li><p><strong>å¯¹ç§°åŠ å¯†</strong>ï¼ˆAESï¼‰ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šåŠ å¯†é€Ÿåº¦å¿«ï¼Œæ•ˆç‡é«˜</li>
<li>ç¼ºç‚¹ï¼šå¯†é’¥åˆ†å‘å›°éš¾</li>
</ul>
</li>
</ol>
<p><strong>HTTPS çš„å·§å¦™ä¹‹å¤„</strong>ï¼š</p>
<ul>
<li>ç”¨éå¯¹ç§°åŠ å¯†å®‰å…¨åœ°äº¤æ¢å¯¹ç§°å¯†é’¥</li>
<li>ç”¨å¯¹ç§°åŠ å¯†è¿›è¡Œå®é™…çš„æ•°æ®ä¼ è¾“</li>
<li>æ—¢ä¿è¯äº†å®‰å…¨æ€§ï¼Œåˆä¿è¯äº†æ•ˆç‡</li>
</ul>
<h2 id="HTTPS-æœ€ä½³å®è·µæ€»ç»“"><a href="#HTTPS-æœ€ä½³å®è·µæ€»ç»“" class="headerlink" title="HTTPS æœ€ä½³å®è·µæ€»ç»“"></a>HTTPS æœ€ä½³å®è·µæ€»ç»“</h2><h3 id="1-è¯ä¹¦ç®¡ç†"><a href="#1-è¯ä¹¦ç®¡ç†" class="headerlink" title="1. è¯ä¹¦ç®¡ç†"></a>1. è¯ä¹¦ç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨æƒå¨ CA ç­¾å‘çš„è¯ä¹¦</span></span><br><span class="line"><span class="comment"># æ¨è Let&#x27;s Encrypt å…è´¹è¯ä¹¦</span></span><br><span class="line">certbot --nginx -d yourdomain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šæœŸæ›´æ–°è¯ä¹¦</span></span><br><span class="line">0 3 * * * /usr/bin/certbot renew --quiet</span><br></pre></td></tr></table></figure>

<h3 id="2-TLS-ç‰ˆæœ¬é…ç½®"><a href="#2-TLS-ç‰ˆæœ¬é…ç½®" class="headerlink" title="2. TLS ç‰ˆæœ¬é…ç½®"></a>2. TLS ç‰ˆæœ¬é…ç½®</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx é…ç½®ç¤ºä¾‹</span></span><br><span class="line"><span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;  <span class="comment"># åªä½¿ç”¨å®‰å…¨ç‰ˆæœ¬</span></span><br><span class="line"><span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;</span><br><span class="line"><span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-å®‰å…¨å¤´é…ç½®"><a href="#3-å®‰å…¨å¤´é…ç½®" class="headerlink" title="3. å®‰å…¨å¤´é…ç½®"></a>3. å®‰å…¨å¤´é…ç½®</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼ºåˆ¶ HTTPS</span></span><br><span class="line"><span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é˜²æ­¢é™çº§æ”»å‡»</span></span><br><span class="line"><span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line"><span class="attribute">add_header</span> X-Frame-Options DENY;</span><br><span class="line"><span class="attribute">add_header</span> X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-æ€§èƒ½ä¼˜åŒ–"><a href="#4-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="4. æ€§èƒ½ä¼˜åŒ–"></a>4. æ€§èƒ½ä¼˜åŒ–</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨ HTTP/2</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼šè¯å¤ç”¨</span></span><br><span class="line"><span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"><span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># OCSP Stapling</span></span><br><span class="line"><span class="attribute">ssl_stapling</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">ssl_stapling_verify</span> <span class="literal">on</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-å¼€å‘ç¯å¢ƒé…ç½®"><a href="#5-å¼€å‘ç¯å¢ƒé…ç½®" class="headerlink" title="5. å¼€å‘ç¯å¢ƒé…ç½®"></a>5. å¼€å‘ç¯å¢ƒé…ç½®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node.js Express ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">&#x27;https&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  <span class="attr">key</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;private-key.pem&#x27;</span>),</span><br><span class="line">  <span class="attr">cert</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;certificate.pem&#x27;</span>),</span><br><span class="line">  <span class="comment">// å¼ºåˆ¶ TLS 1.2+</span></span><br><span class="line">  <span class="attr">secureProtocol</span>: <span class="string">&#x27;TLSv1_2_method&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">https.<span class="title function_">createServer</span>(options, app).<span class="title function_">listen</span>(<span class="number">443</span>);</span><br></pre></td></tr></table></figure>

<h3 id="6-ç›‘æ§å’Œç»´æŠ¤"><a href="#6-ç›‘æ§å’Œç»´æŠ¤" class="headerlink" title="6. ç›‘æ§å’Œç»´æŠ¤"></a>6. ç›‘æ§å’Œç»´æŠ¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> certificate.crt -text -noout | grep <span class="string">&quot;Not After&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯• SSL é…ç½®</span></span><br><span class="line">curl -I https://yourdomain.com</span><br><span class="line">openssl s_client -connect yourdomain.com:443 -servername yourdomain.com</span><br></pre></td></tr></table></figure>

<h3 id="7-å®‰å…¨æ£€æŸ¥æ¸…å•"><a href="#7-å®‰å…¨æ£€æŸ¥æ¸…å•" class="headerlink" title="7. å®‰å…¨æ£€æŸ¥æ¸…å•"></a>7. å®‰å…¨æ£€æŸ¥æ¸…å•</h3><ul>
<li>âœ… ä½¿ç”¨ TLS 1.2 æˆ–æ›´é«˜ç‰ˆæœ¬</li>
<li>âœ… ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†å¥—ä»¶</li>
<li>âœ… å¯ç”¨ HSTS</li>
<li>âœ… é…ç½®æ­£ç¡®çš„è¯ä¹¦é“¾</li>
<li>âœ… å®šæœŸæ›´æ–°è¯ä¹¦</li>
<li>âœ… ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´</li>
<li>âœ… ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•ï¼ˆAES-256ï¼‰</li>
<li>âœ… å¯ç”¨ Perfect Forward Secrecy</li>
</ul>
<p>è¿™ä¸ªæµç¨‹å›¾å¾ˆå¥½åœ°å±•ç¤ºäº† HTTPS å¦‚ä½•é€šè¿‡éå¯¹ç§°åŠ å¯†ä¿è¯å¯†é’¥äº¤æ¢çš„å®‰å…¨æ€§ï¼Œå†é€šè¿‡å¯¹ç§°åŠ å¯†ä¿è¯æ•°æ®ä¼ è¾“çš„æ•ˆç‡ï¼Œæ˜¯ç°ä»£ç½‘ç»œå®‰å…¨é€šä¿¡çš„æ ‡å‡†å®ç°ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">129</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
