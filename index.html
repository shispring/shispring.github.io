<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://shispring.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="shispring">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/27/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/27/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">Go并发编程最佳实践指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-27 17:55:54 / 修改时间：17:56:23" itemprop="dateCreated datePublished" datetime="2025-11-27T17:55:54+08:00">2025-11-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Go-并发编程最佳实践指南"><a href="#Go-并发编程最佳实践指南" class="headerlink" title="Go 并发编程最佳实践指南"></a>Go 并发编程最佳实践指南</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li>errgroup</li>
<li>sync.WaitGroup</li>
<li>sync.Mutex</li>
<li>Channel</li>
<li>Context</li>
<li>最佳实践总结</li>
</ol>
<hr>
<h2 id="errgroup"><a href="#errgroup" class="headerlink" title="errgroup"></a>errgroup</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>errgroup</code> 提供了一种优雅的方式来管理一组并发的 goroutine，并统一处理错误。它是 <code>golang.org/x/sync/errgroup</code> 包中的功能。</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul>
<li>并发执行多个任务</li>
<li>任意一个任务失败，整体失败</li>
<li>支持 context 取消</li>
<li>支持并发限制</li>
</ul>
<h3 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;golang.org/x/sync/errgroup&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 创建 errgroup</span></span><br><span class="line">  group, ctx := errgroup.WithContext(context.Background())</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 并发执行多个任务</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ &#123;</span><br><span class="line">    i := i <span class="comment">// 避免闭包问题</span></span><br><span class="line">    group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Task %d started\n&quot;</span>, i)</span><br><span class="line">      time.Sleep(time.Second)</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Task %d completed\n&quot;</span>, i)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待所有任务完成</span></span><br><span class="line">  <span class="keyword">if</span> err := group.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Error: %v\n&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="带并发限制的用法"><a href="#带并发限制的用法" class="headerlink" title="带并发限制的用法"></a>带并发限制的用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;golang.org/x/sync/errgroup&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  group, ctx := errgroup.WithContext(context.Background())</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 限制并发数为 3</span></span><br><span class="line">  group.SetLimit(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 并发执行 10 个任务</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">    i := i</span><br><span class="line">    group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Task %d started\n&quot;</span>, i)</span><br><span class="line">      time.Sleep(time.Second)</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Task %d completed\n&quot;</span>, i)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := group.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Error: %v\n&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;golang.org/x/sync/errgroup&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  group, ctx := errgroup.WithContext(context.Background())</span><br><span class="line"></span><br><span class="line">  group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Task 1&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Task 2&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;task 2 failed&quot;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Task 3&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait 返回第一个错误</span></span><br><span class="line">  <span class="keyword">if</span> err := group.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;First error: %v\n&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p><code>WaitGroup</code> 用于等待一组 goroutine 完成，不关心错误处理。</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加 3 个 goroutine</span></span><br><span class="line">  wg.Add(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</span><br><span class="line">    i := i</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done() <span class="comment">// 任务完成时调用</span></span><br><span class="line">      fmt.Printf(<span class="string">&quot;Task %d completed\n&quot;</span>, i)</span><br><span class="line">      time.Sleep(time.Second)</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待所有 goroutine 完成</span></span><br><span class="line">  wg.Wait()</span><br><span class="line">  fmt.Println(<span class="string">&quot;All tasks completed&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="vs-errgroup"><a href="#vs-errgroup" class="headerlink" title="vs errgroup"></a>vs errgroup</h3><table>
<thead>
<tr>
<th>特性</th>
<th>WaitGroup</th>
<th>errgroup</th>
</tr>
</thead>
<tbody><tr>
<td>错误处理</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>并发限制</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>Context 支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>使用场景</td>
<td>简单并发</td>
<td>复杂并发</td>
</tr>
</tbody></table>
<hr>
<h2 id="sync-Mutex"><a href="#sync-Mutex" class="headerlink" title="sync.Mutex"></a>sync.Mutex</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>用于保护共享数据的互斥锁。</p>
<h3 id="基础用法-1"><a href="#基础用法-1" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">  counter := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      mu.Lock()</span><br><span class="line">      counter++</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Counter: %d\n&quot;</span>, counter)</span><br><span class="line">      mu.Unlock()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待所有 goroutine 完成</span></span><br><span class="line">  time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sync-RWMutex（读写锁）"><a href="#sync-RWMutex（读写锁）" class="headerlink" title="sync.RWMutex（读写锁）"></a>sync.RWMutex（读写锁）</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">var</span> rwmu sync.RWMutex</span><br><span class="line">  data := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;<span class="string">&quot;count&quot;</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 写操作</span></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rwmu.Lock()</span><br><span class="line">    data[<span class="string">&quot;count&quot;</span>]++</span><br><span class="line">    rwmu.Unlock()</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 读操作（可以并发）</span></span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      rwmu.RLock()</span><br><span class="line">      fmt.Printf(<span class="string">&quot;Count: %d\n&quot;</span>, data[<span class="string">&quot;count&quot;</span>])</span><br><span class="line">      rwmu.RUnlock()</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><h3 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h3><p>Channel 是 Go 中用于 goroutine 之间通信的机制。</p>
<h3 id="基础用法-2"><a href="#基础用法-2" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 创建 channel</span></span><br><span class="line">  ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch &lt;- <span class="number">42</span> <span class="comment">// 发送</span></span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  value := &lt;-ch <span class="comment">// 接收</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;Received: %d\n&quot;</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-select-处理多个-channel"><a href="#使用-select-处理多个-channel" class="headerlink" title="使用 select 处理多个 channel"></a>使用 select 处理多个 channel</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">  ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    time.Sleep(time.Second)</span><br><span class="line">    ch1 &lt;- <span class="string">&quot;result 1&quot;</span></span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    ch2 &lt;- <span class="string">&quot;result 2&quot;</span></span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 等待第一个完成的</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> res1 := &lt;-ch1:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Got:&quot;</span>, res1)</span><br><span class="line">  <span class="keyword">case</span> res2 := &lt;-ch2:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Got:&quot;</span>, res2)</span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(<span class="number">3</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;Timeout&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><h3 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h3><p>Context 用于控制 goroutine 的生命周期、超时和取消。</p>
<h3 id="基础用法-3"><a href="#基础用法-3" class="headerlink" title="基础用法"></a>基础用法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 创建带超时的 context</span></span><br><span class="line">  ctx, cancel := context.WithTimeout(context.Background(), <span class="number">2</span>*time.Second)</span><br><span class="line">  <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟耗时操作</span></span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-time.After(<span class="number">3</span> * time.Second):</span><br><span class="line">    fmt.Println(<span class="string">&quot;Operation completed&quot;</span>)</span><br><span class="line">  <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">    fmt.Println(<span class="string">&quot;Operation cancelled:&quot;</span>, ctx.Err())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="取消-Context"><a href="#取消-Context" class="headerlink" title="取消 Context"></a>取消 Context</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;sync&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    i := i</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">defer</span> wg.Done()</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-time.After(<span class="number">5</span> * time.Second):</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Task %d completed\n&quot;</span>, i)</span><br><span class="line">      <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Task %d cancelled\n&quot;</span>, i)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2 秒后取消所有 goroutine</span></span><br><span class="line">  time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">  cancel()</span><br><span class="line"></span><br><span class="line">  wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="最佳实践总结"><a href="#最佳实践总结" class="headerlink" title="最佳实践总结"></a>最佳实践总结</h2><h3 id="1-优先使用-errgroup"><a href="#1-优先使用-errgroup" class="headerlink" title="1. 优先使用 errgroup"></a>1. 优先使用 errgroup</h3><p>当需要管理多个 goroutine 且需要错误处理时，优先使用 <code>errgroup</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">group, ctx := errgroup.WithContext(context.Background())</span><br><span class="line">group.SetLimit(<span class="number">10</span>) <span class="comment">// 限制并发</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item := <span class="keyword">range</span> items &#123;</span><br><span class="line">  item := item</span><br><span class="line">  group.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> processItem(ctx, item)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := group.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Error(<span class="string">&quot;Processing failed:&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-避免闭包陷阱"><a href="#2-避免闭包陷阱" class="headerlink" title="2. 避免闭包陷阱"></a>2. 避免闭包陷阱</h3><p><strong>错误方式：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(i) <span class="comment">// 可能打印 10 次</span></span><br><span class="line">  &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>正确方式：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">  i := i <span class="comment">// 创建本地副本</span></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(i)</span><br><span class="line">  &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-使用-Context-控制超时和取消"><a href="#3-使用-Context-控制超时和取消" class="headerlink" title="3. 使用 Context 控制超时和取消"></a>3. 使用 Context 控制超时和取消</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">group, groupCtx := errgroup.WithContext(ctx)</span><br><span class="line"><span class="comment">// 在 groupCtx 中检查取消信号</span></span><br></pre></td></tr></table></figure>

<h3 id="4-合理设置并发限制"><a href="#4-合理设置并发限制" class="headerlink" title="4. 合理设置并发限制"></a>4. 合理设置并发限制</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">group := errgroup.Group&#123;&#125;</span><br><span class="line">group.SetLimit(runtime.NumCPU()) <span class="comment">// 根据 CPU 核心数限制</span></span><br></pre></td></tr></table></figure>

<h3 id="5-优雅的错误包装"><a href="#5-优雅的错误包装" class="headerlink" title="5. 优雅的错误包装"></a>5. 优雅的错误包装</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := processItem(ctx, item); err != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;process item %d: %w&quot;</span>, item.ID, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://golang.org/pkg/sync/">Go sync 包文档</a></li>
<li><a target="_blank" rel="noopener" href="https://golang.org/pkg/context/">Go context 包文档</a></li>
<li><a target="_blank" rel="noopener" href="https://pkg.go.dev/golang.org/x/sync/errgroup">golang.org&#x2F;x&#x2F;sync&#x2F;errgroup</a></li>
<li><a target="_blank" rel="noopener" href="https://golang.org/doc/effective_go#concurrency">Effective Go - Concurrency</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/20/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95k8s-webhook%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95k8s-webhook%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">本地调试k8s webhook方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-20 15:07:57 / 修改时间：21:19:29" itemprop="dateCreated datePublished" datetime="2025-11-20T15:07:57+08:00">2025-11-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Cloudflared-本地调试-Kubernetes-Webhook"><a href="#Cloudflared-本地调试-Kubernetes-Webhook" class="headerlink" title="Cloudflared 本地调试 Kubernetes Webhook"></a>Cloudflared 本地调试 Kubernetes Webhook</h1><p>本文档介绍如何使用 Cloudflared 隧道技术在本地调试 Kubernetes Webhook，无需暴露公网 IP 或配置复杂的网络环境。</p>
<h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul>
<li><a href="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">方案对比</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">环境准备</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4">操作步骤</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ul>
<hr>
<h2 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h2><h3 id="Localtunnel-vs-Cloudflared"><a href="#Localtunnel-vs-Cloudflared" class="headerlink" title="Localtunnel vs Cloudflared"></a>Localtunnel vs Cloudflared</h3><table>
<thead>
<tr>
<th>方案</th>
<th>caBundle 配置</th>
<th>是否可行</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Localtunnel</strong></td>
<td>设置为空</td>
<td>❌ <strong>不可行</strong></td>
<td>Localtunnel 使用 <code>*.loca.lt</code> 证书，调试会出现 tls: failed to verify certificate: x509: certificate signed by unknown authorityi</td>
</tr>
<tr>
<td><strong>Cloudflared</strong></td>
<td>设置为空</td>
<td>✅ <strong>推荐</strong></td>
<td>Cloudflare 提供企业级稳定隧道服务，证书被系统信任，连接稳定可靠</td>
</tr>
</tbody></table>
<p><strong>结论</strong>：<code>caBundle</code> 设置为空（依赖系统 CA 信任链）， <strong>在稳定性、性能和可靠性上远优于 Localtunnel</strong>，推荐使用 Cloudflared。</p>
<hr>
<h3 id="系统默认信任证书"><a href="#系统默认信任证书" class="headerlink" title="系统默认信任证书"></a>系统默认信任证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#存放的是证书链</span><br><span class="line">/etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#查看机器上受信任的证书机构</span><br><span class="line">awk -v cmd=&#x27;openssl x509 -noout -subject&#x27; &#x27; /BEGIN/&#123;close(cmd)&#125;;&#123;print | cmd&#125;&#x27; &lt; /etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#也可以以下命令分开查看</span><br><span class="line">awk &#x27;/BEGIN/&#123;i++&#125;&#123;print &gt; &quot;cert_&quot;i&quot;.crt&quot;&#125;&#x27; /etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#查某一个</span><br><span class="line">openssl x509 -in cert_1.crt -noout -text | grep -A1 &quot;Subject Alternative Name&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#检查“系统是否信任某域名的证书”</span><br><span class="line">echo | openssl s_client -connect example.com:443 2&gt;/dev/null | openssl x509 -noout -subject -issuer -text | grep -A1 &quot;Subject Alternative Name&quot;</span><br><span class="line"></span><br><span class="line">- 检查返回是否包含：Verify return code: 0 (ok)</span><br><span class="line">- 如果是 0 → 说明系统信任这个证书。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1-安装-Cloudflared"><a href="#1-安装-Cloudflared" class="headerlink" title="1. 安装 Cloudflared"></a>1. 安装 Cloudflared</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">https://github.com/cloudflare/cloudflared</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">rpm -ivh https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-x86_64.rpm</span><br><span class="line"></span><br><span class="line"># 验证安装</span><br><span class="line">cloudflared --version</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="步骤-0：生成自签名证书"><a href="#步骤-0：生成自签名证书" class="headerlink" title="步骤 0：生成自签名证书"></a>步骤 0：生成自签名证书</h3><p>Webhook Controller 启动时需要 TLS 证书，使用以下脚本生成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">LOCAL_IP=<span class="string">&quot;10.16.217.194&quot;</span></span><br><span class="line">WEBHOOK_PORT=<span class="string">&quot;11443&quot;</span></span><br><span class="line">VALIDATING_WEBHOOK_CONFIG_NAME=<span class="string">&quot;dev-lbv4-webhook-debug&quot;</span></span><br><span class="line">WEBHOOK_CERT_DIR=<span class="string">&quot;/tmp/k8s-webhook-server/serving-certs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查网络连通性</span></span><br><span class="line"><span class="keyword">if</span> ! kubectl cluster-info &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;❌ 无法连接到Kubernetes集群&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请检查KUBECONFIG设置：<span class="variable">$KUBECONFIG</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查端口是否被占用</span></span><br><span class="line"><span class="keyword">if</span> netstat -tlnp 2&gt;/dev/null | grep -q <span class="string">&quot;:<span class="variable">$&#123;WEBHOOK_PORT&#125;</span> &quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;❌ 端口 <span class="variable">$&#123;WEBHOOK_PORT&#125;</span> 已被占用，请先关闭占用进程&quot;</span></span><br><span class="line">    netstat -tlnp | grep <span class="string">&quot;:<span class="variable">$&#123;WEBHOOK_PORT&#125;</span> &quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第1步：重新生成证书</span></span><br><span class="line"><span class="comment"># 否则启动：panic: open /tmp/k8s-webhook-server/serving-certs/tls.crt: no such file or directory</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;第1步：重新生成TLS证书（支持IP: <span class="variable">$&#123;LOCAL_IP&#125;</span>）...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理旧证书</span></span><br><span class="line"><span class="built_in">rm</span> -rf certs/*</span><br><span class="line"><span class="built_in">mkdir</span> -p certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成新的证书配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; certs/server.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">C = CN</span></span><br><span class="line"><span class="string">ST = Beijing</span></span><br><span class="line"><span class="string">L = Beijing</span></span><br><span class="line"><span class="string">O = Qihoo</span></span><br><span class="line"><span class="string">OU = DevOps</span></span><br><span class="line"><span class="string">CN = *.qihoo.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">keyUsage = keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = *.qihoo.com</span></span><br><span class="line"><span class="string">DNS.2 = k8s.qihoo.com</span></span><br><span class="line"><span class="string">IP.1 = 10.16.217.194</span></span><br><span class="line"><span class="string">IP.2 = 127.0.0.1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成CA证书</span></span><br><span class="line">openssl genrsa -out certs/ca.key 2048 &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl req -new -x509 -days 365 -key certs/ca.key -out certs/ca.crt -subj <span class="string">&quot;/CN=*.qihoo.com&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成服务器证书</span></span><br><span class="line">openssl genrsa -out certs/tls.key 2048 &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl req -new -key certs/tls.key -out certs/server.csr -config certs/server.conf &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> certs/server.csr -CA certs/ca.crt -CAkey certs/ca.key -CAcreateserial -out certs/tls.crt -days 365 -extensions v3_req -extfile certs/server.conf &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ 证书生成完成&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将证书复制到controller-runtime期望的位置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;复制证书到controller-runtime期望的位置...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> certs/tls.crt <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> certs/tls.key <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 644 <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.crt</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 600 <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.key</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> <span class="variable">$USER</span>:<span class="variable">$USER</span> <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.*</span><br><span class="line"><span class="built_in">sudo</span> tree <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ 证书已复制到 <span class="variable">$WEBHOOK_CERT_DIR</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;验证证书内容:&quot;</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.crt -text -noout | grep -E <span class="string">&quot;(Subject:|DNS:|IP Address:)&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示使用说明</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;接下来请按照以下步骤操作：&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1️⃣  在VSCode中设置断点：&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   - 在 webhook Handle 方法开始处设置断点&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2️⃣  启动调试器：&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3️⃣  启动cloudflared，然后根据生成的URL部署validatingwebhookconfiguration&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-2：启动-Cloudflared-隧道"><a href="#步骤-2：启动-Cloudflared-隧道" class="headerlink" title="步骤 2：启动 Cloudflared 隧道"></a>步骤 2：启动 Cloudflared 隧道</h3><p>使用 <code>--no-tls-verify</code> 参数禁用 Cloudflared 对后端 HTTPS 证书的验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cloudflared tunnel --url https://localhost:11443 --no-tls-verify</span><br></pre></td></tr></table></figure>

<p><strong>记录输出的公网 URL</strong>，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------------------------------------------------------------+</span><br><span class="line">|  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable):  |</span><br><span class="line">|  https://since-machinery-ruby-plate.trycloudflare.com                                     |</span><br><span class="line">+--------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>⚠️ 注意</strong>：每次启动 Cloudflared 都会生成新的随机域名，你需要更新 Webhook 配置。</p>
</blockquote>
<p><strong>保持终端运行</strong>，不要关闭 Cloudflared 进程。</p>
<hr>
<h3 id="步骤-3：配置-ValidatingWebhookConfiguration"><a href="#步骤-3：配置-ValidatingWebhookConfiguration" class="headerlink" title="步骤 3：配置 ValidatingWebhookConfiguration"></a>步骤 3：配置 ValidatingWebhookConfiguration</h3><p>创建 Webhook 配置文件 <code>webhook-config.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-lv4-webhook-debug</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev.lb4.webhook.validator</span></span><br><span class="line">  <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="comment"># 使用 Cloudflared 提供的公网 URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://since-machinery-ruby-plate.trycloudflare.com/validate-delete-pods</span></span><br><span class="line">    <span class="comment"># 🔑 关键：caBundle 必须为空</span></span><br><span class="line">    <span class="comment"># 当使用外部 URL 时，API Server 会使用系统信任的 CA 验证证书</span></span><br><span class="line">    <span class="comment"># Cloudflare 的证书已被系统 CA 信任</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 调试阶段设置为 Fail，便于查看错误信息</span></span><br><span class="line">  <span class="comment"># 生产环境可设置为 Ignore</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 命名空间选择器：仅对 default 命名空间生效</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/metadata.name</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">      <span class="attr">values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zxtest</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">objectSelector:</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拦截规则：删除 Pod 操作</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 调试时设置较长超时时间</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p><strong>应用配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f webhook-config.yaml</span><br></pre></td></tr></table></figure>

<p><strong>验证配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Webhook 配置</span></span><br><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认 URL 和 caBundle 设置正确</span></span><br><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug \</span><br><span class="line">    -o jsonpath=<span class="string">&#x27;&#123;.webhooks[0].clientConfig&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="步骤-4：测试-Webhook"><a href="#步骤-4：测试-Webhook" class="headerlink" title="步骤 4：测试 Webhook"></a>步骤 4：测试 Webhook</h3><p><strong>触发 Webhook 验证</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 default 命名空间下Pod，观察 Webhook 是否被调用</span></span><br><span class="line">kubectl delete pod test-pod -n default</span><br></pre></td></tr></table></figure>

<p><strong>预期结果</strong>：</p>
<ul>
<li>✅ VSCode 中的断点被触发</li>
<li>✅ Cloudflared 终端显示请求日志</li>
<li>✅ Pod 删除成功或被拒绝（取决于你的验证逻辑）</li>
</ul>
<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="1-证书验证失败"><a href="#1-证书验证失败" class="headerlink" title="1. 证书验证失败"></a>1. 证书验证失败</h3><p><strong>错误信息</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls: failed to verify certificate: x509: certificate signed by unknown authority</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>：Cloudflared 尝试验证后端 HTTPS 证书，但你使用的是自签名证书。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>✅ 确保启动 Cloudflared 时使用了 <code>--no-tls-verify</code> 参数</li>
<li>✅ 或者使用 HTTP 后端（<code>--url http://localhost:8080</code>）</li>
</ul>
<hr>
<h3 id="2-Webhook-超时"><a href="#2-Webhook-超时" class="headerlink" title="2. Webhook 超时"></a>2. Webhook 超时</h3><p><strong>错误信息</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to call webhook: Post &quot;https://xxx.trycloudflare.com/validate-delete-pods?timeout=10s&quot;: context deadline exceeded</span><br></pre></td></tr></table></figure>

<p><strong>原因</strong>：</p>
<ul>
<li>网络延迟过高</li>
<li>Webhook 处理逻辑耗时过长</li>
<li>Cloudflared 隧道不稳定</li>
</ul>
<p><strong>解决方案</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加超时时间</span></span><br><span class="line"><span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或临时设置为 Ignore 模式</span></span><br><span class="line"><span class="attr">failurePolicy:</span> <span class="string">Ignore</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-Cloudflared-连接断开"><a href="#3-Cloudflared-连接断开" class="headerlink" title="3. Cloudflared 连接断开"></a>3. Cloudflared 连接断开</h3><p><strong>现象</strong>：隧道 URL 无法访问，API Server 调用失败。</p>
<p><strong>解决方案</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 重启 Cloudflared</span></span><br><span class="line">cloudflared tunnel --url https://localhost:11443 --no-tls-verify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 更新 Webhook 配置中的新 URL</span></span><br><span class="line">kubectl edit validatingwebhookconfiguration dev-webhook-debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用命名隧道（生产环境推荐）</span></span><br><span class="line">cloudflared tunnel create my-webhook-tunnel</span><br><span class="line">cloudflared tunnel route dns my-webhook-tunnel webhook.example.com</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-API-Server-无法访问公网"><a href="#4-API-Server-无法访问公网" class="headerlink" title="4. API Server 无法访问公网"></a>4. API Server 无法访问公网</h3><p><strong>现象</strong>：集群在私有网络中，无法访问 Cloudflare 隧道。</p>
<p><strong>解决方案</strong>：在集群内部署 Cloudflared 代理：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudflared-proxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudflared</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cloudflare/cloudflared:latest</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cloudflared</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tunnel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--url</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http://your-webhook-service:8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--no-tls-verify</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-调试断点未触发"><a href="#5-调试断点未触发" class="headerlink" title="5. 调试断点未触发"></a>5. 调试断点未触发</h3><p><strong>检查清单</strong>：</p>
<ol>
<li><p>✅ Controller 是否正常启动？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i :11443</span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ Cloudflared 是否正常运行？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试隧道连通性</span></span><br><span class="line">curl https://since-machinery-ruby-plate.trycloudflare.com/validate-delete-pods</span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ Webhook 配置是否正确？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug -o yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>✅ Pod 是否在正确的命名空间？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认 namespaceSelector 配置</span></span><br><span class="line">kubectl get pod -n default</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="1-使用持久化隧道（生产环境）"><a href="#1-使用持久化隧道（生产环境）" class="headerlink" title="1. 使用持久化隧道（生产环境）"></a>1. 使用持久化隧道（生产环境）</h3><p>临时隧道每次启动 URL 都会变化，不适合长期使用。创建命名隧道：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录 Cloudflare</span></span><br><span class="line">cloudflared tunnel login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建命名隧道</span></span><br><span class="line">cloudflared tunnel create my-webhook-tunnel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置路由</span></span><br><span class="line">cloudflared tunnel route dns my-webhook-tunnel webhook.yourdomain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建配置文件 ~/.cloudflared/config.yml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ~/.cloudflared/config.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">tunnel: &lt;tunnel-id&gt;</span></span><br><span class="line"><span class="string">credentials-file: /path/to/credentials.json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ingress:</span></span><br><span class="line"><span class="string">  - hostname: webhook.yourdomain.com</span></span><br><span class="line"><span class="string">    service: https://localhost:11443</span></span><br><span class="line"><span class="string">    originRequest:</span></span><br><span class="line"><span class="string">      noTLSVerify: true</span></span><br><span class="line"><span class="string">  - service: http_status:404</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动隧道</span></span><br><span class="line">cloudflared tunnel run my-webhook-tunnel</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用 Cloudflared 调试 Kubernetes Webhook 的优势：</p>
<ul>
<li>✅ <strong>零配置</strong>：无需配置防火墙、NAT 或公网 IP</li>
<li>✅ <strong>安全</strong>：使用 Cloudflare 企业级安全隧道</li>
<li>✅ <strong>稳定</strong>：Cloudflare 全球网络保证连接质量</li>
<li>✅ <strong>快速</strong>：几分钟即可完成配置</li>
</ul>
<p><strong>核心要点</strong>：</p>
<ol>
<li>使用 <code>--no-tls-verify</code> 跳过后端证书验证</li>
<li>Webhook 配置中 <code>caBundle</code> 必须为空</li>
<li>依赖 Cloudflare 的受信任证书完成 TLS 握手</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/17/terminationGracePeriodSeconds%E4%B8%8EdeletionGracePeriodSeconds/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/17/terminationGracePeriodSeconds%E4%B8%8EdeletionGracePeriodSeconds/" class="post-title-link" itemprop="url">terminationGracePeriodSeconds与deletionGracePeriodSeconds</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-11-17 17:58:16" itemprop="dateCreated datePublished" datetime="2025-11-17T17:58:16+08:00">2025-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-11-19 15:12:59" itemprop="dateModified" datetime="2025-11-19T15:12:59+08:00">2025-11-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在Kubernetes环境中，当Pod被删除时，kubelet会发送SIGTERM信号给容器进程，启动优雅停止过程。如果预设的grace期限内进程未结束，则发送SIGKILL强制终止。Pod的终止流程包括从service endpoint移除、执行preStopHook、发送SIGTERM、等待进程结束等步骤。为了实现优雅退出，应用需捕获并处理SIGTERM信号，可能需要配合设置preStopHook和terminationGracePeriodSeconds。</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="️⃣-1-terminationGracePeriodSeconds-——-Pod-spec-字段（用户配置）"><a href="#️⃣-1-terminationGracePeriodSeconds-——-Pod-spec-字段（用户配置）" class="headerlink" title="#️⃣ 1. terminationGracePeriodSeconds —— Pod spec 字段（用户配置）"></a>#️⃣ 1. terminationGracePeriodSeconds —— Pod spec 字段（用户配置）</h1><h3 id="✔-所在位置"><a href="#✔-所在位置" class="headerlink" title="✔ 所在位置"></a>✔ 所在位置</h3><p>Pod Spec 字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h3 id="✔-意义"><a href="#✔-意义" class="headerlink" title="✔ 意义"></a>✔ 意义</h3><p><strong>“容器终止前允许它优雅退出的时间”</strong><br>即：K8s 要删除 Pod 时，不是立刻强制杀掉容器，而是：</p>
<ol>
<li>kubelet 先向容器发送 <strong>SIGTERM</strong></li>
<li>等待 <code>terminationGracePeriodSeconds</code> 秒</li>
<li>超时后如果容器仍未退出 → 再发送 <strong>SIGKILL</strong></li>
</ol>
<h3 id="✔-默认值"><a href="#✔-默认值" class="headerlink" title="✔ 默认值"></a>✔ 默认值</h3><p>30 秒。</p>
<h3 id="✔-被哪些机制使用？"><a href="#✔-被哪些机制使用？" class="headerlink" title="✔ 被哪些机制使用？"></a>✔ 被哪些机制使用？</h3><ul>
<li>Pod eviction（驱逐）</li>
<li>Deployment 滚动升级</li>
<li>手动删除 Pod</li>
<li>节点失联时 controller manager 删除 orphaned pods</li>
</ul>
<p>这些都会触发 graceful termination。</p>
<hr>
<h1 id="️⃣-2-deletionGracePeriodSeconds-——-Kubernetes-API（运行时动态产生）"><a href="#️⃣-2-deletionGracePeriodSeconds-——-Kubernetes-API（运行时动态产生）" class="headerlink" title="#️⃣ 2. deletionGracePeriodSeconds —— Kubernetes API（运行时动态产生）"></a>#️⃣ 2. deletionGracePeriodSeconds —— Kubernetes API（运行时动态产生）</h1><h3 id="✔-所在位置-1"><a href="#✔-所在位置-1" class="headerlink" title="✔ 所在位置"></a>✔ 所在位置</h3><p><strong>不在 Pod Spec 内</strong>，属于 metadata 的运行时字段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">deletionTimestamp:</span> <span class="string">&quot;2024-11-14T01:02:03Z&quot;</span></span><br><span class="line">  <span class="attr">deletionGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>➡ <strong>API Server 写入的字段，代表当前删除操作所使用的宽限期。</strong></p>
<h3 id="✔-来自哪里？"><a href="#✔-来自哪里？" class="headerlink" title="✔ 来自哪里？"></a>✔ 来自哪里？</h3><p>来源于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">terminationGracePeriodSeconds</span><br></pre></td></tr></table></figure>

<p>或者用户通过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod podA --grace-period=10</span><br></pre></td></tr></table></figure>

<p>覆盖默认值。</p>
<h3 id="✔-工作方式（Controller-Kubelet）"><a href="#✔-工作方式（Controller-Kubelet）" class="headerlink" title="✔ 工作方式（Controller &amp; Kubelet）"></a>✔ 工作方式（Controller &amp; Kubelet）</h3><p>当你删除 Pod：</p>
<ol>
<li><p>API Server 设置：</p>
<ul>
<li><code>deletionTimestamp</code> &#x3D; 当前时间</li>
<li><code>deletionGracePeriodSeconds</code> &#x3D; 本次删除使用的宽限秒数</li>
</ul>
</li>
<li><p>kubelet 根据这个值（而不是 Spec 里的 terminationGracePeriodSeconds）控制真正的 SIGTERM → SIGKILL 过程。</p>
</li>
</ol>
<p>因此：</p>
<blockquote>
<p><strong>deletionGracePeriodSeconds 是“实际生效”的宽限期。</strong><br><strong>terminationGracePeriodSeconds 是“默认配置”。</strong></p>
</blockquote>
<hr>
<h1 id="️⃣-3-二者关系总结"><a href="#️⃣-3-二者关系总结" class="headerlink" title="#️⃣ 3. 二者关系总结"></a>#️⃣ 3. 二者关系总结</h1><table>
<thead>
<tr>
<th>项目</th>
<th>terminationGracePeriodSeconds</th>
<th>deletionGracePeriodSeconds</th>
</tr>
</thead>
<tbody><tr>
<td>类型</td>
<td>Pod Spec 固定字段</td>
<td>Pod metadata 运行时字段</td>
</tr>
<tr>
<td>谁设置的？</td>
<td>用户写在 YAML 中</td>
<td>API Server 删除 Pod 时自动写入</td>
</tr>
<tr>
<td>何时存在？</td>
<td>Pod 一出生就有</td>
<td>只有 Pod 被删除时才出现</td>
</tr>
<tr>
<td>默认值</td>
<td>30 秒</td>
<td>等于 terminationGracePeriodSeconds</td>
</tr>
<tr>
<td>可以覆盖？</td>
<td>可以（spec 设置）</td>
<td>可被 <code>kubectl delete --grace-period=X</code> 覆盖</td>
</tr>
<tr>
<td>实际生效？</td>
<td>❌（只是默认值）</td>
<td>✅（真正决定 kubelet 等待时间）</td>
</tr>
</tbody></table>
<hr>
<h1 id="️⃣-4-为什么-Kubernetes-需要两个字段？"><a href="#️⃣-4-为什么-Kubernetes-需要两个字段？" class="headerlink" title="#️⃣ 4. 为什么 Kubernetes 需要两个字段？"></a>#️⃣ 4. 为什么 Kubernetes 需要两个字段？</h1><p>原因如下：</p>
<h2 id="✦-①-Pod-Spec-需要一个默认优雅退出时间"><a href="#✦-①-Pod-Spec-需要一个默认优雅退出时间" class="headerlink" title="✦ ① Pod Spec 需要一个默认优雅退出时间"></a>✦ ① Pod Spec 需要一个默认优雅退出时间</h2><p>应用有不同的退出需求，如：</p>
<ul>
<li>Web 服务器需要 10s 关闭连接</li>
<li>数据库需要 60s flush 数据</li>
<li>Stream 服务需要完成正在发送的数据包</li>
</ul>
<p>于是 <code>terminationGracePeriodSeconds</code> 用来为 Pod <strong>设定统一默认退出策略</strong>。</p>
<hr>
<h2 id="✦-②-删除操作可能需要临时修改退出宽限期"><a href="#✦-②-删除操作可能需要临时修改退出宽限期" class="headerlink" title="✦ ② 删除操作可能需要临时修改退出宽限期"></a>✦ ② 删除操作可能需要临时修改退出宽限期</h2><p>例如：</p>
<h3 id="✔-强制删除"><a href="#✔-强制删除" class="headerlink" title="✔ 强制删除"></a>✔ 强制删除</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod A --grace-period=0 --force</span><br></pre></td></tr></table></figure>

<p>这时：</p>
<ul>
<li><strong>不会修改 pod.spec.terminationGracePeriodSeconds</strong></li>
<li>但 <strong>metadata.deletionGracePeriodSeconds &#x3D; 0</strong></li>
</ul>
<p>kubelet 看到 0 → 立即 SIGKILL。</p>
<hr>
<h2 id="✦-③-deletionGracePeriodSeconds-表示-Pod-正在-termination-状态"><a href="#✦-③-deletionGracePeriodSeconds-表示-Pod-正在-termination-状态" class="headerlink" title="✦ ③ deletionGracePeriodSeconds 表示 Pod 正在 termination 状态"></a>✦ ③ deletionGracePeriodSeconds 表示 Pod 正在 termination 状态</h2><p>带有：</p>
<ul>
<li>deletionTimestamp</li>
<li>deletionGracePeriodSeconds</li>
</ul>
<p>API Server 认为 Pod 处于 “Terminating”，controller manager 和 kubelet由此处理清理流程。</p>
<hr>
<h1 id="️⃣-5-结合例子理解（最清晰）"><a href="#️⃣-5-结合例子理解（最清晰）" class="headerlink" title="#️⃣ 5. 结合例子理解（最清晰）"></a>#️⃣ 5. 结合例子理解（最清晰）</h1><h3 id="Pod-YAML（用户写的）："><a href="#Pod-YAML（用户写的）：" class="headerlink" title="Pod YAML（用户写的）："></a>Pod YAML（用户写的）：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h3 id="删除命令："><a href="#删除命令：" class="headerlink" title="删除命令："></a>删除命令：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod mypod</span><br></pre></td></tr></table></figure>

<h3 id="Pod-在-API-Server-会变成："><a href="#Pod-在-API-Server-会变成：" class="headerlink" title="Pod 在 API Server 会变成："></a>Pod 在 API Server 会变成：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">deletionTimestamp:</span> <span class="string">&quot;2025-11-17T08:00:00Z&quot;</span></span><br><span class="line">  <span class="attr">deletionGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>kubelet 会等待 30 秒后强杀</li>
</ul>
<hr>
<h3 id="覆盖默认值："><a href="#覆盖默认值：" class="headerlink" title="覆盖默认值："></a>覆盖默认值：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod mypod --grace-period=5</span><br></pre></td></tr></table></figure>

<p>API Server 变成：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">deletionGracePeriodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>此时 kubelet 的实际宽限期是 5 秒，而不是 Spec 中的 30 秒。</p>
<hr>
<h1 id="️⃣-6-哪些场景必须关注这两个值？"><a href="#️⃣-6-哪些场景必须关注这两个值？" class="headerlink" title="#️⃣ 6. 哪些场景必须关注这两个值？"></a>#️⃣ 6. 哪些场景必须关注这两个值？</h1><h3 id="✔-滚动升级慢"><a href="#✔-滚动升级慢" class="headerlink" title="✔ 滚动升级慢"></a>✔ 滚动升级慢</h3><p>容器退出慢 → 需要增大 terminationGracePeriodSeconds。</p>
<h3 id="✔-Pod-一直处于-Terminating"><a href="#✔-Pod-一直处于-Terminating" class="headerlink" title="✔ Pod 一直处于 Terminating"></a>✔ Pod 一直处于 Terminating</h3><p>检查 deletionGracePeriodSeconds 表示实际等待多久。</p>
<h3 id="✔-强制删除-Pod-时需要明确-grace-period-0-的行为"><a href="#✔-强制删除-Pod-时需要明确-grace-period-0-的行为" class="headerlink" title="✔ 强制删除 Pod 时需要明确 --grace-period=0 的行为"></a>✔ 强制删除 Pod 时需要明确 <code>--grace-period=0</code> 的行为</h3><p>它不会改 spec，但会影响 metadata 的实际值。</p>
<h3 id="✔-Stateful-workloads（DB，消息队列）需要更长的宽限期"><a href="#✔-Stateful-workloads（DB，消息队列）需要更长的宽限期" class="headerlink" title="✔ Stateful workloads（DB，消息队列）需要更长的宽限期"></a>✔ Stateful workloads（DB，消息队列）需要更长的宽限期</h3><p>否则容易数据损坏或主从 failover。</p>
<hr>
<h1 id="⭐-最后一段总结（可直接加入知识库）"><a href="#⭐-最后一段总结（可直接加入知识库）" class="headerlink" title="⭐ 最后一段总结（可直接加入知识库）"></a>⭐ 最后一段总结（可直接加入知识库）</h1><ul>
<li><p><code>terminationGracePeriodSeconds</code> &#x3D; Pod 的 <strong>默认优雅退出时间</strong>，用户定义。</p>
</li>
<li><p><code>deletionGracePeriodSeconds</code> &#x3D; Pod <strong>被删除时真正采用的宽限期</strong>，由 API Server 设置，可被强制覆盖。</p>
</li>
<li><p>二者共同决定了 Pod 的生命周期：</p>
<ul>
<li>Pod 配置退出策略（spec）</li>
<li>具体删除动作由 API server 在 metadata 记录（metadata）</li>
</ul>
</li>
</ul>
<hr>
<h1 id="⭐-terminationGracePeriodSeconds-设计核心原则（总结）"><a href="#⭐-terminationGracePeriodSeconds-设计核心原则（总结）" class="headerlink" title="⭐ terminationGracePeriodSeconds 设计核心原则（总结）"></a>⭐ terminationGracePeriodSeconds 设计核心原则（总结）</h1><table>
<thead>
<tr>
<th>原则</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>1. 与业务退出耗时相匹配</td>
<td>不够会被 SIGKILL</td>
</tr>
<tr>
<td>2. 大于 preStop 脚本执行时间</td>
<td>防止脚本被中断</td>
</tr>
<tr>
<td>3. 大于 LB 连接迁移耗时</td>
<td>防止客户端访问异常</td>
</tr>
<tr>
<td>4. 必须进行业务侧 graceful shutdown</td>
<td>否则延长时间也没用</td>
</tr>
<tr>
<td>5. 对长任务必须设计 checkpoint</td>
<td>不然永远无法优雅终止</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/13/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2k3s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/13/%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2k3s/" class="post-title-link" itemprop="url">安装部署k3s</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-13 17:12:18 / 修改时间：23:00:10" itemprop="dateCreated datePublished" datetime="2025-11-13T17:12:18+08:00">2025-11-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s/3314">https://forums.rancher.cn/t/k3s/3314</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | \</span><br><span class="line">  INSTALL_K3S_MIRROR=cn \</span><br><span class="line">  INSTALL_K3S_SKIP_SELINUX_RPM=true \</span><br><span class="line">  K3S_TOKEN=12345 sh -s - \</span><br><span class="line">  --system-default-registry=registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
<p>📘 说明：<br>• INSTALL_K3S_SKIP_SELINUX_RPM&#x3D;true：告诉安装脚本跳过 k3s-selinux 安装；</p>
<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status k3s</span><br><span class="line"></span><br><span class="line">k3s --version</span><br></pre></td></tr></table></figure>

<h3 id="🧠-K3s-的-kubeconfig-默认路径"><a href="#🧠-K3s-的-kubeconfig-默认路径" class="headerlink" title="🧠 K3s 的 kubeconfig 默认路径"></a>🧠 K3s 的 kubeconfig 默认路径</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#默认路径</span><br><span class="line">/etc/rancher/k3s/k3s.yaml</span><br><span class="line"></span><br><span class="line">#kubectl 使用时需要显式指定该配置文件，或者将其复制到 $HOME/.kube/config。</span><br><span class="line">kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get nodes</span><br><span class="line"></span><br><span class="line">#copy</span><br><span class="line">sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></pre></td></tr></table></figure>

<h3 id="部署helm"><a href="#部署helm" class="headerlink" title="部署helm"></a>部署helm</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#helm与k8s版本兼容匹配：https://helm.sh/zh/docs/topics/version_skew</span><br><span class="line">wget https://get.helm.sh/helm-v3.15.3-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v3.15.3-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="部署cert-manager"><a href="#部署cert-manager" class="headerlink" title="部署cert-manager"></a>部署cert-manager</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#安装certcert-manager</span><br><span class="line">#安装CRD： https://github.com/cert-manager/cert-manager/releases</span><br><span class="line"></span><br><span class="line">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/&lt;VERSION&gt;/cert-manager.crds.yaml</span><br><span class="line">eg:</span><br><span class="line">https://github.com/cert-manager/cert-manager/releases/download/v1.19.1/cert-manager.crds.yaml</span><br><span class="line"></span><br><span class="line">#使用helm安装</span><br><span class="line">helm repo add jetstack https://charts.jetstack.io</span><br><span class="line"></span><br><span class="line">helm repo update</span><br><span class="line">helm install cert-manager jetstack/cert-manager \</span><br><span class="line"> --namespace cert-manager \</span><br><span class="line"> --create-namespace</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/13/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/13/%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">系统性能测试完全指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-13 14:14:11 / 修改时间：14:15:06" itemprop="dateCreated datePublished" datetime="2025-11-13T14:14:11+08:00">2025-11-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux系统性能测试完全指南-🚀"><a href="#Linux系统性能测试完全指南-🚀" class="headerlink" title="Linux系统性能测试完全指南 🚀"></a>Linux系统性能测试完全指南 🚀</h1><h2 id="一、截图命令分析"><a href="#一、截图命令分析" class="headerlink" title="一、截图命令分析"></a>一、截图命令分析</h2><h3 id="📊-系统状态概览"><a href="#📊-系统状态概览" class="headerlink" title="📊 系统状态概览"></a>📊 系统状态概览</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top - 12:49:30 up 7 days, 1:57, 3 <span class="built_in">users</span>, load average: 12.87, 10.83, 7.73</span><br></pre></td></tr></table></figure>

<p><strong>解析：</strong></p>
<ul>
<li><code>12:49:30</code> - 当前系统时间</li>
<li><code>up 7 days, 1:57</code> - 系统运行了7天1小时57分钟</li>
<li><code>3 users</code> - 3个用户登录</li>
<li><code>load average: 12.87, 10.83, 7.73</code> - <strong>系统负载（1分钟、5分钟、15分钟平均值）</strong><ul>
<li>💡 <strong>这个值很高！</strong> 对于一个CPU核心，理想值应该 &lt; 1.0</li>
<li>如果你有20核CPU，12.87意味着60%的负载，尚可接受</li>
<li>如果只有8核，说明系统严重过载（160%负载）</li>
</ul>
</li>
</ul>
<h3 id="💾-内存使用情况"><a href="#💾-内存使用情况" class="headerlink" title="💾 内存使用情况"></a>💾 内存使用情况</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MiB Mem : 191787.3 total, 40167.1 free, 124708.3 used, 26912.0 buff/cache</span><br><span class="line">MiB Swap: 4096.0 total, 3892.9 free, 203.1 used. 50499.3 avail Mem</span><br></pre></td></tr></table></figure>

<p><strong>解析：</strong></p>
<ul>
<li><strong>物理内存：</strong> 192GB总量<ul>
<li>已用：124GB (65%)</li>
<li>空闲：40GB (21%)</li>
<li>缓存：27GB (14%)</li>
<li><strong>可用内存：50GB</strong> （包含可回收的缓存）</li>
</ul>
</li>
<li><strong>Swap交换分区：</strong> 4GB<ul>
<li>已用：203MB (5%) - 正常，说明内存压力不大</li>
</ul>
</li>
</ul>
<p><strong>评估：</strong> ✅ 内存使用率65%，尚有余量，健康状态</p>
<h3 id="🔥-进程分析"><a href="#🔥-进程分析" class="headerlink" title="🔥 进程分析"></a>🔥 进程分析</h3><p>从截图中看到大量 <code>stress-ng</code> 和 <code>dd</code> 命令：</p>
<h4 id="1-stress-ng-命令"><a href="#1-stress-ng-命令" class="headerlink" title="1. stress-ng 命令"></a><strong>1. stress-ng 命令</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress-ng --vm 3 --vm-bytes 28.05G --vm-method all --vm-hang 0 --<span class="built_in">timeout</span> 0</span><br></pre></td></tr></table></figure>

<p><strong>含义：</strong></p>
<ul>
<li><code>--vm 3</code> - 启动3个虚拟内存压测进程</li>
<li><code>--vm-bytes 28.05G</code> - 每个进程分配28GB内存</li>
<li><code>--vm-method all</code> - 使用所有内存压测方法（读写、复制、排序等）</li>
<li><code>--vm-hang 0</code> - 不挂起进程</li>
<li><code>--timeout 0</code> - 无限期运行（直到手动停止）</li>
</ul>
<p><strong>目的：</strong> 对内存进行压力测试</p>
<h4 id="2-stress-ng-CPU-测试"><a href="#2-stress-ng-CPU-测试" class="headerlink" title="2. stress-ng CPU 测试"></a><strong>2. stress-ng CPU 测试</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress-ng --cpu 21 --cpu-method matrixprod --<span class="built_in">timeout</span> 0</span><br></pre></td></tr></table></figure>

<p><strong>含义：</strong></p>
<ul>
<li><code>--cpu 21</code> - 启动21个CPU压测进程</li>
<li><code>--cpu-method matrixprod</code> - 使用矩阵乘法算法（高强度计算）</li>
<li><code>--timeout 0</code> - 持续运行</li>
</ul>
<p><strong>目的：</strong> 对CPU进行满负载压力测试</p>
<h4 id="3-dd-磁盘测试"><a href="#3-dd-磁盘测试" class="headerlink" title="3. dd 磁盘测试"></a><strong>3. dd 磁盘测试</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/shm/memhog_5 bs=1G count=5 iflag=fullblock</span><br></pre></td></tr></table></figure>

<p><strong>含义：</strong></p>
<ul>
<li><code>if=/dev/zero</code> - 输入源：无限产生0字节的设备</li>
<li><code>of=/dev/shm/memhog_5</code> - 输出到共享内存（RAM磁盘）</li>
<li><code>bs=1G</code> - 块大小1GB</li>
<li><code>count=5</code> - 写入5个块（总共5GB）</li>
<li><code>iflag=fullblock</code> - 确保读取完整块</li>
</ul>
<p><strong>目的：</strong> 测试内存写入性能（这里测试的是RAM，不是磁盘）</p>
<h4 id="4-ping-命令"><a href="#4-ping-命令" class="headerlink" title="4. ping 命令"></a><strong>4. ping 命令</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -f -s 1 127.0.0.1</span><br></pre></td></tr></table></figure>

<p><strong>含义：</strong></p>
<ul>
<li><code>-f</code> - 洪水ping（尽可能快地发送数据包）</li>
<li><code>-s 1</code> - 数据包大小1字节</li>
<li><code>127.0.0.1</code> - 本地回环接口</li>
</ul>
<p><strong>目的：</strong> 测试网络栈和本地网络性能</p>
<hr>
<h2 id="二、CPU性能测试最佳实践"><a href="#二、CPU性能测试最佳实践" class="headerlink" title="二、CPU性能测试最佳实践"></a>二、CPU性能测试最佳实践</h2><h3 id="🔧-工具1-stress-ng-推荐"><a href="#🔧-工具1-stress-ng-推荐" class="headerlink" title="🔧 工具1: stress-ng (推荐)"></a>🔧 工具1: stress-ng (推荐)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install stress-ng  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line"><span class="built_in">sudo</span> yum install stress-ng  <span class="comment"># CentOS/RHEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础CPU测试（使用所有核心）</span></span><br><span class="line">stress-ng --cpu 0 --cpu-method all --metrics --<span class="built_in">timeout</span> 60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定核心数测试（例如测试8核）</span></span><br><span class="line">stress-ng --cpu 8 --cpu-method matrixprod --metrics --<span class="built_in">timeout</span> 60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多种方法综合测试</span></span><br><span class="line">stress-ng --cpu 4 --cpu-method int64 --<span class="built_in">timeout</span> 30s</span><br><span class="line">stress-ng --cpu 4 --cpu-method <span class="built_in">float</span> --<span class="built_in">timeout</span> 30s</span><br><span class="line">stress-ng --cpu 4 --cpu-method ackermann --<span class="built_in">timeout</span> 30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有可用的CPU测试方法</span></span><br><span class="line">stress-ng --cpu-method <span class="built_in">which</span></span><br></pre></td></tr></table></figure>

<p><strong>推荐配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生产环境预演测试（70%负载，持续5分钟）</span></span><br><span class="line">NUM_CORES=$(<span class="built_in">nproc</span>)</span><br><span class="line">LOAD_CORES=$((NUM_CORES * <span class="number">70</span> / <span class="number">100</span>))</span><br><span class="line">stress-ng --cpu <span class="variable">$LOAD_CORES</span> --cpu-method matrixprod --metrics --<span class="built_in">timeout</span> 300s</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具2-sysbench"><a href="#🔧-工具2-sysbench" class="headerlink" title="🔧 工具2: sysbench"></a>🔧 工具2: sysbench</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install sysbench</span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU性能测试</span></span><br><span class="line">sysbench cpu --cpu-max-prime=20000 --threads=8 run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多线程测试（测试线程扩展性）</span></span><br><span class="line"><span class="keyword">for</span> threads <span class="keyword">in</span> 1 2 4 8 16; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Testing with <span class="variable">$threads</span> threads&quot;</span></span><br><span class="line">    sysbench cpu --cpu-max-prime=20000 --threads=<span class="variable">$threads</span> run</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具3-htop-top-实时监控"><a href="#🔧-工具3-htop-top-实时监控" class="headerlink" title="🔧 工具3: htop&#x2F;top 实时监控"></a>🔧 工具3: htop&#x2F;top 实时监控</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装htop（更友好）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install htop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动htop</span></span><br><span class="line">htop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按键说明：</span></span><br><span class="line"><span class="comment"># F2 - 设置</span></span><br><span class="line"><span class="comment"># F5 - 树状视图</span></span><br><span class="line"><span class="comment"># F6 - 排序选择</span></span><br><span class="line"><span class="comment"># P - 按CPU使用率排序</span></span><br><span class="line"><span class="comment"># M - 按内存使用率排序</span></span><br><span class="line"><span class="comment"># T - 按运行时间排序</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具4-mpstat-多核详细监控"><a href="#🔧-工具4-mpstat-多核详细监控" class="headerlink" title="🔧 工具4: mpstat (多核详细监控)"></a>🔧 工具4: mpstat (多核详细监控)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装sysstat包</span></span><br><span class="line"><span class="built_in">sudo</span> apt install sysstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每2秒输出一次，显示每个CPU核心的使用率</span></span><br><span class="line">mpstat -P ALL 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续监控30秒</span></span><br><span class="line">mpstat -P ALL 2 15</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出解释：</span></span><br><span class="line"><span class="comment"># %usr - 用户态CPU时间</span></span><br><span class="line"><span class="comment"># %sys - 内核态CPU时间</span></span><br><span class="line"><span class="comment"># %idle - 空闲时间</span></span><br><span class="line"><span class="comment"># %iowait - 等待I/O的时间（高则说明磁盘瓶颈）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、内存性能测试最佳实践"><a href="#三、内存性能测试最佳实践" class="headerlink" title="三、内存性能测试最佳实践"></a>三、内存性能测试最佳实践</h2><h3 id="🔧-工具1-stress-ng-内存测试"><a href="#🔧-工具1-stress-ng-内存测试" class="headerlink" title="🔧 工具1: stress-ng 内存测试"></a>🔧 工具1: stress-ng 内存测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础内存压测（分配80%可用内存）</span></span><br><span class="line">TOTAL_MEM=$(free -g | awk <span class="string">&#x27;/^Mem:/&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">TEST_MEM=$((TOTAL_MEM * <span class="number">80</span> / <span class="number">100</span>))</span><br><span class="line">stress-ng --vm 4 --vm-bytes <span class="variable">$&#123;TEST_MEM&#125;</span>G --vm-method all --<span class="built_in">timeout</span> 300s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存读写性能测试</span></span><br><span class="line">stress-ng --vm 2 --vm-bytes 4G --vm-method write64 --metrics --<span class="built_in">timeout</span> 60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存带宽测试</span></span><br><span class="line">stress-ng --stream 4 --stream-L3-size 8M --metrics --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具2-memtester-内存稳定性测试"><a href="#🔧-工具2-memtester-内存稳定性测试" class="headerlink" title="🔧 工具2: memtester (内存稳定性测试)"></a>🔧 工具2: memtester (内存稳定性测试)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install memtester</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试2GB内存，运行5次</span></span><br><span class="line"><span class="built_in">sudo</span> memtester 2G 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 警告：会占用真实物理内存，可能导致OOM</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具3-sysbench-内存测试"><a href="#🔧-工具3-sysbench-内存测试" class="headerlink" title="🔧 工具3: sysbench 内存测试"></a>🔧 工具3: sysbench 内存测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内存连续读写测试</span></span><br><span class="line">sysbench memory --memory-block-size=1K --memory-total-size=10G run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机访问测试</span></span><br><span class="line">sysbench memory --memory-block-size=1K --memory-total-size=10G \</span><br><span class="line">    --memory-access-mode=rnd run</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具4-vmstat-内存动态监控"><a href="#🔧-工具4-vmstat-内存动态监控" class="headerlink" title="🔧 工具4: vmstat (内存动态监控)"></a>🔧 工具4: vmstat (内存动态监控)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每2秒刷新一次</span></span><br><span class="line">vmstat 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出解释：</span></span><br><span class="line"><span class="comment"># swpd - 使用的swap大小（持续非0说明内存不足）</span></span><br><span class="line"><span class="comment"># free - 空闲内存</span></span><br><span class="line"><span class="comment"># buff - 缓冲区内存</span></span><br><span class="line"><span class="comment"># cache - 缓存内存</span></span><br><span class="line"><span class="comment"># si - 从swap读入内存（非0说明内存压力大）</span></span><br><span class="line"><span class="comment"># so - 从内存写入swap（非0说明内存压力大）</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具5-free-命令详解"><a href="#🔧-工具5-free-命令详解" class="headerlink" title="🔧 工具5: free 命令详解"></a>🔧 工具5: free 命令详解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以人类可读方式显示</span></span><br><span class="line">free -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续监控（每2秒刷新）</span></span><br><span class="line">watch -n 2 free -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详细输出</span></span><br><span class="line">free -h -w</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、磁盘I-O性能测试最佳实践"><a href="#四、磁盘I-O性能测试最佳实践" class="headerlink" title="四、磁盘I&#x2F;O性能测试最佳实践"></a>四、磁盘I&#x2F;O性能测试最佳实践</h2><h3 id="🔧-工具1-fio-最专业的磁盘测试工具"><a href="#🔧-工具1-fio-最专业的磁盘测试工具" class="headerlink" title="🔧 工具1: fio (最专业的磁盘测试工具)"></a>🔧 工具1: fio (最专业的磁盘测试工具)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install fio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机读测试（4K块，IOPS性能）</span></span><br><span class="line">fio --name=random-read --ioengine=libaio --rw=randread --bs=4k \</span><br><span class="line">    --numjobs=4 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/test.fio --size=1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机写测试</span></span><br><span class="line">fio --name=random-write --ioengine=libaio --rw=randwrite --bs=4k \</span><br><span class="line">    --numjobs=4 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/test.fio --size=1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 顺序读测试（带宽性能）</span></span><br><span class="line">fio --name=seq-read --ioengine=libaio --rw=<span class="built_in">read</span> --bs=1M \</span><br><span class="line">    --numjobs=1 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/test.fio --size=2G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 顺序写测试</span></span><br><span class="line">fio --name=seq-write --ioengine=libaio --rw=write --bs=1M \</span><br><span class="line">    --numjobs=1 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/test.fio --size=2G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 混合读写测试（70%读，30%写）</span></span><br><span class="line">fio --name=randrw --ioengine=libaio --rw=randrw --rwmixread=70 \</span><br><span class="line">    --bs=4k --numjobs=4 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/test.fio --size=1G</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具2-dd-简单快速测试"><a href="#🔧-工具2-dd-简单快速测试" class="headerlink" title="🔧 工具2: dd (简单快速测试)"></a>🔧 工具2: dd (简单快速测试)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入测试（测试写入速度）</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/tmp/test.img bs=1G count=1 oflag=direct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取测试（清空缓存后测试）</span></span><br><span class="line"><span class="built_in">sudo</span> sh -c <span class="string">&quot;sync; echo 3 &gt; /proc/sys/vm/drop_caches&quot;</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/tmp/test.img of=/dev/null bs=1G count=1 iflag=direct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理测试文件</span></span><br><span class="line"><span class="built_in">rm</span> -f /tmp/test.img</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具3-hdparm-磁盘设备测试"><a href="#🔧-工具3-hdparm-磁盘设备测试" class="headerlink" title="🔧 工具3: hdparm (磁盘设备测试)"></a>🔧 工具3: hdparm (磁盘设备测试)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install hdparm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试磁盘读取速度</span></span><br><span class="line"><span class="built_in">sudo</span> hdparm -t /dev/sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试缓存读取速度</span></span><br><span class="line"><span class="built_in">sudo</span> hdparm -T /dev/sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘详细信息</span></span><br><span class="line"><span class="built_in">sudo</span> hdparm -I /dev/sda</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具4-iostat-I-O实时监控"><a href="#🔧-工具4-iostat-I-O实时监控" class="headerlink" title="🔧 工具4: iostat (I&#x2F;O实时监控)"></a>🔧 工具4: iostat (I&#x2F;O实时监控)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装（包含在sysstat中）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install sysstat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每2秒刷新一次，显示扩展信息</span></span><br><span class="line">iostat -x 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示特定设备</span></span><br><span class="line">iostat -x /dev/sda 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出解释：</span></span><br><span class="line"><span class="comment"># %util - 磁盘繁忙程度（&gt;80%说明磁盘瓶颈）</span></span><br><span class="line"><span class="comment"># r/s - 每秒读请求数</span></span><br><span class="line"><span class="comment"># w/s - 每秒写请求数</span></span><br><span class="line"><span class="comment"># rkB/s - 每秒读取KB</span></span><br><span class="line"><span class="comment"># wkB/s - 每秒写入KB</span></span><br><span class="line"><span class="comment"># await - 平均等待时间（ms）</span></span><br><span class="line"><span class="comment"># svctm - 平均服务时间（ms）</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具5-iotop-查看哪个进程占用I-O"><a href="#🔧-工具5-iotop-查看哪个进程占用I-O" class="headerlink" title="🔧 工具5: iotop (查看哪个进程占用I&#x2F;O)"></a>🔧 工具5: iotop (查看哪个进程占用I&#x2F;O)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install iotop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动iotop</span></span><br><span class="line"><span class="built_in">sudo</span> iotop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只显示有I/O活动的进程</span></span><br><span class="line"><span class="built_in">sudo</span> iotop -o</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按键说明：</span></span><br><span class="line"><span class="comment"># 左右箭头 - 改变排序列</span></span><br><span class="line"><span class="comment"># r - 反向排序</span></span><br><span class="line"><span class="comment"># o - 只显示有I/O的进程</span></span><br><span class="line"><span class="comment"># p - 按PID排序</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、网络性能测试最佳实践"><a href="#五、网络性能测试最佳实践" class="headerlink" title="五、网络性能测试最佳实践"></a>五、网络性能测试最佳实践</h2><h3 id="🔧-工具1-iperf3-带宽测试"><a href="#🔧-工具1-iperf3-带宽测试" class="headerlink" title="🔧 工具1: iperf3 (带宽测试)"></a>🔧 工具1: iperf3 (带宽测试)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt install iperf3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在服务器端启动（假设服务器IP: 192.168.1.100）</span></span><br><span class="line">iperf3 -s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在客户端测试（带宽测试）</span></span><br><span class="line">iperf3 -c 192.168.1.100 -t 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP并发测试（10个并发流）</span></span><br><span class="line">iperf3 -c 192.168.1.100 -P 10 -t 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># UDP带宽测试（指定带宽1Gbps）</span></span><br><span class="line">iperf3 -c 192.168.1.100 -u -b 1G -t 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向测试（服务器向客户端发送）</span></span><br><span class="line">iperf3 -c 192.168.1.100 -R -t 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># 双向测试</span></span><br><span class="line">iperf3 -c 192.168.1.100 --bidir -t 60</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具2-ping-延迟测试"><a href="#🔧-工具2-ping-延迟测试" class="headerlink" title="🔧 工具2: ping (延迟测试)"></a>🔧 工具2: ping (延迟测试)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础ping测试</span></span><br><span class="line">ping -c 100 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 大包ping（测试MTU）</span></span><br><span class="line">ping -c 100 -s 1472 8.8.8.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 洪水ping（需要root权限）</span></span><br><span class="line"><span class="built_in">sudo</span> ping -f -c 10000 192.168.1.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计摘要</span></span><br><span class="line">ping -c 100 -q 8.8.8.8</span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具3-netstat-ss-连接状态监控"><a href="#🔧-工具3-netstat-ss-连接状态监控" class="headerlink" title="🔧 工具3: netstat&#x2F;ss (连接状态监控)"></a>🔧 工具3: netstat&#x2F;ss (连接状态监控)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有TCP连接</span></span><br><span class="line">ss -ant</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看监听端口</span></span><br><span class="line">ss -lntp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计连接状态</span></span><br><span class="line">ss -s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看连接最多的IP</span></span><br><span class="line">ss -ant | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span> | <span class="built_in">cut</span> -d: -f1 | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -rn | <span class="built_in">head</span></span><br></pre></td></tr></table></figure>

<h3 id="🔧-工具4-sar-网络历史数据"><a href="#🔧-工具4-sar-网络历史数据" class="headerlink" title="🔧 工具4: sar (网络历史数据)"></a>🔧 工具4: sar (网络历史数据)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网络接口统计（每2秒一次）</span></span><br><span class="line">sar -n DEV 2 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看TCP统计</span></span><br><span class="line">sar -n TCP 2 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看错误统计</span></span><br><span class="line">sar -n EDEV 2 10</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、综合压力测试脚本"><a href="#六、综合压力测试脚本" class="headerlink" title="六、综合压力测试脚本"></a>六、综合压力测试脚本</h2><h3 id="📝-完整的系统压测脚本"><a href="#📝-完整的系统压测脚本" class="headerlink" title="📝 完整的系统压测脚本"></a>📝 完整的系统压测脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 系统全面性能测试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">LOG_DIR=<span class="string">&quot;./performance_test_<span class="subst">$(date +%Y%m%d_%H%M%S)</span>&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$LOG_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 系统性能测试开始 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;日志目录: <span class="variable">$LOG_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 系统信息收集</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;收集系统信息...&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 系统信息 ===&quot;</span></span><br><span class="line">    <span class="built_in">uname</span> -a</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== CPU信息 ===&quot;</span></span><br><span class="line">    lscpu</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 内存信息 ===&quot;</span></span><br><span class="line">    free -h</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 磁盘信息 ===&quot;</span></span><br><span class="line">    <span class="built_in">df</span> -h</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;=== 负载信息 ===&quot;</span></span><br><span class="line">    <span class="built_in">uptime</span></span><br><span class="line">&#125; &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/system_info.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. CPU压力测试（60秒）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始CPU压力测试（60秒）...&quot;</span></span><br><span class="line">NUM_CORES=$(<span class="built_in">nproc</span>)</span><br><span class="line">stress-ng --cpu <span class="variable">$NUM_CORES</span> --cpu-method matrixprod --metrics \</span><br><span class="line">    --<span class="built_in">timeout</span> 60s &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/cpu_stress.log&quot;</span> 2&gt;&amp;1 &amp;</span><br><span class="line">STRESS_PID=$!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同时监控</span></span><br><span class="line">mpstat -P ALL 2 30 &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/cpu_monitor.log&quot;</span> &amp;</span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$STRESS_PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 内存压力测试（60秒）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始内存压力测试（60秒）...&quot;</span></span><br><span class="line">TOTAL_MEM=$(free -g | awk <span class="string">&#x27;/^Mem:/&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">TEST_MEM=$((TOTAL_MEM * <span class="number">50</span> / <span class="number">100</span>))</span><br><span class="line">stress-ng --vm 4 --vm-bytes <span class="variable">$&#123;TEST_MEM&#125;</span>G --vm-method all \</span><br><span class="line">    --<span class="built_in">timeout</span> 60s --metrics &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/memory_stress.log&quot;</span> 2&gt;&amp;1 &amp;</span><br><span class="line">STRESS_PID=$!</span><br><span class="line"></span><br><span class="line">vmstat 2 30 &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/memory_monitor.log&quot;</span> &amp;</span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$STRESS_PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 磁盘I/O测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始磁盘I/O测试（60秒）...&quot;</span></span><br><span class="line">fio --name=disk-test --ioengine=libaio --rw=randrw --rwmixread=70 \</span><br><span class="line">    --bs=4k --numjobs=4 --iodepth=32 --runtime=60 --time_based \</span><br><span class="line">    --filename=/tmp/fio_test.tmp --size=1G \</span><br><span class="line">    --output=<span class="string">&quot;<span class="variable">$LOG_DIR</span>/disk_io.log&quot;</span> &amp;</span><br><span class="line">FIO_PID=$!</span><br><span class="line"></span><br><span class="line">iostat -x 2 30 &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/iostat_monitor.log&quot;</span> &amp;</span><br><span class="line"><span class="built_in">sleep</span> 60</span><br><span class="line"><span class="built_in">wait</span> <span class="variable">$FIO_PID</span></span><br><span class="line"><span class="built_in">rm</span> -f /tmp/fio_test.tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 生成测试报告</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;生成测试报告...&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;===================================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   系统性能测试报告&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   测试时间: <span class="subst">$(date)</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;===================================&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;详细日志请查看 <span class="variable">$LOG_DIR</span> 目录&quot;</span></span><br><span class="line">&#125; &gt; <span class="string">&quot;<span class="variable">$LOG_DIR</span>/REPORT.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 测试完成 ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;报告保存在: <span class="variable">$LOG_DIR</span>/REPORT.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>使用方法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x performance_test.sh</span><br><span class="line"><span class="built_in">sudo</span> ./performance_test.sh</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、监控命令速查表"><a href="#七、监控命令速查表" class="headerlink" title="七、监控命令速查表"></a>七、监控命令速查表</h2><table>
<thead>
<tr>
<th>监控对象</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>综合监控</strong></td>
<td><code>top</code> &#x2F; <code>htop</code></td>
<td>实时系统资源监控</td>
</tr>
<tr>
<td><strong>CPU</strong></td>
<td><code>mpstat -P ALL 2</code></td>
<td>每个核心的使用率</td>
</tr>
<tr>
<td></td>
<td><code>sar -u 2 10</code></td>
<td>CPU历史统计</td>
</tr>
<tr>
<td></td>
<td><code>lscpu</code></td>
<td>CPU详细信息</td>
</tr>
<tr>
<td><strong>内存</strong></td>
<td><code>free -h</code></td>
<td>内存使用概览</td>
</tr>
<tr>
<td></td>
<td><code>vmstat 2</code></td>
<td>内存动态监控</td>
</tr>
<tr>
<td></td>
<td><code>sar -r 2 10</code></td>
<td>内存历史统计</td>
</tr>
<tr>
<td><strong>磁盘I&#x2F;O</strong></td>
<td><code>iostat -x 2</code></td>
<td>磁盘I&#x2F;O统计</td>
</tr>
<tr>
<td></td>
<td><code>iotop</code></td>
<td>进程I&#x2F;O排行</td>
</tr>
<tr>
<td></td>
<td><code>df -h</code></td>
<td>磁盘空间使用</td>
</tr>
<tr>
<td><strong>网络</strong></td>
<td><code>iftop</code></td>
<td>实时网络流量</td>
</tr>
<tr>
<td></td>
<td><code>nethogs</code></td>
<td>进程网络使用</td>
</tr>
<tr>
<td></td>
<td><code>ss -ant</code></td>
<td>网络连接状态</td>
</tr>
<tr>
<td><strong>进程</strong></td>
<td>&#96;ps aux –sort&#x3D;-%cpu</td>
<td>head&#96;</td>
</tr>
<tr>
<td></td>
<td>&#96;ps aux –sort&#x3D;-%mem</td>
<td>head&#96;</td>
</tr>
</tbody></table>
<hr>
<h2 id="八、性能测试注意事项-⚠️"><a href="#八、性能测试注意事项-⚠️" class="headerlink" title="八、性能测试注意事项 ⚠️"></a>八、性能测试注意事项 ⚠️</h2><h3 id="🔴-关键警告"><a href="#🔴-关键警告" class="headerlink" title="🔴 关键警告"></a>🔴 关键警告</h3><ol>
<li><p><strong>生产环境慎用</strong></p>
<ul>
<li><code>stress-ng</code> 会造成真实负载，可能影响业务</li>
<li>建议在非高峰期或测试环境执行</li>
<li>先小范围测试，再逐步增加强度</li>
</ul>
</li>
<li><p><strong>磁盘测试风险</strong></p>
<ul>
<li><code>dd</code> 和 <code>fio</code> 会写入大量数据</li>
<li>确保有足够磁盘空间</li>
<li>避免在系统盘根目录测试</li>
</ul>
</li>
<li><p><strong>内存测试风险</strong></p>
<ul>
<li>分配过多内存可能触发OOM Killer</li>
<li>建议不超过可用内存的80%</li>
<li>注意监控swap使用率</li>
</ul>
</li>
<li><p><strong>监控数据保存</strong></p>
<ul>
<li>所有测试应保存日志，便于后续分析</li>
<li>建议使用 <code>tee</code> 命令同时输出和保存</li>
</ul>
</li>
</ol>
<hr>
<h2 id="九、性能基准值参考"><a href="#九、性能基准值参考" class="headerlink" title="九、性能基准值参考"></a>九、性能基准值参考</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li><strong>负载平均值：</strong> 应 &lt; 核心数</li>
<li><strong>%idle：</strong> 正常应 &gt; 20%</li>
<li><strong>%iowait：</strong> 应 &lt; 10%（高则磁盘瓶颈）</li>
</ul>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><ul>
<li><strong>可用内存：</strong> 应 &gt; 总量的20%</li>
<li><strong>Swap使用：</strong> 应 &lt; 10%</li>
<li><strong>si&#x2F;so：</strong> 应接近0（频繁swap说明内存不足）</li>
</ul>
<h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><ul>
<li><strong>%util：</strong> 应 &lt; 80%</li>
<li><strong>await：</strong> SSD &lt; 10ms，HDD &lt; 20ms</li>
<li><strong>IOPS：</strong> SSD &gt; 10000，HDD &gt; 100</li>
</ul>
<h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><ul>
<li><strong>带宽利用率：</strong> 应 &lt; 80%</li>
<li><strong>丢包率：</strong> 应 &lt; 0.1%</li>
<li><strong>延迟：</strong> 局域网 &lt; 1ms，公网 &lt; 100ms</li>
</ul>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/07/%E4%B8%AD%E6%96%AD%E6%95%85%E4%BA%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/07/%E4%B8%AD%E6%96%AD%E6%95%85%E4%BA%8B/" class="post-title-link" itemprop="url">中断故事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-07 22:15:24 / 修改时间：22:17:26" itemprop="dateCreated datePublished" datetime="2025-11-07T22:15:24+08:00">2025-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="NAPI机制详解与快递站的故事-📦"><a href="#NAPI机制详解与快递站的故事-📦" class="headerlink" title="NAPI机制详解与快递站的故事 📦"></a>NAPI机制详解与快递站的故事 📦</h1><h2 id="一、NAPI在系统中的存在形式"><a href="#一、NAPI在系统中的存在形式" class="headerlink" title="一、NAPI在系统中的存在形式"></a>一、NAPI在系统中的存在形式</h2><h3 id="❓-NAPI是进程吗？"><a href="#❓-NAPI是进程吗？" class="headerlink" title="❓ NAPI是进程吗？"></a>❓ NAPI是进程吗？</h3><p><strong>不是独立进程！</strong> NAPI是Linux内核网络子系统的一个<strong>机制&#x2F;框架</strong>，而不是一个可见的进程。</p>
<h3 id="🔍-在系统中如何体现？"><a href="#🔍-在系统中如何体现？" class="headerlink" title="🔍 在系统中如何体现？"></a>🔍 在系统中如何体现？</h3><h4 id="1-软中断上下文中运行"><a href="#1-软中断上下文中运行" class="headerlink" title="1. 软中断上下文中运行"></a>1. <strong>软中断上下文中运行</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看软中断处理线程（每个CPU一个）</span></span><br><span class="line">ps aux | grep ksoftirqd</span><br></pre></td></tr></table></figure>
<p>输出示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root         12  0.0  0.0      0     0 ?        S    10:00   0:00 [ksoftirqd/0]</span><br><span class="line">root         18  0.0  0.0      0     0 ?        S    10:00   0:00 [ksoftirqd/1]</span><br><span class="line">root         24  0.0  0.0      0     0 ?        S    10:00   0:00 [ksoftirqd/2]</span><br></pre></td></tr></table></figure>

<p><strong>NAPI就运行在这些 <code>ksoftirqd</code> 线程中！</strong></p>
<h4 id="2-每个网卡有自己的NAPI结构"><a href="#2-每个网卡有自己的NAPI结构" class="headerlink" title="2. 每个网卡有自己的NAPI结构"></a>2. <strong>每个网卡有自己的NAPI结构</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网卡的NAPI统计</span></span><br><span class="line"><span class="built_in">cat</span> /proc/net/softnet_stat</span><br></pre></td></tr></table></figure>

<h4 id="3-可以通过内核参数调整"><a href="#3-可以通过内核参数调整" class="headerlink" title="3. 可以通过内核参数调整"></a>3. <strong>可以通过内核参数调整</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看NAPI相关参数</span></span><br><span class="line">sysctl -a | grep net.core</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、NAPI工作原理详解"><a href="#二、NAPI工作原理详解" class="headerlink" title="二、NAPI工作原理详解"></a>二、NAPI工作原理详解</h2><h3 id="🎯-核心思想：智能切换"><a href="#🎯-核心思想：智能切换" class="headerlink" title="🎯 核心思想：智能切换"></a>🎯 核心思想：智能切换</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">低负载（包少） ──→ 中断模式（来一个处理一个）</span><br><span class="line">                     ↓</span><br><span class="line">                  负载上升</span><br><span class="line">                     ↓</span><br><span class="line">高负载（包多） ──→ 轮询模式（定时批量处理）</span><br></pre></td></tr></table></figure>

<h3 id="📊-工作流程图"><a href="#📊-工作流程图" class="headerlink" title="📊 工作流程图"></a>📊 工作流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">包到达 → 硬中断 → 触发NAPI → 开启轮询 → 批量处理</span><br><span class="line">                      ↓</span><br><span class="line">                  处理完毕</span><br><span class="line">                      ↓</span><br><span class="line">                队列空了 → 关闭轮询 → 等待下次中断</span><br></pre></td></tr></table></figure>

<h3 id="💡-为什么这样设计？"><a href="#💡-为什么这样设计？" class="headerlink" title="💡 为什么这样设计？"></a>💡 为什么这样设计？</h3><h4 id="问题1：纯中断模式的问题"><a href="#问题1：纯中断模式的问题" class="headerlink" title="问题1：纯中断模式的问题"></a><strong>问题1：纯中断模式的问题</strong></h4><ul>
<li>每来1个包就中断1次</li>
<li>高负载时（每秒100万个包）&#x3D; 100万次中断</li>
<li>CPU被中断打断，来回切换开销巨大</li>
</ul>
<h4 id="问题2：纯轮询模式的问题"><a href="#问题2：纯轮询模式的问题" class="headerlink" title="问题2：纯轮询模式的问题"></a><strong>问题2：纯轮询模式的问题</strong></h4><ul>
<li>没包也要不停查看，浪费CPU</li>
<li>低负载时响应延迟高</li>
</ul>
<h4 id="NAPI的解决方案：混合模式"><a href="#NAPI的解决方案：混合模式" class="headerlink" title="NAPI的解决方案：混合模式"></a><strong>NAPI的解决方案：混合模式</strong></h4><ul>
<li><strong>低负载</strong>：用中断（响应快）</li>
<li><strong>高负载</strong>：用轮询（效率高）</li>
<li><strong>动态切换</strong>：自动适应</li>
</ul>
<h3 id="🔧-NAPI的实现细节"><a href="#🔧-NAPI的实现细节" class="headerlink" title="🔧 NAPI的实现细节"></a>🔧 NAPI的实现细节</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码示例</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">napi_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">poll_list</span>;</span>  <span class="comment">// 轮询列表</span></span><br><span class="line">    <span class="type">int</span> (*poll)(<span class="keyword">struct</span> napi_struct *, <span class="type">int</span>);  <span class="comment">// 轮询函数</span></span><br><span class="line">    <span class="type">int</span> weight;  <span class="comment">// 每次轮询处理的最大包数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 网卡驱动注册NAPI</span></span><br><span class="line">netif_napi_add(dev, &amp;priv-&gt;napi, my_poll_function, <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断处理函数</span></span><br><span class="line">irq_handler() &#123;</span><br><span class="line">    disable_irq();  <span class="comment">// 关闭网卡中断</span></span><br><span class="line">    napi_schedule(&amp;priv-&gt;napi);  <span class="comment">// 启动NAPI轮询</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NAPI轮询函数</span></span><br><span class="line">my_poll_function(<span class="keyword">struct</span> napi_struct *napi, <span class="type">int</span> budget) &#123;</span><br><span class="line">    <span class="type">int</span> work_done = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (work_done &lt; budget) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!more_packets())</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        process_packet();</span><br><span class="line">        work_done++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (work_done &lt; budget) &#123;</span><br><span class="line">        napi_complete(napi);  <span class="comment">// 处理完了，关闭轮询</span></span><br><span class="line">        enable_irq();  <span class="comment">// 重新开启中断</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> work_done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、快递站的完整故事-📮"><a href="#三、快递站的完整故事-📮" class="headerlink" title="三、快递站的完整故事 📮"></a>三、快递站的完整故事 📮</h2><h3 id="🏢-故事背景设定"><a href="#🏢-故事背景设定" class="headerlink" title="🏢 故事背景设定"></a>🏢 故事背景设定</h3><p><strong>人物角色：</strong></p>
<ul>
<li><strong>网线</strong> &#x3D; 高速公路</li>
<li><strong>网卡（NIC1）</strong> &#x3D; 小区快递接收点</li>
<li><strong>门卫</strong> &#x3D; 硬件中断</li>
<li><strong>DMA搬运工</strong> &#x3D; 自动传送带机器人</li>
<li><strong>Ring Buffer</strong> &#x3D; 环形旋转仓库（8个格子）</li>
<li><strong>NAPI巡检员</strong> &#x3D; 智能快递管理员</li>
<li><strong>软中断处理员</strong> &#x3D; 后台分拣中心</li>
<li><strong>协议栈</strong> &#x3D; 快递最后一公里投递员</li>
<li><strong>应用程序</strong> &#x3D; 收件人</li>
</ul>
<hr>
<h3 id="📖-故事正文"><a href="#📖-故事正文" class="headerlink" title="📖 故事正文"></a>📖 故事正文</h3><h4 id="第一幕：平静的早晨（低负载）"><a href="#第一幕：平静的早晨（低负载）" class="headerlink" title="第一幕：平静的早晨（低负载）"></a><strong>第一幕：平静的早晨（低负载）</strong></h4><p>早上8点，阳光明媚。小区快递接收点很安静，偶尔有一两个快递到达。</p>
<p><strong>门卫老王（硬件中断）</strong> 坐在门口，悠闲地喝着茶。</p>
<p><em>叮咚！</em> 一个快递包裹从高速公路（网线）送到了接收点（网卡NIC1）。</p>
<p><strong>老王（硬件中断）：</strong> “哎呀，有快递了！” 他立刻按响门铃（触发中断），通知楼上的管理中心。</p>
<p><strong>DMA机器人（自动搬运工）</strong> 听到信号后，立刻启动，不需要任何人工操作，直接把包裹从接收点搬到了<strong>环形旋转仓库</strong>（Ring Buffer）的1号格子里。</p>
<p><strong>老王快速登记：</strong> “1号包裹已入库！” 然后继续回去喝茶。</p>
<p><strong>NAPI巡检员小李（轮询机制）</strong> 听到通知后过来查看：</p>
<ul>
<li>看了看仓库，只有1个包裹</li>
<li>拿起包裹，交给<strong>后台分拣中心</strong>（软中断处理）</li>
<li>分拣员快速处理，贴上标签，送给<strong>快递员</strong>（协议栈）</li>
<li>快递员查看地址（IP层），确认楼号和房间号（TCP&#x2F;UDP层），最后敲门交给<strong>收件人</strong>（应用程序）</li>
</ul>
<p>小李处理完后说：**”仓库空了，我继续等老王通知吧。”** （关闭轮询，回到中断模式）</p>
<hr>
<h4 id="第二幕：双11爆仓（高负载）"><a href="#第二幕：双11爆仓（高负载）" class="headerlink" title="第二幕：双11爆仓（高负载）"></a><strong>第二幕：双11爆仓（高负载）</strong></h4><p>中午12点，双11促销开始了！快递像雪片一样飞来！</p>
<p><em>叮咚！叮咚！叮咚！叮咚！</em> 每秒钟有<strong>成百上千个</strong>包裹到达！</p>
<p><strong>老王（硬件中断）</strong> 急得满头大汗：</p>
<ul>
<li>“1号包裹到了！”（按门铃）</li>
<li>“2号包裹到了！”（按门铃）</li>
<li>“3号包裹到了！”（按门铃）</li>
<li>…</li>
</ul>
<p>他发现自己<strong>光按门铃就按不过来</strong>了，手都快抽筋了！而且楼上的人也被频繁的门铃吵得工作效率下降！</p>
<p><strong>这时，NAPI巡检员小李（智能管理员）发现了问题：</strong></p>
<p><strong>小李：</strong> “老王，你别按了！我看这架势，包裹会源源不断来。你就专心让DMA机器人往仓库里放吧，我<strong>自己定时过来批量取</strong>就行了！”</p>
<p><strong>老王：</strong> “好！那我就不按门铃了！” （<strong>关闭中断</strong>）</p>
<p>于是，新的工作模式开始了：</p>
<ol>
<li><p><strong>DMA机器人</strong> 疯狂工作，不停地把包裹放入<strong>环形仓库</strong>的1→2→3→4→5→6→7→8→1→2…（循环使用）</p>
</li>
<li><p><strong>小李（NAPI轮询）</strong> 每隔一小段时间（比如几微秒）就来仓库看一眼：</p>
<ul>
<li>“哦，有64个包裹！” （budget&#x3D;64）</li>
<li>一次性拿走64个，交给<strong>后台分拣中心</strong>（软中断）</li>
<li>分拣中心开始批量处理：<ul>
<li>贴标签（添加协议信息）</li>
<li>分类（IP路由）</li>
<li>装车（送入协议栈）</li>
</ul>
</li>
<li><strong>快递员们</strong>（协议栈）批量投递到各家各户（应用程序）</li>
</ul>
</li>
<li><p><strong>关键优化：</strong></p>
<ul>
<li>老王不用频繁按门铃了（减少中断开销）</li>
<li>小李批量处理，效率高（一次拿64个）</li>
<li>仓库满了也不怕，DMA会覆盖旧数据（Ring Buffer特性）</li>
</ul>
</li>
</ol>
<hr>
<h4 id="第三幕：夜深人静（恢复低负载）"><a href="#第三幕：夜深人静（恢复低负载）" class="headerlink" title="第三幕：夜深人静（恢复低负载）"></a><strong>第三幕：夜深人静（恢复低负载）</strong></h4><p>晚上11点，双11活动结束，快递量骤减。</p>
<p><strong>小李（NAPI）</strong> 又来巡检了：</p>
<ul>
<li>第1次：拿了20个包裹</li>
<li>第2次：拿了5个包裹</li>
<li>第3次：拿了1个包裹</li>
<li>第4次：<strong>仓库空了！</strong></li>
</ul>
<p><strong>小李：</strong> “看来又恢复平静了。老王，你继续按门铃模式吧，我去休息了。”（<strong>关闭轮询，重新开启中断</strong>）</p>
<p><strong>老王：</strong> “好嘞！” （<strong>恢复中断模式</strong>）</p>
<p>系统又回到了开始的状态：有包裹就按门铃，NAPI按需响应。</p>
<hr>
<h2 id="四、关键知识点总结"><a href="#四、关键知识点总结" class="headerlink" title="四、关键知识点总结"></a>四、关键知识点总结</h2><h3 id="🎯-NAPI的精髓"><a href="#🎯-NAPI的精髓" class="headerlink" title="🎯 NAPI的精髓"></a>🎯 NAPI的精髓</h3><table>
<thead>
<tr>
<th>场景</th>
<th>模式</th>
<th>原因</th>
</tr>
</thead>
<tbody><tr>
<td><strong>低负载</strong></td>
<td>中断驱动</td>
<td>响应快，不浪费CPU</td>
</tr>
<tr>
<td><strong>高负载</strong></td>
<td>轮询驱动</td>
<td>减少中断，批量处理</td>
</tr>
<tr>
<td><strong>切换时机</strong></td>
<td>自动检测</td>
<td>队列满→开轮询；队列空→关轮询</td>
</tr>
</tbody></table>
<h3 id="🔑-记忆口诀"><a href="#🔑-记忆口诀" class="headerlink" title="🔑 记忆口诀"></a>🔑 记忆口诀</h3><p><strong>“包少按门铃，包多我自取”</strong></p>
<ul>
<li>包少（低负载）&#x3D; 中断模式（按门铃通知）</li>
<li>包多（高负载）&#x3D; 轮询模式（主动批量取）</li>
</ul>
<h3 id="📊-性能对比"><a href="#📊-性能对比" class="headerlink" title="📊 性能对比"></a>📊 性能对比</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">纯中断模式：</span><br><span class="line">  1,000,000 包/秒 × 1 中断/包 = 1,000,000 次中断 😱</span><br><span class="line"></span><br><span class="line">NAPI混合模式：</span><br><span class="line">  1,000,000 包/秒 ÷ 64 包/批 = 15,625 次轮询 😊</span><br><span class="line">  </span><br><span class="line">性能提升：约 60 倍！</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、实战查看"><a href="#五、实战查看" class="headerlink" title="五、实战查看"></a>五、实战查看</h2><h3 id="查看NAPI统计"><a href="#查看NAPI统计" class="headerlink" title="查看NAPI统计"></a>查看NAPI统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看软中断统计</span></span><br><span class="line"><span class="built_in">cat</span> /proc/softirqs</span><br></pre></td></tr></table></figure>

<h3 id="调整NAPI参数"><a href="#调整NAPI参数" class="headerlink" title="调整NAPI参数"></a>调整NAPI参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每次轮询最多处理的包数（budget）</span></span><br><span class="line">sysctl net.core.netdev_budget=300</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每次轮询最长时间（微秒）</span></span><br><span class="line">sysctl net.core.netdev_budget_usecs=2000</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🎓-总结"><a href="#🎓-总结" class="headerlink" title="🎓 总结"></a>🎓 总结</h2><ul>
<li><strong>NAPI不是进程</strong>，是运行在<code>ksoftirqd</code>内核线程中的机制</li>
<li><strong>核心是智能切换</strong>：低负载用中断，高负载用轮询</li>
<li><strong>快递站故事</strong>：老王（中断）和小李（轮询）配合，应对不同流量</li>
<li><strong>性能提升</strong>：减少中断次数，提高批量处理效率</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/07/dnsperf%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/07/dnsperf%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/" class="post-title-link" itemprop="url">dnsperf使用说明</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-07 17:19:42 / 修改时间：17:36:04" itemprop="dateCreated datePublished" datetime="2025-11-07T17:19:42+08:00">2025-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="🧭-dnsperf-实战与最佳实践速查指南"><a href="#🧭-dnsperf-实战与最佳实践速查指南" class="headerlink" title="🧭 dnsperf 实战与最佳实践速查指南"></a>🧭 dnsperf 实战与最佳实践速查指南</h1><h2 id="📖-1-工具简介"><a href="#📖-1-工具简介" class="headerlink" title="📖 1. 工具简介"></a>📖 1. 工具简介</h2><p><code>dnsperf</code> 是由 <strong>Nominum &#x2F; DNS-OARC</strong> 提供的 <strong>DNS 性能压测工具</strong>，用于模拟客户端大规模并发请求，测试 <strong>DNS 服务器（如 BIND、CoreDNS、PowerDNS）</strong> 的 QPS、响应延迟、丢包率等性能指标。<br>常用于：</p>
<ul>
<li>DNS 服务性能压测；</li>
<li>网络栈优化与软中断验证；</li>
<li>负载均衡策略评估；</li>
<li>DNS 缓存与 TTL 策略测试。</li>
</ul>
<hr>
<h2 id="⚙️-2-安装方式"><a href="#⚙️-2-安装方式" class="headerlink" title="⚙️ 2. 安装方式"></a>⚙️ 2. 安装方式</h2><h3 id="✅-通用（RHEL-Anolis-CentOS-8-）"><a href="#✅-通用（RHEL-Anolis-CentOS-8-）" class="headerlink" title="✅ 通用（RHEL&#x2F;Anolis&#x2F;CentOS 8+）"></a>✅ 通用（RHEL&#x2F;Anolis&#x2F;CentOS 8+）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y https://mirrors.aliyun.com/epel/epel-release-latest-8.noarch.rpm</span><br><span class="line">yum install -y dnsperf</span><br></pre></td></tr></table></figure>

<h3 id="✅-验证安装"><a href="#✅-验证安装" class="headerlink" title="✅ 验证安装"></a>✅ 验证安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -h</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="🧰-3-基本命令与参数说明"><a href="#🧰-3-基本命令与参数说明" class="headerlink" title="🧰 3. 基本命令与参数说明"></a>🧰 3. 基本命令与参数说明</h2><table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>-s &lt;server&gt;</code></td>
<td>指定被测 DNS 服务器 IP</td>
<td>必填</td>
</tr>
<tr>
<td><code>-p &lt;port&gt;</code></td>
<td>DNS 端口（默认53）</td>
<td>可用于测试 CoreDNS 或自定义端口</td>
</tr>
<tr>
<td><code>-d &lt;datafile&gt;</code></td>
<td>测试域名文件路径</td>
<td>每行一个域名</td>
</tr>
<tr>
<td><code>-l &lt;duration&gt;</code></td>
<td>压测时长（秒）</td>
<td>如 <code>-l 60</code> 表示持续压测 1 分钟</td>
</tr>
<tr>
<td><code>-Q &lt;rate&gt;</code></td>
<td>每秒查询速率（QPS 限制）</td>
<td>如 <code>-Q 5000</code></td>
</tr>
<tr>
<td><code>-c &lt;clients&gt;</code></td>
<td>模拟并发客户端数量</td>
<td>默认1，可设多线程</td>
</tr>
<tr>
<td><code>-t &lt;threads&gt;</code></td>
<td>线程数（默认1）</td>
<td>与 CPU 核绑定测试软中断时建议多核</td>
</tr>
<tr>
<td><code>-v</code></td>
<td>输出详细日志</td>
<td>包括 RTT 分布和请求统计</td>
</tr>
<tr>
<td><code>-D</code></td>
<td>打印每个查询结果</td>
<td>用于验证响应内容</td>
</tr>
<tr>
<td><code>-S</code></td>
<td>使用 TCP 而非 UDP</td>
<td>用于验证 TCP fallback</td>
</tr>
<tr>
<td><code>-T</code></td>
<td>设置每个线程的目标 QPS</td>
<td>可用于核级软中断分配分析</td>
</tr>
</tbody></table>
<hr>
<h2 id="📋-4-测试数据文件格式（queries-txt）"><a href="#📋-4-测试数据文件格式（queries-txt）" class="headerlink" title="📋 4. 测试数据文件格式（queries.txt）"></a>📋 4. 测试数据文件格式（<code>queries.txt</code>）</h2><p>示例：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www.baidu.com. A</span><br></pre></td></tr></table></figure>

<blockquote>
<p>⚠️ 注意：</p>
<ul>
<li>每行一个查询；</li>
<li>以 <strong><code>.</code> 结尾</strong>；</li>
<li>查询类型可为 <code>A</code>, <code>AAAA</code>, <code>MX</code>, <code>NS</code>, <code>TXT</code> 等。</li>
</ul>
</blockquote>
<hr>
<h2 id="🚀-5-常用命令模板与实战注释"><a href="#🚀-5-常用命令模板与实战注释" class="headerlink" title="🚀 5. 常用命令模板与实战注释"></a>🚀 5. 常用命令模板与实战注释</h2><h3 id="🧩-5-1-基础测试（单线程）"><a href="#🧩-5-1-基础测试（单线程）" class="headerlink" title="🧩 5.1 基础测试（单线程）"></a>🧩 5.1 基础测试（单线程）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 10.16.13.14 -d queries.txt -l 30</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
<ul>
<li>连续压测 30 秒</li>
<li>默认 UDP + 单线程</li>
<li>适用于功能验证阶段</li>
</ul>
</blockquote>
<hr>
<h3 id="⚡️-5-2-并发压测（多线程高并发）"><a href="#⚡️-5-2-并发压测（多线程高并发）" class="headerlink" title="⚡️ 5.2 并发压测（多线程高并发）"></a>⚡️ 5.2 并发压测（多线程高并发）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 10.16.13.14 -d queries.txt -l 60 -Q 50000 -t 8 -c 50</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
<ul>
<li>目标 QPS：50,000</li>
<li>线程数：8（建议与 CPU 核数绑定）</li>
<li>模拟 50 个客户端并发请求</li>
<li>适合测试多核软中断均衡性能</li>
</ul>
</blockquote>
<blockquote>
<p>💡 <strong>监控建议：</strong><br>在被测 DNS 服务器执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n1 <span class="string">&quot;cat /proc/softirqs | grep NET_RX&quot;</span></span><br></pre></td></tr></table></figure>

<p>同时观察各 CPU 的软中断分布是否均衡。</p>
</blockquote>
<hr>
<h3 id="🌐-5-3-TCP-模式验证（DNS-over-TCP）"><a href="#🌐-5-3-TCP-模式验证（DNS-over-TCP）" class="headerlink" title="🌐 5.3 TCP 模式验证（DNS over TCP）"></a>🌐 5.3 TCP 模式验证（DNS over TCP）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 10.16.13.14 -p 53 -d queries.txt -S -l 30</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
<ul>
<li>使用 TCP 连接进行查询；</li>
<li>适用于验证 <strong>TCP fallback</strong> 或防火墙规则。</li>
</ul>
</blockquote>
<hr>
<h3 id="🧪-5-4-指定每线程速率（核绑定验证）"><a href="#🧪-5-4-指定每线程速率（核绑定验证）" class="headerlink" title="🧪 5.4 指定每线程速率（核绑定验证）"></a>🧪 5.4 指定每线程速率（核绑定验证）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">taskset -c 0-7 dnsperf -s 10.16.13.14 -d queries.txt -t 8 -T 5000 -l 30</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
<ul>
<li>限定在 CPU 0-7 核运行；</li>
<li>每线程 5,000 QPS；</li>
<li>可结合 <code>irqbalance</code> 或 <code>ethtool -X</code> 调整中断亲和性；</li>
<li>用于验证 <strong>软中断分布与性能关系</strong>。</li>
</ul>
</blockquote>
<hr>
<h3 id="📊-5-5-查看响应延迟分布"><a href="#📊-5-5-查看响应延迟分布" class="headerlink" title="📊 5.5 查看响应延迟分布"></a>📊 5.5 查看响应延迟分布</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 10.16.13.14 -d queries.txt -l 30 -Q 10000 -v</span><br><span class="line">dnsperf -s 10.16.13.14 -d queries.txt -l 60 -t 8 -Q 400000 -v &gt; dnsperf_verbose.log 2&gt;&amp;1</span><br><span class="line"><span class="comment">#分析</span></span><br><span class="line">grep -E <span class="string">&quot;Latency Distribution|Queries per second|Average Latency|Latency StdDev&quot;</span> dnsperf_verbose.log -n</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>输出示例：</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Statistics:</span><br><span class="line">  Queries sent:         300000</span><br><span class="line">  Queries completed:    299995 (100.00%)</span><br><span class="line">  Response codes:       NOERROR 299995</span><br><span class="line">  Average latency:      1.32 ms</span><br><span class="line">  Latency StdDev:       0.28 ms</span><br><span class="line">  Latency Distribution:</span><br><span class="line">    50%: 1.28 ms</span><br><span class="line">    90%: 1.47 ms</span><br><span class="line">    99%: 1.88 ms</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>用途：</strong> 观察性能抖动与延迟曲线，判断内核队列 &#x2F; IRQ 调整效果。</p>
</blockquote>
<hr>
<h3 id="🔍-5-6-自定义端口测试（CoreDNS-ingress-nginx-场景）"><a href="#🔍-5-6-自定义端口测试（CoreDNS-ingress-nginx-场景）" class="headerlink" title="🔍 5.6 自定义端口测试（CoreDNS &#x2F; ingress-nginx 场景）"></a>🔍 5.6 自定义端口测试（CoreDNS &#x2F; ingress-nginx 场景）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 192.168.179.135 -p 1053 -d queries.txt -l 30</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：</strong></p>
<ul>
<li>当你的 DNS 服务运行在自定义端口（如 CoreDNS、Nginx stream 模式）时使用。</li>
</ul>
</blockquote>
<hr>
<h2 id="📈-6-性能指标解读"><a href="#📈-6-性能指标解读" class="headerlink" title="📈 6. 性能指标解读"></a>📈 6. 性能指标解读</h2><table>
<thead>
<tr>
<th>指标</th>
<th>含义</th>
<th>关键参考值</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Queries per second</strong></td>
<td>每秒查询数 (QPS)</td>
<td>核心性能指标</td>
</tr>
<tr>
<td><strong>Average latency</strong></td>
<td>平均响应延迟</td>
<td>&lt; 2ms 为优秀</td>
</tr>
<tr>
<td><strong>Dropped packets</strong></td>
<td>丢包率</td>
<td>理论应为 0</td>
</tr>
<tr>
<td><strong>RTT StdDev</strong></td>
<td>响应抖动</td>
<td>越小越稳定</td>
</tr>
<tr>
<td><strong>CPU SoftIRQ Balance</strong></td>
<td>各核软中断均衡度</td>
<td>CPU0 不应长期100%</td>
</tr>
</tbody></table>
<hr>
<h2 id="🧠-7-高级应用场景"><a href="#🧠-7-高级应用场景" class="headerlink" title="🧠 7. 高级应用场景"></a>🧠 7. 高级应用场景</h2><table>
<thead>
<tr>
<th>场景</th>
<th>目标</th>
<th>推荐配置</th>
</tr>
</thead>
<tbody><tr>
<td><strong>软中断均衡验证</strong></td>
<td>调整 <code>ethtool -X</code>, <code>irqbalance</code>, <code>taskset</code></td>
<td><code>-t 8 -T 5000</code> 配合 <code>/proc/softirqs</code></td>
</tr>
<tr>
<td><strong>CoreDNS 性能测试</strong></td>
<td>验证集群内 DNS 服务稳定性</td>
<td><code>dnsperf -s &lt;clusterDNS&gt;</code></td>
</tr>
<tr>
<td><strong>边缘节点压力测试</strong></td>
<td>验证边缘 CoreDNS 容量</td>
<td>增加 <code>-c 100 -Q 80000</code></td>
</tr>
<tr>
<td><strong>Ingress &#x2F; API 域名解析链路压测</strong></td>
<td>验证上层流量入口延迟</td>
<td>将 <code>dnsperf</code> 与 <code>wrk</code>、<code>iperf3</code> 结合使用</td>
</tr>
<tr>
<td><strong>BIND &#x2F; PDNS 优化验证</strong></td>
<td>调整线程数、缓存大小</td>
<td>对比 QPS 与平均延迟变化</td>
</tr>
</tbody></table>
<hr>
<h2 id="🧾-8-典型验证流程（软中断均衡实验）"><a href="#🧾-8-典型验证流程（软中断均衡实验）" class="headerlink" title="🧾 8. 典型验证流程（软中断均衡实验）"></a>🧾 8. 典型验证流程（软中断均衡实验）</h2><ol>
<li><p><strong>准备域名数据：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; queries.txt &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">www.baidu.com. A</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>绑定中断核（如只绑定 CPU0）：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> irq <span class="keyword">in</span> $(grep eth0 /proc/interrupts | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | sed <span class="string">&#x27;s/://&#x27;</span>); <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> 1 &gt; /proc/irq/<span class="variable">$irq</span>/smp_affinity</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>执行 dnsperf 压测：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsperf -s 10.16.13.14 -d queries.txt -t 8 -Q 10000 -l 30</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>观察软中断分布：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n1 <span class="string">&quot;grep NET_RX /proc/softirqs&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>调整中断亲和性，重新压测对比。</strong></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/07/iperf%E5%8E%8B%E6%B5%8B%E5%B8%A6%E5%AE%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/07/iperf%E5%8E%8B%E6%B5%8B%E5%B8%A6%E5%AE%BD/" class="post-title-link" itemprop="url">iperf压测带宽</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-07 10:17:24 / 修改时间：10:30:03" itemprop="dateCreated datePublished" datetime="2025-11-07T10:17:24+08:00">2025-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 iperf3</span></span><br><span class="line">yum install -y iperf3  <span class="comment"># CentOS/RHEL</span></span><br><span class="line"><span class="comment">#查看系统架构及版本</span></span><br><span class="line"><span class="built_in">uname</span> -m &amp;&amp; <span class="built_in">cat</span> /etc/os-release | egrep <span class="string">&quot;NAME|VERSION&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"><span class="comment"># 1. 启动 iperf3 服务端</span></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line">iperf3 -s -p 5201</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或后台运行</span></span><br><span class="line">iperf3 -s -D</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改为实际服务器 IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"><span class="comment"># 2. 客户端梯度压测</span></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打满带宽：单线程 TCP 测试</span></span><br><span class="line">iperf3 -c &lt;server_ip&gt; -t 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多线程（并发10连接）</span></span><br><span class="line">iperf3 -c &lt;server_ip&gt; -P 10 -t 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 梯度测试（1G、5G、10G）</span></span><br><span class="line">iperf3 -c &lt;server_ip&gt; -b 1G -t 30</span><br><span class="line">iperf3 -c &lt;server_ip&gt; -b 5G -t 30</span><br><span class="line">iperf3 -c &lt;server_ip&gt; -b 10G -t 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># UDP 模式下验证包丢率</span></span><br><span class="line">iperf3 -u -b 10G -c &lt;server_ip&gt; -t 30</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/05/%E8%AE%BE%E5%A4%87%E4%BF%A1%E6%81%AF%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/05/%E8%AE%BE%E5%A4%87%E4%BF%A1%E6%81%AF%E6%B1%87%E6%80%BB/" class="post-title-link" itemprop="url">设备信息汇总</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-05 10:53:50 / 修改时间：11:21:47" itemprop="dateCreated datePublished" datetime="2025-11-05T10:53:50+08:00">2025-11-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="NUMA架构lstopo显示系统拓扑"><a href="#NUMA架构lstopo显示系统拓扑" class="headerlink" title="NUMA架构lstopo显示系统拓扑"></a>NUMA架构lstopo显示系统拓扑</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud-atlas.readthedocs.io/zh-cn/latest/kernel/memory/numa/lstopo.html">https://cloud-atlas.readthedocs.io/zh-cn/latest/kernel/memory/numa/lstopo.html</a> </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">yum install -y hwloc hwloc-gui</span><br><span class="line"></span><br><span class="line">#查看摘要，文字表述</span><br><span class="line">lstopo</span><br><span class="line">lstopo -s</span><br><span class="line">lstopo-no-graphics</span><br><span class="line"></span><br><span class="line">#ascii art 格式输出,物理索引</span><br><span class="line">lstopo --of ascii -p</span><br><span class="line"></span><br><span class="line">#逻辑索引</span><br><span class="line">lstopo --of ascii -l</span><br><span class="line"></span><br><span class="line"># 生成 PNG 图片</span><br><span class="line">lstopo --of png /root/topo.png</span><br><span class="line"></span><br><span class="line"># 或者更简单的写法（自动根据后缀识别格式）</span><br><span class="line">lstopo /root/topo.png</span><br><span class="line"></span><br><span class="line"># 生成 SVG 矢量图（推荐，清晰且可放大）</span><br><span class="line">lstopo /root/topo.svg</span><br><span class="line"></span><br><span class="line"># 生成 PDF 格式</span><br><span class="line">lstopo /root/topo.pdf</span><br><span class="line"></span><br><span class="line"># 拓扑包含所有 PCIe / 网卡设备信息</span><br><span class="line">lstopo --whole-io topo-full.svg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#生成一张带编号、整齐布局的图：</span><br><span class="line">lstopo --whole-io --rect --fontsize 9 --gridsize 8 /root/topo.svg</span><br><span class="line"></span><br><span class="line"># 生成带网卡的完整 NUMA + PCIe 拓扑图</span><br><span class="line">sudo lstopo --whole-system --whole-io --rect --fontsize 9 --gridsize 8 /root/topo.svg</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="可选美化与调整参数"><a href="#可选美化与调整参数" class="headerlink" title="可选美化与调整参数"></a>可选美化与调整参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>--fontsize 10</code></td>
<td>调整字体大小</td>
</tr>
<tr>
<td><code>--gridsize 10</code></td>
<td>控制元素间距</td>
</tr>
<tr>
<td><code>--rect</code></td>
<td>使用矩形布局（更规整）</td>
</tr>
<tr>
<td><code>--horiz</code> &#x2F; <code>--vert</code></td>
<td>强制水平或垂直布局</td>
</tr>
<tr>
<td><code>--physical</code></td>
<td>显示物理 CPU 核编号</td>
</tr>
<tr>
<td><code>--logical</code></td>
<td>显示逻辑编号（默认）</td>
</tr>
</tbody></table>
<h3 id="符号说明"><a href="#符号说明" class="headerlink" title="符号说明"></a>符号说明</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PU P# 是处理单元处理器</span><br><span class="line">L#i 代表指令高速缓存。</span><br><span class="line">L#d 代表数据高速缓存。</span><br><span class="line">L1 代表1级缓存。</span><br><span class="line">L2 代表第2级高速缓存。</span><br><span class="line">L3 代表三级缓存</span><br></pre></td></tr></table></figure>

<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y numactl </span><br><span class="line"></span><br><span class="line">numactl --hardware</span><br><span class="line">lscpu</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/04/%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/04/%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">系统分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-04 15:05:10 / 修改时间：15:22:05" itemprop="dateCreated datePublished" datetime="2025-11-04T15:05:10+08:00">2025-11-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="系统分析"><a href="#系统分析" class="headerlink" title="系统分析"></a>系统分析</h2><blockquote>
<p>覆盖了网卡、NUMA、中断、CPU绑定、CPU软中断分布、I&#x2F;O负载(pidstat&#x2F;iostat)、队列与中断绑定分析</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"># 网络 + NUMA + CPU + 中断 综合排查脚本</span><br><span class="line"># ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">NIC=$&#123;1:-eth2&#125;   # 默认网卡 eth2，可通过参数指定</span><br><span class="line">echo -e &quot;\n\033[1;36m&gt;&gt;&gt; 开始分析网卡: $NIC\033[0m&quot;</span><br><span class="line">echo &quot;------------------------------------------------------------&quot;</span><br><span class="line"></span><br><span class="line"># ========== 1. 基础硬件与NUMA结构 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[1] NUMA与CPU拓扑信息\033[0m&quot;</span><br><span class="line">lscpu | egrep &quot;Model name|Socket|Core|Thread|NUMA&quot;</span><br><span class="line">echo</span><br><span class="line">numactl --hardware | grep -E &quot;available:|node [0-9]+ cpus:&quot;</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">if [ -f &quot;/sys/class/net/$NIC/device/numa_node&quot; ]; then</span><br><span class="line">    NUMA_NODE=$(cat /sys/class/net/$NIC/device/numa_node)</span><br><span class="line">    echo &quot;🧩 网卡 $NIC 属于 NUMA 节点: $NUMA_NODE&quot;</span><br><span class="line">    NODE_CPUS=$(cat /sys/devices/system/node/node$&#123;NUMA_NODE&#125;/cpulist)</span><br><span class="line">    echo &quot;🧠 对应 NUMA 节点CPU列表: $NODE_CPUS&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;⚠️ 未找到 $NIC 的 NUMA 节点信息&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># ========== 2. 网卡硬件与队列信息 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[2] 网卡硬件参数与队列情况\033[0m&quot;</span><br><span class="line">ethtool -i $NIC | grep -E &quot;driver|version|firmware&quot;</span><br><span class="line">ethtool -l $NIC | grep -A1 &quot;Combined&quot;</span><br><span class="line">echo</span><br><span class="line">echo &quot;队列列表:&quot;</span><br><span class="line">ls /sys/class/net/$NIC/queues/ 2&gt;/dev/null || echo &quot;无队列目录&quot;</span><br><span class="line">echo</span><br><span class="line">ethtool -x $NIC 2&gt;/dev/null | head -20 || echo &quot;该网卡不支持RSS映射查看&quot;</span><br><span class="line"></span><br><span class="line"># ========== 3. 中断分布与绑定 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[3] 中断与CPU绑定关系\033[0m&quot;</span><br><span class="line">echo &quot;👉 $NIC 的中断号分布：&quot;</span><br><span class="line">grep $NIC /proc/interrupts | awk &#x27;&#123;print $1 &quot;\t&quot; $NF&#125;&#x27; | tr -d &#x27;:&#x27; | column -t</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n👉 每个中断号绑定CPU信息:&quot;</span><br><span class="line">grep $NIC /proc/interrupts | cut -d: -f1 | while read irq; do</span><br><span class="line">    [ -n &quot;$irq&quot; ] &amp;&amp; printf &quot;IRQ %-4s -&gt; CPU(s): %s\n&quot; &quot;$irq&quot; &quot;$(cat /proc/irq/$irq/smp_affinity_list 2&gt;/dev/null)&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># ========== 4. 网卡接收性能参数 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[4] 网卡接收性能参数\033[0m&quot;</span><br><span class="line">sysctl -a 2&gt;/dev/null | grep &quot;net.core.netdev_max_backlog&quot;</span><br><span class="line">ethtool -S $NIC 2&gt;/dev/null | egrep &quot;rx_|tx_&quot; | head -20</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line"># ========== 5. CPU中断与软中断负载 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[5] CPU中断与软中断统计\033[0m&quot;</span><br><span class="line">echo -e &quot;\n🧮 查看单核CPU的软中断(top前几项)：&quot;</span><br><span class="line">mpstat -P ALL 1 1 | grep -v &quot;Average&quot; | grep -v &quot;^$&quot; | head -15</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n🧩 /proc/softirqs 前20行：&quot;</span><br><span class="line">head -20 /proc/softirqs</span><br><span class="line"></span><br><span class="line"># ========== 6. 机器整体性能快照 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[6] 系统整体性能快照\033[0m&quot;</span><br><span class="line">echo -e &quot;\n📊 CPU使用率：&quot;</span><br><span class="line">mpstat 1 1 | tail -10</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n💾 磁盘I/O负载：&quot;</span><br><span class="line">iostat -x -d 1 1 | grep -v &quot;^$&quot;</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n📈 网络流量速率：&quot;</span><br><span class="line">sar -n DEV 1 1 | grep $NIC</span><br><span class="line">echo</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n👀 进程级CPU/IO统计（前5名）：&quot;</span><br><span class="line">pidstat -dru 1 1 | head -20</span><br><span class="line"></span><br><span class="line"># ========== 7. 附加建议 ==========</span><br><span class="line">echo -e &quot;\n\033[1;33m[7] 附加建议命令（可选手动执行）\033[0m&quot;</span><br><span class="line">cat &lt;&lt;EOF</span><br><span class="line"># 查看中断平衡服务状态（IRQBalance）</span><br><span class="line">systemctl status irqbalance</span><br><span class="line"></span><br><span class="line"># 查看RSS配置与中断CPU亲和性调整建议</span><br><span class="line">grep . /sys/class/net/$NIC/queues/*/rps_cpus</span><br><span class="line">grep . /sys/class/net/$NIC/queues/*/xps_cpus</span><br><span class="line"></span><br><span class="line"># 查看当前活跃连接数</span><br><span class="line">ss -s</span><br><span class="line"></span><br><span class="line"># 实时监控单核CPU中断变化（示例）</span><br><span class="line">watch -n1 &#x27;cat /proc/softirqs | head -20&#x27;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo -e &quot;\n\033[1;32m✅ 完成，以上为网卡与NUMA性能诊断信息。\033[0m&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>🧩 输出逻辑概览（排查顺序）</p>
<table>
<thead>
<tr>
<th>步骤</th>
<th>主要目的</th>
<th>核心命令</th>
</tr>
</thead>
<tbody><tr>
<td>1️⃣ NUMA与CPU拓扑</td>
<td>了解CPU与内存结构</td>
<td><code>lscpu</code>, <code>numactl</code></td>
</tr>
<tr>
<td>2️⃣ 网卡硬件与队列</td>
<td>确认网卡队列、RSS能力</td>
<td><code>ethtool -l</code>, <code>ethtool -x</code></td>
</tr>
<tr>
<td>3️⃣ 中断绑定关系</td>
<td>分析IRQ与CPU的分布</td>
<td><code>/proc/interrupts</code>, <code>/proc/irq/</code></td>
</tr>
<tr>
<td>4️⃣ 网络性能参数</td>
<td>核心队列与缓冲</td>
<td><code>ethtool -S</code>, <code>sysctl net.core</code></td>
</tr>
<tr>
<td>5️⃣ CPU软中断分析</td>
<td>检查软中断瓶颈</td>
<td><code>mpstat</code>, <code>/proc/softirqs</code></td>
</tr>
<tr>
<td>6️⃣ 系统性能快照</td>
<td>看系统整体健康度</td>
<td><code>pidstat</code>, <code>iostat</code>, <code>sar</code></td>
</tr>
<tr>
<td>7️⃣ 附加优化</td>
<td>手动调整指引</td>
<td>RSS&#x2F;XPS, irqbalance</td>
</tr>
</tbody></table>
<h2 id="irqtop-与-lsirq"><a href="#irqtop-与-lsirq" class="headerlink" title="irqtop 与 lsirq"></a>irqtop 与 lsirq</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#cat /proc/interrupts 格式不够良好</span><br><span class="line">#默认util-linux-2.38才集成了irqtop与lsirq，升级util-linux有一定风险，仅编译安装两个工具</span><br><span class="line">#rpm -q util-linux</span><br><span class="line">util-linux-2.32.1-22.0.1.an8.x86_64</span><br><span class="line"></span><br><span class="line">#Anolis OS 8.2 编译安装</span><br><span class="line">git clone https://github.com/util-linux/util-linux.git</span><br><span class="line">cd util-linux/</span><br><span class="line">./autogen.sh</span><br><span class="line"></span><br><span class="line">#两个工具依赖libsmartcols</span><br><span class="line">./configure --enable-libsmartcols --disable-all-programs --enable-lsirq --enable-irqtop</span><br><span class="line">make</span><br><span class="line">cp lsirq /usr/local/bin/</span><br><span class="line">cp irqtop /usr/local/bin/</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
