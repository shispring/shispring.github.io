<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta name="description" content="Cloudflared æœ¬åœ°è°ƒè¯• Kubernetes Webhookæœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cloudflared éš§é“æŠ€æœ¯åœ¨æœ¬åœ°è°ƒè¯• Kubernetes Webhookï¼Œæ— éœ€æš´éœ²å…¬ç½‘ IP æˆ–é…ç½®å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚ ğŸ“‹ ç›®å½• æ–¹æ¡ˆå¯¹æ¯” ç¯å¢ƒå‡†å¤‡ æ“ä½œæ­¥éª¤ å¸¸è§é—®é¢˜ æœ€ä½³å®è·µ   æ–¹æ¡ˆå¯¹æ¯”Localtunnel vs Cloudflared   æ–¹æ¡ˆ caBundle é…ç½® æ˜¯å¦å¯è¡Œ è¯´æ˜">
<meta property="og:type" content="article">
<meta property="og:title" content="æœ¬åœ°è°ƒè¯•k8s webhookæ–¹æ¡ˆ">
<meta property="og:url" content="https://shispring.github.io/2025/11/20/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95k8s-webhook%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Cloudflared æœ¬åœ°è°ƒè¯• Kubernetes Webhookæœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cloudflared éš§é“æŠ€æœ¯åœ¨æœ¬åœ°è°ƒè¯• Kubernetes Webhookï¼Œæ— éœ€æš´éœ²å…¬ç½‘ IP æˆ–é…ç½®å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚ ğŸ“‹ ç›®å½• æ–¹æ¡ˆå¯¹æ¯” ç¯å¢ƒå‡†å¤‡ æ“ä½œæ­¥éª¤ å¸¸è§é—®é¢˜ æœ€ä½³å®è·µ   æ–¹æ¡ˆå¯¹æ¯”Localtunnel vs Cloudflared   æ–¹æ¡ˆ caBundle é…ç½® æ˜¯å¦å¯è¡Œ è¯´æ˜">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-11-20T07:07:57.000Z">
<meta property="article:modified_time" content="2025-11-20T13:19:29.528Z">
<meta property="article:author" content="shispring">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/2025/11/20/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95k8s-webhook%E6%96%B9%E6%A1%88/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>æœ¬åœ°è°ƒè¯•k8s webhookæ–¹æ¡ˆ | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>èµ„æº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/11/20/%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95k8s-webhook%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          æœ¬åœ°è°ƒè¯•k8s webhookæ–¹æ¡ˆ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-11-20 15:07:57 / ä¿®æ”¹æ—¶é—´ï¼š21:19:29" itemprop="dateCreated datePublished" datetime="2025-11-20T15:07:57+08:00">2025-11-20</time>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Cloudflared-æœ¬åœ°è°ƒè¯•-Kubernetes-Webhook"><a href="#Cloudflared-æœ¬åœ°è°ƒè¯•-Kubernetes-Webhook" class="headerlink" title="Cloudflared æœ¬åœ°è°ƒè¯• Kubernetes Webhook"></a>Cloudflared æœ¬åœ°è°ƒè¯• Kubernetes Webhook</h1><p>æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cloudflared éš§é“æŠ€æœ¯åœ¨æœ¬åœ°è°ƒè¯• Kubernetes Webhookï¼Œæ— éœ€æš´éœ²å…¬ç½‘ IP æˆ–é…ç½®å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚</p>
<h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><ul>
<li><a href="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">æ–¹æ¡ˆå¯¹æ¯”</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">ç¯å¢ƒå‡†å¤‡</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4">æ“ä½œæ­¥éª¤</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">å¸¸è§é—®é¢˜</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æœ€ä½³å®è·µ</a></li>
</ul>
<hr>
<h2 id="æ–¹æ¡ˆå¯¹æ¯”"><a href="#æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="æ–¹æ¡ˆå¯¹æ¯”"></a>æ–¹æ¡ˆå¯¹æ¯”</h2><h3 id="Localtunnel-vs-Cloudflared"><a href="#Localtunnel-vs-Cloudflared" class="headerlink" title="Localtunnel vs Cloudflared"></a>Localtunnel vs Cloudflared</h3><table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>caBundle é…ç½®</th>
<th>æ˜¯å¦å¯è¡Œ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Localtunnel</strong></td>
<td>è®¾ç½®ä¸ºç©º</td>
<td>âŒ <strong>ä¸å¯è¡Œ</strong></td>
<td>Localtunnel ä½¿ç”¨ <code>*.loca.lt</code> è¯ä¹¦ï¼Œè°ƒè¯•ä¼šå‡ºç° tls: failed to verify certificate: x509: certificate signed by unknown authorityi</td>
</tr>
<tr>
<td><strong>Cloudflared</strong></td>
<td>è®¾ç½®ä¸ºç©º</td>
<td>âœ… <strong>æ¨è</strong></td>
<td>Cloudflare æä¾›ä¼ä¸šçº§ç¨³å®šéš§é“æœåŠ¡ï¼Œè¯ä¹¦è¢«ç³»ç»Ÿä¿¡ä»»ï¼Œè¿æ¥ç¨³å®šå¯é </td>
</tr>
</tbody></table>
<p><strong>ç»“è®º</strong>ï¼š<code>caBundle</code> è®¾ç½®ä¸ºç©ºï¼ˆä¾èµ–ç³»ç»Ÿ CA ä¿¡ä»»é“¾ï¼‰ï¼Œ <strong>åœ¨ç¨³å®šæ€§ã€æ€§èƒ½å’Œå¯é æ€§ä¸Šè¿œä¼˜äº Localtunnel</strong>ï¼Œæ¨èä½¿ç”¨ Cloudflaredã€‚</p>
<hr>
<h3 id="ç³»ç»Ÿé»˜è®¤ä¿¡ä»»è¯ä¹¦"><a href="#ç³»ç»Ÿé»˜è®¤ä¿¡ä»»è¯ä¹¦" class="headerlink" title="ç³»ç»Ÿé»˜è®¤ä¿¡ä»»è¯ä¹¦"></a>ç³»ç»Ÿé»˜è®¤ä¿¡ä»»è¯ä¹¦</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#å­˜æ”¾çš„æ˜¯è¯ä¹¦é“¾</span><br><span class="line">/etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹æœºå™¨ä¸Šå—ä¿¡ä»»çš„è¯ä¹¦æœºæ„</span><br><span class="line">awk -v cmd=&#x27;openssl x509 -noout -subject&#x27; &#x27; /BEGIN/&#123;close(cmd)&#125;;&#123;print | cmd&#125;&#x27; &lt; /etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#ä¹Ÿå¯ä»¥ä»¥ä¸‹å‘½ä»¤åˆ†å¼€æŸ¥çœ‹</span><br><span class="line">awk &#x27;/BEGIN/&#123;i++&#125;&#123;print &gt; &quot;cert_&quot;i&quot;.crt&quot;&#125;&#x27; /etc/ssl/certs/ca-certificates.crt</span><br><span class="line"></span><br><span class="line">#æŸ¥æŸä¸€ä¸ª</span><br><span class="line">openssl x509 -in cert_1.crt -noout -text | grep -A1 &quot;Subject Alternative Name&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#æ£€æŸ¥â€œç³»ç»Ÿæ˜¯å¦ä¿¡ä»»æŸåŸŸåçš„è¯ä¹¦â€</span><br><span class="line">echo | openssl s_client -connect example.com:443 2&gt;/dev/null | openssl x509 -noout -subject -issuer -text | grep -A1 &quot;Subject Alternative Name&quot;</span><br><span class="line"></span><br><span class="line">- æ£€æŸ¥è¿”å›æ˜¯å¦åŒ…å«ï¼šVerify return code: 0 (ok)</span><br><span class="line">- å¦‚æœæ˜¯ 0 â†’ è¯´æ˜ç³»ç»Ÿä¿¡ä»»è¿™ä¸ªè¯ä¹¦ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="1-å®‰è£…-Cloudflared"><a href="#1-å®‰è£…-Cloudflared" class="headerlink" title="1. å®‰è£… Cloudflared"></a>1. å®‰è£… Cloudflared</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">https://github.com/cloudflare/cloudflared</span><br><span class="line"></span><br><span class="line"># Linux</span><br><span class="line">rpm -ivh https://github.com/cloudflare/cloudflared/releases/download/2025.11.1/cloudflared-linux-x86_64.rpm</span><br><span class="line"></span><br><span class="line"># éªŒè¯å®‰è£…</span><br><span class="line">cloudflared --version</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="æ“ä½œæ­¥éª¤"><a href="#æ“ä½œæ­¥éª¤" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h2><h3 id="æ­¥éª¤-0ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦"><a href="#æ­¥éª¤-0ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦" class="headerlink" title="æ­¥éª¤ 0ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦"></a>æ­¥éª¤ 0ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦</h3><p>Webhook Controller å¯åŠ¨æ—¶éœ€è¦ TLS è¯ä¹¦ï¼Œä½¿ç”¨ä»¥ä¸‹è„šæœ¬ç”Ÿæˆï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">LOCAL_IP=<span class="string">&quot;10.16.217.194&quot;</span></span><br><span class="line">WEBHOOK_PORT=<span class="string">&quot;11443&quot;</span></span><br><span class="line">VALIDATING_WEBHOOK_CONFIG_NAME=<span class="string">&quot;dev-lbv4-webhook-debug&quot;</span></span><br><span class="line">WEBHOOK_CERT_DIR=<span class="string">&quot;/tmp/k8s-webhook-server/serving-certs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç½‘ç»œè¿é€šæ€§</span></span><br><span class="line"><span class="keyword">if</span> ! kubectl cluster-info &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ³•è¿æ¥åˆ°Kubernetesé›†ç¾¤&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;è¯·æ£€æŸ¥KUBECONFIGè®¾ç½®ï¼š<span class="variable">$KUBECONFIG</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨</span></span><br><span class="line"><span class="keyword">if</span> netstat -tlnp 2&gt;/dev/null | grep -q <span class="string">&quot;:<span class="variable">$&#123;WEBHOOK_PORT&#125;</span> &quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ ç«¯å£ <span class="variable">$&#123;WEBHOOK_PORT&#125;</span> å·²è¢«å ç”¨ï¼Œè¯·å…ˆå…³é—­å ç”¨è¿›ç¨‹&quot;</span></span><br><span class="line">    netstat -tlnp | grep <span class="string">&quot;:<span class="variable">$&#123;WEBHOOK_PORT&#125;</span> &quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬1æ­¥ï¼šé‡æ–°ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line"><span class="comment"># å¦åˆ™å¯åŠ¨ï¼španic: open /tmp/k8s-webhook-server/serving-certs/tls.crt: no such file or directory</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ç¬¬1æ­¥ï¼šé‡æ–°ç”ŸæˆTLSè¯ä¹¦ï¼ˆæ”¯æŒIP: <span class="variable">$&#123;LOCAL_IP&#125;</span>ï¼‰...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†æ—§è¯ä¹¦</span></span><br><span class="line"><span class="built_in">rm</span> -rf certs/*</span><br><span class="line"><span class="built_in">mkdir</span> -p certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ–°çš„è¯ä¹¦é…ç½®</span></span><br><span class="line"><span class="built_in">cat</span> &gt; certs/server.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">C = CN</span></span><br><span class="line"><span class="string">ST = Beijing</span></span><br><span class="line"><span class="string">L = Beijing</span></span><br><span class="line"><span class="string">O = Qihoo</span></span><br><span class="line"><span class="string">OU = DevOps</span></span><br><span class="line"><span class="string">CN = *.qihoo.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">keyUsage = keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = *.qihoo.com</span></span><br><span class="line"><span class="string">DNS.2 = k8s.qihoo.com</span></span><br><span class="line"><span class="string">IP.1 = 10.16.217.194</span></span><br><span class="line"><span class="string">IP.2 = 127.0.0.1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”ŸæˆCAè¯ä¹¦</span></span><br><span class="line">openssl genrsa -out certs/ca.key 2048 &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl req -new -x509 -days 365 -key certs/ca.key -out certs/ca.crt -subj <span class="string">&quot;/CN=*.qihoo.com&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦</span></span><br><span class="line">openssl genrsa -out certs/tls.key 2048 &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl req -new -key certs/tls.key -out certs/server.csr -config certs/server.conf &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> certs/server.csr -CA certs/ca.crt -CAkey certs/ca.key -CAcreateserial -out certs/tls.crt -days 365 -extensions v3_req -extfile certs/server.conf &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… è¯ä¹¦ç”Ÿæˆå®Œæˆ&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†è¯ä¹¦å¤åˆ¶åˆ°controller-runtimeæœŸæœ›çš„ä½ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å¤åˆ¶è¯ä¹¦åˆ°controller-runtimeæœŸæœ›çš„ä½ç½®...&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> certs/tls.crt <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> certs/tls.key <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 644 <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.crt</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 600 <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.key</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> <span class="variable">$USER</span>:<span class="variable">$USER</span> <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.*</span><br><span class="line"><span class="built_in">sudo</span> tree <span class="variable">$WEBHOOK_CERT_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… è¯ä¹¦å·²å¤åˆ¶åˆ° <span class="variable">$WEBHOOK_CERT_DIR</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;éªŒè¯è¯ä¹¦å†…å®¹:&quot;</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> <span class="variable">$WEBHOOK_CERT_DIR</span>/tls.crt -text -noout | grep -E <span class="string">&quot;(Subject:|DNS:|IP Address:)&quot;</span> | <span class="built_in">head</span> -10</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºä½¿ç”¨è¯´æ˜</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ¥ä¸‹æ¥è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1ï¸âƒ£  åœ¨VSCodeä¸­è®¾ç½®æ–­ç‚¹ï¼š&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   - åœ¨ webhook Handle æ–¹æ³•å¼€å§‹å¤„è®¾ç½®æ–­ç‚¹&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2ï¸âƒ£  å¯åŠ¨è°ƒè¯•å™¨ï¼š&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3ï¸âƒ£  å¯åŠ¨cloudflaredï¼Œç„¶åæ ¹æ®ç”Ÿæˆçš„URLéƒ¨ç½²validatingwebhookconfiguration&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="æ­¥éª¤-2ï¼šå¯åŠ¨-Cloudflared-éš§é“"><a href="#æ­¥éª¤-2ï¼šå¯åŠ¨-Cloudflared-éš§é“" class="headerlink" title="æ­¥éª¤ 2ï¼šå¯åŠ¨ Cloudflared éš§é“"></a>æ­¥éª¤ 2ï¼šå¯åŠ¨ Cloudflared éš§é“</h3><p>ä½¿ç”¨ <code>--no-tls-verify</code> å‚æ•°ç¦ç”¨ Cloudflared å¯¹åç«¯ HTTPS è¯ä¹¦çš„éªŒè¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cloudflared tunnel --url https://localhost:11443 --no-tls-verify</span><br></pre></td></tr></table></figure>

<p><strong>è®°å½•è¾“å‡ºçš„å…¬ç½‘ URL</strong>ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------------------------------------------------------------+</span><br><span class="line">|  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable):  |</span><br><span class="line">|  https://since-machinery-ruby-plate.trycloudflare.com                                     |</span><br><span class="line">+--------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>âš ï¸ æ³¨æ„</strong>ï¼šæ¯æ¬¡å¯åŠ¨ Cloudflared éƒ½ä¼šç”Ÿæˆæ–°çš„éšæœºåŸŸåï¼Œä½ éœ€è¦æ›´æ–° Webhook é…ç½®ã€‚</p>
</blockquote>
<p><strong>ä¿æŒç»ˆç«¯è¿è¡Œ</strong>ï¼Œä¸è¦å…³é—­ Cloudflared è¿›ç¨‹ã€‚</p>
<hr>
<h3 id="æ­¥éª¤-3ï¼šé…ç½®-ValidatingWebhookConfiguration"><a href="#æ­¥éª¤-3ï¼šé…ç½®-ValidatingWebhookConfiguration" class="headerlink" title="æ­¥éª¤ 3ï¼šé…ç½® ValidatingWebhookConfiguration"></a>æ­¥éª¤ 3ï¼šé…ç½® ValidatingWebhookConfiguration</h3><p>åˆ›å»º Webhook é…ç½®æ–‡ä»¶ <code>webhook-config.yaml</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-lv4-webhook-debug</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev.lb4.webhook.validator</span></span><br><span class="line">  <span class="attr">admissionReviewVersions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">v1beta1</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ Cloudflared æä¾›çš„å…¬ç½‘ URL</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://since-machinery-ruby-plate.trycloudflare.com/validate-delete-pods</span></span><br><span class="line">    <span class="comment"># ğŸ”‘ å…³é”®ï¼šcaBundle å¿…é¡»ä¸ºç©º</span></span><br><span class="line">    <span class="comment"># å½“ä½¿ç”¨å¤–éƒ¨ URL æ—¶ï¼ŒAPI Server ä¼šä½¿ç”¨ç³»ç»Ÿä¿¡ä»»çš„ CA éªŒè¯è¯ä¹¦</span></span><br><span class="line">    <span class="comment"># Cloudflare çš„è¯ä¹¦å·²è¢«ç³»ç»Ÿ CA ä¿¡ä»»</span></span><br><span class="line">    <span class="attr">caBundle:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è°ƒè¯•é˜¶æ®µè®¾ç½®ä¸º Failï¼Œä¾¿äºæŸ¥çœ‹é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">  <span class="comment"># ç”Ÿäº§ç¯å¢ƒå¯è®¾ç½®ä¸º Ignore</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">matchPolicy:</span> <span class="string">Equivalent</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å‘½åç©ºé—´é€‰æ‹©å™¨ï¼šä»…å¯¹ default å‘½åç©ºé—´ç”Ÿæ•ˆ</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/metadata.name</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">      <span class="attr">values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zxtest</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">objectSelector:</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ‹¦æˆªè§„åˆ™ï¼šåˆ é™¤ Pod æ“ä½œ</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">apiVersions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">operations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DELETE</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è°ƒè¯•æ—¶è®¾ç½®è¾ƒé•¿è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p><strong>åº”ç”¨é…ç½®</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f webhook-config.yaml</span><br></pre></td></tr></table></figure>

<p><strong>éªŒè¯é…ç½®</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ Webhook é…ç½®</span></span><br><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤ URL å’Œ caBundle è®¾ç½®æ­£ç¡®</span></span><br><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug \</span><br><span class="line">    -o jsonpath=<span class="string">&#x27;&#123;.webhooks[0].clientConfig&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="æ­¥éª¤-4ï¼šæµ‹è¯•-Webhook"><a href="#æ­¥éª¤-4ï¼šæµ‹è¯•-Webhook" class="headerlink" title="æ­¥éª¤ 4ï¼šæµ‹è¯• Webhook"></a>æ­¥éª¤ 4ï¼šæµ‹è¯• Webhook</h3><p><strong>è§¦å‘ Webhook éªŒè¯</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤ default å‘½åç©ºé—´ä¸‹Podï¼Œè§‚å¯Ÿ Webhook æ˜¯å¦è¢«è°ƒç”¨</span></span><br><span class="line">kubectl delete pod test-pod -n default</span><br></pre></td></tr></table></figure>

<p><strong>é¢„æœŸç»“æœ</strong>ï¼š</p>
<ul>
<li>âœ… VSCode ä¸­çš„æ–­ç‚¹è¢«è§¦å‘</li>
<li>âœ… Cloudflared ç»ˆç«¯æ˜¾ç¤ºè¯·æ±‚æ—¥å¿—</li>
<li>âœ… Pod åˆ é™¤æˆåŠŸæˆ–è¢«æ‹’ç»ï¼ˆå–å†³äºä½ çš„éªŒè¯é€»è¾‘ï¼‰</li>
</ul>
<hr>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="1-è¯ä¹¦éªŒè¯å¤±è´¥"><a href="#1-è¯ä¹¦éªŒè¯å¤±è´¥" class="headerlink" title="1. è¯ä¹¦éªŒè¯å¤±è´¥"></a>1. è¯ä¹¦éªŒè¯å¤±è´¥</h3><p><strong>é”™è¯¯ä¿¡æ¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls: failed to verify certificate: x509: certificate signed by unknown authority</span><br></pre></td></tr></table></figure>

<p><strong>åŸå› </strong>ï¼šCloudflared å°è¯•éªŒè¯åç«¯ HTTPS è¯ä¹¦ï¼Œä½†ä½ ä½¿ç”¨çš„æ˜¯è‡ªç­¾åè¯ä¹¦ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>âœ… ç¡®ä¿å¯åŠ¨ Cloudflared æ—¶ä½¿ç”¨äº† <code>--no-tls-verify</code> å‚æ•°</li>
<li>âœ… æˆ–è€…ä½¿ç”¨ HTTP åç«¯ï¼ˆ<code>--url http://localhost:8080</code>ï¼‰</li>
</ul>
<hr>
<h3 id="2-Webhook-è¶…æ—¶"><a href="#2-Webhook-è¶…æ—¶" class="headerlink" title="2. Webhook è¶…æ—¶"></a>2. Webhook è¶…æ—¶</h3><p><strong>é”™è¯¯ä¿¡æ¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to call webhook: Post &quot;https://xxx.trycloudflare.com/validate-delete-pods?timeout=10s&quot;: context deadline exceeded</span><br></pre></td></tr></table></figure>

<p><strong>åŸå› </strong>ï¼š</p>
<ul>
<li>ç½‘ç»œå»¶è¿Ÿè¿‡é«˜</li>
<li>Webhook å¤„ç†é€»è¾‘è€—æ—¶è¿‡é•¿</li>
<li>Cloudflared éš§é“ä¸ç¨³å®š</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–ä¸´æ—¶è®¾ç½®ä¸º Ignore æ¨¡å¼</span></span><br><span class="line"><span class="attr">failurePolicy:</span> <span class="string">Ignore</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-Cloudflared-è¿æ¥æ–­å¼€"><a href="#3-Cloudflared-è¿æ¥æ–­å¼€" class="headerlink" title="3. Cloudflared è¿æ¥æ–­å¼€"></a>3. Cloudflared è¿æ¥æ–­å¼€</h3><p><strong>ç°è±¡</strong>ï¼šéš§é“ URL æ— æ³•è®¿é—®ï¼ŒAPI Server è°ƒç”¨å¤±è´¥ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. é‡å¯ Cloudflared</span></span><br><span class="line">cloudflared tunnel --url https://localhost:11443 --no-tls-verify</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ›´æ–° Webhook é…ç½®ä¸­çš„æ–° URL</span></span><br><span class="line">kubectl edit validatingwebhookconfiguration dev-webhook-debug</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ä½¿ç”¨å‘½åéš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰</span></span><br><span class="line">cloudflared tunnel create my-webhook-tunnel</span><br><span class="line">cloudflared tunnel route dns my-webhook-tunnel webhook.example.com</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-API-Server-æ— æ³•è®¿é—®å…¬ç½‘"><a href="#4-API-Server-æ— æ³•è®¿é—®å…¬ç½‘" class="headerlink" title="4. API Server æ— æ³•è®¿é—®å…¬ç½‘"></a>4. API Server æ— æ³•è®¿é—®å…¬ç½‘</h3><p><strong>ç°è±¡</strong>ï¼šé›†ç¾¤åœ¨ç§æœ‰ç½‘ç»œä¸­ï¼Œæ— æ³•è®¿é—® Cloudflare éš§é“ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šåœ¨é›†ç¾¤å†…éƒ¨ç½² Cloudflared ä»£ç†ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cloudflared-proxy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloudflared</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cloudflare/cloudflared:latest</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cloudflared</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tunnel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--url</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">http://your-webhook-service:8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--no-tls-verify</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="5-è°ƒè¯•æ–­ç‚¹æœªè§¦å‘"><a href="#5-è°ƒè¯•æ–­ç‚¹æœªè§¦å‘" class="headerlink" title="5. è°ƒè¯•æ–­ç‚¹æœªè§¦å‘"></a>5. è°ƒè¯•æ–­ç‚¹æœªè§¦å‘</h3><p><strong>æ£€æŸ¥æ¸…å•</strong>ï¼š</p>
<ol>
<li><p>âœ… Controller æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -i :11443</span><br></pre></td></tr></table></figure>
</li>
<li><p>âœ… Cloudflared æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æµ‹è¯•éš§é“è¿é€šæ€§</span></span><br><span class="line">curl https://since-machinery-ruby-plate.trycloudflare.com/validate-delete-pods</span><br></pre></td></tr></table></figure>
</li>
<li><p>âœ… Webhook é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get validatingwebhookconfiguration dev-webhook-debug -o yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>âœ… Pod æ˜¯å¦åœ¨æ­£ç¡®çš„å‘½åç©ºé—´ï¼Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®è®¤ namespaceSelector é…ç½®</span></span><br><span class="line">kubectl get pod -n default</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="1-ä½¿ç”¨æŒä¹…åŒ–éš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"><a href="#1-ä½¿ç”¨æŒä¹…åŒ–éš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰" class="headerlink" title="1. ä½¿ç”¨æŒä¹…åŒ–éš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"></a>1. ä½¿ç”¨æŒä¹…åŒ–éš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</h3><p>ä¸´æ—¶éš§é“æ¯æ¬¡å¯åŠ¨ URL éƒ½ä¼šå˜åŒ–ï¼Œä¸é€‚åˆé•¿æœŸä½¿ç”¨ã€‚åˆ›å»ºå‘½åéš§é“ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç™»å½• Cloudflare</span></span><br><span class="line">cloudflared tunnel login</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå‘½åéš§é“</span></span><br><span class="line">cloudflared tunnel create my-webhook-tunnel</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®è·¯ç”±</span></span><br><span class="line">cloudflared tunnel route dns my-webhook-tunnel webhook.yourdomain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé…ç½®æ–‡ä»¶ ~/.cloudflared/config.yml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; ~/.cloudflared/config.yml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">tunnel: &lt;tunnel-id&gt;</span></span><br><span class="line"><span class="string">credentials-file: /path/to/credentials.json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ingress:</span></span><br><span class="line"><span class="string">  - hostname: webhook.yourdomain.com</span></span><br><span class="line"><span class="string">    service: https://localhost:11443</span></span><br><span class="line"><span class="string">    originRequest:</span></span><br><span class="line"><span class="string">      noTLSVerify: true</span></span><br><span class="line"><span class="string">  - service: http_status:404</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨éš§é“</span></span><br><span class="line">cloudflared tunnel run my-webhook-tunnel</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½¿ç”¨ Cloudflared è°ƒè¯• Kubernetes Webhook çš„ä¼˜åŠ¿ï¼š</p>
<ul>
<li>âœ… <strong>é›¶é…ç½®</strong>ï¼šæ— éœ€é…ç½®é˜²ç«å¢™ã€NAT æˆ–å…¬ç½‘ IP</li>
<li>âœ… <strong>å®‰å…¨</strong>ï¼šä½¿ç”¨ Cloudflare ä¼ä¸šçº§å®‰å…¨éš§é“</li>
<li>âœ… <strong>ç¨³å®š</strong>ï¼šCloudflare å…¨çƒç½‘ç»œä¿è¯è¿æ¥è´¨é‡</li>
<li>âœ… <strong>å¿«é€Ÿ</strong>ï¼šå‡ åˆ†é’Ÿå³å¯å®Œæˆé…ç½®</li>
</ul>
<p><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p>
<ol>
<li>ä½¿ç”¨ <code>--no-tls-verify</code> è·³è¿‡åç«¯è¯ä¹¦éªŒè¯</li>
<li>Webhook é…ç½®ä¸­ <code>caBundle</code> å¿…é¡»ä¸ºç©º</li>
<li>ä¾èµ– Cloudflare çš„å—ä¿¡ä»»è¯ä¹¦å®Œæˆ TLS æ¡æ‰‹</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/11/17/terminationGracePeriodSeconds%E4%B8%8EdeletionGracePeriodSeconds/" rel="prev" title="terminationGracePeriodSecondsä¸deletionGracePeriodSeconds">
      <i class="fa fa-chevron-left"></i> terminationGracePeriodSecondsä¸deletionGracePeriodSeconds
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/11/27/Go%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/" rel="next" title="Goå¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µæŒ‡å—">
      Goå¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µæŒ‡å— <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Cloudflared-%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95-Kubernetes-Webhook"><span class="nav-number">1.</span> <span class="nav-text">Cloudflared æœ¬åœ°è°ƒè¯• Kubernetes Webhook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%93%8B-%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">ğŸ“‹ ç›®å½•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="nav-number">1.2.</span> <span class="nav-text">æ–¹æ¡ˆå¯¹æ¯”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Localtunnel-vs-Cloudflared"><span class="nav-number">1.2.1.</span> <span class="nav-text">Localtunnel vs Cloudflared</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E9%BB%98%E8%AE%A4%E4%BF%A1%E4%BB%BB%E8%AF%81%E4%B9%A6"><span class="nav-number">1.2.2.</span> <span class="nav-text">ç³»ç»Ÿé»˜è®¤ä¿¡ä»»è¯ä¹¦</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.3.</span> <span class="nav-text">ç¯å¢ƒå‡†å¤‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85-Cloudflared"><span class="nav-number">1.3.1.</span> <span class="nav-text">1. å®‰è£… Cloudflared</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.4.</span> <span class="nav-text">æ“ä½œæ­¥éª¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-0%EF%BC%9A%E7%94%9F%E6%88%90%E8%87%AA%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="nav-number">1.4.1.</span> <span class="nav-text">æ­¥éª¤ 0ï¼šç”Ÿæˆè‡ªç­¾åè¯ä¹¦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%90%AF%E5%8A%A8-Cloudflared-%E9%9A%A7%E9%81%93"><span class="nav-number">1.4.2.</span> <span class="nav-text">æ­¥éª¤ 2ï¼šå¯åŠ¨ Cloudflared éš§é“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E9%85%8D%E7%BD%AE-ValidatingWebhookConfiguration"><span class="nav-number">1.4.3.</span> <span class="nav-text">æ­¥éª¤ 3ï¼šé…ç½® ValidatingWebhookConfiguration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E6%B5%8B%E8%AF%95-Webhook"><span class="nav-number">1.4.4.</span> <span class="nav-text">æ­¥éª¤ 4ï¼šæµ‹è¯• Webhook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">1.5.</span> <span class="nav-text">å¸¸è§é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81%E5%A4%B1%E8%B4%A5"><span class="nav-number">1.5.1.</span> <span class="nav-text">1. è¯ä¹¦éªŒè¯å¤±è´¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Webhook-%E8%B6%85%E6%97%B6"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. Webhook è¶…æ—¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Cloudflared-%E8%BF%9E%E6%8E%A5%E6%96%AD%E5%BC%80"><span class="nav-number">1.5.3.</span> <span class="nav-text">3. Cloudflared è¿æ¥æ–­å¼€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-API-Server-%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91"><span class="nav-number">1.5.4.</span> <span class="nav-text">4. API Server æ— æ³•è®¿é—®å…¬ç½‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E8%B0%83%E8%AF%95%E6%96%AD%E7%82%B9%E6%9C%AA%E8%A7%A6%E5%8F%91"><span class="nav-number">1.5.5.</span> <span class="nav-text">5. è°ƒè¯•æ–­ç‚¹æœªè§¦å‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.6.</span> <span class="nav-text">æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8C%96%E9%9A%A7%E9%81%93%EF%BC%88%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%EF%BC%89"><span class="nav-number">1.6.1.</span> <span class="nav-text">1. ä½¿ç”¨æŒä¹…åŒ–éš§é“ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.7.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">178</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
