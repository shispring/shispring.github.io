<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shispring.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta name="description" content="Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æğŸ¯ ç›®å½• Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£ Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ› Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹   Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨   é˜¶æ®µ Pod Phase Pod Condition Container State Webhook è§¦å‘">
<meta property="og:type" content="article">
<meta property="og:title" content="podç”Ÿå‘½å‘¨æœŸä¸webhookç®¡æ§åˆ†æ">
<meta property="og:url" content="https://shispring.github.io/2025/08/01/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8Ewebhook%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æğŸ¯ ç›®å½• Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£ Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ› Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹   Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨   é˜¶æ®µ Pod Phase Pod Condition Container State Webhook è§¦å‘">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-08-01T06:56:23.000Z">
<meta property="article:modified_time" content="2025-08-01T06:59:16.807Z">
<meta property="article:author" content="shispring">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shispring.github.io/2025/08/01/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8Ewebhook%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>podç”Ÿå‘½å‘¨æœŸä¸webhookç®¡æ§åˆ†æ | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources" rel="section"><i class="fa fa-download fa-fw"></i>èµ„æº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shispring.github.io/2025/08/01/pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8Ewebhook%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="shispring">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          podç”Ÿå‘½å‘¨æœŸä¸webhookç®¡æ§åˆ†æ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-01 14:56:23 / ä¿®æ”¹æ—¶é—´ï¼š14:59:16" itemprop="dateCreated datePublished" datetime="2025-08-01T14:56:23+08:00">2025-08-01</time>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Kubernetes-Pod-ç”Ÿå‘½å‘¨æœŸä¸-Webhook-ç®¡æ§åˆ†æ"><a href="#Kubernetes-Pod-ç”Ÿå‘½å‘¨æœŸä¸-Webhook-ç®¡æ§åˆ†æ" class="headerlink" title="Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æ"></a>Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æ</h1><h2 id="ğŸ¯-ç›®å½•"><a href="#ğŸ¯-ç›®å½•" class="headerlink" title="ğŸ¯ ç›®å½•"></a>ğŸ¯ ç›®å½•</h2><ul>
<li><a href="#pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%8A%B6%E6%80%81%E8%AF%A6%E8%A7%A3">Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</a></li>
<li><a href="#webhook-%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA">Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº</a></li>
<li><a href="#%E5%90%84%E9%98%B6%E6%AE%B5-webhook-%E7%AE%A1%E6%8E%A7%E8%83%BD%E5%8A%9B">å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›</a></li>
<li><a href="#pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B%E5%9B%BE">Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B">å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</a></li>
</ul>
<hr>
<h2 id="Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"><a href="#Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£" class="headerlink" title="Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"></a>Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</h2><h3 id="ğŸ“Š-Pod-çŠ¶æ€è½¬æ¢è¡¨"><a href="#ğŸ“Š-Pod-çŠ¶æ€è½¬æ¢è¡¨" class="headerlink" title="ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨"></a>ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨</h3><table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>Pod Phase</th>
<th>Pod Condition</th>
<th>Container State</th>
<th>Webhook è§¦å‘</th>
<th>ç®¡æ§èƒ½åŠ›</th>
</tr>
</thead>
<tbody><tr>
<td><strong>åˆ›å»ºå‰</strong></td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>âœ… ValidatingAdmissionWebhook<br>âœ… MutatingAdmissionWebhook</td>
<td>ğŸ”¥ <strong>å®Œå…¨ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>åˆ›å»ºä¸­</strong></td>
<td>Pending</td>
<td>PodScheduled: False</td>
<td>Waiting</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>è°ƒåº¦ä¸­</strong></td>
<td>Pending</td>
<td>PodScheduled: True</td>
<td>Waiting</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>åˆå§‹åŒ–</strong></td>
<td>Pending</td>
<td>Initialized: False</td>
<td>Waiting&#x2F;Running</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>è¿è¡Œä¸­</strong></td>
<td>Running</td>
<td>Ready: True</td>
<td>Running</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>ç»ˆæ­¢å‰</strong></td>
<td>Running â†’ Terminating</td>
<td>-</td>
<td>Running</td>
<td>âœ… Lifecycle PreStop Hook</td>
<td>âš ï¸ <strong>æœ‰é™ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>ç»ˆæ­¢ä¸­</strong></td>
<td>Terminating</td>
<td>-</td>
<td>Terminating</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
<tr>
<td><strong>å®Œæˆ&#x2F;å¤±è´¥</strong></td>
<td>Succeeded&#x2F;Failed</td>
<td>-</td>
<td>Terminated</td>
<td>âŒ</td>
<td>ğŸš« <strong>æ— æ³•ç®¡æ§</strong></td>
</tr>
</tbody></table>
<h3 id="ğŸ”-å…³é”®è§‚å¯Ÿç‚¹"><a href="#ğŸ”-å…³é”®è§‚å¯Ÿç‚¹" class="headerlink" title="ğŸ” å…³é”®è§‚å¯Ÿç‚¹"></a>ğŸ” å…³é”®è§‚å¯Ÿç‚¹</h3><h4 id="1-Webhook-ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»"><a href="#1-Webhook-ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»" class="headerlink" title="1. Webhook ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»"></a>1. Webhook ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»</h4><ul>
<li><strong>Pod åˆ›å»ºå‰</strong>ï¼šAdmission Controller é˜¶æ®µï¼Œæœ€å¼ºç®¡æ§èƒ½åŠ›</li>
<li><strong>Pod ç»ˆæ­¢å‰</strong>ï¼šPreStop Hook é˜¶æ®µï¼Œæœ‰é™çš„ä¼˜é›…å…³é—­æ§åˆ¶</li>
</ul>
<h4 id="2-æ— æ³•ç®¡æ§çš„é˜¶æ®µ"><a href="#2-æ— æ³•ç®¡æ§çš„é˜¶æ®µ" class="headerlink" title="2. æ— æ³•ç®¡æ§çš„é˜¶æ®µ"></a>2. æ— æ³•ç®¡æ§çš„é˜¶æ®µ</h4><ul>
<li>Pod åˆ›å»ºåçš„æ•´ä¸ªè¿è¡Œç”Ÿå‘½å‘¨æœŸ</li>
<li>å®¹å™¨å¯åŠ¨ã€å¥åº·æ£€æŸ¥ã€é‡å¯ç­‰è¿‡ç¨‹</li>
<li>èµ„æºè°ƒåº¦å’ŒèŠ‚ç‚¹åˆ†é…è¿‡ç¨‹</li>
</ul>
<hr>
<h2 id="Webhook-ç±»å‹ä¸è§¦å‘æ—¶æœº"><a href="#Webhook-ç±»å‹ä¸è§¦å‘æ—¶æœº" class="headerlink" title="Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº"></a>Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº</h2><h3 id="ğŸ£-Admission-Controller-Webhook"><a href="#ğŸ£-Admission-Controller-Webhook" class="headerlink" title="ğŸ£ Admission Controller Webhook"></a>ğŸ£ Admission Controller Webhook</h3><h4 id="ValidatingAdmissionWebhook"><a href="#ValidatingAdmissionWebhook" class="headerlink" title="ValidatingAdmissionWebhook"></a>ValidatingAdmissionWebhook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate-pod.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/validate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>è§¦å‘æ—¶æœºï¼š</strong></p>
<ul>
<li>âœ… Pod CREATE è¯·æ±‚</li>
<li>âœ… Pod UPDATE è¯·æ±‚  </li>
<li>âœ… åœ¨ etcd å­˜å‚¨ä¹‹å‰</li>
<li>âœ… åœ¨è°ƒåº¦å™¨åˆ†é…ä¹‹å‰</li>
</ul>
<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>ğŸ”¥ <strong>æ‹’ç»åˆ›å»º</strong>ï¼šè¿”å›é”™è¯¯é˜»æ­¢ Pod åˆ›å»º</li>
<li>ğŸ”¥ <strong>éªŒè¯è§„åˆ™</strong>ï¼šæ£€æŸ¥èµ„æºé™åˆ¶ã€æ ‡ç­¾ã€æ³¨è§£ç­‰</li>
<li>ğŸ”¥ <strong>å®‰å…¨ç­–ç•¥</strong>ï¼šå¼ºåˆ¶å®‰å…¨ç­–ç•¥åˆè§„</li>
</ul>
<h4 id="MutatingAdmissionWebhook"><a href="#MutatingAdmissionWebhook" class="headerlink" title="MutatingAdmissionWebhook"></a>MutatingAdmissionWebhook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MutatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-mutator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mutate-pod.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/mutate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">admissionReviewVersions:</span> [<span class="string">&quot;v1&quot;</span>, <span class="string">&quot;v1beta1&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>ğŸ”¥ <strong>ä¿®æ”¹é…ç½®</strong>ï¼šæ³¨å…¥ sidecar å®¹å™¨</li>
<li>ğŸ”¥ <strong>æ·»åŠ èµ„æº</strong>ï¼šè®¾ç½®é»˜è®¤èµ„æºé™åˆ¶</li>
<li>ğŸ”¥ <strong>å®‰å…¨å¢å¼º</strong>ï¼šæ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡</li>
<li>ğŸ”¥ <strong>ç¯å¢ƒæ³¨å…¥</strong>ï¼šæ·»åŠ ç¯å¢ƒå˜é‡ã€æŒ‚è½½ç‚¹</li>
</ul>
<h3 id="ğŸª-Lifecycle-Hook"><a href="#ğŸª-Lifecycle-Hook" class="headerlink" title="ğŸª Lifecycle Hook"></a>ğŸª Lifecycle Hook</h3><h4 id="PreStop-Hook"><a href="#PreStop-Hook" class="headerlink" title="PreStop Hook"></a>PreStop Hook</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;nginx -s quit; while killall -0 nginx; do sleep 1; done&quot;</span>]</span><br><span class="line">        <span class="comment"># æˆ–è€… HTTP è°ƒç”¨</span></span><br><span class="line">        <span class="attr">httpGet:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/shutdown</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure>

<p><strong>è§¦å‘æ—¶æœºï¼š</strong></p>
<ul>
<li>âœ… Pod æ”¶åˆ° SIGTERM ä¹‹å‰</li>
<li>âœ… åˆ é™¤ Pod æ—¶</li>
<li>âœ… èŠ‚ç‚¹é©±é€æ—¶</li>
<li>âœ… Deployment æ»šåŠ¨æ›´æ–°æ—¶</li>
</ul>
<p><strong>ç®¡æ§èƒ½åŠ›ï¼š</strong></p>
<ul>
<li>âš ï¸ <strong>ä¼˜é›…å…³é—­</strong>ï¼šæ¸…ç†èµ„æºã€ä¿å­˜çŠ¶æ€</li>
<li>âš ï¸ <strong>å®Œæˆå¤„ç†</strong>ï¼šå¤„ç†å‰©ä½™è¯·æ±‚</li>
<li>âš ï¸ <strong>é€šçŸ¥æœåŠ¡</strong>ï¼šé€šçŸ¥å…¶ä»–æœåŠ¡ä¸‹çº¿</li>
<li>âš ï¸ <strong>æœ‰æ—¶é—´é™åˆ¶</strong>ï¼šé»˜è®¤ 30s (terminationGracePeriodSeconds)</li>
</ul>
<hr>
<h2 id="å„é˜¶æ®µ-Webhook-ç®¡æ§èƒ½åŠ›"><a href="#å„é˜¶æ®µ-Webhook-ç®¡æ§èƒ½åŠ›" class="headerlink" title="å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›"></a>å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›</h2><h3 id="ğŸš€-Pod-åˆ›å»ºé˜¶æ®µ-æœ€å¼ºç®¡æ§"><a href="#ğŸš€-Pod-åˆ›å»ºé˜¶æ®µ-æœ€å¼ºç®¡æ§" class="headerlink" title="ğŸš€ Pod åˆ›å»ºé˜¶æ®µ (æœ€å¼ºç®¡æ§)"></a>ğŸš€ Pod åˆ›å»ºé˜¶æ®µ (æœ€å¼ºç®¡æ§)</h3><h4 id="Mutating-Webhook-å…¸å‹ç”¨ä¾‹"><a href="#Mutating-Webhook-å…¸å‹ç”¨ä¾‹" class="headerlink" title="Mutating Webhook å…¸å‹ç”¨ä¾‹"></a>Mutating Webhook å…¸å‹ç”¨ä¾‹</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. Sidecar æ³¨å…¥</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">sidecar.istio.io/inject:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line"><span class="comment"># ç»è¿‡ Mutating Webhook å:</span></span><br><span class="line"><span class="comment"># + istio-proxy sidecar å®¹å™¨</span></span><br><span class="line"><span class="comment"># + ç›¸å…³ volume å’Œ æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="comment"># + ç½‘ç»œé…ç½®ä¿®æ”¹</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. å®‰å…¨ç­–ç•¥æ³¨å…¥</span></span><br><span class="line"><span class="comment"># åŸå§‹ Pod è§„èŒƒ</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># ç»è¿‡ Mutating Webhook å:</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">drop:</span> [<span class="string">&quot;ALL&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Validating-Webhook-å…¸å‹åœºæ™¯"><a href="#Validating-Webhook-å…¸å‹åœºæ™¯" class="headerlink" title="Validating Webhook å…¸å‹åœºæ™¯"></a>Validating Webhook å…¸å‹åœºæ™¯</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Webhook éªŒè¯é€»è¾‘ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">validatePod</span><span class="params">(pod *corev1.Pod)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. èµ„æºé™åˆ¶æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> container.Resources.Limits == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;container %s must have resource limits&quot;</span>, container.Name)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        cpuLimit := container.Resources.Limits[corev1.ResourceCPU]</span><br><span class="line">        <span class="keyword">if</span> cpuLimit.IsZero() || cpuLimit.Cmp(resource.MustParse(<span class="string">&quot;2&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;CPU limit must be between 0 and 2 cores&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. é•œåƒå®‰å…¨æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> !strings.HasPrefix(container.Image, <span class="string">&quot;registry.company.com/&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;only internal registry images are allowed&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ ‡ç­¾å¿…éœ€æ€§æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Labels[<span class="string">&quot;app&quot;</span>] == <span class="string">&quot;&quot;</span> || pod.Labels[<span class="string">&quot;version&quot;</span>] == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;app and version labels are required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-Pod-ç»ˆæ­¢é˜¶æ®µ-æœ‰é™ç®¡æ§"><a href="#âš ï¸-Pod-ç»ˆæ­¢é˜¶æ®µ-æœ‰é™ç®¡æ§" class="headerlink" title="âš ï¸ Pod ç»ˆæ­¢é˜¶æ®µ (æœ‰é™ç®¡æ§)"></a>âš ï¸ Pod ç»ˆæ­¢é˜¶æ®µ (æœ‰é™ç®¡æ§)</h3><h4 id="PreStop-Hook-ä½¿ç”¨åœºæ™¯"><a href="#PreStop-Hook-ä½¿ç”¨åœºæ™¯" class="headerlink" title="PreStop Hook ä½¿ç”¨åœºæ™¯"></a>PreStop Hook ä½¿ç”¨åœºæ™¯</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ•°æ®åº“è¿æ¥æ± ä¼˜é›…å…³é—­</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            # åœæ­¢æ¥å—æ–°è¯·æ±‚</span></span><br><span class="line"><span class="string">            curl -X POST http://localhost:8080/admin/shutdown</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ</span></span><br><span class="line">            <span class="string">while</span> [ <span class="string">$(curl</span> <span class="string">-s</span> <span class="string">http://localhost:8080/admin/connections)</span> <span class="string">-gt</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">do</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">&quot;Waiting for connections to drain...&quot;</span></span><br><span class="line">              <span class="string">sleep</span> <span class="number">2</span></span><br><span class="line">            <span class="string">done</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ¸…ç†ç¼“å­˜</span></span><br><span class="line">            <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://localhost:8080/admin/flush-cache</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…ä¼˜é›…å…³é—­</span></span><br><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">  <span class="attr">preStop:</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        # åœæ­¢æ¶ˆè´¹æ–°æ¶ˆæ¯</span></span><br><span class="line"><span class="string">        kill -USR1 $(pgrep consumer)</span></span><br><span class="line"><span class="string"></span>        </span><br><span class="line">        <span class="comment"># ç­‰å¾…å½“å‰æ¶ˆæ¯å¤„ç†å®Œæˆ</span></span><br><span class="line">        <span class="string">while</span> <span class="string">pgrep</span> <span class="string">-f</span> <span class="string">&quot;processing_message&quot;</span> <span class="string">&gt;</span> <span class="string">/dev/null;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Waiting for message processing...&quot;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">1</span></span><br><span class="line">        <span class="string">done</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æäº¤åç§»é‡</span></span><br><span class="line">        <span class="string">/app/commit_offsets.sh</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸš«-æ— æ³•ç®¡æ§çš„é˜¶æ®µ"><a href="#ğŸš«-æ— æ³•ç®¡æ§çš„é˜¶æ®µ" class="headerlink" title="ğŸš« æ— æ³•ç®¡æ§çš„é˜¶æ®µ"></a>ğŸš« æ— æ³•ç®¡æ§çš„é˜¶æ®µ</h3><h4 id="è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–"><a href="#è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–" class="headerlink" title="è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–"></a>è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™äº›çŠ¶æ€å˜åŒ–æ— æ³•é€šè¿‡ Webhook ç®¡æ§:</span></span><br><span class="line"><span class="comment"># - å®¹å™¨å¯åŠ¨å¤±è´¥ (CrashLoopBackOff)</span></span><br><span class="line"><span class="comment"># - å¥åº·æ£€æŸ¥å¤±è´¥ (Liveness/Readiness Probe)</span></span><br><span class="line"><span class="comment"># - èµ„æºä¸è¶³å¯¼è‡´é©±é€ (Evicted)</span></span><br><span class="line"><span class="comment"># - èŠ‚ç‚¹æ•…éšœå¯¼è‡´çš„ Pod é‡æ–°è°ƒåº¦</span></span><br><span class="line"><span class="comment"># - OOMKilled çŠ¶æ€</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Pod-ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾"><a href="#Pod-ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾" class="headerlink" title="Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾"></a>Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[kubectl apply pod.yaml] --&gt; B&#123;Mutating Admission Webhook&#125;</span><br><span class="line">    B --&gt; C&#123;Validating Admission Webhook&#125;</span><br><span class="line">    C --&gt;|Approved| D[Pod Stored in etcd]</span><br><span class="line">    C --&gt;|Rejected| E[Creation Failed]</span><br><span class="line">    B --&gt;|Modified| C</span><br><span class="line">    </span><br><span class="line">    D --&gt; F[Scheduler Assigns Node]</span><br><span class="line">    F --&gt; G[Kubelet Pulls Images]</span><br><span class="line">    G --&gt; H[Init Containers]</span><br><span class="line">    H --&gt; I[Main Containers Start]</span><br><span class="line">    I --&gt; J&#123;Health Checks&#125;</span><br><span class="line">    J --&gt;|Pass| K[Pod Running]</span><br><span class="line">    J --&gt;|Fail| L[Container Restart]</span><br><span class="line">    L --&gt; I</span><br><span class="line">    </span><br><span class="line">    K --&gt; M[Application Serving]</span><br><span class="line">    M --&gt; N&#123;Termination Signal?&#125;</span><br><span class="line">    N --&gt;|No| M</span><br><span class="line">    N --&gt;|Yes| O[PreStop Hook Execution]</span><br><span class="line">    </span><br><span class="line">    O --&gt; P[SIGTERM Sent]</span><br><span class="line">    P --&gt; Q[Graceful Shutdown Period]</span><br><span class="line">    Q --&gt; R&#123;Containers Stopped?&#125;</span><br><span class="line">    R --&gt;|Yes| S[Pod Terminated]</span><br><span class="line">    R --&gt;|No| T[SIGKILL After Grace Period]</span><br><span class="line">    T --&gt; S</span><br><span class="line">    </span><br><span class="line">    S --&gt; U[Pod Removed from etcd]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ffeb3b</span><br><span class="line">    style C fill:#ffeb3b</span><br><span class="line">    style O fill:#ff9800</span><br><span class="line">    style E fill:#f44336</span><br><span class="line">    style K fill:#4caf50</span><br><span class="line">    style S fill:#9e9e9e</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ¯-å…³é”®æ§åˆ¶ç‚¹è¯´æ˜"><a href="#ğŸ¯-å…³é”®æ§åˆ¶ç‚¹è¯´æ˜" class="headerlink" title="ğŸ¯ å…³é”®æ§åˆ¶ç‚¹è¯´æ˜"></a>ğŸ¯ å…³é”®æ§åˆ¶ç‚¹è¯´æ˜</h3><h4 id="1-åˆ›å»ºå‰æ§åˆ¶ç‚¹-æœ€å¼ºç®¡æ§"><a href="#1-åˆ›å»ºå‰æ§åˆ¶ç‚¹-æœ€å¼ºç®¡æ§" class="headerlink" title="1. åˆ›å»ºå‰æ§åˆ¶ç‚¹ (æœ€å¼ºç®¡æ§)"></a>1. <strong>åˆ›å»ºå‰æ§åˆ¶ç‚¹</strong> (æœ€å¼ºç®¡æ§)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶æœºï¼šPod å¯¹è±¡åˆ›å»ºä¹‹å‰</span></span><br><span class="line"><span class="comment"># ä½ç½®ï¼šAPI Server æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå­˜å‚¨åˆ° etcd ä¹‹å‰</span></span><br><span class="line"><span class="comment"># èƒ½åŠ›ï¼š</span></span><br><span class="line"><span class="comment"># - å®Œå…¨æ‹’ç»åˆ›å»º</span></span><br><span class="line"><span class="comment"># - ä¿®æ”¹ Pod è§„èŒƒ</span></span><br><span class="line"><span class="comment"># - æ³¨å…¥é¢å¤–é…ç½®</span></span><br><span class="line"><span class="comment"># - å¼ºåˆ¶å®‰å…¨ç­–ç•¥</span></span><br></pre></td></tr></table></figure>

<h4 id="2-ç»ˆæ­¢å‰æ§åˆ¶ç‚¹-æœ‰é™ç®¡æ§"><a href="#2-ç»ˆæ­¢å‰æ§åˆ¶ç‚¹-æœ‰é™ç®¡æ§" class="headerlink" title="2. ç»ˆæ­¢å‰æ§åˆ¶ç‚¹ (æœ‰é™ç®¡æ§)"></a>2. <strong>ç»ˆæ­¢å‰æ§åˆ¶ç‚¹</strong> (æœ‰é™ç®¡æ§)</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶æœºï¼šPod æ”¶åˆ°åˆ é™¤ä¿¡å·åï¼ŒSIGTERM å‘é€å‰</span></span><br><span class="line"><span class="comment"># ä½ç½®ï¼šå®¹å™¨è¿è¡Œæ—¶å‡†å¤‡ç»ˆæ­¢å®¹å™¨æ—¶</span></span><br><span class="line"><span class="comment"># èƒ½åŠ›ï¼š</span></span><br><span class="line"><span class="comment"># - ä¼˜é›…å…³é—­å¤„ç†</span></span><br><span class="line"><span class="comment"># - æ¸…ç†èµ„æº</span></span><br><span class="line"><span class="comment"># - ä¿å­˜çŠ¶æ€</span></span><br><span class="line"><span class="comment"># - é€šçŸ¥å…¶ä»–æœåŠ¡</span></span><br><span class="line"><span class="comment"># é™åˆ¶ï¼š</span></span><br><span class="line"><span class="comment"># - æœ‰æ—¶é—´é™åˆ¶ (terminationGracePeriodSeconds)</span></span><br><span class="line"><span class="comment"># - æ— æ³•é˜»æ­¢åˆ é™¤</span></span><br><span class="line"><span class="comment"># - æ— æ³•ä¿®æ”¹ Pod è§„èŒƒ</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹"><a href="#å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹" class="headerlink" title="å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹"></a>å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹</h2><h3 id="åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥"><a href="#åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥" class="headerlink" title="åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥"></a>åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥</h3><h4 id="Validating-Webhook-å®ç°"><a href="#Validating-Webhook-å®ç°" class="headerlink" title="Validating Webhook å®ç°"></a>Validating Webhook å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    </span><br><span class="line">    admissionv1 <span class="string">&quot;k8s.io/api/admission/v1&quot;</span></span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SecurityValidator <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> ValidatePod(pod *corev1.Pod) []<span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> violations []<span class="type">string</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç‰¹æƒå®¹å™¨</span></span><br><span class="line">    <span class="keyword">for</span> _, container := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        <span class="keyword">if</span> container.SecurityContext != <span class="literal">nil</span> &amp;&amp; </span><br><span class="line">           container.SecurityContext.Privileged != <span class="literal">nil</span> &amp;&amp; </span><br><span class="line">           *container.SecurityContext.Privileged &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Privileged container not allowed: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥ root ç”¨æˆ·</span></span><br><span class="line">        <span class="keyword">if</span> container.SecurityContext == <span class="literal">nil</span> || </span><br><span class="line">           container.SecurityContext.RunAsNonRoot == <span class="literal">nil</span> || </span><br><span class="line">           !*container.SecurityContext.RunAsNonRoot &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Container must run as non-root: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥èµ„æºé™åˆ¶</span></span><br><span class="line">        <span class="keyword">if</span> container.Resources.Limits == <span class="literal">nil</span> &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;Resource limits required: %s&quot;</span>, container.Name))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç½‘ç»œç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Spec.HostNetwork &#123;</span><br><span class="line">        violations = <span class="built_in">append</span>(violations, <span class="string">&quot;Host network not allowed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥å·æŒ‚è½½</span></span><br><span class="line">    <span class="keyword">for</span> _, volume := <span class="keyword">range</span> pod.Spec.Volumes &#123;</span><br><span class="line">        <span class="keyword">if</span> volume.HostPath != <span class="literal">nil</span> &#123;</span><br><span class="line">            violations = <span class="built_in">append</span>(violations, </span><br><span class="line">                fmt.Sprintf(<span class="string">&quot;HostPath volume not allowed: %s&quot;</span>, volume.Name))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> violations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">    <span class="keyword">var</span> body []<span class="type">byte</span></span><br><span class="line">    <span class="keyword">if</span> r.Body != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> data, err := io.ReadAll(r.Body); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            body = data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> admissionResponse *admissionv1.AdmissionResponse</span><br><span class="line">    ar := admissionv1.AdmissionReview&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(body, &amp;ar); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        admissionResponse = &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: err.Error(),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        admissionResponse = sv.validate(&amp;ar)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    admissionReview := admissionv1.AdmissionReview&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> admissionResponse != <span class="literal">nil</span> &#123;</span><br><span class="line">        admissionReview.Response = admissionResponse</span><br><span class="line">        <span class="keyword">if</span> ar.Request != <span class="literal">nil</span> &#123;</span><br><span class="line">            admissionReview.Response.UID = ar.Request.UID</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    respBytes, _ := json.Marshal(admissionReview)</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    w.Write(respBytes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sv *SecurityValidator)</span></span> validate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    req := ar.Request</span><br><span class="line">    <span class="keyword">var</span> pod corev1.Pod</span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(req.Object.Raw, &amp;pod); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: err.Error(),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    violations := sv.ValidatePod(&amp;pod)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(violations) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Allowed: <span class="literal">false</span>,</span><br><span class="line">            Result: &amp;metav1.Status&#123;</span><br><span class="line">                Message: fmt.Sprintf(<span class="string">&quot;Security violations: %v&quot;</span>, violations),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯2ï¼šSidecar-è‡ªåŠ¨æ³¨å…¥"><a href="#åœºæ™¯2ï¼šSidecar-è‡ªåŠ¨æ³¨å…¥" class="headerlink" title="åœºæ™¯2ï¼šSidecar è‡ªåŠ¨æ³¨å…¥"></a>åœºæ™¯2ï¼šSidecar è‡ªåŠ¨æ³¨å…¥</h3><h4 id="Mutating-Webhook-å®ç°"><a href="#Mutating-Webhook-å®ç°" class="headerlink" title="Mutating Webhook å®ç°"></a>Mutating Webhook å®ç°</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    </span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/api/resource&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SidecarInjector <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(si *SidecarInjector)</span></span> InjectSidecar(pod *corev1.Pod) []<span class="type">byte</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ³¨å…¥</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations == <span class="literal">nil</span> || pod.Annotations[<span class="string">&quot;sidecar.example.com/inject&quot;</span>] != <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> patches []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å…¥ sidecar å®¹å™¨</span></span><br><span class="line">    sidecarContainer := corev1.Container&#123;</span><br><span class="line">        Name:  <span class="string">&quot;logging-sidecar&quot;</span>,</span><br><span class="line">        Image: <span class="string">&quot;fluent/fluent-bit:1.8&quot;</span>,</span><br><span class="line">        Resources: corev1.ResourceRequirements&#123;</span><br><span class="line">            Limits: corev1.ResourceList&#123;</span><br><span class="line">                corev1.ResourceCPU:    resource.MustParse(<span class="string">&quot;100m&quot;</span>),</span><br><span class="line">                corev1.ResourceMemory: resource.MustParse(<span class="string">&quot;128Mi&quot;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">            Requests: corev1.ResourceList&#123;</span><br><span class="line">                corev1.ResourceCPU:    resource.MustParse(<span class="string">&quot;50m&quot;</span>),</span><br><span class="line">                corev1.ResourceMemory: resource.MustParse(<span class="string">&quot;64Mi&quot;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        VolumeMounts: []corev1.VolumeMount&#123;</span><br><span class="line">            &#123;</span><br><span class="line">                Name:      <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/var/log/app&quot;</span>,</span><br><span class="line">                ReadOnly:  <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                Name:      <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/fluent-bit/etc&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å®¹å™¨çš„ patch</span></span><br><span class="line">    patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/containers/-&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: sidecarContainer,</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å…¥å…±äº«å·</span></span><br><span class="line">    logVolume := corev1.Volume&#123;</span><br><span class="line">        Name: <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">        VolumeSource: corev1.VolumeSource&#123;</span><br><span class="line">            EmptyDir: &amp;corev1.EmptyDirVolumeSource&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    configVolume := corev1.Volume&#123;</span><br><span class="line">        Name: <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">        VolumeSource: corev1.VolumeSource&#123;</span><br><span class="line">            ConfigMap: &amp;corev1.ConfigMapVolumeSource&#123;</span><br><span class="line">                LocalObjectReference: corev1.LocalObjectReference&#123;</span><br><span class="line">                    Name: <span class="string">&quot;fluent-bit-config&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(pod.Spec.Volumes) == <span class="number">0</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: []corev1.Volume&#123;logVolume, configVolume&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes/-&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: logVolume,</span><br><span class="line">        &#125;)</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/spec/volumes/-&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: configVolume,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ºä¸»å®¹å™¨æ·»åŠ æ—¥å¿—å·æŒ‚è½½</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> pod.Spec.Containers &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:   <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: fmt.Sprintf(<span class="string">&quot;/spec/containers/%d/volumeMounts/-&quot;</span>, i),</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: corev1.VolumeMount&#123;</span><br><span class="line">                Name:      <span class="string">&quot;app-logs&quot;</span>,</span><br><span class="line">                MountPath: <span class="string">&quot;/var/log/app&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    patchBytes, _ := json.Marshal(patches)</span><br><span class="line">    <span class="keyword">return</span> patchBytes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†"><a href="#åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†" class="headerlink" title="åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†"></a>åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†</h3><h4 id="PreStop-Hook-é…ç½®"><a href="#PreStop-Hook-é…ç½®" class="headerlink" title="PreStop Hook é…ç½®"></a>PreStop Hook é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">web-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">web-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.21</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">                echo &quot;Starting graceful shutdown...&quot;</span></span><br><span class="line"><span class="string"></span>                </span><br><span class="line">                <span class="comment"># 1. åœæ­¢æ¥å—æ–°è¿æ¥ (ä»è´Ÿè½½å‡è¡¡å™¨æ‘˜é™¤)</span></span><br><span class="line">                <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://localhost:8080/admin/health/disable</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 2. ç­‰å¾…ç°æœ‰è¿æ¥å®Œæˆ</span></span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;Waiting for connections to finish...&quot;</span></span><br><span class="line">                <span class="string">timeout=50</span></span><br><span class="line">                <span class="string">while</span> [ <span class="string">$timeout</span> <span class="string">-gt</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">do</span></span><br><span class="line">                  <span class="string">active_conn=$(netstat</span> <span class="string">-an</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">:80</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">ESTABLISHED</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span></span><br><span class="line">                  <span class="string">if</span> [ <span class="string">$active_conn</span> <span class="string">-eq</span> <span class="number">0</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">                    <span class="string">echo</span> <span class="string">&quot;All connections closed&quot;</span></span><br><span class="line">                    <span class="string">break</span></span><br><span class="line">                  <span class="string">fi</span></span><br><span class="line">                  <span class="string">echo</span> <span class="string">&quot;Active connections: $active_conn, waiting...&quot;</span></span><br><span class="line">                  <span class="string">sleep</span> <span class="number">1</span></span><br><span class="line">                  <span class="string">timeout=$((timeout-1))</span></span><br><span class="line">                <span class="string">done</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 3. åˆ·æ–°ç¼“å­˜åˆ°æŒä¹…å­˜å‚¨</span></span><br><span class="line">                <span class="string">if</span> [ <span class="string">-f</span> <span class="string">/app/flush_cache.sh</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">                  <span class="string">echo</span> <span class="string">&quot;Flushing cache...&quot;</span></span><br><span class="line">                  <span class="string">/app/flush_cache.sh</span></span><br><span class="line">                <span class="string">fi</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 4. é€šçŸ¥ç›‘æ§ç³»ç»Ÿ</span></span><br><span class="line">                <span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://monitoring-service/api/v1/shutdown</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-H</span> <span class="string">&quot;Content-Type: application/json&quot;</span> <span class="string">\</span></span><br><span class="line">                  <span class="string">-d</span> <span class="string">&quot;&#123;\&quot;pod\&quot;:\&quot;$HOSTNAME\&quot;,\&quot;timestamp\&quot;:\&quot;$(date -Iseconds)\&quot;&#125;&quot;</span></span><br><span class="line">                </span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¥åº·æ£€æŸ¥é…ç½®</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"><a href="#æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹"></a>æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</h2><h3 id="âœ…-Admission-Webhook-æœ€ä½³å®è·µ"><a href="#âœ…-Admission-Webhook-æœ€ä½³å®è·µ" class="headerlink" title="âœ… Admission Webhook æœ€ä½³å®è·µ"></a>âœ… Admission Webhook æœ€ä½³å®è·µ</h3><h4 id="1-æ€§èƒ½ä¼˜åŒ–"><a href="#1-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="1. æ€§èƒ½ä¼˜åŒ–"></a>1. æ€§èƒ½ä¼˜åŒ–</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Webhook é…ç½®ä¼˜åŒ–</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">optimized-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate.example.com</span></span><br><span class="line">  <span class="attr">clientConfig:</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">webhook-service</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">&quot;/validate&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="comment"># æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">10</span>          <span class="comment"># è®¾ç½®é€‚å½“è¶…æ—¶</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Fail</span>         <span class="comment"># æ˜ç¡®å¤±è´¥ç­–ç•¥</span></span><br><span class="line">  <span class="attr">sideEffects:</span> <span class="string">None</span>          <span class="comment"># å£°æ˜æ— å‰¯ä½œç”¨</span></span><br><span class="line">  <span class="attr">reinvocationPolicy:</span> <span class="string">Never</span>   <span class="comment"># é¿å…é‡å¤è°ƒç”¨</span></span><br></pre></td></tr></table></figure>

<h4 id="2-é”™è¯¯å¤„ç†"><a href="#2-é”™è¯¯å¤„ç†" class="headerlink" title="2. é”™è¯¯å¤„ç†"></a>2. é”™è¯¯å¤„ç†</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Webhook)</span></span> validate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    <span class="comment">// å®ç°è¶…æ—¶æ§åˆ¶</span></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®ç°é‡è¯•æœºåˆ¶</span></span><br><span class="line">    <span class="keyword">var</span> lastErr <span class="type">error</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">if</span> result, err := w.doValidation(ctx, ar); err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastErr = err</span><br><span class="line">            time.Sleep(time.Duration(i+<span class="number">1</span>) * time.Millisecond * <span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®ç­–ç•¥å¤„ç†å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> w.config.FailurePolicy == <span class="string">&quot;Ignore&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">            Allowed: <span class="literal">true</span>,</span><br><span class="line">            Warnings: []<span class="type">string</span>&#123;fmt.Sprintf(<span class="string">&quot;Validation failed but ignored: %v&quot;</span>, lastErr)&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">false</span>,</span><br><span class="line">        Result: &amp;metav1.Status&#123;</span><br><span class="line">            Code:    http.StatusInternalServerError,</span><br><span class="line">            Message: lastErr.Error(),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-å®‰å…¨è€ƒè™‘"><a href="#3-å®‰å…¨è€ƒè™‘" class="headerlink" title="3. å®‰å…¨è€ƒè™‘"></a>3. å®‰å…¨è€ƒè™‘</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TLS é…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="comment"># Base64 encoded certificate</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="comment"># Base64 encoded private key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># RBAC é…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>, <span class="string">&quot;configmaps&quot;</span>, <span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;apps&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;deployments&quot;</span>, <span class="string">&quot;replicasets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader-binding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-service-account</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br></pre></td></tr></table></figure>

<h3 id="âš ï¸-PreStop-Hook-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-PreStop-Hook-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ PreStop Hook æ³¨æ„äº‹é¡¹"></a>âš ï¸ PreStop Hook æ³¨æ„äº‹é¡¹</h3><h4 id="1-æ—¶é—´é™åˆ¶ç®¡ç†"><a href="#1-æ—¶é—´é™åˆ¶ç®¡ç†" class="headerlink" title="1. æ—¶é—´é™åˆ¶ç®¡ç†"></a>1. æ—¶é—´é™åˆ¶ç®¡ç†</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span>  <span class="comment"># æ ¹æ®åº”ç”¨éœ€è¦è°ƒæ•´</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            # é¢„ç•™æ—¶é—´ç»™ SIGTERM å¤„ç†</span></span><br><span class="line"><span class="string">            available_time=50  # æ¯” terminationGracePeriodSeconds å°‘ 10 ç§’</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># åˆ†é˜¶æ®µå¤„ç†</span></span><br><span class="line">            <span class="comment"># é˜¶æ®µ1: åœæ­¢æ¥å—æ–°è¯·æ±‚ (5ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 1: Stopping new requests...&quot;</span></span><br><span class="line">            <span class="string">/app/stop_accepting_requests.sh</span></span><br><span class="line">            <span class="string">sleep</span> <span class="number">5</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é˜¶æ®µ2: ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ (35ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 2: Waiting for existing requests...&quot;</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">35</span> <span class="string">/app/wait_for_requests.sh</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é˜¶æ®µ3: æ¸…ç†èµ„æº (10ç§’)</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;Phase 3: Cleanup...&quot;</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">10</span> <span class="string">/app/cleanup.sh</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;PreStop hook completed&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-å¹‚ç­‰æ€§ä¿è¯"><a href="#2-å¹‚ç­‰æ€§ä¿è¯" class="headerlink" title="2. å¹‚ç­‰æ€§ä¿è¯"></a>2. å¹‚ç­‰æ€§ä¿è¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># graceful_shutdown.sh - å¹‚ç­‰çš„å…³é—­è„šæœ¬</span></span><br><span class="line"></span><br><span class="line">SHUTDOWN_FLAG=<span class="string">&quot;/tmp/shutdown_initiated&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹å…³é—­æµç¨‹</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Shutdown already in progress, skipping...&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå…³é—­æ ‡è®°</span></span><br><span class="line"><span class="built_in">touch</span> <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting graceful shutdown process...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Performing cleanup...&quot;</span></span><br><span class="line">    <span class="comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    <span class="built_in">rm</span> -f /tmp/app_*.tmp</span><br><span class="line">    <span class="comment"># å…³é—­æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="built_in">exec</span> 3&gt;&amp;-</span><br><span class="line">    <span class="comment"># ç§»é™¤å…³é—­æ ‡è®°</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$SHUTDOWN_FLAG</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¿¡å·å¤„ç†</span></span><br><span class="line"><span class="built_in">trap</span> cleanup EXIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå…³é—­æ­¥éª¤</span></span><br><span class="line">/app/shutdown_steps.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Graceful shutdown completed&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ğŸš¨-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#ğŸš¨-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><h4 id="1-Webhook-è¶…æ—¶é—®é¢˜"><a href="#1-Webhook-è¶…æ—¶é—®é¢˜" class="headerlink" title="1. Webhook è¶…æ—¶é—®é¢˜"></a>1. Webhook è¶…æ—¶é—®é¢˜</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šWebhook å“åº”æ—¶é—´è¿‡é•¿å¯¼è‡´ Pod åˆ›å»ºå¤±è´¥</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼š</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fast-validator</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">5</span>          <span class="comment"># è®¾ç½®åˆç†è¶…æ—¶</span></span><br><span class="line">  <span class="attr">failurePolicy:</span> <span class="string">Ignore</span>      <span class="comment"># è¶…æ—¶æ—¶å…è®¸é€šè¿‡</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># åœ¨ Webhook ä»£ç ä¸­å®ç°å¿«é€Ÿè·¯å¾„</span></span><br><span class="line">  <span class="string">func</span> <span class="string">quickValidation(pod</span> <span class="string">*corev1.Pod)</span> <span class="string">bool</span> &#123;</span><br><span class="line">      <span class="string">//</span> <span class="string">åªæ£€æŸ¥å…³é”®é¡¹ï¼Œè·³è¿‡è€—æ—¶éªŒè¯</span></span><br><span class="line">      <span class="string">return</span> <span class="string">pod.Spec.SecurityContext</span> <span class="type">!=</span> <span class="string">nil</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-PreStop-Hook-æ‰§è¡Œå¤±è´¥"><a href="#2-PreStop-Hook-æ‰§è¡Œå¤±è´¥" class="headerlink" title="2. PreStop Hook æ‰§è¡Œå¤±è´¥"></a>2. PreStop Hook æ‰§è¡Œå¤±è´¥</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šPreStop hook è„šæœ¬æ‰§è¡Œå¤±è´¥æˆ–è¶…æ—¶</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼š</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">90</span>  <span class="comment"># å¢åŠ ä¼˜é›…å…³é—­æ—¶é—´</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º</span></span><br><span class="line"><span class="string"></span>            </span><br><span class="line">            <span class="comment"># æ·»åŠ è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">            <span class="string">exec</span> <span class="string">&gt;</span> <span class="string">/var/log/prestop.log</span> <span class="number">2</span><span class="string">&gt;&amp;1</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$(date): Starting PreStop hook&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># ä½¿ç”¨ timeout å‘½ä»¤é˜²æ­¢å¡æ­»</span></span><br><span class="line">            <span class="string">timeout</span> <span class="number">30</span> <span class="string">/app/graceful_shutdown.sh</span> <span class="string">||</span> &#123;</span><br><span class="line">                <span class="string">echo</span> <span class="string">&quot;$(date): Graceful shutdown timeout, forcing cleanup&quot;</span></span><br><span class="line">                <span class="string">/app/force_cleanup.sh</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;$(date): PreStop hook completed&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-å¾ªç¯ä¾èµ–é—®é¢˜"><a href="#3-å¾ªç¯ä¾èµ–é—®é¢˜" class="headerlink" title="3. å¾ªç¯ä¾èµ–é—®é¢˜"></a>3. å¾ªç¯ä¾èµ–é—®é¢˜</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é—®é¢˜ï¼šWebhook æœ¬èº«çš„ Pod ä¹Ÿè¢« Webhook æ‹¦æˆª</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ namespaceSelector æ’é™¤</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingAdmissionWebhook</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-validator</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">validate-app-pods</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">      <span class="attr">values:</span> [<span class="string">&quot;webhook-system&quot;</span>, <span class="string">&quot;kube-system&quot;</span>]  <span class="comment"># æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operations:</span> [<span class="string">&quot;CREATE&quot;</span>, <span class="string">&quot;UPDATE&quot;</span>]</span><br><span class="line">    <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">apiVersions:</span> [<span class="string">&quot;v1&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="4-èµ„æºç«äº‰é—®é¢˜"><a href="#4-èµ„æºç«äº‰é—®é¢˜" class="headerlink" title="4. èµ„æºç«äº‰é—®é¢˜"></a>4. èµ„æºç«äº‰é—®é¢˜</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜ï¼šå¤šä¸ª Webhook åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ª Pod</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶å’Œæ¡ä»¶æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MutatingWebhook)</span></span> mutate(ar *admissionv1.AdmissionReview) *admissionv1.AdmissionResponse &#123;</span><br><span class="line">    <span class="keyword">var</span> pod corev1.Pod</span><br><span class="line">    json.Unmarshal(ar.Request.Object.Raw, &amp;pod)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å…¶ä»– Webhook å¤„ç†è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations[<span class="string">&quot;webhook.example.com/processed&quot;</span>] == <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;Allowed: <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> patches []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†æ ‡è®°</span></span><br><span class="line">    <span class="keyword">if</span> pod.Annotations == <span class="literal">nil</span> &#123;</span><br><span class="line">        patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/metadata/annotations&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    patches = <span class="built_in">append</span>(patches, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">        <span class="string">&quot;op&quot;</span>:    <span class="string">&quot;add&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:  <span class="string">&quot;/metadata/annotations/webhook.example.com~1processed&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå®é™…çš„å˜æ›´</span></span><br><span class="line">    patches = <span class="built_in">append</span>(patches, m.addSidecar(&amp;pod)...)</span><br><span class="line">    </span><br><span class="line">    patchBytes, _ := json.Marshal(patches)</span><br><span class="line">    <span class="keyword">return</span> &amp;admissionv1.AdmissionResponse&#123;</span><br><span class="line">        Allowed: <span class="literal">true</span>,</span><br><span class="line">        Patch:   patchBytes,</span><br><span class="line">        PatchType: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> *admissionv1.PatchType &#123;</span><br><span class="line">            pt := admissionv1.PatchTypeJSONPatch</span><br><span class="line">            <span class="keyword">return</span> &amp;pt</span><br><span class="line">        &#125;(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="é«˜çº§åœºæ™¯ä¸æ‰©å±•"><a href="#é«˜çº§åœºæ™¯ä¸æ‰©å±•" class="headerlink" title="é«˜çº§åœºæ™¯ä¸æ‰©å±•"></a>é«˜çº§åœºæ™¯ä¸æ‰©å±•</h2><h3 id="ğŸ¯-åŠ¨æ€ç­–ç•¥ç®¡ç†"><a href="#ğŸ¯-åŠ¨æ€ç­–ç•¥ç®¡ç†" class="headerlink" title="ğŸ¯ åŠ¨æ€ç­–ç•¥ç®¡ç†"></a>ğŸ¯ åŠ¨æ€ç­–ç•¥ç®¡ç†</h3><h4 id="åŸºäº-ConfigMap-çš„ç­–ç•¥é…ç½®"><a href="#åŸºäº-ConfigMap-çš„ç­–ç•¥é…ç½®" class="headerlink" title="åŸºäº ConfigMap çš„ç­–ç•¥é…ç½®"></a>åŸºäº ConfigMap çš„ç­–ç•¥é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webhook-policies</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">webhook-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">security-policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">      - name: &quot;no-privileged-containers&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;error&quot;</span></span><br><span class="line"><span class="string">        check: &quot;privileged_container&quot;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      - name: &quot;resource-limits-required&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;warning&quot;</span></span><br><span class="line"><span class="string">        check: &quot;resource_limits&quot;</span></span><br><span class="line"><span class="string">        config:</span></span><br><span class="line"><span class="string">          max_cpu: &quot;2&quot;</span></span><br><span class="line"><span class="string">          max_memory: &quot;4Gi&quot;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      - name: &quot;trusted-registries-only&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        severity: &quot;error&quot;</span></span><br><span class="line"><span class="string">        check: &quot;image_registry&quot;</span></span><br><span class="line"><span class="string">        config:</span></span><br><span class="line"><span class="string">          allowed_registries:</span></span><br><span class="line"><span class="string">            - &quot;registry.company.com&quot;</span></span><br><span class="line"><span class="string">            - &quot;gcr.io/company-project&quot;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">injection-policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    sidecars:</span></span><br><span class="line"><span class="string">      - name: &quot;logging-sidecar&quot;</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        trigger:</span></span><br><span class="line"><span class="string">          annotation: &quot;logging.company.com/enabled&quot;</span></span><br><span class="line"><span class="string">          value: &quot;true&quot;</span></span><br><span class="line"><span class="string">        container:</span></span><br><span class="line"><span class="string">          image: &quot;fluent/fluent-bit:1.8&quot;</span></span><br><span class="line"><span class="string">          resources:</span></span><br><span class="line"><span class="string">            requests:</span></span><br><span class="line"><span class="string">              cpu: &quot;50m&quot;</span></span><br><span class="line"><span class="string">              memory: &quot;64Mi&quot;</span></span><br><span class="line"><span class="string">            limits:</span></span><br><span class="line"><span class="string">              cpu: &quot;100m&quot;</span></span><br><span class="line"><span class="string">              memory: &quot;128Mi&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="åŠ¨æ€ç­–ç•¥åŠ è½½å™¨"><a href="#åŠ¨æ€ç­–ç•¥åŠ è½½å™¨" class="headerlink" title="åŠ¨æ€ç­–ç•¥åŠ è½½å™¨"></a>åŠ¨æ€ç­–ç•¥åŠ è½½å™¨</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">    <span class="string">&quot;gopkg.in/yaml.v2&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PolicyManager <span class="keyword">struct</span> &#123;</span><br><span class="line">    client       kubernetes.Interface</span><br><span class="line">    policies     *PolicyConfig</span><br><span class="line">    lastUpdate   time.Time</span><br><span class="line">    updateChan   <span class="keyword">chan</span> *PolicyConfig</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PolicyConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Rules    []ValidationRule <span class="string">`yaml:&quot;rules&quot;`</span></span><br><span class="line">    Sidecars []SidecarConfig  <span class="string">`yaml:&quot;sidecars&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PolicyManager)</span></span> WatchPolicies(ctx context.Context) &#123;</span><br><span class="line">    ticker := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            <span class="keyword">if</span> err := pm.reloadPolicies(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Printf(<span class="string">&quot;Failed to reload policies: %v&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pm *PolicyManager)</span></span> reloadPolicies() <span class="type">error</span> &#123;</span><br><span class="line">    cm, err := pm.client.CoreV1().ConfigMaps(<span class="string">&quot;webhook-system&quot;</span>).</span><br><span class="line">        Get(context.TODO(), <span class="string">&quot;webhook-policies&quot;</span>, metav1.GetOptions&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥ ConfigMap æ˜¯å¦æœ‰æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> cm.ResourceVersion == pm.policies.Version &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> newPolicies PolicyConfig</span><br><span class="line">    <span class="keyword">if</span> securityData, ok := cm.Data[<span class="string">&quot;security-policy.yaml&quot;</span>]; ok &#123;</span><br><span class="line">        <span class="keyword">if</span> err := yaml.Unmarshal([]<span class="type">byte</span>(securityData), &amp;newPolicies); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŸå­æ€§æ›´æ–°ç­–ç•¥</span></span><br><span class="line">    pm.policies = &amp;newPolicies</span><br><span class="line">    pm.lastUpdate = time.Now()</span><br><span class="line">    </span><br><span class="line">    log.Printf(<span class="string">&quot;Policies updated at %v&quot;</span>, pm.lastUpdate)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ”-å®¡è®¡ä¸ç›‘æ§"><a href="#ğŸ”-å®¡è®¡ä¸ç›‘æ§" class="headerlink" title="ğŸ” å®¡è®¡ä¸ç›‘æ§"></a>ğŸ” å®¡è®¡ä¸ç›‘æ§</h3><h4 id="Webhook-æ‰§è¡Œç›‘æ§"><a href="#Webhook-æ‰§è¡Œç›‘æ§" class="headerlink" title="Webhook æ‰§è¡Œç›‘æ§"></a>Webhook æ‰§è¡Œç›‘æ§</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    webhookDuration = prometheus.NewHistogramVec(</span><br><span class="line">        prometheus.HistogramOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_duration_seconds&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;Time spent processing admission webhook requests&quot;</span>,</span><br><span class="line">            Buckets: prometheus.DefBuckets,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;operation&quot;</span>, <span class="string">&quot;resource&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    webhookRequests = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_requests_total&quot;</span>,</span><br><span class="line">            Help: <span class="string">&quot;Total number of admission webhook requests&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;operation&quot;</span>, <span class="string">&quot;resource&quot;</span>, <span class="string">&quot;result&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    webhookErrors = prometheus.NewCounterVec(</span><br><span class="line">        prometheus.CounterOpts&#123;</span><br><span class="line">            Name: <span class="string">&quot;webhook_admission_errors_total&quot;</span>, </span><br><span class="line">            Help: <span class="string">&quot;Total number of admission webhook errors&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        []<span class="type">string</span>&#123;<span class="string">&quot;webhook_name&quot;</span>, <span class="string">&quot;error_type&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    prometheus.MustRegister(webhookDuration, webhookRequests, webhookErrors)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *AdmissionWebhook)</span></span> ServeHTTP(writer http.ResponseWriter, request *http.Request) &#123;</span><br><span class="line">    start := time.Now()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è§£æè¯·æ±‚</span></span><br><span class="line">    ar, err := w.parseAdmissionRequest(request)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        webhookErrors.WithLabelValues(w.name, <span class="string">&quot;parse_error&quot;</span>).Inc()</span><br><span class="line">        http.Error(writer, err.Error(), http.StatusBadRequest)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†è¯·æ±‚</span></span><br><span class="line">    response := w.processAdmissionRequest(ar)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•æŒ‡æ ‡</span></span><br><span class="line">    duration := time.Since(start).Seconds()</span><br><span class="line">    labels := []<span class="type">string</span>&#123;</span><br><span class="line">        w.name,</span><br><span class="line">        <span class="type">string</span>(ar.Request.Operation),</span><br><span class="line">        ar.Request.Kind.Kind,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response.Allowed &#123;</span><br><span class="line">        webhookRequests.WithLabelValues(<span class="built_in">append</span>(labels, <span class="string">&quot;allowed&quot;</span>)...).Inc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        webhookRequests.WithLabelValues(<span class="built_in">append</span>(labels, <span class="string">&quot;denied&quot;</span>)...).Inc()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    webhookDuration.WithLabelValues(labels...).Observe(duration)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€å“åº”</span></span><br><span class="line">    w.sendAdmissionResponse(writer, response)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å®¡è®¡æ—¥å¿—ç»“æ„åŒ–"><a href="#å®¡è®¡æ—¥å¿—ç»“æ„åŒ–" class="headerlink" title="å®¡è®¡æ—¥å¿—ç»“æ„åŒ–"></a>å®¡è®¡æ—¥å¿—ç»“æ„åŒ–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> AuditEvent <span class="keyword">struct</span> &#123;</span><br><span class="line">    Timestamp     time.Time                 <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">    WebhookName   <span class="type">string</span>                   <span class="string">`json:&quot;webhook_name&quot;`</span></span><br><span class="line">    Operation     <span class="type">string</span>                   <span class="string">`json:&quot;operation&quot;`</span></span><br><span class="line">    Resource      <span class="type">string</span>                   <span class="string">`json:&quot;resource&quot;`</span></span><br><span class="line">    Namespace     <span class="type">string</span>                   <span class="string">`json:&quot;namespace&quot;`</span></span><br><span class="line">    ObjectName    <span class="type">string</span>                   <span class="string">`json:&quot;object_name&quot;`</span></span><br><span class="line">    UserInfo      *authenticationv1.UserInfo <span class="string">`json:&quot;user_info&quot;`</span></span><br><span class="line">    Decision      <span class="type">string</span>                   <span class="string">`json:&quot;decision&quot;`</span></span><br><span class="line">    Reason        <span class="type">string</span>                   <span class="string">`json:&quot;reason,omitempty&quot;`</span></span><br><span class="line">    Modifications []<span class="type">string</span>                 <span class="string">`json:&quot;modifications,omitempty&quot;`</span></span><br><span class="line">    Duration      time.Duration            <span class="string">`json:&quot;duration&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *AdmissionWebhook)</span></span> auditLog(ar *admissionv1.AdmissionReview, response *admissionv1.AdmissionResponse, duration time.Duration) &#123;</span><br><span class="line">    event := AuditEvent&#123;</span><br><span class="line">        Timestamp:   time.Now(),</span><br><span class="line">        WebhookName: w.name,</span><br><span class="line">        Operation:   <span class="type">string</span>(ar.Request.Operation),</span><br><span class="line">        Resource:    ar.Request.Kind.Kind,</span><br><span class="line">        Namespace:   ar.Request.Namespace,</span><br><span class="line">        ObjectName:  ar.Request.Name,</span><br><span class="line">        UserInfo:    &amp;ar.Request.UserInfo,</span><br><span class="line">        Duration:    duration,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> response.Allowed &#123;</span><br><span class="line">        event.Decision = <span class="string">&quot;ALLOW&quot;</span></span><br><span class="line">        <span class="keyword">if</span> response.Patch != <span class="literal">nil</span> &#123;</span><br><span class="line">            event.Modifications = w.extractModifications(response.Patch)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        event.Decision = <span class="string">&quot;DENY&quot;</span></span><br><span class="line">        <span class="keyword">if</span> response.Result != <span class="literal">nil</span> &#123;</span><br><span class="line">            event.Reason = response.Result.Message</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€åˆ°å®¡è®¡ç³»ç»Ÿ</span></span><br><span class="line">    w.auditLogger.Log(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ğŸ› ï¸-æµ‹è¯•ä¸è°ƒè¯•"><a href="#ğŸ› ï¸-æµ‹è¯•ä¸è°ƒè¯•" class="headerlink" title="ğŸ› ï¸ æµ‹è¯•ä¸è°ƒè¯•"></a>ğŸ› ï¸ æµ‹è¯•ä¸è°ƒè¯•</h3><h4 id="Webhook-å•å…ƒæµ‹è¯•"><a href="#Webhook-å•å…ƒæµ‹è¯•" class="headerlink" title="Webhook å•å…ƒæµ‹è¯•"></a>Webhook å•å…ƒæµ‹è¯•</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">    </span><br><span class="line">    admissionv1 <span class="string">&quot;k8s.io/api/admission/v1&quot;</span></span><br><span class="line">    corev1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSecurityValidator_ValidatePod</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name     <span class="type">string</span></span><br><span class="line">        pod      *corev1.Pod</span><br><span class="line">        wantErr  <span class="type">bool</span></span><br><span class="line">        wantMsgs []<span class="type">string</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;valid pod&quot;</span>,</span><br><span class="line">            pod: &amp;corev1.Pod&#123;</span><br><span class="line">                Spec: corev1.PodSpec&#123;</span><br><span class="line">                    Containers: []corev1.Container&#123;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                            Image: <span class="string">&quot;registry.company.com/app:v1.0&quot;</span>,</span><br><span class="line">                            SecurityContext: &amp;corev1.SecurityContext&#123;</span><br><span class="line">                                RunAsNonRoot: &amp;[]<span class="type">bool</span>&#123;<span class="literal">true</span>&#125;[<span class="number">0</span>],</span><br><span class="line">                            &#125;,</span><br><span class="line">                            Resources: corev1.ResourceRequirements&#123;</span><br><span class="line">                                Limits: corev1.ResourceList&#123;</span><br><span class="line">                                    corev1.ResourceCPU: resource.MustParse(<span class="string">&quot;1&quot;</span>),</span><br><span class="line">                                &#125;,</span><br><span class="line">                            &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            wantErr: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;privileged container&quot;</span>,</span><br><span class="line">            pod: &amp;corev1.Pod&#123;</span><br><span class="line">                Spec: corev1.PodSpec&#123;</span><br><span class="line">                    Containers: []corev1.Container&#123;</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                            Image: <span class="string">&quot;registry.company.com/app:v1.0&quot;</span>,</span><br><span class="line">                            SecurityContext: &amp;corev1.SecurityContext&#123;</span><br><span class="line">                                Privileged: &amp;[]<span class="type">bool</span>&#123;<span class="literal">true</span>&#125;[<span class="number">0</span>],</span><br><span class="line">                            &#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            wantErr:  <span class="literal">true</span>,</span><br><span class="line">            wantMsgs: []<span class="type">string</span>&#123;<span class="string">&quot;Privileged container not allowed: app&quot;</span>&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    validator := &amp;SecurityValidator&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            violations := validator.ValidatePod(tt.pod)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> tt.wantErr &amp;&amp; <span class="built_in">len</span>(violations) == <span class="number">0</span> &#123;</span><br><span class="line">                t.Error(<span class="string">&quot;Expected violations but got none&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> !tt.wantErr &amp;&amp; <span class="built_in">len</span>(violations) &gt; <span class="number">0</span> &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;Unexpected violations: %v&quot;</span>, violations)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> _, expectedMsg := <span class="keyword">range</span> tt.wantMsgs &#123;</span><br><span class="line">                found := <span class="literal">false</span></span><br><span class="line">                <span class="keyword">for</span> _, violation := <span class="keyword">range</span> violations &#123;</span><br><span class="line">                    <span class="keyword">if</span> violation == expectedMsg &#123;</span><br><span class="line">                        found = <span class="literal">true</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> !found &#123;</span><br><span class="line">                    t.Errorf(<span class="string">&quot;Expected violation message %q not found&quot;</span>, expectedMsg)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAdmissionWebhook_Integration</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæµ‹è¯•ç”¨çš„ admission request</span></span><br><span class="line">    pod := &amp;corev1.Pod&#123;</span><br><span class="line">        ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">            Name:      <span class="string">&quot;test-pod&quot;</span>,</span><br><span class="line">            Namespace: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        Spec: corev1.PodSpec&#123;</span><br><span class="line">            Containers: []corev1.Container&#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    Name:  <span class="string">&quot;app&quot;</span>,</span><br><span class="line">                    Image: <span class="string">&quot;nginx:latest&quot;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    podBytes, _ := json.Marshal(pod)</span><br><span class="line">    ar := &amp;admissionv1.AdmissionReview&#123;</span><br><span class="line">        Request: &amp;admissionv1.AdmissionRequest&#123;</span><br><span class="line">            UID:       <span class="string">&quot;test-uid&quot;</span>,</span><br><span class="line">            Operation: admissionv1.Create,</span><br><span class="line">            Object: runtime.RawExtension&#123;</span><br><span class="line">                Raw: podBytes,</span><br><span class="line">            &#125;,</span><br><span class="line">            Kind: metav1.GroupVersionKind&#123;</span><br><span class="line">                Kind: <span class="string">&quot;Pod&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    webhook := NewSecurityValidator()</span><br><span class="line">    response := webhook.validate(ar)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> !response.Allowed &#123;</span><br><span class="line">        t.Errorf(<span class="string">&quot;Expected pod to be allowed, but was denied: %v&quot;</span>, response.Result.Message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è°ƒè¯•å·¥å…·è„šæœ¬"><a href="#è°ƒè¯•å·¥å…·è„šæœ¬" class="headerlink" title="è°ƒè¯•å·¥å…·è„šæœ¬"></a>è°ƒè¯•å·¥å…·è„šæœ¬</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># webhook_debug.sh - Webhook è°ƒè¯•å·¥å…·</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">WEBHOOK_NAME=<span class="variable">$&#123;1:-&quot;security-validator&quot;&#125;</span></span><br><span class="line">NAMESPACE=<span class="variable">$&#123;2:-&quot;webhook-system&quot;&#125;</span></span><br><span class="line">TEST_POD=<span class="variable">$&#123;3:-&quot;test-pod.yaml&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Webhook è°ƒè¯•å·¥å…· ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Webhook: <span class="variable">$WEBHOOK_NAME</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Namespace: <span class="variable">$NAMESPACE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Test Pod: <span class="variable">$TEST_POD</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. æ£€æŸ¥ Webhook é…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. æ£€æŸ¥ Webhook é…ç½®:&quot;</span></span><br><span class="line">kubectl get validatingadmissionwebhooks.admissionregistration.k8s.io <span class="variable">$WEBHOOK_NAME</span> -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥ Webhook æœåŠ¡çŠ¶æ€</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. æ£€æŸ¥ Webhook æœåŠ¡:&quot;</span></span><br><span class="line">kubectl get pods -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span></span><br><span class="line">kubectl get svc -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. æ£€æŸ¥ TLS è¯ä¹¦:&quot;</span></span><br><span class="line">kubectl get secret -n <span class="variable">$NAMESPACE</span> webhook-certs -o jsonpath=<span class="string">&#x27;&#123;.data.tls\.crt&#125;&#x27;</span> | \</span><br><span class="line">    <span class="built_in">base64</span> -d | openssl x509 -text -noout | grep -A2 <span class="string">&quot;Validity&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æµ‹è¯• Webhook è¿é€šæ€§</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. æµ‹è¯• Webhook è¿é€šæ€§:&quot;</span></span><br><span class="line">WEBHOOK_SVC=$(kubectl get svc -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>)</span><br><span class="line">kubectl run webhook-test --image=curlimages/curl --<span class="built_in">rm</span> -it --restart=Never -- \</span><br><span class="line">    curl -k https://<span class="variable">$WEBHOOK_SVC</span>.<span class="variable">$NAMESPACE</span>.svc.cluster.local/validate -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. å¹²è¿è¡Œæµ‹è¯• Pod</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. å¹²è¿è¡Œæµ‹è¯• Pod:&quot;</span></span><br><span class="line">kubectl apply -f <span class="variable">$TEST_POD</span> --dry-run=server -v=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. æŸ¥çœ‹ Webhook æ—¥å¿—</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;6. Webhook æ—¥å¿— (æœ€è¿‘ 50 è¡Œ):&quot;</span></span><br><span class="line">kubectl logs -n <span class="variable">$NAMESPACE</span> -l app=<span class="variable">$WEBHOOK_NAME</span> --<span class="built_in">tail</span>=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. æŸ¥çœ‹ API Server å®¡è®¡æ—¥å¿— (å¦‚æœå¯ç”¨)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;7. API Server ç›¸å…³æ—¥å¿—:&quot;</span></span><br><span class="line">kubectl logs -n kube-system -l component=kube-apiserver --<span class="built_in">tail</span>=20 | grep -i admission</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== è°ƒè¯•å®Œæˆ ===&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="æ€»ç»“ä¸å»ºè®®"><a href="#æ€»ç»“ä¸å»ºè®®" class="headerlink" title="æ€»ç»“ä¸å»ºè®®"></a>æ€»ç»“ä¸å»ºè®®</h2><h3 id="ğŸ¯-å…³é”®è¦ç‚¹æ€»ç»“"><a href="#ğŸ¯-å…³é”®è¦ç‚¹æ€»ç»“" class="headerlink" title="ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“"></a>ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“</h3><h4 id="1-Webhook-ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£"><a href="#1-Webhook-ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£" class="headerlink" title="1. Webhook ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£"></a>1. <strong>Webhook ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£</strong></h4><ul>
<li><strong>Pod åˆ›å»ºå‰</strong>ï¼šæœ€å¼ºç®¡æ§èƒ½åŠ›ï¼Œå¯ä»¥å®Œå…¨æ‹’ç»æˆ–ä¿®æ”¹ Pod</li>
<li><strong>Pod ç»ˆæ­¢å‰</strong>ï¼šæœ‰é™ç®¡æ§èƒ½åŠ›ï¼Œåªèƒ½æ‰§è¡Œæ¸…ç†å’Œé€šçŸ¥æ“ä½œ</li>
<li><strong>è¿è¡ŒæœŸé—´</strong>ï¼šæ— æ³•é€šè¿‡ Webhook ç®¡æ§ï¼Œéœ€è¦å…¶ä»–æœºåˆ¶</li>
</ul>
<h4 id="2-è®¾è®¡åŸåˆ™"><a href="#2-è®¾è®¡åŸåˆ™" class="headerlink" title="2. è®¾è®¡åŸåˆ™"></a>2. <strong>è®¾è®¡åŸåˆ™</strong></h4><ul>
<li><strong>å¿«é€Ÿå“åº”</strong>ï¼šWebhook åº”è¯¥åœ¨æ¯«ç§’çº§å®Œæˆå¤„ç†</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šåŒæ ·çš„è¾“å…¥æ€»æ˜¯äº§ç”ŸåŒæ ·çš„è¾“å‡º</li>
<li><strong>å®¹é”™æ€§</strong>ï¼šåˆç†è®¾ç½® failurePolicy å’Œè¶…æ—¶æ—¶é—´</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šæä¾›è¯¦ç»†çš„æ—¥å¿—å’ŒæŒ‡æ ‡</li>
</ul>
<h4 id="3-å¸¸è§é™·é˜±"><a href="#3-å¸¸è§é™·é˜±" class="headerlink" title="3. å¸¸è§é™·é˜±"></a>3. <strong>å¸¸è§é™·é˜±</strong></h4><ul>
<li>é¿å… Webhook å¤„ç†è‡ªèº« Pod (ä½¿ç”¨ namespaceSelector)</li>
<li>é˜²æ­¢æ— é™é€’å½’è°ƒç”¨ (ä½¿ç”¨ reinvocationPolicy)</li>
<li>æ³¨æ„æ—¶é—´é™åˆ¶ (PreStop Hook æœ‰ terminationGracePeriodSeconds é™åˆ¶)</li>
<li>å¤„ç†ç½‘ç»œåˆ†åŒºå’Œè¶…æ—¶æƒ…å†µ</li>
</ul>
<h3 id="ğŸš€-è¿›é˜¶å»ºè®®"><a href="#ğŸš€-è¿›é˜¶å»ºè®®" class="headerlink" title="ğŸš€ è¿›é˜¶å»ºè®®"></a>ğŸš€ è¿›é˜¶å»ºè®®</h3><h4 id="1-å¤šå±‚é˜²æŠ¤ç­–ç•¥"><a href="#1-å¤šå±‚é˜²æŠ¤ç­–ç•¥" class="headerlink" title="1. å¤šå±‚é˜²æŠ¤ç­–ç•¥"></a>1. <strong>å¤šå±‚é˜²æŠ¤ç­–ç•¥</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»„åˆä½¿ç”¨å¤šç§ Webhook å®ç°æ·±åº¦é˜²æŠ¤</span></span><br><span class="line"><span class="comment"># Layer 1: Mutating Webhook (æ³¨å…¥å®‰å…¨é…ç½®)</span></span><br><span class="line"><span class="comment"># Layer 2: Validating Webhook (éªŒè¯å®‰å…¨ç­–ç•¥)  </span></span><br><span class="line"><span class="comment"># Layer 3: OPA Gatekeeper (ç­–ç•¥å³ä»£ç )</span></span><br><span class="line"><span class="comment"># Layer 4: Pod Security Standards (è¿è¡Œæ—¶å®‰å…¨)</span></span><br></pre></td></tr></table></figure>

<h4 id="2-æ¸è¿›å¼éƒ¨ç½²"><a href="#2-æ¸è¿›å¼éƒ¨ç½²" class="headerlink" title="2. æ¸è¿›å¼éƒ¨ç½²"></a>2. <strong>æ¸è¿›å¼éƒ¨ç½²</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å®½æ¾åˆ°ä¸¥æ ¼çš„ç­–ç•¥æ¼”è¿›</span></span><br><span class="line"><span class="attr">Phase 1: failurePolicy:</span> <span class="string">Ignore</span>  <span class="comment"># è§‚å¯Ÿæ¨¡å¼ï¼Œè®°å½•ä½†ä¸é˜»æ­¢</span></span><br><span class="line"><span class="attr">Phase 2:</span> <span class="string">åªé’ˆå¯¹ç‰¹å®šå‘½åç©ºé—´å¯ç”¨</span></span><br><span class="line"><span class="attr">Phase 3: failurePolicy:</span> <span class="string">Fail</span>    <span class="comment"># å¼ºåˆ¶æ‰§è¡Œ</span></span><br><span class="line"><span class="attr">Phase 4:</span> <span class="string">æ‰©å±•åˆ°æ‰€æœ‰å‘½åç©ºé—´</span></span><br></pre></td></tr></table></figure>

<h4 id="3-ç›‘æ§å‘Šè­¦ä½“ç³»"><a href="#3-ç›‘æ§å‘Šè­¦ä½“ç³»" class="headerlink" title="3. ç›‘æ§å‘Šè­¦ä½“ç³»"></a>3. <strong>ç›‘æ§å‘Šè­¦ä½“ç³»</strong></h4><ul>
<li>Webhook å“åº”æ—¶é—´ç›‘æ§</li>
<li>æ‹’ç»ç‡å’Œé€šè¿‡ç‡ç»Ÿè®¡</li>
<li>é”™è¯¯ç±»å‹åˆ†ç±»ç»Ÿè®¡</li>
<li>èµ„æºä½¿ç”¨æƒ…å†µç›‘æ§</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/07/31/tcpdump%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%88%86%E6%9E%90%E6%8C%87%E5%8D%97/" rel="prev" title="tcpdumpè§£æåŠåˆ†ææŒ‡å—">
      <i class="fa fa-chevron-left"></i> tcpdumpè§£æåŠåˆ†ææŒ‡å—
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/08/05/zap%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB/" rel="next" title="zapæ—¥å¿—çº§åˆ«">
      zapæ—¥å¿—çº§åˆ« <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-Pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8E-Webhook-%E7%AE%A1%E6%8E%A7%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes Pod ç”Ÿå‘½å‘¨æœŸä¸ Webhook ç®¡æ§åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%8E%AF-%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">ğŸ¯ ç›®å½•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%8A%B6%E6%80%81%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.2.</span> <span class="nav-text">Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%93%8A-Pod-%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E8%A1%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">ğŸ“Š Pod çŠ¶æ€è½¬æ¢è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%8D-%E5%85%B3%E9%94%AE%E8%A7%82%E5%AF%9F%E7%82%B9"><span class="nav-number">1.2.2.</span> <span class="nav-text">ğŸ” å…³é”®è§‚å¯Ÿç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Webhook-%E7%94%9F%E6%95%88%E7%9A%84%E5%85%B3%E9%94%AE%E6%97%B6%E5%88%BB"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">1. Webhook ç”Ÿæ•ˆçš„å…³é”®æ—¶åˆ»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%97%A0%E6%B3%95%E7%AE%A1%E6%8E%A7%E7%9A%84%E9%98%B6%E6%AE%B5"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">2. æ— æ³•ç®¡æ§çš„é˜¶æ®µ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webhook-%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%A7%A6%E5%8F%91%E6%97%B6%E6%9C%BA"><span class="nav-number">1.3.</span> <span class="nav-text">Webhook ç±»å‹ä¸è§¦å‘æ—¶æœº</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%8E%A3-Admission-Controller-Webhook"><span class="nav-number">1.3.1.</span> <span class="nav-text">ğŸ£ Admission Controller Webhook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ValidatingAdmissionWebhook"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">ValidatingAdmissionWebhook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MutatingAdmissionWebhook"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">MutatingAdmissionWebhook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%AA%9D-Lifecycle-Hook"><span class="nav-number">1.3.2.</span> <span class="nav-text">ğŸª Lifecycle Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PreStop-Hook"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">PreStop Hook</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E9%98%B6%E6%AE%B5-Webhook-%E7%AE%A1%E6%8E%A7%E8%83%BD%E5%8A%9B"><span class="nav-number">1.4.</span> <span class="nav-text">å„é˜¶æ®µ Webhook ç®¡æ§èƒ½åŠ›</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9A%80-Pod-%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5-%E6%9C%80%E5%BC%BA%E7%AE%A1%E6%8E%A7"><span class="nav-number">1.4.1.</span> <span class="nav-text">ğŸš€ Pod åˆ›å»ºé˜¶æ®µ (æœ€å¼ºç®¡æ§)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mutating-Webhook-%E5%85%B8%E5%9E%8B%E7%94%A8%E4%BE%8B"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">Mutating Webhook å…¸å‹ç”¨ä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Validating-Webhook-%E5%85%B8%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">Validating Webhook å…¸å‹åœºæ™¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%9A%A0%EF%B8%8F-Pod-%E7%BB%88%E6%AD%A2%E9%98%B6%E6%AE%B5-%E6%9C%89%E9%99%90%E7%AE%A1%E6%8E%A7"><span class="nav-number">1.4.2.</span> <span class="nav-text">âš ï¸ Pod ç»ˆæ­¢é˜¶æ®µ (æœ‰é™ç®¡æ§)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PreStop-Hook-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">PreStop Hook ä½¿ç”¨åœºæ™¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9A%AB-%E6%97%A0%E6%B3%95%E7%AE%A1%E6%8E%A7%E7%9A%84%E9%98%B6%E6%AE%B5"><span class="nav-number">1.4.3.</span> <span class="nav-text">ğŸš« æ— æ³•ç®¡æ§çš„é˜¶æ®µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">è¿è¡Œæ—¶çŠ¶æ€å˜åŒ–</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.5.</span> <span class="nav-text">Pod ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%8E%AF-%E5%85%B3%E9%94%AE%E6%8E%A7%E5%88%B6%E7%82%B9%E8%AF%B4%E6%98%8E"><span class="nav-number">1.5.1.</span> <span class="nav-text">ğŸ¯ å…³é”®æ§åˆ¶ç‚¹è¯´æ˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E5%89%8D%E6%8E%A7%E5%88%B6%E7%82%B9-%E6%9C%80%E5%BC%BA%E7%AE%A1%E6%8E%A7"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">1. åˆ›å»ºå‰æ§åˆ¶ç‚¹ (æœ€å¼ºç®¡æ§)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%BB%88%E6%AD%A2%E5%89%8D%E6%8E%A7%E5%88%B6%E7%82%B9-%E6%9C%89%E9%99%90%E7%AE%A1%E6%8E%A7"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">2. ç»ˆæ­¢å‰æ§åˆ¶ç‚¹ (æœ‰é™ç®¡æ§)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E5%9C%BA%E6%99%AF%E4%B8%8E%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.6.</span> <span class="nav-text">å®æˆ˜åœºæ™¯ä¸é…ç½®ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF1%EF%BC%9A%E5%AE%89%E5%85%A8%E5%90%88%E8%A7%84%E6%A3%80%E6%9F%A5"><span class="nav-number">1.6.1.</span> <span class="nav-text">åœºæ™¯1ï¼šå®‰å…¨åˆè§„æ£€æŸ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Validating-Webhook-%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">Validating Webhook å®ç°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF2%EF%BC%9ASidecar-%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5"><span class="nav-number">1.6.2.</span> <span class="nav-text">åœºæ™¯2ï¼šSidecar è‡ªåŠ¨æ³¨å…¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mutating-Webhook-%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">Mutating Webhook å®ç°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF3%EF%BC%9A%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%AD%E5%A4%84%E7%90%86"><span class="nav-number">1.6.3.</span> <span class="nav-text">åœºæ™¯3ï¼šä¼˜é›…å…³é—­å¤„ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PreStop-Hook-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">PreStop Hook é…ç½®</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">1.7.</span> <span class="nav-text">æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%9C%85-Admission-Webhook-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.7.1.</span> <span class="nav-text">âœ… Admission Webhook æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">1. æ€§èƒ½ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">2. é”™è¯¯å¤„ç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%AE%89%E5%85%A8%E8%80%83%E8%99%91"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">3. å®‰å…¨è€ƒè™‘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%9A%A0%EF%B8%8F-PreStop-Hook-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">1.7.2.</span> <span class="nav-text">âš ï¸ PreStop Hook æ³¨æ„äº‹é¡¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%97%B6%E9%97%B4%E9%99%90%E5%88%B6%E7%AE%A1%E7%90%86"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">1. æ—¶é—´é™åˆ¶ç®¡ç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%B9%82%E7%AD%89%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">2. å¹‚ç­‰æ€§ä¿è¯</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9A%A8-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.7.3.</span> <span class="nav-text">ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Webhook-%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98"><span class="nav-number">1.7.3.1.</span> <span class="nav-text">1. Webhook è¶…æ—¶é—®é¢˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-PreStop-Hook-%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5"><span class="nav-number">1.7.3.2.</span> <span class="nav-text">2. PreStop Hook æ‰§è¡Œå¤±è´¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98"><span class="nav-number">1.7.3.3.</span> <span class="nav-text">3. å¾ªç¯ä¾èµ–é—®é¢˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E8%B5%84%E6%BA%90%E7%AB%9E%E4%BA%89%E9%97%AE%E9%A2%98"><span class="nav-number">1.7.3.4.</span> <span class="nav-text">4. èµ„æºç«äº‰é—®é¢˜</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%9C%BA%E6%99%AF%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="nav-number">1.8.</span> <span class="nav-text">é«˜çº§åœºæ™¯ä¸æ‰©å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%8E%AF-%E5%8A%A8%E6%80%81%E7%AD%96%E7%95%A5%E7%AE%A1%E7%90%86"><span class="nav-number">1.8.1.</span> <span class="nav-text">ğŸ¯ åŠ¨æ€ç­–ç•¥ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-ConfigMap-%E7%9A%84%E7%AD%96%E7%95%A5%E9%85%8D%E7%BD%AE"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">åŸºäº ConfigMap çš„ç­–ç•¥é…ç½®</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E7%AD%96%E7%95%A5%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">åŠ¨æ€ç­–ç•¥åŠ è½½å™¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%8D-%E5%AE%A1%E8%AE%A1%E4%B8%8E%E7%9B%91%E6%8E%A7"><span class="nav-number">1.8.2.</span> <span class="nav-text">ğŸ” å®¡è®¡ä¸ç›‘æ§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Webhook-%E6%89%A7%E8%A1%8C%E7%9B%91%E6%8E%A7"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">Webhook æ‰§è¡Œç›‘æ§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A1%E8%AE%A1%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84%E5%8C%96"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">å®¡è®¡æ—¥å¿—ç»“æ„åŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9B%A0%EF%B8%8F-%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E8%AF%95"><span class="nav-number">1.8.3.</span> <span class="nav-text">ğŸ› ï¸ æµ‹è¯•ä¸è°ƒè¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Webhook-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.8.3.1.</span> <span class="nav-text">Webhook å•å…ƒæµ‹è¯•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%E8%84%9A%E6%9C%AC"><span class="nav-number">1.8.3.2.</span> <span class="nav-text">è°ƒè¯•å·¥å…·è„šæœ¬</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.9.</span> <span class="nav-text">æ€»ç»“ä¸å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%8E%AF-%E5%85%B3%E9%94%AE%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">1.9.1.</span> <span class="nav-text">ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Webhook-%E7%AE%A1%E6%8E%A7%E7%9A%84%E9%BB%84%E9%87%91%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">1. Webhook ç®¡æ§çš„é»„é‡‘æ—¶é—´çª—å£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">2. è®¾è®¡åŸåˆ™</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">3. å¸¸è§é™·é˜±</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9A%80-%E8%BF%9B%E9%98%B6%E5%BB%BA%E8%AE%AE"><span class="nav-number">1.9.2.</span> <span class="nav-text">ğŸš€ è¿›é˜¶å»ºè®®</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%A4%9A%E5%B1%82%E9%98%B2%E6%8A%A4%E7%AD%96%E7%95%A5"><span class="nav-number">1.9.2.1.</span> <span class="nav-text">1. å¤šå±‚é˜²æŠ¤ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%B8%90%E8%BF%9B%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">2. æ¸è¿›å¼éƒ¨ç½²</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB"><span class="nav-number">1.9.2.3.</span> <span class="nav-text">3. ç›‘æ§å‘Šè­¦ä½“ç³»</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="shispring"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">shispring</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">174</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">shispring</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
